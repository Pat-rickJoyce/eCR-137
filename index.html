<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eICR Form Generator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9fafb;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        h1 {
            color: #1f2937;
            margin: 0;
            font-size: 2rem;
        }
        .subtitle {
            color: #6b7280;
            margin: 5px 0 0 0;
        }
        .rctc-info {
            background: #e0f2fe;
            border: 1px solid #81d4fa;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        .rctc-info h3 {
            margin: 0 0 10px 0;
            color: #0277bd;
        }
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn:hover { opacity: 0.9; }
        .section {
            margin-bottom: 30px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 20px 0;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        .textarea-group {
            grid-column: 1 / -1;
        }
        label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }
        input, textarea, select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .footer-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            flex-wrap: wrap;
        }
        .code-search {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: #f9fafb;
            margin-top: 10px;
            display: none;
        }
        .result-item {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .result-item:hover {
            background-color: #e5e7eb;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .code-display {
            font-family: monospace;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        .hidden { display: none; }
        .trigger-indicator {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; }
            .form-grid { grid-template-columns: 1fr; }
            .container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>eICR Generator</h1>
                <p class="subtitle">Electronic Initial Case Report with Reportable Condition Trigger Codes</p>
            </div>
            <div class="buttons">
                <label class="btn btn-secondary">
                    üìÅ Load Form Data
                    <input type="file" accept=".json" onchange="loadFormData(event)" class="hidden">
                </label>
                <button class="btn btn-warning" onclick="loadRCTCFile()">üìã Load RCTC File</button>
                <button class="btn btn-success" onclick="saveFormData()">üíæ Save Form Data</button>
                <button class="btn btn-primary" onclick="generateAndDownloadCDA()">üìÑ Generate CDA</button>
                <button class="btn btn-success" onclick="generateAndPostCDA()">üöÄ Generate & Post CDA to S3</button>
                <button class="btn btn-primary" onclick="generateAndDownloadRR()">üì® Generate RR</button>

            </div>
        </div>


        <div class="section">
            <h2 class="section-title">Patient Demographics</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Patient ID</label>
                    <input type="text" id="patientId" value="MRN-00234567">
                </div>
                <div class="input-group">
                    <label>Patient Name</label>
                    <input type="text" id="patientName" value="Emma Rose Johnson">
                </div>
                <div class="input-group">
                    <label>Phone</label>
                    <input type="text" id="patientPhone" value="+1-555-234-5678">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="patientEmail" value="johnson.family@email.com">
                </div>
                <div class="input-group">
                    <label>Address</label>
                    <input type="text" id="patientAddress" value="1247 Maple Street">
                </div>
                <div class="input-group">
                    <label>City</label>
                    <input type="text" id="patientCity" value="Springfield">
                </div>
                <div class="input-group">
                    <label>State</label>
                    <input type="text" id="patientState" value="Illinois">
                </div>
                <div class="input-group">
                    <label>ZIP Code</label>
                    <input type="text" id="patientZip" value="62701">
                </div>
                <div class="input-group">
                    <label>County</label>
                    <input type="text" id="patientCounty" value="Sangamon County">
                </div>
                <div class="input-group">
                    <label>Country</label>
                    <input type="text" id="patientCountry" value="United States">
                </div>
                <div class="input-group">
                    <label>Gender (F/M)</label>
                    <input type="text" id="patientGender" value="F">
                </div>
                <div class="input-group">
                    <label>Birth Date (YYYYMMDD)</label>
                    <input type="text" id="patientBirthDate" value="20240615">
                </div>
                <div class="input-group">
                    <label>Race Code</label>
                    <select id="patientRace">
                        <option value="1002-5">American Indian or Alaska Native</option>
                        <option value="2028-9">Asian</option>
                        <option value="2054-5">Black or African American</option>
                        <option value="2076-8">Native Hawaiian or Other Pacific Islander</option>
                        <option value="2106-3" selected>White</option>
                        <option value="2131-1">Other Race</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Ethnicity Code</label>
                    <select id="patientEthnicity">
                        <option value="2135-2">Hispanic or Latino</option>
                        <option value="2186-5" selected>Not Hispanic or Latino</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Birth Place</label>
                    <input type="text" id="patientBirthPlace" value="Memorial Hospital, Springfield, IL">
                </div>
                <div class="input-group">
                    <label>Birth Sex</label>
                    <select id="patientBirthSex">
                        <option value="F">Female</option>
                        <option value="M">Male</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Gender Identity</label>
                    <select id="patientGenderIdentity">
                        <option value="446151000124109">Identifies as female gender (finding)</option>
                        <option value="446141000124107">Identifies as male gender (finding)</option>
                        <option value="33791000087105">Identifies as nonbinary gender (finding)</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Detailed Race Code</label>
                    <select id="patientDetailedRace">
                        <option value="1004-1">American Indian</option>
                        <option value="1010-8">Alaska Native</option>
                        <option value="2029-7">Asian Indian</option>
                        <option value="2040-4">Chinese</option>
                        <option value="2047-9">Filipino</option>
                        <option value="2051-1">Japanese</option>
                        <option value="2054-5">Korean</option>
                        <option value="2058-6">Vietnamese</option>
                        <option value="2060-2">Other Asian</option>
                        <option value="2076-8">Black</option>
                        <option value="2108-9" selected>White</option>
                        <option value="2131-1">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Detailed Ethnicity Code</label>
                    <select id="patientDetailedEthnicity">
                        <option value="2137-8">Mexican</option>
                        <option value="2141-0">Puerto Rican</option>
                        <option value="2142-8">Cuban</option>
                        <option value="2148-5" selected>Not Hispanic or Latino</option>
                        <option value="2180-8">Other Hispanic or Latino</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Primary Language</label>
                    <input type="text" id="patientLanguage" value="en">
                </div>
                <div class="input-group">
                    <label>Death Indicator</label>
                    <select id="patientDeathIndicator">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Date of Death (YYYYMMDD)</label>
                    <input type="text" id="patientDeathDate" placeholder="Leave blank if alive">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Guardian/Parent Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Guardian Name</label>
                    <input type="text" id="guardianName" value="Sarah Michelle Johnson">
                </div>
                <div class="input-group">
                    <label>Guardian Phone</label>
                    <input type="text" id="guardianPhone" value="+1-555-234-5678">
                </div>
                <div class="input-group">
                    <label>Guardian Email</label>
                    <input type="email" id="guardianEmail" value="sarah.johnson@email.com">
                </div>
                <div class="input-group">
                    <label>Guardian Address</label>
                    <input type="text" id="guardianAddress" value="1247 Maple Street">
                </div>
                <div class="input-group">
                    <label>Guardian City</label>
                    <input type="text" id="guardianCity" value="Springfield">
                </div>
                <div class="input-group">
                    <label>Guardian State</label>
                    <input type="text" id="guardianState" value="Illinois">
                </div>
                <div class="input-group">
                    <label>Guardian ZIP Code</label>
                    <input type="text" id="guardianZip" value="62701">
                </div>
                <div class="input-group">
                    <label>Guardian Relationship Code</label>
                    <select id="guardianCode">
                        <option value="MTH">Mother</option>
                        <option value="FTH">Father</option>
                        <option value="GRMTH">Grandmother</option>
                        <option value="GRFTH">Grandfather</option>
                        <option value="GUARD">Guardian</option>
                        <option value="O">Other</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Provider Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Provider ID</label>
                    <input type="text" id="providerId" value="1234567890">
                </div>
                <div class="input-group">
                    <label>Provider Name</label>
                    <input type="text" id="providerName" value="Dr Royce Hemlock">
                </div>
                <div class="input-group">
                    <label>Provider Phone</label>
                    <input type="text" id="providerPhone" value="+1-555-777-0123">
                </div>
                <div class="input-group">
                    <label>Provider Email</label>
                    <input type="email" id="providerEmail" value="dr.hemlock@grmfc.gc.example.com">
                </div>
                <div class="input-group">
                    <label>Provider Fax</label>
                    <input type="text" id="providerFax" value="+1-555-777-0124">
                </div>
                <div class="input-group">
                    <label>Facility ID</label>
                    <input type="text" id="facilityId" value="FAC-987654321">
                </div>
                <div class="input-group">
                    <label>Facility Name</label>
                    <input type="text" id="facilityName" value="Grand Republic Medical Facility Clinic">
                </div>
                <div class="input-group">
                    <label>Facility Address</label>
                    <input type="text" id="facilityAddress" value="500 Republica Medical Plaza, Suite 1000">
                </div>
                <div class="input-group">
                    <label>Facility Type Code</label>
                    <select id="facilityTypeCode">
                        <option value="OF">Outpatient Facility</option>
                        <option value="HOSP">Hospital</option>
                        <option value="COMM">Community Hospital</option>
                        <option value="PROFF">Provider's Office</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Organization Name</label>
                    <input type="text" id="organizationName" value="Grand Republic Medical Corporation">
                </div>
                <div class="input-group">
                    <label>Organization ID</label>
                    <input type="text" id="organizationId" value="ORG-123456789">
                </div>
                <div class="input-group">
                    <label>Organization Phone</label>
                    <input type="text" id="organizationPhone" value="+1-555-777-1000">
                </div>
                <div class="input-group">
                    <label>Organization Email</label>
                    <input type="email" id="organizationEmail" value="info@grmfc.gc.example.com">
                </div>
                <div class="input-group">
                    <label>Organization Fax</label>
                    <input type="text" id="organizationFax" value="+1-555-777-1001">
                </div>
                <div class="input-group">
                    <label>Organization Address</label>
                    <input type="text" id="organizationAddress" value="500 Republica Medical Plaza">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Encounter Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Encounter ID</label>
                    <input type="text" id="encounterId" value="9937015">
                </div>
                <div class="input-group">
                    <label>Encounter Type</label>
                    <input type="text" id="encounterType" value="AMB">
                </div>
                <div class="input-group">
                    <label>Encounter Date (YYYYMMDD)</label>
                    <input type="text" id="encounterDate" value="20240615">
                </div>
                <div class="input-group">
                    <label>Encounter End Date (YYYYMMDD)</label>
                    <input type="text" id="encounterEndDate" value="20240615">
                </div>
                <div class="input-group">
                    <label>Encounter Disposition</label>
                    <select id="encounterDisposition">
                        <option value="01">Routine discharge/release to home or self care</option>
                        <option value="02">Discharge/transfer to another short term hospital</option>
                        <option value="03">Discharge/transfer to skilled nursing facility</option>
                        <option value="04">Discharge/transfer to an intermediate care facility</option>
                        <option value="05">Discharge/transfer to another type of institution</option>
                        <option value="06">Discharge/transfer to home under care of organized home health service</option>
                        <option value="07">Left against medical advice or discontinued care</option>
                        <option value="20">Expired</option>
                    </select>
                </div>
                <div class="input-group textarea-group">
                    <label>Chief Complaint</label>
                    <textarea id="chiefComplaint">fever, cough, exposure to COVID-19 hot zone</textarea>
                </div>
                <div class="input-group textarea-group">
                    <label>History of Present Illness</label>
                    <textarea id="presentIllness">The patient initially presented with difficulty breathing and fever. Patient disclosed recent travel to a known COVID-19 hot zone.</textarea>
                </div>
                <div class="input-group textarea-group">
                    <label>Reason for Visit</label>
                    <textarea id="reasonForVisit">Routine follow-up visit and COVID-19 screening due to exposure</textarea>
                </div>
                <div class="input-group textarea-group">
                    <label>Past Medical History</label>
                    <textarea id="pastMedicalHistory">No significant past medical history. No known allergies.</textarea>
                </div>
                <div class="input-group textarea-group">
                    <label>Review of Systems</label>
                    <textarea id="reviewOfSystems">Patient reports fever, fatigue, and mild cough. Denies chest pain, shortness of breath at rest.</textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Diagnoses with RCTC Trigger Codes</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Diagnosis 1 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="diagnosis1Code" value="67531005" onblur="validateTriggerCode('diagnosis1Code')">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('diagnosis1Code')">üîç</button>
                    </div>
                    <div id="diagnosis1Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Diagnosis 1 Name</label>
                    <input type="text" id="diagnosis1Name" value="Spina bifida (disorder)">
                </div>
                <div class="input-group">
                    <label>Diagnosis 2 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="diagnosis2Code" value="414819007" onblur="validateTriggerCode('diagnosis2Code')">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('diagnosis2Code')">üîç</button>
                    </div>
                    <div id="diagnosis2Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Diagnosis 2 Name</label>
                    <input type="text" id="diagnosis2Name" value="Neonatal abstinence syndrome (disorder)">
                </div>
                <div class="input-group">
                    <label>Diagnosis 3 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="diagnosis3Code" value="86299006" onblur="validateTriggerCode('diagnosis3Code')">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('diagnosis3Code')">üîç</button>
                    </div>
                    <div id="diagnosis3Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Diagnosis 3 Name</label>
                    <input type="text" id="diagnosis3Name" value="Tetralogy of Fallot (disorder)">
                </div>
                <div class="input-group">
                    <label>Date of Diagnosis 1 (YYYYMMDD)</label>
                    <input type="text" id="diagnosis1Date" value="20240615">
                </div>
                <div class="input-group">
                    <label>Date of Onset 1 (YYYYMMDD)</label>
                    <input type="text" id="diagnosis1OnsetDate" value="20240615">
                </div>
                <div class="input-group">
                    <label>Date of Diagnosis 2 (YYYYMMDD)</label>
                    <input type="text" id="diagnosis2Date" value="20240615">
                </div>
                <div class="input-group">
                    <label>Date of Onset 2 (YYYYMMDD)</label>
                    <input type="text" id="diagnosis2OnsetDate" value="20240615">
                </div>
                <div class="input-group">
                    <label>Date of Diagnosis 3 (YYYYMMDD)</label>
                    <input type="text" id="diagnosis3Date" value="20240615">
                </div>
                <div class="input-group">
                    <label>Date of Onset 3 (YYYYMMDD)</label>
                    <input type="text" id="diagnosis3OnsetDate" value="20240615">
                </div>
                <div class="input-group">
                    <label>Problem Type</label>
                    <select id="problemType">
                        <option value="55607006">Problem</option>
                        <option value="282291009">Diagnosis</option>
                        <option value="404684003">Finding</option>
                        <option value="418799008">Symptom</option>
                    </select>
                </div>
                <div class="input-group textarea-group">
                    <label>Symptoms</label>
                    <textarea id="symptoms">Fever, cough, fatigue, and respiratory symptoms consistent with viral infection</textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Laboratory Tests with RCTC Trigger Codes</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Lab Test 1 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="labTest1Code" value="94310-0" onblur="validateTriggerCode('labTest1Code')">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('labTest1Code')">üîç</button>
                    </div>
                    <div id="labTest1Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Lab Test 1 Name</label>
                    <input type="text" id="labTest1Name" value="SARS-like Coronavirus N gene [Presence] in Unspecified specimen by NAA with probe detection">
                </div>
                <div class="input-group">
                    <label>Lab Test 1 Result</label>
                    <select id="labTest1Result">
                        <option value="Detected">Detected</option>
                        <option value="Not Detected">Not Detected</option>
                        <option value="Positive">Positive</option>
                        <option value="Negative">Negative</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="labTest2Code" value="34487-9" onblur="validateTriggerCode('labTest2Code')">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('labTest2Code')">üîç</button>
                    </div>
                    <div id="labTest2Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Name</label>
                    <input type="text" id="labTest2Name" value="Influenza virus A RNA [Presence] in Respiratory specimen by NAA with probe detection">
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Result</label>
                    <select id="labTest2Result">
                        <option value="Detected">Detected</option>
                        <option value="Not Detected">Not Detected</option>
                        <option value="Positive">Positive</option>
                        <option value="Negative">Negative</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Lab Order 1 Code</label>
                    <input type="text" id="labOrder1Code" value="19080-1">
                </div>
                <div class="input-group">
                    <label>Lab Order 1 ID</label>
                    <input type="text" id="labOrder1Id" value="ORD-2024-001">
                </div>
                <div class="input-group">
                    <label>Lab Order 1 Time (YYYYMMDDHHMMSS)</label>
                    <input type="text" id="labOrder1Time" value="20240615080000">
                </div>
                <div class="input-group">
                    <label>Lab Test 1 Status</label>
                    <select id="labTest1Status">
                        <option value="completed">Completed</option>
                        <option value="active">Active</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Lab Test 1 Time (YYYYMMDDHHMMSS)</label>
                    <input type="text" id="labTest1Time" value="20240615100000">
                </div>
                <div class="input-group">
                    <label>Lab Test 1 Interpretation</label>
                    <select id="labTest1Interpretation">
                        <option value="A">Abnormal</option>
                        <option value="N">Normal</option>
                        <option value="H">High</option>
                        <option value="L">Low</option>
                        <option value="HH">Critical high</option>
                        <option value="LL">Critical low</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Lab Test 1 Reference Range</label>
                    <input type="text" id="labTest1ReferenceRange" value="2.5-15.0 ng/mL">
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Status</label>
                    <select id="labTest2Status">
                        <option value="completed">Completed</option>
                        <option value="active">Active</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Time (YYYYMMDDHHMMSS)</label>
                    <input type="text" id="labTest2Time" value="20240615110000">
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Interpretation</label>
                    <select id="labTest2Interpretation">
                        <option value="A">Abnormal</option>
                        <option value="N">Normal</option>
                        <option value="H">High</option>
                        <option value="L">Low</option>
                        <option value="HH">Critical high</option>
                        <option value="LL">Critical low</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Reference Range</label>
                    <input type="text" id="labTest2ReferenceRange" value="Negative-Positive">
                </div>
            </div>
        </div>

<!-- ‚ñë‚ñë‚ñë  MEDICATIONS  ‚ñë‚ñë‚ñë================================================ -->
<div class="section">
  <h2 class="section-title">Medications</h2>

  <div class="form-grid">

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Administered Medication 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="input-group">
      <label>Administered Medication 1 Code</label>
      <input type="text" id="adminMed1Code" value="42946">
    </div>

    <div class="input-group">
      <label>Administered Medication 1 Name</label>
      <input type="text" id="adminMed1Name" value="Folic acid">
    </div>

    <div class="input-group">
      <label>Administration ID 1</label>
      <input type="text" id="adminMed1Id" value="MED-2024-001">
    </div>

    <div class="input-group">
      <label>Administration Status 1</label>
      <select id="adminMed1Status">
        <option value="completed">Completed</option>
        <option value="active">Active</option>
        <option value="suspended">Suspended</option>
        <option value="aborted">Aborted</option>
      </select>
    </div>

    <div class="input-group">
      <label>Administration Time 1 (YYYYMMDDHHMMSS)</label>
      <input type="text" id="adminMed1Time" value="20240615120000">
    </div>

    <div class="input-group">
      <label>Route 1</label>
      <select id="adminMed1Route">
        <option value="PO">Oral</option>
        <option value="IV">Intravenous</option>
        <option value="IM">Intramuscular</option>
        <option value="SC">Subcutaneous</option>
        <option value="SL">Sublingual</option>
        <option value="TOP">Topical</option>
        <option value="INH">Inhalation</option>
      </select>
    </div>

    <!-- ‚Äî NEW dose widgets ‚Äî -->
    <div class="input-group">
      <label>Dose 1 ‚Ä¢ Amount</label>
      <input type="number" step="0.01" id="adminMed1DoseValue" value="0.4">
    </div>

    <div class="input-group">
      <label>Dose 1 ‚Ä¢ Unit</label>
      <select id="adminMed1DoseUnit">
        <option value="mg">mg</option>
        <option value="mcg">mcg</option>
        <option value="g">g</option>
        <option value="mL">mL</option>
        <option value="1">each / tablet</option>
      </select>
    </div>

    <div class="input-group">
      <label>Dose 1 ‚Ä¢ Volume (opt)</label>
      <input type="number" step="0.01" id="adminMed1VolValue" placeholder="0.5">
    </div>

    <div class="input-group">
      <label>Vol ‚Ä¢ Unit</label>
      <select id="adminMed1VolUnit">
        <option value=""></option>
        <option value="mL">mL</option>
        <option value="L">L</option>
      </select>
    </div>

    <div class="input-group">
      <label><input type="checkbox" id="adminMed1Negated"> NOT given</label>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Administered Medication 2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="input-group">
      <label>Administered Medication 2 Code</label>
      <input type="text" id="adminMed2Code" value="161">
    </div>

    <div class="input-group">
      <label>Administered Medication 2 Name</label>
      <input type="text" id="adminMed2Name" value="Multivitamin preparation">
    </div>

    <div class="input-group">
      <label>Administration ID 2</label>
      <input type="text" id="adminMed2Id" value="MED-2024-002">
    </div>

    <div class="input-group">
      <label>Administration Status 2</label>
      <select id="adminMed2Status">
        <option value="completed">Completed</option>
        <option value="active">Active</option>
        <option value="suspended">Suspended</option>
        <option value="aborted">Aborted</option>
      </select>
    </div>

    <div class="input-group">
      <label>Administration Time 2 (YYYYMMDDHHMMSS)</label>
      <input type="text" id="adminMed2Time" value="20240615130000">
    </div>

    <div class="input-group">
      <label>Route 2</label>
      <select id="adminMed2Route">
        <option value="PO">Oral</option>
        <option value="IV">Intravenous</option>
        <option value="IM">Intramuscular</option>
        <option value="SC">Subcutaneous</option>
        <option value="SL">Sublingual</option>
        <option value="TOP">Topical</option>
        <option value="INH">Inhalation</option>
      </select>
    </div>

    <!-- ‚Äî NEW dose widgets ‚Äî -->
    <div class="input-group">
      <label>Dose 2 ‚Ä¢ Amount</label>
      <input type="number" step="0.01" id="adminMed2DoseValue" value="1">
    </div>

    <div class="input-group">
      <label>Dose 2 ‚Ä¢ Unit</label>
      <select id="adminMed2DoseUnit">
        <option value="mg">mg</option>
        <option value="mcg">mcg</option>
        <option value="g">g</option>
        <option value="mL">mL</option>
        <option value="1" selected>each / tablet</option>
      </select>
    </div>

    <div class="input-group">
      <label>Dose 2 ‚Ä¢ Volume (opt)</label>
      <input type="number" step="0.01" id="adminMed2VolValue" placeholder="">
    </div>

    <div class="input-group">
      <label>Vol ‚Ä¢ Unit</label>
      <select id="adminMed2VolUnit">
        <option value=""></option>
        <option value="mL">mL</option>
        <option value="L">L</option>
      </select>
    </div>

    <div class="input-group">
      <label><input type="checkbox" id="adminMed2Negated"> NOT given</label>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Planned Medication (unchanged) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="input-group">
      <label>Planned Medication 1 Code</label>
      <input type="text" id="plannedMed1Code" value="161">
    </div>

    <div class="input-group">
      <label>Planned Medication 1 Name</label>
      <input type="text" id="plannedMed1Name" value="Multivitamin with iron">
    </div>

    <div class="input-group">
      <label>Planned Medication 1 Instructions</label>
      <textarea id="plannedMed1Instructions">
Take 1 tablet daily with food for nutritional support during neural tube defect management
      </textarea>
    </div>

  </div>
</div>
<!-- ‚ñë‚ñë‚ñë=============================================================== -->


        <div class="section">
            <h2 class="section-title">Immunizations</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Immunization 1 Status</label>
                    <select id="immunization1Status">
                        <option value="completed" selected>Completed</option>
                        <option value="not-done">Not Done</option>
                        <option value="refused">Refused</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Immunization 1 ID</label>
                    <input type="text" id="immunization1Id" placeholder="e.g., IMM-001" value="HepB-NB-001">
                </div>
                <div class="input-group">
                    <label>Immunization 1 Date (YYYYMMDD)</label>
                    <input type="text" id="immunization1Date" placeholder="e.g., 20250201" value="20240615">
                </div>
                <div class="input-group">
                    <label>Vaccine 1 Code</label>
                    <input type="text" id="vaccine1Code" placeholder="e.g., 207" value="08">
                </div>
                <div class="input-group">
                    <label>Vaccine 1 Name</label>
                    <input type="text" id="vaccine1Name" placeholder="e.g., COVID-19 mRNA vaccine" value="Hepatitis B vaccine, pediatric or pediatric/adolescent dosage">
                </div>
                <div class="input-group">
                    <label>Dose Quantity 1</label>
                    <input type="text" id="vaccine1Dose" placeholder="e.g., 0.3 mL" value="0.5 mL">
                </div>
                <div class="input-group">
                    <label>Route 1</label>
                    <select id="vaccine1Route">
                        <option value="IM" selected>Intramuscular</option>
                        <option value="SC">Subcutaneous</option>
                        <option value="ID">Intradermal</option>
                        <option value="PO">Oral</option>
                        <option value="IN">Intranasal</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Manufacturer 1</label>
                    <input type="text" id="vaccine1Manufacturer" placeholder="e.g., Pfizer-BioNTech" value="Merck Co, Inc.">
                </div>
                <div class="input-group">
                    <label>Immunization 2 Status</label>
                    <select id="immunization2Status">
                        <option value="completed" selected>Completed</option>
                        <option value="not-done">Not Done</option>
                        <option value="refused">Refused</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Immunization 2 ID</label>
                    <input type="text" id="immunization2Id" placeholder="e.g., IMM-002" value="VitK-NB-001">
                </div>
                <div class="input-group">
                    <label>Immunization 2 Date (YYYYMMDD)</label>
                    <input type="text" id="immunization2Date" placeholder="e.g., 20250101" value="20240615">
                </div>
                <div class="input-group">
                    <label>Vaccine 2 Code</label>
                    <input type="text" id="vaccine2Code" placeholder="e.g., 141" value="87567">
                </div>
                <div class="input-group">
                    <label>Vaccine 2 Name</label>
                    <input type="text" id="vaccine2Name" placeholder="e.g., Influenza vaccine" value="Vitamin K1 injection (phytonadione)">
                </div>
                <div class="input-group">
                    <label>Dose Quantity 2</label>
                    <input type="text" id="vaccine2Dose" placeholder="e.g., 0.5 mL" value="1 mg (0.5 mL)">
                </div>
                <div class="input-group">
                    <label>Route 2</label>
                    <select id="vaccine2Route">
                        <option value="IM" selected>Intramuscular</option>
                        <option value="SC">Subcutaneous</option>
                        <option value="ID">Intradermal</option>
                        <option value="PO">Oral</option>
                        <option value="IN">Intranasal</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Manufacturer 2</label>
                    <input type="text" id="vaccine2Manufacturer" placeholder="e.g., Sanofi Pasteur" value="Hospira Inc.">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Pregnancy Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Pregnancy Status</label>
                    <select id="pregnancyStatus">
                        <option value="77386006">Pregnant</option>
                        <option value="60001007" selected>Not pregnant</option>
                        <option value="102874004">Possible pregnancy</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Pregnancy Effective Time (YYYYMMDD)</label>
                    <input type="text" id="pregnancyEffectiveTime" placeholder="Date of assessment" value="20240615">
                </div>
                <div class="input-group">
                    <label>Estimated Delivery Date (YYYYMMDD)</label>
                    <input type="text" id="estimatedDeliveryDate" placeholder="Expected delivery date" value="20240615">
                </div>
                <div class="input-group">
                    <label>Pregnancy Determination Method</label>
                    <select id="pregnancyDeterminationMethod">
                        <option value="169560004">Urine pregnancy test</option>
                        <option value="167252002">Serum pregnancy test</option>
                        <option value="12611008" selected>Ultrasound examination</option>
                        <option value="271900007">Patient reported</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Gestational Age (weeks)</label>
                    <input type="text" id="gestationalAge" placeholder="e.g., 12" value="39">
                </div>
                <div class="input-group">
                    <label>Last Menstrual Period (YYYYMMDD)</label>
                    <input type="text" id="lastMenstrualPeriod" placeholder="Date of LMP" value="20230906">
                </div>
                <div class="input-group">
                    <label>Pregnancy Outcome</label>
                    <select id="pregnancyOutcome">
                        <option value="281050002" selected>Live birth</option>
                        <option value="237364002">Stillbirth</option>
                        <option value="17369002">Miscarriage</option>
                        <option value="69422002">Elective termination</option>
                        <option value="N/A">Not applicable</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Postpartum Status</label>
                    <select id="postpartumStatus">
                        <option value="255410009" selected>Postpartum</option>
                        <option value="255409004">Not postpartum</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Travel History</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Travel Start Date (YYYYMMDD)</label>
                    <input type="text" id="travelStartDate" value="20240515">
                </div>
                <div class="input-group">
                    <label>Travel End Date (YYYYMMDD)</label>
                    <input type="text" id="travelEndDate" value="20240520">
                </div>
                <div class="input-group">
                    <label>Travel Location</label>
                    <input type="text" id="travelLocation" value="Chicago, Illinois">
                </div>
                <div class="input-group">
                    <label>Travel Location Code</label>
                    <input type="text" id="travelLocationCode" value="IL">
                </div>
                <div class="input-group">
                    <label>Travel Address</label>
                    <input type="text" id="travelAddress" value="123 Oak Street, Springfield, IL 62701">
                </div>
                <div class="input-group">
                    <label>Purpose of Travel</label>
                    <select id="purposeOfTravel">
                        <option value="224930009">Business</option>
                        <option value="289049007" selected>Leisure</option>
                        <option value="385731004">Medical</option>
                        <option value="224930009">Educational</option>
                        <option value="O">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Transportation Type</label>
                    <select id="transportationType">
                        <option value="73957001">Air transport</option>
                        <option value="49122002" selected>Ground transport</option>
                        <option value="272125009">Water transport</option>
                        <option value="34965002">Public transport</option>
                        <option value="71783008">Private transport</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Transportation Details</label>
                    <textarea id="transportationDetails">Personal vehicle - 2022 Honda Pilot, License plate: ABC-1234</textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Occupation Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Current Occupation</label>
                    <input type="text" id="currentOccupation" value="Marketing Manager">
                </div>
                <div class="input-group">
                    <label>Usual Occupation</label>
                    <input type="text" id="usualOccupation" value="Marketing Manager">
                </div>
                <div class="input-group">
                    <label>Current Industry</label>
                    <input type="text" id="currentIndustry" value="Healthcare Services">
                </div>
                <div class="input-group">
                    <label>Usual Industry</label>
                    <input type="text" id="usualIndustry" value="Healthcare Services">
                </div>
                <div class="input-group">
                    <label>Current Job Title</label>
                    <input type="text" id="currentJobTitle" value="Senior Marketing Manager">
                </div>
                <div class="input-group">
                    <label>Current Employer Name</label>
                    <input type="text" id="currentEmployerName" value="Springfield Medical Center">
                </div>
                <div class="input-group">
                    <label>Current Employer Phone</label>
                    <input type="text" id="currentEmployerPhone" value="+1-217-555-0155">
                </div>
                <div class="input-group">
                    <label>Current Employer Address</label>
                    <input type="text" id="currentEmployerAddress" value="800 E Capitol Ave, Springfield, IL 62701">
                </div>
                <div class="input-group">
                    <label>Occupational Exposure</label>
                    <select id="occupationalExposure">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Employment Status</label>
                    <select id="employmentStatus">
                        <option value="1" selected>Employed</option>
                        <option value="2">Unemployed</option>
                        <option value="3">Not in labor force</option>
                        <option value="4">Retired</option>
                        <option value="5">Student</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Specimen Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Specimen 1 Source</label>
                    <select id="specimen1Source">
                        <option value="258500001">Nasopharyngeal swab</option>
                        <option value="461911000124106">Oropharyngeal swab</option>
                        <option value="258580003" selected>Whole blood sample</option>
                        <option value="122555007">Venous blood sample</option>
                        <option value="309051001">Body fluid sample</option>
                        <option value="119295008">Specimen obtained by aspiration</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Specimen 1 Type</label>
                    <input type="text" id="specimen1Type" placeholder="e.g., Swab" value="Whole blood">
                </div>
                <div class="input-group">
                    <label>Specimen 1 ID</label>
                    <input type="text" id="specimen1Id" placeholder="e.g., SPEC-001" value="NB-BLOOD-20240615-001">
                </div>
                <div class="input-group">
                    <label>Collection Date 1 (YYYYMMDDHHMMSS)</label>
                    <input type="text" id="collection1Date" placeholder="e.g., 20250216110000" value="20240615083000">
                </div>
                <div class="input-group">
                    <label>Specimen 2 Source</label>
                    <select id="specimen2Source">
                        <option value="258500001">Nasopharyngeal swab</option>
                        <option value="461911000124106">Oropharyngeal swab</option>
                        <option value="258580003">Whole blood sample</option>
                        <option value="122555007">Venous blood sample</option>
                        <option value="309051001" selected>Body fluid sample</option>
                        <option value="119295008">Specimen obtained by aspiration</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Specimen 2 Type</label>
                    <input type="text" id="specimen2Type" placeholder="e.g., Blood" value="Cerebrospinal fluid">
                </div>
                <div class="input-group">
                    <label>Specimen 2 ID</label>
                    <input type="text" id="specimen2Id" placeholder="e.g., SPEC-002" value="NB-CSF-20240615-001">
                </div>
                <div class="input-group">
                    <label>Collection Date 2 (YYYYMMDDHHMMSS)</label>
                    <input type="text" id="collection2Date" placeholder="e.g., 20250216120000" value="20240615093000">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Additional Clinical Data</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Temperature (¬∞F)</label>
                    <input type="text" id="temperature" placeholder="e.g., 98.6" value="97.8">
                </div>
                <div class="input-group">
                    <label>Blood Pressure (mmHg)</label>
                    <input type="text" id="bloodPressure" placeholder="e.g., 120/80" value="65/42">
                </div>
                <div class="input-group">
                    <label>Heart Rate (bpm)</label>
                    <input type="text" id="heartRate" placeholder="e.g., 72" value="145">
                </div>
                <div class="input-group">
                    <label>Respiratory Rate (breaths/min)</label>
                    <input type="text" id="respiratoryRate" placeholder="e.g., 16" value="38">
                </div>
                <div class="input-group">
                    <label>Oxygen Saturation (%)</label>
                    <input type="text" id="oxygenSaturation" placeholder="e.g., 98" value="97">
                </div>
                <div class="input-group">
                    <label>Weight (lbs)</label>
                    <input type="text" id="weight" placeholder="e.g., 150" value="6.2">
                </div>
                <div class="input-group">
                    <label>Height (inches)</label>
                    <input type="text" id="height" placeholder="e.g., 68" value="19.5">
                </div>
                <div class="input-group">
                    <label>BMI</label>
                    <input type="text" id="bmi" placeholder="e.g., 22.8" value="13.2">
                </div>
                <div class="input-group">
                    <label>Therapeutic Response</label>
                    <select id="therapeuticResponse">
                        <option value="182840001" selected>Good response</option>
                        <option value="182841002">Poor response</option>
                        <option value="182842009">No response</option>
                        <option value="182843004">Partial response</option>
                        <option value="385655000">Not applicable</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Homeless Status</label>
                    <select id="homelessStatus">
                        <option value="105526001">Homeless</option>
                        <option value="105529008" selected>Not homeless</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Congregate Living</label>
                    <select id="congregateLiving">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Congregate Living Type</label>
                    <select id="congregateLivingType">
                        <option value="224683003">Nursing home</option>
                        <option value="42665001">School</option>
                        <option value="264362003">Prison</option>
                        <option value="257656006">Dormitory</option>
                        <option value="224891009">Shelter</option>
                        <option value="O" selected>Other</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Procedures</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Current Procedure 1 Code</label>
                    <input type="text" id="currentProc1Code" placeholder="e.g., 33747-0" value="80146002">
                </div>
                <div class="input-group">
                    <label>Current Procedure 1 Name</label>
                    <input type="text" id="currentProc1Name" placeholder="e.g., Bronchoscopy" value="Excision of spinal lesion">
                </div>
                <div class="input-group">
                    <label>Current Procedure 1 Date (YYYYMMDD)</label>
                    <input type="text" id="currentProc1Date" placeholder="e.g., 20250216" value="20240615">
                </div>
                <div class="input-group">
                    <label>Current Procedure 1 Type</label>
                    <select id="currentProc1Type">
                        <option value="act">Act</option>
                        <option value="observation">Observation</option>
                        <option value="procedure" selected>Procedure</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Current Procedure 2 Code</label>
                    <input type="text" id="currentProc2Code" placeholder="e.g., 71388002" value="241615005">
                </div>
                <div class="input-group">
                    <label>Current Procedure 2 Name</label>
                    <input type="text" id="currentProc2Name" placeholder="e.g., Chest X-ray" value="Magnetic resonance imaging of spine">
                </div>
                <div class="input-group">
                    <label>Current Procedure 2 Date (YYYYMMDD)</label>
                    <input type="text" id="currentProc2Date" placeholder="e.g., 20250216" value="20240615">
                </div>
                <div class="input-group">
                    <label>Current Procedure 2 Type</label>
                    <select id="currentProc2Type">
                        <option value="act">Act</option>
                        <option value="observation" selected>Observation</option>
                        <option value="procedure">Procedure</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Trigger Procedure 1 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="triggerProc1Code" placeholder="e.g., 168731009" onblur="validateTriggerCode('triggerProc1Code')" value="230690007">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('triggerProc1Code')">üîç</button>
                    </div>
                    <div id="triggerProc1Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Trigger Procedure 1 Name</label>
                    <input type="text" id="triggerProc1Name" placeholder="e.g., Intubation" value="Stroke">
                </div>
                <div class="input-group">
                    <label>Trigger Procedure 1 Date (YYYYMMDD)</label>
                    <input type="text" id="triggerProc1Date" placeholder="e.g., 20250216" value="20240615">
                </div>
                <div class="input-group">
                    <label>Trigger Procedure 1 Type</label>
                    <select id="triggerProc1Type">
                        <option value="act">Act</option>
                        <option value="observation" selected>Observation</option>
                        <option value="procedure">Procedure</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Planned Procedure 1 Code</label>
                    <input type="text" id="plannedProc1Code" placeholder="e.g., 182836005" value="182836005">
                </div>
                <div class="input-group">
                    <label>Planned Procedure 1 Name</label>
                    <input type="text" id="plannedProc1Name" placeholder="e.g., Follow-up CT scan" value="Neurosurgical follow-up">
                </div>
                <div class="input-group">
                    <label>Planned Procedure 1 Date (YYYYMMDD)</label>
                    <input type="text" id="plannedProc1Date" placeholder="e.g., 20250220" value="20240715">
                </div>
                <div class="input-group">
                    <label>Planned Procedure 1 Type</label>
                    <select id="plannedProc1Type">
                        <option value="act" selected>Act</option>
                        <option value="observation">Observation</option>
                        <option value="procedure">Procedure</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Special Populations and Demographics</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Disability Status</label>
                    <select id="disabilityStatus">
                        <option value="21134002" selected>Disabled</option>
                        <option value="405159006">Not disabled</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Disability Type</label>
                    <input type="text" id="disabilityType" value="Spina bifida - congenital neural tube defect">
                </div>
                <div class="input-group">
                    <label>Tribal Affiliation</label>
                    <input type="text" id="tribalAffiliation" value="Not applicable">
                </div>
                <div class="input-group">
                    <label>Tribal Enrollment</label>
                    <select id="tribalEnrollment">
                        <option value="true">Yes</option>
                        <option value="false" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Country of Nationality</label>
                    <input type="text" id="countryOfNationality" value="United States">
                </div>
                <div class="input-group">
                    <label>Country of Nationality Code</label>
                    <input type="text" id="countryOfNationalityCode" value="US">
                </div>
                <div class="input-group">
                    <label>Country of Residence</label>
                    <input type="text" id="countryOfResidence" value="United States">
                </div>
                <div class="input-group">
                    <label>Country of Residence Code</label>
                    <input type="text" id="countryOfResidenceCode" value="US">
                </div>
                <div class="input-group">
                    <label>Immigration Status</label>
                    <select id="immigrationStatus">
                        <option value="160542002" selected>US Citizen</option>
                        <option value="160540005">Permanent Resident</option>
                        <option value="160541006">Temporary Resident</option>
                        <option value="160543007">Undocumented</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Preferred Language</label>
                    <input type="text" id="preferredLanguage" value="English">
                </div>
                <div class="input-group">
                    <label>Interpreter Needed</label>
                    <select id="interpreterNeeded">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Insurance Status</label>
                    <select id="insuranceStatus">
                        <option value="48758009" selected>Insured</option>
                        <option value="182890002">Uninsured</option>
                        <option value="182891003">Self-pay</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Emergency and Public Health</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Emergency Outbreak Information</label>
                    <select id="emergencyOutbreakInfo">
                        <option value="443684005">Disease outbreak</option>
                        <option value="410546004">Public health emergency</option>
                        <option value="N/A" selected>Not applicable</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Outbreak Details</label>
                    <textarea id="outbreakDetails">No current outbreak or emergency situation related to this case</textarea>
                </div>
                <div class="input-group">
                    <label>Exposure/Contact Information</label>
                    <select id="exposureContactInfo">
                        <option value="24932003">Exposed</option>
                        <option value="84100007">Contact</option>
                        <option value="373068000" selected>No exposure</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Exposure Type</label>
                    <select id="exposureType">
                        <option value="409822003">Direct contact</option>
                        <option value="417746004">Airborne</option>
                        <option value="418038007">Droplet</option>
                        <option value="447964005">Contact precaution</option>
                        <option value="OTH" selected>Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Exposure Location</label>
                    <input type="text" id="exposureLocation" value="Not applicable - congenital condition">
                </div>
                <div class="input-group">
                    <label>Exposure Date (YYYYMMDD)</label>
                    <input type="text" id="exposureDate" value="Not applicable">
                </div>
                <div class="input-group">
                    <label>Contact Person Name</label>
                    <input type="text" id="contactPersonName" value="Dr. Patricia Williams, MD">
                </div>
                <div class="input-group">
                    <label>Contact Person Phone</label>
                    <input type="text" id="contactPersonPhone" value="+1-217-555-0199">
                </div>
                <div class="input-group">
                    <label>Vaccine Credential Patient Assertion</label>
                    <select id="vaccineCredentialAssertion">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Vaccine Card Available</label>
                    <select id="vaccineCardAvailable">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Quarantine Status</label>
                    <select id="quarantineStatus">
                        <option value="182856006">In quarantine</option>
                        <option value="182857002">Released from quarantine</option>
                        <option value="405178008" selected>Not in quarantine</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Isolation Status</label>
                    <select id="isolationStatus">
                        <option value="40174006">In isolation</option>
                        <option value="182840001">Released from isolation</option>
                        <option value="385432009" selected>Not in isolation</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Document Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Document ID</label>
                    <input type="text" id="documentId" value="10c13861-86a8-4a9a-aec6-b615921178df">
                </div>
                <div class="input-group">
                    <label>Effective Time</label>
                    <input type="text" id="effectiveTime" value="20240615150000-0500">
                </div>
                <div class="input-group">
                    <label>Set ID</label>
                    <input type="text" id="setId" value="8d86218e-0fea-11eb-8216-a80388425cfb">
                </div>
                <div class="input-group">
                    <label>Version Number</label>
                    <input type="text" id="versionNumber" value="3">
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global RCTC data storage
        let rctcData = {
            diagnosis: [],
            labOrder: [],
            labObs: [],
            medications: [],
            organism: [],
            metadata: {
                oid: '2.16.840.1.113762.1.4.1146.2260', // RCTC Birth Defect Trigger Codes OID
                version: '2.0.1',
                effectiveDate: '2025-06-01',
                releaseDate: '2025-03-18'
            }
        };

        function getFormData() {
            const fields = [
                // Patient Demographics
                'patientId', 'patientName', 'patientPhone', 'patientEmail', 'patientAddress',
                'patientCity', 'patientState', 'patientZip', 'patientCounty', 'patientCountry',
                'patientGender', 'patientBirthDate', 'patientRace', 'patientEthnicity',
                'patientBirthPlace', 'patientBirthSex', 'patientGenderIdentity', 'patientDetailedRace',
                'patientDetailedEthnicity', 'patientLanguage', 'patientDeathIndicator', 'patientDeathDate',
                
                // Guardian Information
                'guardianName', 'guardianPhone', 'guardianEmail', 'guardianAddress', 'guardianCity',
                'guardianState', 'guardianZip', 'guardianCode',
                
                // Provider Information
                'providerId', 'providerName', 'providerPhone', 'providerEmail', 'providerFax',
                'facilityId', 'facilityName', 'facilityAddress', 'facilityTypeCode',
                'organizationName', 'organizationId', 'organizationPhone', 'organizationEmail',
                'organizationFax', 'organizationAddress',
                
                // Encounter Information
                'encounterId', 'encounterType', 'encounterDate', 'encounterEndDate', 'encounterDisposition',
                'chiefComplaint', 'presentIllness', 'reasonForVisit', 'pastMedicalHistory', 'reviewOfSystems',
                
                // Diagnoses
                'diagnosis1Code', 'diagnosis1Name', 'diagnosis2Code', 'diagnosis2Name', 'diagnosis3Code', 'diagnosis3Name',
                'diagnosis1Date', 'diagnosis1OnsetDate', 'diagnosis2Date', 'diagnosis2OnsetDate',
                'diagnosis3Date', 'diagnosis3OnsetDate', 'problemType', 'symptoms',
                
                // Laboratory Tests
                'labTest1Code', 'labTest1Name', 'labTest1Result', 'labTest2Code', 'labTest2Name', 'labTest2Result',
                'labOrder1Code', 'labOrder1Id', 'labOrder1Time', 'labTest1Status', 'labTest1Time',
                'labTest1Interpretation', 'labTest1ReferenceRange', 'labTest2Status', 'labTest2Time',
                'labTest2Interpretation', 'labTest2ReferenceRange',
                
                // Medications
'adminMed1Code', 'adminMed1Name', 'adminMed1Id', 'adminMed1Status', 'adminMed1Time',
'adminMed1Route',
'adminMed1DoseValue', 'adminMed1DoseUnit', 'adminMed1VolValue', 'adminMed1VolUnit', 'adminMed1Negated',

'adminMed2Code', 'adminMed2Name', 'adminMed2Id', 'adminMed2Status', 'adminMed2Time',
'adminMed2Route',
'adminMed2DoseValue', 'adminMed2DoseUnit', 'adminMed2VolValue', 'adminMed2VolUnit', 'adminMed2Negated',

// Planned medication stays as-is
'plannedMed1Code', 'plannedMed1Name', 'plannedMed1Instructions',

                
                // Immunizations
                'immunization1Status', 'immunization1Id', 'immunization1Date', 'vaccine1Code', 'vaccine1Name',
                'vaccine1Dose', 'vaccine1Route', 'vaccine1Manufacturer', 'immunization2Status', 'immunization2Id',
                'immunization2Date', 'vaccine2Code', 'vaccine2Name', 'vaccine2Dose', 'vaccine2Route', 'vaccine2Manufacturer',
                
                // Pregnancy Information
                'pregnancyStatus', 'pregnancyEffectiveTime', 'estimatedDeliveryDate', 'pregnancyDeterminationMethod',
                'gestationalAge', 'lastMenstrualPeriod', 'pregnancyOutcome', 'postpartumStatus',
                
                // Travel History
                'travelStartDate', 'travelEndDate', 'travelLocation', 'travelLocationCode', 'travelAddress',
                'purposeOfTravel', 'transportationType', 'transportationDetails',
                
                // Occupation Information
                'currentOccupation', 'usualOccupation', 'currentIndustry', 'usualIndustry', 'currentJobTitle',
                'currentEmployerName', 'currentEmployerPhone', 'currentEmployerAddress', 'occupationalExposure', 'employmentStatus',
                
                // Specimen Information
                'specimen1Source', 'specimen1Type', 'specimen1Id', 'collection1Date',
                'specimen2Source', 'specimen2Type', 'specimen2Id', 'collection2Date',
                
                // Additional Clinical Data
                'temperature', 'bloodPressure', 'heartRate', 'respiratoryRate', 'oxygenSaturation',
                'weight', 'height', 'bmi', 'therapeuticResponse', 'homelessStatus', 'congregateLiving', 'congregateLivingType',
                
                // Procedures
                'currentProc1Code', 'currentProc1Name', 'currentProc1Date', 'currentProc1Type',
                'currentProc2Code', 'currentProc2Name', 'currentProc2Date', 'currentProc2Type',
                'triggerProc1Code', 'triggerProc1Name', 'triggerProc1Date', 'triggerProc1Type',
                'plannedProc1Code', 'plannedProc1Name', 'plannedProc1Date', 'plannedProc1Type',
                
                // Special Populations and Demographics
                'disabilityStatus', 'disabilityType', 'tribalAffiliation', 'tribalEnrollment',
                'countryOfNationality', 'countryOfNationalityCode', 'countryOfResidence', 'countryOfResidenceCode',
                'immigrationStatus', 'preferredLanguage', 'interpreterNeeded', 'insuranceStatus',
                
                // Emergency and Public Health
                'emergencyOutbreakInfo', 'outbreakDetails', 'exposureContactInfo', 'exposureType',
                'exposureLocation', 'exposureDate', 'contactPersonName', 'contactPersonPhone',
                'vaccineCredentialAssertion', 'vaccineCardAvailable', 'quarantineStatus', 'isolationStatus',
                
                // Document Information
                'documentId', 'effectiveTime', 'setId', 'versionNumber'
            ];
            
            const data = {};
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    data[field] = element.value;
                }
            });
            return data;
        }

        function setFormData(data) {
            Object.keys(data).forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.value = data[field];
                }
            });
        }

        function loadRCTCFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = handleRCTCFile;
            input.click();
        }

        function handleRCTCFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            alert('RCTC file processing would require additional libraries in a real implementation. For now, the generator uses hardcoded RCTC OID and version information.');
            
            console.log('RCTC file selected:', file.name);
        }

        function searchRCTCCodes(fieldId) {
            const resultsDiv = document.getElementById(fieldId + '_results');
            
            // Sample RCTC codes for demonstration
            const sampleCodes = [
                { code: '840539006', display: 'Disease caused by severe acute respiratory syndrome coronavirus 2 (disorder)', system: 'SNOMED-CT' },
                { code: '719865001', display: 'Influenza A virus infection (disorder)', system: 'SNOMED-CT' },
                { code: '3928002', display: 'Zika virus disease (disorder)', system: 'SNOMED-CT' },
                { code: '94310-0', display: 'SARS-like Coronavirus N gene [Presence] in Unspecified specimen by NAA with probe detection', system: 'LOINC' },
                { code: '34487-9', display: 'Influenza virus A RNA [Presence] in Respiratory specimen by NAA with probe detection', system: 'LOINC' },
                { code: '168731009', display: 'Intubation procedure', system: 'SNOMED-CT' },
                { code: '71388002', display: 'Radiographic procedure', system: 'SNOMED-CT' },
                { code: '33747-0', display: 'General procedure code', system: 'LOINC' },
                // Birth Defect RCTC Trigger Codes - RCTC Release 20250318.xlsx
                { code: '41040004', display: 'Complete trisomy 21 syndrome (disorder)', system: 'SNOMED-CT' },
                { code: '72951007', display: 'Gastroschisis (disorder)', system: 'SNOMED-CT' },
                { code: '67531005', display: 'Spina bifida (disorder)', system: 'SNOMED-CT' },
                { code: '86299006', display: 'Tetralogy of Fallot (disorder)', system: 'SNOMED-CT' },
                { code: '414819007', display: 'Neonatal abstinence syndrome (disorder)', system: 'SNOMED-CT' }
            ];

            resultsDiv.innerHTML = '';
            sampleCodes.forEach(item => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `<strong>${item.code}</strong> (${item.system})<br><small>${item.display}</small>`;
                div.onclick = () => {
                    document.getElementById(fieldId).value = item.code;
                    const nameField = fieldId.replace('Code', 'Name');
                    const nameElement = document.getElementById(nameField);
                    if (nameElement) {
                        nameElement.value = item.display;
                    }
                    resultsDiv.style.display = 'none';
                };
                resultsDiv.appendChild(div);
            });
            
            resultsDiv.style.display = 'block';
        }

        function validateTriggerCode(fieldId) {
            const code = document.getElementById(fieldId).value;
            const triggerCodes = ['840539006', '719865001', '3928002', '94310-0', '34487-9', '168731009',
                                 '41040004', '72951007', '67531005', '86299006', '414819007'];
            
            if (code && !triggerCodes.includes(code)) {
                console.log('Warning: Code', code, 'may not be a valid RCTC trigger code');
            }
        }

        function getRaceDisplayName(raceCode) {
            const raceCodes = {
                '1002-5': 'American Indian or Alaska Native',
                '2028-9': 'Asian',
                '2054-5': 'Black or African American',
                '2076-8': 'Native Hawaiian or Other Pacific Islander',
                '2106-3': 'White',
                '2131-1': 'Other Race',
                'UNK': 'Unknown',
                'ASKU': 'Asked but unknown'
            };
            return raceCodes[raceCode] || 'Race';
        }

        function getEthnicityDisplayName(ethnicityCode) {
            const ethnicityCodes = {
                '2135-2': 'Hispanic or Latino',
                '2186-5': 'Not Hispanic or Latino',
                'UNK': 'Unknown',
                'ASKU': 'Asked but unknown'
            };
            return ethnicityCodes[ethnicityCode] || 'Ethnicity';
        }

        function validateDateFormat(dateString, fieldName) {
            if (!dateString) return true; // Allow empty dates
            
            const datePattern = /^\d{8}$/; // YYYYMMDD
            const dateTimePattern = /^\d{14}$/; // YYYYMMDDHHMMSS
            
            if (!datePattern.test(dateString) && !dateTimePattern.test(dateString)) {
                alert(`${fieldName} must be in YYYYMMDD or YYYYMMDDHHMMSS format`);
                return false;
            }
            
            // Additional date validation can be added here
            return true;
        }

        function validateRequiredFields() {
            const requiredFields = [
                { id: 'patientId', name: 'Patient ID' },
                { id: 'patientName', name: 'Patient Name' },
                { id: 'patientBirthDate', name: 'Patient Birth Date' },
                { id: 'providerId', name: 'Provider ID' },
                { id: 'providerName', name: 'Provider Name' },
                { id: 'encounterId', name: 'Encounter ID' },
                { id: 'encounterDate', name: 'Encounter Date' },
                { id: 'documentId', name: 'Document ID' },
                { id: 'effectiveTime', name: 'Effective Time' }
            ];
            
            for (let field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    alert(`${field.name} is required`);
                    element?.focus();
                    return false;
                }
            }
            return true;
        }

        function validateFormData() {
            if (!validateRequiredFields()) {
                return false;
            }
            
            // Validate date formats
            const dateFields = [
                { id: 'patientBirthDate', name: 'Patient Birth Date' },
                { id: 'encounterDate', name: 'Encounter Date' },
                { id: 'encounterEndDate', name: 'Encounter End Date' },
                { id: 'travelStartDate', name: 'Travel Start Date' },
                { id: 'travelEndDate', name: 'Travel End Date' }
            ];
            
            for (let field of dateFields) {
                const element = document.getElementById(field.id);
                if (element && !validateDateFormat(element.value, field.name)) {
                    element.focus();
                    return false;
                }
            }
            
            return true;
        }

        // Helper functions for CDA generation

// Helper functions for CDA generation
function xmlEscape(str = '') {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;');
}

function generateRR () {
  const d = getFormData();
  const x = s => xmlEscape(s || '');       // one-letter alias = escape **everything**
  const guid = () => generateGUID();

  /* =============== STATIC RR CONSTANTS =============== */
  const authorOrgOID    = '2.16.840.1.114222.4.1.217446';  // AIMS
  const custodianOrgOID = '2.16.840.1.114222.4.1.217446';  // APHL
  const rrDocOID        = guid();                          // doc ID for THIS RR
  const rrCreateTS      = new Date().toISOString()
                               .replace(/[-:T]/g,'')
                               .substring(0,14) + '-0000';

  /* =============== REPORTABLE CONDITIONS =============== */
  // Grab every diagnosis that has a code + name ‚Äì you can refine this
  // to only pull RCTC matches if desired.
  const conditions = [
    { code: d.diagnosis1Code, name: d.diagnosis1Name },
    { code: d.diagnosis2Code, name: d.diagnosis2Name },
    { code: d.diagnosis3Code, name: d.diagnosis3Name }
  ].filter(c => c.code && c.name);

  // Very simple classification: everything marked R1 (reportable)
  // Swap this for your own logic if you also emit R3 / R5 etc.
  const classify = () => 'R1';                      // R1 = ‚Äúreportable‚Äù
  const jurisdiction = () => `${x(d.patientCounty)} Health Department`;

  /* ---------- Build <text> table & machine-readable entries ---------- */
  let condRows   = '';
  let condEntries = '';

  conditions.forEach((c, idx) => {
    const resultCode = classify(c);      // e.g. R1, R3 ‚Ä¶
    const entryId    = guid();

    /* human-readable table row */
    condRows += `
      <tr>
        <td>${x(c.name)}</td>
        <td>${x(c.code)}</td>
        <td>${resultCode}</td>
        <td>${jurisdiction()}</td>
      </tr>`;

    /* machine-readable observation (Reportability Result Observation) */
    condEntries += `
      <entry>
        <observation classCode="OBS" moodCode="EVN">
          <!-- Reportability Result Observation (RR-O) -->
          <templateId root="2.16.840.1.113883.10.20.15.2.3.8" extension="2017-04-01"/>
          <id root="${entryId}"/>
          <code code="RR" codeSystem="2.16.840.1.114222.4.5.274"
                displayName="Reportability Result"/>
          <statusCode code="completed"/>
          <effectiveTime value="${rrCreateTS}"/>
          <value xsi:type="CD"
                 code="${resultCode}"
                 codeSystem="2.16.840.1.114222.4.5.232"
                 displayName="${resultCode === 'R1' ? 'Reportable' : 'Not Reportable'}"/>
          <entryRelationship typeCode="SUBJ">
            <observation classCode="OBS" moodCode="EVN">
              <!-- Condition that triggered the rule -->
              <templateId root="2.16.840.1.113883.10.20.15.2.3.3"/>
              <id root="${guid()}"/>
              <code code="75323-6" codeSystem="2.16.840.1.113883.6.1"
                    displayName="Condition"/>
              <statusCode code="completed"/>
              <value xsi:type="CD"
                     code="${x(c.code)}"
                     codeSystem="2.16.840.1.113883.6.96"
                     displayName="${x(c.name)}"/>
            </observation>
          </entryRelationship>
          <participant typeCode="DST">
            <participantRole classCode="AGNT">
              <addr><state>${x(d.patientState)}</state></addr>
              <playingEntity classCode="PLC">
                <name>${jurisdiction()}</name>
              </playingEntity>
            </participantRole>
          </participant>
        </observation>
      </entry>`;
  });

  /* =============== THE RR XML =============== */
  return `<?xml version="1.0" encoding="UTF-8"?>
<ClinicalDocument xmlns="urn:hl7-org:v3" xmlns:sdtc="urn:hl7-org:sdtc"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!-- ---------------- HEADER ---------------- -->
  <realmCode code="US"/>
  <typeId root="2.16.840.1.113883.1.3" extension="POCD_HD000040"/>
  <templateId root="2.16.840.1.113883.10.20.15.2.1.2" extension="2017-04-01"/>
  <id root="${rrDocOID}"/>
  <code code="88085-6" codeSystem="2.16.840.1.113883.6.1"
        displayName="Reportability response report Document Public health"/>
  <title>Reportability Response</title>
  <effectiveTime value="${rrCreateTS}"/>
  <confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25"/>
  <languageCode code="en-US"/>

  <!-- ---------------- PATIENT ---------------- -->
  <recordTarget>
    <patientRole>
      <id extension="${x(d.patientId)}" root="2.16.840.1.113883.19.5"/>
      <addr use="H">
        <streetAddressLine>${x(d.patientAddress)}</streetAddressLine>
        <city>${x(d.patientCity)}</city><state>${x(d.patientState)}</state>
        <postalCode>${x(d.patientZip)}</postalCode>
        <country>${x(d.patientCountry) || 'US'}</country>
      </addr>
      <telecom value="tel:${x(d.patientPhone)}" use="MC"/>
      <patient>
        <name use="L">
          <given>${x((d.patientName||' ').split(' ')[0])}</given>
          <family>${x((d.patientName||' ').split(' ').slice(1).join(' '))}</family>
        </name>
        <administrativeGenderCode code="${x(d.patientGender)}"
                                  codeSystem="2.16.840.1.113883.5.1"/>
        <birthTime value="${x(d.patientBirthDate)}"/>
      </patient>
    </patientRole>
  </recordTarget>

  <!-- ---------------- AUTHOR (AIMS) ---------------- -->
  <author>
    <time value="${rrCreateTS}"/>
    <assignedAuthor>
      <id root="${authorOrgOID}"/>
      <assignedAuthoringDevice>
        <manufacturerModelName>AIMS</manufacturerModelName>
        <softwareName>AIMS</softwareName>
      </assignedAuthoringDevice>
    </assignedAuthor>
  </author>

  <!-- ---------------- CUSTODIAN (APHL) ---------------- -->
  <custodian>
    <assignedCustodian>
      <representedCustodianOrganization>
        <id root="${custodianOrgOID}"/>
        <name>APHL | Association of Public Health Laboratories</name>
      </representedCustodianOrganization>
    </assignedCustodian>
  </custodian>

  <!-- ---------------- INFO RECIPIENT (Provider) ---------------- -->
  <informationRecipient typeCode="PRCP">
    <intendedRecipient>
      <id extension="${x(d.providerId)}" root="2.16.840.1.113883.4.6"/>
      <informationRecipient>
        <name>
          <given>${x((d.providerName||' ').split(' ')[0])}</given>
          <family>${x((d.providerName||' ').split(' ').slice(1).join(' '))}</family>
        </name>
      </informationRecipient>
      <receivedOrganization><name>${x(d.facilityName)}</name></receivedOrganization>
    </intendedRecipient>
  </informationRecipient>

  <!-- ---------------- ENCOMPASSING ENCOUNTER ---------------- -->
  <componentOf>
    <encompassingEncounter>
      <id extension="${x(d.encounterId)}" root="2.16.840.1.113883.19"/>
      <effectiveTime><low value="${x(d.encounterDate)}"/></effectiveTime>
    </encompassingEncounter>
  </componentOf>

  <!-- ---------------- BODY ---------------- -->
  <component><structuredBody>

    <!-- SUBJECT section (88084-9) -->
    <component><section>
      <templateId root="2.16.840.1.113883.10.20.15.2.2.1" extension="2017-04-01"/>
      <code code="88084-9" codeSystem="2.16.840.1.113883.6.1"/>
      <text>
        <paragraph>This response indicates that public-health has processed the
        incoming eICR. <strong>${x(conditions[0]?.name || 'A condition')}</strong>
        is reportable for <em>${jurisdiction()}</em>.</paragraph>
      </text>
    </section></component>

    <!-- PROCESSING-INFO section (88082-3) -->
    <component><section>
      <templateId root="2.16.840.1.113883.10.20.15.2.2.3" extension="2017-04-01"/>
      <code code="88082-3" codeSystem="2.16.840.1.113883.6.1"/>
      <entry>
        <act classCode="ACT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.10.20.15.2.3.9" extension="2017-04-01"/>
          <code code="RR5" codeSystem="2.16.840.1.114222.4.5.232"
                 displayName="Received eICR Information"/>
          <statusCode code="completed"/>
          <reference typeCode="REFR">
            <externalDocument classCode="DOCCLIN" moodCode="EVN">
              <id root="${x(d.documentId)}"/>
              <code code="55751-2" codeSystem="2.16.840.1.113883.6.1"
                     displayName="Public Health Case Report (eICR)"/>
              <setId extension="${x(d.setId)}"
                     root="1.2.840.114350.1.13.380.3.7.1.1"/>
              <versionNumber value="${x(d.versionNumber)}"/>
            </externalDocument>
          </reference>
        </act>
      </entry>
    </section></component>

    <!-- REPORTABILITY RESULTS section (88083-1)  ‚Üê NEW -->
    <component><section>
      <templateId root="2.16.840.1.113883.10.20.15.2.2.2" extension="2017-04-01"/>
      <code code="88083-1" codeSystem="2.16.840.1.113883.6.1"/>
      <title>Reportability Results</title>
      <text>
        <table border="1">
          <thead><tr><th>Condition</th><th>Code</th><th>Classification</th><th>Jurisdiction</th></tr></thead>
          <tbody>${condRows}</tbody>
        </table>
      </text>
      ${condEntries}
    </section></component>

  </structuredBody></component>
</ClinicalDocument>`;
}



function generateAndDownloadRR() {
    try {
      const rrXml = generateRR();          // build the RR XML
      const blob  = new Blob([rrXml], {type:'application/xml'});
      const url   = URL.createObjectURL(blob);
      const a     = document.createElement('a');

      a.href      = url;
      a.download  = `RR_${getFormData().patientId}_${new Date().toISOString().split('T')[0]}.xml`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (e) {
      alert(`RR build failed: ${e.message}`);
      console.error(e);
    }
  }
        
        function generateGUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        /* ---------- Vital-signs & anthropometrics ---------- */
function generateVitalSignsEntries(data) {

  // nothing to do?
  if (
    !data.temperature && !data.bloodPressure && !data.heartRate &&
    !data.respiratoryRate && !data.oxygenSaturation &&
    !data.weight && !data.height && !data.bmi
  ) { return ''; }

  // helper so we don‚Äôt repeat the templateId stanza 8 times
  const vital = (code, display, value, unit) => `
      <component>
        <observation classCode="OBS" moodCode="EVN">
          <templateId root="2.16.840.1.113883.10.20.22.4.27"
                      extension="2014-06-09"/>
          <id root="${generateGUID()}"/>
          <code code="${code}" codeSystem="2.16.840.1.113883.6.1"
                displayName="${display}"/>
          <statusCode code="completed"/>
          <effectiveTime value="${data.encounterDate}"/>
          <value xsi:type="PQ" value="${value}" unit="${unit}"/>
        </observation>
      </component>`;

  return `
    <entry typeCode="DRIV">
      <organizer classCode="CLUSTER" moodCode="EVN">
        <templateId root="2.16.840.1.113883.10.20.22.4.26"
                    extension="2015-08-01"/>
        <id root="${generateGUID()}"/>
        <code code="46680005" codeSystem="2.16.840.1.113883.6.96"
              displayName="Vital signs"/>
        <statusCode code="completed"/>
        <effectiveTime value="${data.encounterDate}"/>

        ${data.temperature         ? vital('8310-5', 'Body temperature',          data.temperature,      '[degF]')     : ''}
        ${data.bloodPressure       ? vital('8480-6', 'Systolic blood pressure',   data.bloodPressure.split('/')[0], 'mm[Hg]') : ''}
        ${data.heartRate           ? vital('8867-4', 'Heart rate',                data.heartRate,        '/min')       : ''}
        ${data.respiratoryRate     ? vital('9279-1', 'Respiratory rate',          data.respiratoryRate,  '/min')       : ''}
        ${data.oxygenSaturation    ? vital('59408-5','Oxygen saturation (SpO‚ÇÇ)',  data.oxygenSaturation, '%')          : ''}
        ${data.weight              ? vital('3141-9', 'Body weight',               data.weight,           'kg')         : ''}
        ${data.height              ? vital('8302-2', 'Body height',               data.height,           'cm')         : ''}
        ${data.bmi                 ? vital('39156-5','Body Mass Index',           data.bmi,              'kg/m2')      : ''}

      </organizer>
    </entry>`;
}
        /* ---------- Specimen Information (up to two specimens) ---------- */
function buildSpecimenSection(d) {
  // bail if the form is blank
  if (!d.specimen1Id && !d.specimen2Id) return '';

  // ---------- human-readable rows ----------
  const rows = [];
  const addRow = (src, type, id, dt) => rows.push(
    `<tr><td>${xmlEscape(src)}</td><td>${xmlEscape(type)}</td>` +
    `<td>${xmlEscape(id)}</td><td>${xmlEscape(dt)}</td></tr>`
  );

  // ---------- machine-readable entries ----------
  const entries = [];
  const addEntry = (src, type, id, dt) => entries.push(`
    <entry typeCode="DRIV">
      <procedure classCode="PROC" moodCode="EVN">
        <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
        <id root="${generateGUID()}" />
        <code code="33747-0" codeSystem="2.16.840.1.113883.6.1" displayName="General procedure" />
        <statusCode code="completed" />
        <effectiveTime value="${xmlEscape(dt)}"/>
        <targetSiteCode displayName="${xmlEscape(src)}" codeSystem="2.16.840.1.113883.6.96" />
        <participant typeCode="PRD">
          <participantRole classCode="SPEC">
            <templateId root="2.16.840.1.113883.10.20.22.4.410" extension="2019-06-21" />
            <id root="2.16.840.1.113883.3.72.5.9.1" extension="${xmlEscape(id)}"/>
            <code displayName="${xmlEscape(type)}" codeSystem="2.16.840.1.113883.6.96"/>
          </participantRole>
        </participant>
      </procedure>
    </entry>`);

  // specimen 1
if (d.specimen1Id) {
  addRow(d.specimen1Source, d.specimen1Type, d.specimen1Id, d.collection1Date);
  addEntry(d.specimen1Source, d.specimen1Type, d.specimen1Id, d.collection1Date);
}

// specimen 2
if (d.specimen2Id) {
  addRow(d.specimen2Source, d.specimen2Type, d.specimen2Id, d.collection2Date);
  addEntry(d.specimen2Source, d.specimen2Type, d.specimen2Id, d.collection2Date);
}


  // ---------- wrap it all in a section ----------
  return `
    <component>
      <section>
        <!-- *Consolidated CDA* Specimen section -->
        <templateId root="2.16.840.1.113883.10.20.22.2.3"/>
        <code code="30954-2" codeSystem="2.16.840.1.113883.6.1" displayName="Specimen"/>
        <title>Specimen Information</title>
        <text>
          <table border="1">
            <thead><tr><th>Source</th><th>Type</th><th>ID</th><th>Collection Date</th></tr></thead>
            <tbody>${rows.join('')}</tbody>
          </table>
        </text>
        ${entries.join('\n')}
      </section>
    </component>`;
}

/* helper to emit dose + optional rate  ---------------------- */
function buildDoseXML (dVal, dUnit, vVal, vUnit) {
  let xml = `          <doseQuantity value="${dVal}" unit="${dUnit}"/>\n`;
  if (vVal && vUnit) {
    xml += `          <rateQuantity value="${vVal}" unit="${vUnit}"/>\n`;
  }
  return xml;
}

       /* ---------- Medication entries (schema-compliant) ---------- */
function generateMedicationEntries (d) {

  const meds = [
    {
      code:d.adminMed1Code, name:d.adminMed1Name, id:d.adminMed1Id,
      status:d.adminMed1Status, time:d.adminMed1Time, route:d.adminMed1Route,
      dVal:d.adminMed1DoseValue, dUnit:d.adminMed1DoseUnit,
      vVal:d.adminMed1VolValue, vUnit:d.adminMed1VolUnit,
      neg:d.adminMed1Negated ? 'true' : 'false'
    },
    {
      code:d.adminMed2Code, name:d.adminMed2Name, id:d.adminMed2Id,
      status:d.adminMed2Status, time:d.adminMed2Time, route:d.adminMed2Route,
      dVal:d.adminMed2DoseValue, dUnit:d.adminMed2DoseUnit,
      vVal:d.adminMed2VolValue, vUnit:d.adminMed2VolUnit,
      neg:d.adminMed2Negated ? 'true' : 'false'
    }
  ];

  return meds.filter(m => m.code && m.name).map(m => `
        <entry typeCode="DRIV">
          <substanceAdministration classCode="SBADM" moodCode="EVN"
                                   negationInd="${m.neg}">
            <templateId root="2.16.840.1.113883.10.20.22.4.16"
                        extension="2014-06-09"/>
            <id root="${generateGUID()}"/>
            <statusCode code="${m.status}"/>
            <effectiveTime xsi:type="IVL_TS">
              <low value="${m.time}"/>
            </effectiveTime>
            <routeCode code="${m.route}"
                       codeSystem="2.16.840.1.113883.3.26.1.1"/>
${buildDoseXML(m.dVal, m.dUnit, m.vVal, m.vUnit)}            <consumable>
              <manufacturedProduct classCode="MANU">
                <templateId root="2.16.840.1.113883.10.20.22.4.23"
                            extension="2014-06-09"/>
                <manufacturedMaterial>
                  <code code="${m.code}"
                        codeSystem="2.16.840.1.113883.6.88"
                        displayName="${xmlEscape(m.name)}"/>
                </manufacturedMaterial>
              </manufacturedProduct>
            </consumable>
          </substanceAdministration>
        </entry>`).join('');
}


        function generateImmunizationEntries(data) {
            let entries = '';
            
            if (data.vaccine1Code && data.vaccine1Name) {
                entries += `
                <entry typeCode="DRIV">
                    <substanceAdministration classCode="SBADM" moodCode="EVN" negationInd="false">
                        <templateId root="2.16.840.1.113883.10.20.22.4.52" extension="2015-08-01" />
                        <id root="${generateGUID()}" />
                        <statusCode code="${data.immunization1Status || 'completed'}" />
                        <effectiveTime value="${data.immunization1Date}" />
                        <routeCode code="${data.vaccine1Route || 'IM'}" codeSystem="2.16.840.1.113883.3.26.1.1" />
                        <doseQuantity value="${data.vaccine1Dose ? data.vaccine1Dose.split(' ')[0] : ''}" unit="${data.vaccine1Dose ? data.vaccine1Dose.split(' ')[1] || 'mL' : 'mL'}" />
                        <consumable>
                            <manufacturedProduct classCode="MANU">
                                <templateId root="2.16.840.1.113883.10.20.22.4.54" extension="2014-06-09" />
                                <manufacturedMaterial>
                                    <code code="${data.vaccine1Code}" codeSystem="2.16.840.1.113883.12.292" displayName="${data.vaccine1Name}" />
                                </manufacturedMaterial>
                                <manufacturerOrganization>
                                    <name>${data.vaccine1Manufacturer}</name>
                                </manufacturerOrganization>
                            </manufacturedProduct>
                        </consumable>
                    </substanceAdministration>
                </entry>`;
            }
            
            if (data.vaccine2Code && data.vaccine2Name) {
                entries += `
                <entry typeCode="DRIV">
                    <substanceAdministration classCode="SBADM" moodCode="EVN" negationInd="false">
                        <templateId root="2.16.840.1.113883.10.20.22.4.52" extension="2015-08-01" />
                        <id root="${generateGUID()}" />
                        <statusCode code="${data.immunization2Status || 'completed'}" />
                        <effectiveTime value="${data.immunization2Date}" />
                        <routeCode code="${data.vaccine2Route || 'IM'}" codeSystem="2.16.840.1.113883.3.26.1.1" />
                        <doseQuantity value="${data.vaccine2Dose ? data.vaccine2Dose.split(' ')[0] : ''}" unit="${data.vaccine2Dose ? data.vaccine2Dose.split(' ')[1] || 'mL' : 'mL'}" />
                        <consumable>
                            <manufacturedProduct classCode="MANU">
                                <templateId root="2.16.840.1.113883.10.20.22.4.54" extension="2014-06-09" />
                                <manufacturedMaterial>
                                    <code code="${data.vaccine2Code}" codeSystem="2.16.840.1.113883.12.292" displayName="${data.vaccine2Name}" />
                                </manufacturedMaterial>
                                <manufacturerOrganization>
                                    <name>${data.vaccine2Manufacturer}</name>
                                </manufacturerOrganization>
                            </manufacturedProduct>
                        </consumable>
                    </substanceAdministration>
                </entry>`;
            }
            
            return entries;
        }

        function generateProcedureEntries(data) {
            let entries = '';
            
            if (data.currentProc1Code && data.currentProc1Name) {
                entries += `
                <entry typeCode="DRIV">
                    <procedure classCode="PROC" moodCode="EVN">
                        <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
                        <id root="${generateGUID()}" />
                        <code code="${data.currentProc1Code}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.currentProc1Name}" />
                        <statusCode code="completed" />
                        <effectiveTime value="${data.currentProc1Date}" />
                    </procedure>
                </entry>`;
            }
            
            if (data.currentProc2Code && data.currentProc2Name) {
                entries += `
                <entry typeCode="DRIV">
                    <procedure classCode="PROC" moodCode="EVN">
                        <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
                        <id root="${generateGUID()}" />
                        <code code="${data.currentProc2Code}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.currentProc2Name}" />
                        <statusCode code="completed" />
                        <effectiveTime value="${data.currentProc2Date}" />
                    </procedure>
                </entry>`;
            }
            
            // Add specimen collection procedures
            if (data.specimen1Id && data.collection1Date) {
                entries += `
                <entry typeCode="DRIV">
                    <procedure classCode="PROC" moodCode="EVN">
                        <templateId root="2.16.840.1.113883.10.20.22.4.415" extension="2019-06-21" />
                        <id root="${generateGUID()}" />
                        <code code="33747-0" codeSystem="2.16.840.1.113883.6.1" displayName="General procedure" />
                        <statusCode code="completed" />
                        <effectiveTime value="${data.collection1Date}" />
                        <targetSiteCode code="${data.specimen1Source}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.specimen1Type}" />
                        <participant typeCode="PRD">
                            <participantRole classCode="SPEC">
                                <templateId root="2.16.840.1.113883.10.20.22.4.410" extension="2019-06-21" />
                                <id root="${generateGUID()}" extension="${data.specimen1Id}" />
                                <code code="${data.specimen1Source}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.specimen1Type}" />
                            </participantRole>
                        </participant>
                    </procedure>
                </entry>`;
            }
            
            if (data.specimen2Id && data.collection2Date) {
                entries += `
                <entry typeCode="DRIV">
                    <procedure classCode="PROC" moodCode="EVN">
                        <templateId root="2.16.840.1.113883.10.20.22.4.415" extension="2019-06-21" />
                        <id root="${generateGUID()}" />
                        <code code="33747-0" codeSystem="2.16.840.1.113883.6.1" displayName="General procedure" />
                        <statusCode code="completed" />
                        <effectiveTime value="${data.collection2Date}" />
                        <targetSiteCode code="${data.specimen2Source}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.specimen2Type}" />
                        <participant typeCode="PRD">
                            <participantRole classCode="SPEC">
                                <templateId root="2.16.840.1.113883.10.20.22.4.410" extension="2019-06-21" />
                                <id root="${generateGUID()}" extension="${data.specimen2Id}" />
                                <code code="${data.specimen2Source}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.specimen2Type}" />
                            </participantRole>
                        </participant>
                    </procedure>
                </entry>`;
            }
            
            return entries;
        }

        function generateCDA() {
            const data = getFormData();
            
            // Validate critical data elements for CDA compliance
            if (!data.patientId || !data.patientName || !data.providerId) {
                throw new Error('Missing required patient or provider information for CDA generation');
            }
            
            if (!data.providerPhone) {
                throw new Error('Provider phone is required for author telecom compliance (CONF:1198-5428)');
            }
            
            if (!data.facilityAddress || !data.patientCity || !data.patientState || !data.patientZip) {
                throw new Error('Complete facility address is required for US Realm compliance (CONF:1198-5452)');
            }
            
            const cdaTemplate = `<?xml version="1.0" encoding="UTF-8"?>
<!-- 
  HL7 CDA-compliant eICR Document
  Generated by eICR Form Generator v1.0
  
  Schema Compliance Fixes Applied:
  - CRITICAL FIX: Patient elements in EXACT CDA schema order: name, gender, birthTime, languageCommunication, race, ethnicity, birthplace, deceased
  - CRITICAL FIX: Author assignedAuthor elements in correct order: id, addr, telecom, device, organization (addr BEFORE telecom)
  - Author assignedAuthor includes required telecom and US Realm address (CONF:1198-5428, CONF:1198-5452)
  - Custodian has exactly one telecom element (CONF:1198-5525)
  - Encounter uses standard dischargeDispositionCode (not sdtc: version)
  - All addresses include country for US Realm compliance
  - All template IDs conform to eICR IG requirements
-->
<ClinicalDocument xmlns="urn:hl7-org:v3" xmlns:cda="urn:hl7-org:v3" xmlns:sdtc="urn:hl7-org:sdtc"
  xmlns:voc="http://www.lantanagroup.com/voc"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="urn:hl7-org:v3 ../../schema/infrastructure/cda/CDA_SDTC.xsd">
  <realmCode code="US" />
  <typeId extension="POCD_HD000040" root="2.16.840.1.113883.1.3" />
  <templateId root="2.16.840.1.113883.10.20.22.1.1" />
  <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.1.1" />
  <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2" />
  <id root="${data.documentId}" />
  <code code="55751-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
    displayName="Public Health Case Report" />
  <title>Initial Public Health Case Report</title>
  <effectiveTime value="${data.effectiveTime}" />
  <confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25" displayName="Normal" />
  <languageCode code="en-US" />
  <setId extension="${data.setId}" root="1.2.840.114350.1.13.380.3.7.1.1" />
  <versionNumber value="${data.versionNumber}" />
  
  <!-- Patient Information -->
 <recordTarget>
    <patientRole>
      <id extension="${data.patientId}" root="2.16.840.1.113883.19.5" />
      <addr use="H">
        <streetAddressLine>${data.patientAddress}</streetAddressLine>
        <city>${data.patientCity}</city>
        <state>${data.patientState}</state>
        <postalCode>${data.patientZip}</postalCode>
        <county>${data.patientCounty}</county>
        <country>${data.patientCountry || 'US'}</country>
      </addr>
      <telecom use="MC" value="tel:${data.patientPhone}" />
      <telecom use="WP" value="mailto:${data.patientEmail}" />
    <patient>
      <!-- CDA Schema Compliant Patient Element Order -->
      <name use="L">
        <given>${data.patientName.split(' ')[0]}</given>
        <family>${data.patientName.split(' ').slice(1).join(' ')}</family>
      </name>
      <administrativeGenderCode code="${data.patientGender}" codeSystem="2.16.840.1.113883.5.1"
        displayName="${data.patientGender === 'F' ? 'Female' : 'Male'}" />
      <birthTime value="${data.patientBirthDate}" />
<sdtc:deceasedInd value="${data.patientDeathIndicator || 'false'}" />
      ${data.patientDeathDate ? `<sdtc:deceasedTime value="${data.patientDeathDate}" />` : ''}

      <raceCode code="${data.patientRace}" codeSystem="2.16.840.1.113883.6.238"
        codeSystemName="Race &amp; Ethnicity - CDC" displayName="${getRaceDisplayName(data.patientRace)}" />
      ${data.patientDetailedRace ? `<sdtc:raceCode code="${data.patientDetailedRace}" codeSystem="2.16.840.1.113883.6.238" />` : ''}
      <ethnicGroupCode code="${data.patientEthnicity}" codeSystem="2.16.840.1.113883.6.238"
        codeSystemName="Race &amp; Ethnicity - CDC" displayName="${getEthnicityDisplayName(data.patientEthnicity)}" />
      ${data.patientDetailedEthnicity ? `<sdtc:ethnicGroupCode code="${data.patientDetailedEthnicity}" codeSystem="2.16.840.1.113883.6.238" />` : ''}
      ${data.guardianName ? `
      <guardian>
        <code code="${data.guardianCode || 'GUARD'}" codeSystem="2.16.840.1.113883.5.111" />
        <addr use="H">
          <streetAddressLine>${data.guardianAddress || ''}</streetAddressLine>
          <city>${data.guardianCity || ''}</city>
          <state>${data.guardianState || ''}</state>
          <postalCode>${data.guardianZip || ''}</postalCode>
        </addr>
        ${data.guardianPhone ? `<telecom use="HP" value="tel:${data.guardianPhone}" />` : ''}
        ${data.guardianEmail ? `<telecom use="WP" value="mailto:${data.guardianEmail}" />` : ''}
        <guardianPerson>
          <name use="L">
            <given>${data.guardianName.split(' ')[0] || ''}</given>
            <family>${data.guardianName.split(' ').slice(1).join(' ') || ''}</family>
          </name>
        </guardianPerson>
      </guardian>` : ''}
      <birthplace>
        <place>
          <addr>
            <city>${data.patientBirthPlace || data.patientCity}</city>
          </addr>
        </place>
      </birthplace>
      <languageCommunication>
        <languageCode code="${data.patientLanguage || 'en'}" />
        <preferenceInd value="true" />
      </languageCommunication>
      
    </patient>
    </patientRole>
  </recordTarget>

  <!-- Provider Information -->
  <author>
    <time value="${data.effectiveTime}" />
    <assignedAuthor>
      <id extension="${data.providerId}" root="2.16.840.1.113883.4.6" />
      <addr use="WP">
        <streetAddressLine>${data.facilityAddress}</streetAddressLine>
        <city>${data.patientCity}</city>
        <state>${data.patientState}</state>
        <postalCode>${data.patientZip}</postalCode>
        <country>US</country>
      </addr>
      <telecom use="WP" value="tel:${data.providerPhone}" />
      ${data.providerEmail ? `<telecom use="WP" value="mailto:${data.providerEmail}" />` : ''}
      <assignedAuthoringDevice>
        <manufacturerModelName>eICR Generator - Version 1.0</manufacturerModelName>
        <softwareName>eICR Generator - Version 1.0</softwareName>
      </assignedAuthoringDevice>
      <representedOrganization>
        <id extension="${data.organizationId || data.facilityId || data.providerId}" root="2.16.840.1.113883.4.6" />
        <name>${data.organizationName || data.facilityName}</name>
        <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}" />
        <addr use="WP">
          <streetAddressLine>${data.organizationAddress || data.facilityAddress}</streetAddressLine>
          <city>${data.patientCity}</city>
          <state>${data.patientState}</state>
          <postalCode>${data.patientZip}</postalCode>
          <country>US</country>
        </addr>
      </representedOrganization>
    </assignedAuthor>
  </author>

  <custodian>
    <assignedCustodian>
      <representedCustodianOrganization>
        <id extension="${data.organizationId || data.facilityId}" root="2.16.840.1.113883.4.6" />
        <name>${data.organizationName || data.facilityName}</name>
        <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}" />
        <addr use="WP">
          <streetAddressLine>${data.organizationAddress || data.facilityAddress}</streetAddressLine>
          <city>${data.patientCity}</city>
          <state>${data.patientState}</state>
          <postalCode>${data.patientZip}</postalCode>
          <country>US</country>
        </addr>
      </representedCustodianOrganization>
    </assignedCustodian>
  </custodian>

  <!-- Encounter Information -->
  <componentOf>
    <encompassingEncounter>
      <id extension="${data.encounterId}" root="2.16.840.1.113883.19" />
      <code code="${data.encounterType}" codeSystem="2.16.840.1.113883.5.4"
        codeSystemName="HL7 ActEncounterCode" displayName="Ambulatory" />
      <effectiveTime>
        <low value="${data.encounterDate}" />
        <high value="${data.encounterEndDate || data.encounterDate}" />
      </effectiveTime>
      ${data.encounterDisposition ? `<dischargeDispositionCode code="${data.encounterDisposition}" codeSystem="2.16.840.1.113883.12.112" />` : ''}
      <responsibleParty>
        <assignedEntity>
          <id extension="${data.providerId}" root="2.16.840.1.113883.4.6" />
          <addr use="WP">
            <streetAddressLine>${data.facilityAddress}</streetAddressLine>
            <city>${data.patientCity}</city>
            <state>${data.patientState}</state>
            <postalCode>${data.patientZip}</postalCode>
            <country>US</country>
          </addr>
          <telecom use="WP" value="tel:${data.providerPhone}" />
          <assignedPerson>
            <name>
              <given>${data.providerName.split(' ')[1]}</given>
              <family>${data.providerName.split(' ')[2]}</family>
            </name>
          </assignedPerson>
          <representedOrganization>
            <name>${data.facilityName}</name>
            <addr use="WP">
              <streetAddressLine>${data.facilityAddress}</streetAddressLine>
              <city>${data.patientCity}</city>
              <state>${data.patientState}</state>
              <postalCode>${data.patientZip}</postalCode>
              <country>US</country>
            </addr>
          </representedOrganization>
        </assignedEntity>
      </responsibleParty>
      <location>
        <healthCareFacility>
          <id extension="${data.facilityId || data.providerId}" root="2.16.840.1.113883.4.6" />
          <code code="${data.facilityTypeCode || 'OF'}" codeSystem="2.16.840.1.113883.5.111"
            codeSystemName="HL7RoleCode" displayName="Healthcare Facility" />
          <location>
            <name>${data.facilityName}</name>
            <addr use="WP">
              <streetAddressLine>${data.facilityAddress}</streetAddressLine>
              <city>${data.patientCity}</city>
              <state>${data.patientState}</state>
              <postalCode>${data.patientZip}</postalCode>
              <country>US</country>
            </addr>
          </location>
          <serviceProviderOrganization>
            <id extension="${data.organizationId || data.facilityId}" root="2.16.840.1.113883.4.6" />
            <name>${data.organizationName || data.facilityName}</name>
            <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}" />
            ${data.organizationEmail ? `<telecom use="WP" value="mailto:${data.organizationEmail}" />` : ''}
            ${data.organizationFax ? `<telecom use="WP" value="fax:${data.organizationFax}" />` : ''}
            <addr use="WP">
              <streetAddressLine>${data.organizationAddress || data.facilityAddress}</streetAddressLine>
              <city>${data.patientCity}</city>
              <state>${data.patientState}</state>
              <postalCode>${data.patientZip}</postalCode>
            </addr>
          </serviceProviderOrganization>
        </healthCareFacility>
      </location>
    </encompassingEncounter>
  </componentOf>

  <component>
    <structuredBody>
      <!-- Encounters Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.22" />
          <templateId root="2.16.840.1.113883.10.20.22.2.22" extension="2015-08-01" />
          <templateId root="2.16.840.1.113883.10.20.22.2.22.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.22.1" extension="2015-08-01" />
          <code code="46240-8" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
            displayName="History of encounters" />
          <title>Encounters</title>
          <text>
            <table>
              <thead>
                <tr><th>Encounter</th><th>Date</th><th>Location</th></tr>
              </thead>
              <tbody><tr><td>Office outpatient visit</td><td>${data.encounterDate}</td><td>${data.facilityName}</td></tr></tbody>
            </table>
          </text>
          <entry typeCode="DRIV">
            <encounter classCode="ENC" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.49" />
              <templateId root="2.16.840.1.113883.10.20.22.4.49" extension="2015-08-01" />
              <id root="2.16.840.1.113883.19.${data.encounterId}" />
              <code code="99213" codeSystem="2.16.840.1.113883.6.12" codeSystemName="CPT-4"
                displayName="Office outpatient visit" />
              <effectiveTime>
                <low value="${data.encounterDate}" />
                <high value="${data.encounterDate}" />
              </effectiveTime>
            </encounter>
          </entry>
        </section>
      </component>

         ${buildSpecimenSection(data)}  

      <!-- Reason for Visit Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.12" />
          <code code="29299-5" codeSystem="2.16.840.1.113883.6.1" displayName="Reason for visit" />
          <title>Reason for visit</title>
          <text>${data.chiefComplaint}</text>
        </section>
      </component>

      <!-- History of Present Illness -->
      <component>
        <section>
          <templateId root="1.3.6.1.4.1.19376.1.5.3.1.3.4" />
          <code code="10164-2" codeSystem="2.16.840.1.113883.6.1" displayName="History of Present Illness" />
          <title>History of Present Illness</title>
          <text>${data.presentIllness}</text>
        </section>
      </component>

      <!-- Medications Administered Section -->
      <component>
        <section nullFlavor="NI">
          <templateId root="2.16.840.1.113883.10.20.22.2.38" />
          <templateId extension="2014-06-09" root="2.16.840.1.113883.10.20.22.2.38" />
          <code code="29549-3" codeSystem="2.16.840.1.113883.6.1"
            codeSystemName="LOINC" displayName="Medications Administered" />
          <title>Medications Administered</title>
          <text>No medications administered</text>
        </section>
      </component>

      <!-- Problems Section with RCTC Trigger Codes -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.5" />
          <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.5" />
          <templateId root="2.16.840.1.113883.10.20.22.2.5.1" />
          <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.5.1" />
          <code code="11450-4" codeSystem="2.16.840.1.113883.6.1" displayName="Problem List" />
          <title>Problem List</title>
          <text>
            <table>
              <thead>
                <tr><th>Problem</th><th>Code</th><th>Date</th><th>RCTC Trigger</th></tr>
              </thead>
              <tbody><tr><td>${data.diagnosis1Name}</td><td>${data.diagnosis1Code}</td><td>${data.encounterDate}</td><td>Yes</td></tr><tr><td>${data.diagnosis2Name}</td><td>${data.diagnosis2Code}</td><td>${data.encounterDate}</td><td>Yes</td></tr><tr><td>${data.diagnosis3Name}</td><td>${data.diagnosis3Code}</td><td>${data.encounterDate}</td><td>Yes</td></tr></tbody>
            </table>
          </text>
          <entry typeCode="DRIV">
            <act classCode="ACT" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.3" />
              <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.3" />
              <id root="a1c0c380-eacc-4b40-9207-85164185558d" />
              <code code="CONC" codeSystem="2.16.840.1.113883.5.6" displayName="Concern" />
              <statusCode code="active" />
              <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
              
              <!-- COVID-19 Diagnosis with RCTC Trigger Code Template -->
              <entryRelationship typeCode="SUBJ">
                <observation classCode="OBS" moodCode="EVN" negationInd="false">
                  <templateId root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.3" />
                  <id root="5e3c9b57-fa2e-48a2-be29-47d9873e3c13" />
                  <code code="75323-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                    displayName="Condition">
                    <translation code="282291009" codeSystem="2.16.840.1.113883.6.96"
                      codeSystemName="SNOMED CT" displayName="Diagnosis" />
                  </code>
                  <statusCode code="completed" />
                  <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
                  <value xsi:type="CD" code="${data.diagnosis1Code}" codeSystem="2.16.840.1.113883.6.96"
                    codeSystemName="SNOMED-CT" displayName="${data.diagnosis1Name}"
                    sdtc:valueSet="${rctcData.metadata.oid}" sdtc:valueSetVersion="${rctcData.metadata.version}" />
                </observation>
              </entryRelationship>

              <!-- Influenza Diagnosis with RCTC Trigger Code Template -->
              <entryRelationship typeCode="SUBJ">
                <observation classCode="OBS" moodCode="EVN" negationInd="false">
                  <templateId root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.3" />
                  <id root="7f32bd91-c5f3-422b-8a9d-3bc24c1e8bc1" />
                  <code code="75323-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                    displayName="Condition">
                    <translation code="282291009" codeSystem="2.16.840.1.113883.6.96"
                      codeSystemName="SNOMED CT" displayName="Diagnosis" />
                  </code>
                  <statusCode code="completed" />
                  <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
                  <value xsi:type="CD" code="${data.diagnosis2Code}" codeSystem="2.16.840.1.113883.6.96"
                    codeSystemName="SNOMED-CT" displayName="${data.diagnosis2Name}"
                    sdtc:valueSet="${rctcData.metadata.oid}" sdtc:valueSetVersion="${rctcData.metadata.version}" />
                </observation>
              </entryRelationship>

              <!-- Zika Diagnosis with RCTC Trigger Code Template -->
              <entryRelationship typeCode="SUBJ">
                <observation classCode="OBS" moodCode="EVN" negationInd="false">
                  <templateId root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.3" />
                  <id root="b0ea9e52-4e54-4c22-8dc3-4bd390e10eef" />
                  <code code="75323-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                    displayName="Condition">
                    <translation code="282291009" codeSystem="2.16.840.1.113883.6.96"
                      codeSystemName="SNOMED CT" displayName="Diagnosis" />
                  </code>
                  <statusCode code="completed" />
                  <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
                  <value xsi:type="CD" code="${data.diagnosis3Code}" codeSystem="2.16.840.1.113883.6.96"
                    codeSystemName="SNOMED-CT" displayName="${data.diagnosis3Name}"
                    sdtc:valueSet="${rctcData.metadata.oid}" sdtc:valueSetVersion="${rctcData.metadata.version}" />
                </observation>
              </entryRelationship>
            </act>
          </entry>
        </section>
      </component>

      <!-- Results Section with RCTC Trigger Codes -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.3" />
          <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.3" />
          <templateId root="2.16.840.1.113883.10.20.22.2.3.1" />
          <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.3.1" />
          <code code="30954-2" codeSystem="2.16.840.1.113883.6.1" displayName="Relevant diagnostic tests and/or laboratory data" />
          <title>Results</title>
          <text>
            <table>
              <thead>
                <tr><th>Test</th><th>Result</th><th>Date</th><th>RCTC Trigger</th></tr>
              </thead>
              <tbody><tr><td>${data.labTest1Name}</td><td>${data.labTest1Result}</td><td>${data.encounterDate}</td><td>Yes</td></tr><tr><td>${data.labTest2Name}</td><td>${data.labTest2Result}</td><td>${data.encounterDate}</td><td>Yes</td></tr></tbody>
            </table>
          </text>
          
          <!-- COVID-19 Test Result with RCTC Trigger Code Template -->
          <entry typeCode="DRIV">
            <organizer classCode="BATTERY" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.1" />
              <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.1" />
              <id root="2047cca3-559f-45da-8775-406538fa4815" />
              <code code="${data.labTest1Code}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                displayName="${data.labTest1Name}" />
              <statusCode code="completed" />
              <effectiveTime>
                <low value="${data.encounterDate}" />
                <high value="${data.encounterDate}" />
              </effectiveTime>
              <component>
                <observation classCode="OBS" moodCode="EVN">
                  <templateId root="2.16.840.1.113883.10.20.22.4.2" />
                  <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.2" />
                  <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.2" />
                  <id root="9890e2c3-019a-4168-8403-a0a069994440" />
                  <code code="${data.labTest1Code}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                    displayName="${data.labTest1Name}"
                    sdtc:valueSet="${rctcData.metadata.oid}" sdtc:valueSetVersion="${rctcData.metadata.version}" />
                  <statusCode code="completed" />
                  <effectiveTime value="${data.encounterDate}" />
                  <value code="260373001" codeSystem="2.16.840.1.113883.6.96"
                    codeSystemName="SNOMED-CT" displayName="${data.labTest1Result}" xsi:type="CD" />
                </observation>
              </component>
            </organizer>
          </entry>

          <!-- Influenza Test Result with RCTC Trigger Code Template -->
          <entry typeCode="DRIV">
            <organizer classCode="BATTERY" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.1" />
              <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.1" />
              <id root="3f4b84f1-d3f6-4731-8e61-7c63d8f39a70" />
              <code code="${data.labTest2Code}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                displayName="${data.labTest2Name}" />
              <statusCode code="completed" />
              <effectiveTime>
                <low value="${data.encounterDate}" />
                <high value="${data.encounterDate}" />
              </effectiveTime>
              <component>
                <observation classCode="OBS" moodCode="EVN">
                  <templateId root="2.16.840.1.113883.10.20.22.4.2" />
                  <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.2" />
                  <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.2" />
                  <id root="6c53c5ff-42a9-4f3c-a2c0-d412f019c0de" />
                  <code code="${data.labTest2Code}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                    displayName="${data.labTest2Name}"
                    sdtc:valueSet="${rctcData.metadata.oid}" sdtc:valueSetVersion="${rctcData.metadata.version}" />
                  <statusCode code="completed" />
                  <effectiveTime value="${data.encounterDate}" />
                  <value code="260373001" codeSystem="2.16.840.1.113883.6.96"
                    codeSystemName="SNOMED-CT" displayName="${data.labTest2Result}" xsi:type="CD" />
                </observation>
              </component>
            </organizer>
          </entry>
        </section>
      </component>

      <!-- Social History Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.17" />
          <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.17" />
          <code code="29762-2" codeSystem="2.16.840.1.113883.6.1" displayName="Social History" />
          <title>Social History</title>
          <text>
            <table>
              <thead>
                <tr><th>Travel History</th><th>Dates</th><th>Location</th></tr>
              </thead>
              <tbody><tr><td>Recent travel</td><td>${data.travelStartDate} - ${data.travelEndDate}</td><td>${data.travelLocation}</td></tr></tbody>
            </table>
          </text>
          <entry typeCode="DRIV">
            <act classCode="ACT" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.15.2.3.1" />
              <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.1" />
              <id root="79565142-eae0-4213-a3b3-b73cdf474682" />
              <code code="420008001" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT"
                displayName="Travel" />
              <text>Recent travel to ${data.travelLocation}</text>
              <statusCode code="completed" />
              <effectiveTime>
                <low value="${data.travelStartDate}" />
                <high value="${data.travelEndDate}" />
              </effectiveTime>
            </act>
          </entry>
          
          <!-- Birth Sex Observation -->
          <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.200" extension="2016-06-01" />
              <id root="${generateGUID()}" />
              <code code="76689-9" codeSystem="2.16.840.1.113883.6.1" displayName="Sex Assigned At Birth" />
              <statusCode code="completed" />
              <effectiveTime value="${data.patientBirthDate}" />
              <value xsi:type="CD" code="${data.patientBirthSex || data.patientGender}" codeSystem="2.16.840.1.113883.5.1" />
            </observation>
          </entry>
          
          <!-- Gender Identity Observation -->
          <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.34.3.45" extension="2022-06-01" />
              <id root="${generateGUID()}" />
              <code code="76691-5" codeSystem="2.16.840.1.113883.6.1" displayName="Gender identity" />
              <statusCode code="completed" />
              <effectiveTime value="${data.patientBirthDate}" />
              <value xsi:type="CD" code="${data.patientGenderIdentity || data.patientGender}" codeSystem="2.16.840.1.113883.6.96" />
            </observation>
          </entry>
          
          <!-- Occupation Information -->
          ${data.currentOccupation ? `
          <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.217" extension="2022-06-01" />
              <id root="${generateGUID()}" />
              <code code="87729-0" codeSystem="2.16.840.1.113883.6.1" displayName="Current occupation" />
              <statusCode code="active" />
              <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
              <value xsi:type="ST">${data.currentOccupation}</value>
              <participant typeCode="IND">
                <participantRole classCode="ASSIGNED">
                   
                  ${data.currentEmployerAddress ? `<addr><streetAddressLine>${data.currentEmployerAddress}</streetAddressLine></addr>` : ''}
                   ${data.currentEmployerPhone ? `<telecom value="tel:${data.currentEmployerPhone}" />` : ''}
                  <playingEntity classCode="ORG">
                    <name>${data.currentEmployerName || 'Unknown'}</name>
                  </playingEntity>
                </participantRole>
              </participant>
            </observation>
          </entry>
          
          <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.216" extension="2022-06-01" />
              <id root="${generateGUID()}" />
              <code code="21843-8" codeSystem="2.16.840.1.113883.6.1" displayName="History of Occupation industry" />
              <statusCode code="active" />
              <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
              <value xsi:type="ST">${data.currentIndustry || 'Unknown'}</value>
            </observation>
          </entry>` : ''}
        </section>
      </component>

      <!-- Vital Signs Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.4" />
          <templateId root="2.16.840.1.113883.10.20.22.2.4" extension="2015-08-01" />
          <templateId root="2.16.840.1.113883.10.20.22.2.4.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.4.1" extension="2015-08-01" />
          <code code="8716-3" codeSystem="2.16.840.1.113883.6.1" displayName="Vital signs" />
          <title>Vital Signs</title>
          <text>
            <table>
              <thead>
                <tr><th>Vital Sign</th><th>Value</th><th>Unit</th><th>Date</th></tr>
              </thead>
              <tbody>${data.temperature ? `<tr><td>Temperature</td><td>${data.temperature}</td><td>¬∞F</td><td>${data.encounterDate}</td></tr>` : ''}${data.bloodPressure ? `<tr><td>Blood Pressure</td><td>${data.bloodPressure}</td><td>mmHg</td><td>${data.encounterDate}</td></tr>` : ''}${data.heartRate ? `<tr><td>Heart Rate</td><td>${data.heartRate}</td><td>bpm</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.respiratoryRate  ? `<tr><td>Respiratory Rate</td><td>${data.respiratoryRate}</td><td>/min</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.oxygenSaturation ? `<tr><td>Oxygen Saturation</td><td>${data.oxygenSaturation}</td><td>%</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.weight           ? `<tr><td>Weight</td><td>${data.weight}</td><td>kg</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.height           ? `<tr><td>Height</td><td>${data.height}</td><td>cm</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.bmi              ? `<tr><td>BMI</td><td>${data.bmi}</td><td>kg/m¬≤</td><td>${data.encounterDate}</td></tr>` : ''}
</tbody>

            </table>
          </text>
          ${generateVitalSignsEntries(data)}
        </section>
      </component>

      <!-- Medications Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.1" extension="2014-06-09" />
          <templateId root="2.16.840.1.113883.10.20.22.2.1.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.1.1" extension="2014-06-09" />
          <code code="10160-0" codeSystem="2.16.840.1.113883.6.1" displayName="Medications" />
          <title>Medications</title>
          <text>
            <table>
              <thead>
                <tr><th>Medication</th><th>Dose</th><th>Route</th><th>Date</th><th>Status</th></tr>
              </thead>
              <tbody>${data.adminMed1Name ? `<tr><td>${data.adminMed1Name}</td><td>${data.adminMed1DoseValue} ${data.adminMed1DoseUnit}${data.adminMed1VolValue ? ' (' + data.adminMed1VolValue + ' ' + data.adminMed1VolUnit + ')' : ''}</td><td>${data.adminMed1Route}</td><td>${data.adminMed1Time}</td><td>${data.adminMed1Status}</td></tr>` : ''}${data.adminMed2Name ? `<tr><td>${data.adminMed2Name}</td><td>${data.adminMed2DoseValue} ${data.adminMed2DoseUnit}${data.adminMed2VolValue ? ' (' + data.adminMed2VolValue + ' ' + data.adminMed2VolUnit + ')' : ''}</td><td>${data.adminMed2Route}</td><td>${data.adminMed2Time}</td><td>${data.adminMed2Status}</td></tr>` : ''}</tbody>
            </table>
          </text>
          ${generateMedicationEntries(data)}
        </section>
      </component>

      <!-- Immunizations Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.2" />
          <templateId root="2.16.840.1.113883.10.20.22.2.2" extension="2015-08-01" />
          <templateId root="2.16.840.1.113883.10.20.22.2.2.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.2.1" extension="2015-08-01" />
          <code code="11369-6" codeSystem="2.16.840.1.113883.6.1" displayName="Immunizations" />
          <title>Immunizations</title>
          <text>
            <table>
              <thead>
                <tr><th>Vaccine</th><th>Date</th><th>Status</th><th>Manufacturer</th></tr>
              </thead>
              <tbody>${data.vaccine1Name ? `<tr><td>${data.vaccine1Name}</td><td>${data.immunization1Date}</td><td>${data.immunization1Status}</td><td>${data.vaccine1Manufacturer}</td></tr>` : ''}${data.vaccine2Name ? `<tr><td>${data.vaccine2Name}</td><td>${data.immunization2Date}</td><td>${data.immunization2Status}</td><td>${data.vaccine2Manufacturer}</td></tr>` : ''}</tbody>
            </table>
          </text>
          ${generateImmunizationEntries(data)}
        </section>
      </component>

      <!-- Procedures Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.7" />
          <templateId root="2.16.840.1.113883.10.20.22.2.7" extension="2014-06-09" />
          <templateId root="2.16.840.1.113883.10.20.22.2.7.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.7.1" extension="2014-06-09" />
          <code code="47519-4" codeSystem="2.16.840.1.113883.6.1" displayName="Procedures" />
          <title>Procedures</title>
          <text>
            <table>
              <thead>
                <tr><th>Procedure</th><th>Date</th><th>Type</th></tr>
              </thead>
              <tbody>${data.currentProc1Name ? `<tr><td>${data.currentProc1Name}</td><td>${data.currentProc1Date}</td><td>${data.currentProc1Type}</td></tr>` : ''}${data.currentProc2Name ? `<tr><td>${data.currentProc2Name}</td><td>${data.currentProc2Date}</td><td>${data.currentProc2Type}</td></tr>` : ''}${data.triggerProc1Name ? `<tr><td>${data.triggerProc1Name}</td><td>${data.triggerProc1Date}</td><td>${data.triggerProc1Type}</td></tr>` : ''}
              </tbody>
            </table>
          </text>
          ${generateProcedureEntries(data)}
        </section>
      </component>

    </structuredBody>
  </component>
</ClinicalDocument>`;
            return cdaTemplate;
        }

        function generateAndDownloadCDA() {
            if (!validateFormData()) {
                return;
            }
            
            try {
                const cdaContent = generateCDA();
                const data = getFormData();
                
                // Additional CDA-specific validation
                if (!cdaContent.includes('<ClinicalDocument')) {
                    throw new Error('Invalid CDA document structure generated');
                }
                
                const blob = new Blob([cdaContent], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `RCTC_eICR_${data.patientId}_${new Date().toISOString().split('T')[0]}.xml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                
            } catch (error) {
                console.error('CDA Generation Error:', error);
                alert(`Error generating CDA document: ${error.message}\n\nPlease check that all required fields are completed correctly.`);
            }
        }

        async function generateAndPostCDA() {
            if (!validateFormData()) {
                return;
            }
            
            try {
                const cdaContent = generateCDA();
                
                // Additional CDA-specific validation
                if (!cdaContent.includes('<ClinicalDocument')) {
                    throw new Error('Invalid CDA document structure generated');
                }
                const s3Url = 'https://eicr-rr-bucket.s3.us-east-2.amazonaws.com/General/test.xml';
                
                const response = await fetch(s3Url, {
                    method: 'PUT',
                    body: cdaContent,
                    headers: {
                        'Content-Type': 'application/xml'
                    }
                });
                
                if (response.ok) {
                    alert('CDA document successfully posted to S3!\n\n‚úÖ Schema Compliance:\n- Patient elements in correct CDA schema order\n- Author elements properly sequenced\n- All required telecom and address elements included\n- US Realm compliance maintained\n\nThe uploaded XML is ready for processing by health information systems.');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error posting CDA to S3:', error);
                alert(`Error posting CDA to S3: ${error.message}\n\nNote: This may fail due to CORS policy or authentication requirements.`);
            }
        }

        function saveFormData() {
            const data = getFormData();
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RCTC_eICR_form_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function loadFormData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        setFormData(data);
                        alert('Form data loaded successfully!');
                    } catch (error) {
                        alert('Error loading file: Invalid JSON format');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            const searchResults = document.querySelectorAll('.search-results');
            searchResults.forEach(result => {
                if (!result.parentElement.contains(e.target)) {
                    result.style.display = 'none';
                }
            });
        });

        function togglePregnancyFields() {
            const genderSelect = document.getElementById('patientGender');
            const pregnancySections = document.querySelectorAll('.section');
            
            let pregnancyDiv = null;
            pregnancySections.forEach(section => {
                const title = section.querySelector('.section-title');
                if (title && title.textContent.includes('Pregnancy Information')) {
                    pregnancyDiv = section;
                }
            });
            
            if (genderSelect && pregnancyDiv) {
                if (genderSelect.value === 'F') {
                    pregnancyDiv.style.display = 'block';
                } else {
                    pregnancyDiv.style.display = 'none';
                }
            }
        }

        function toggleGuardianFields() {
            const birthDate = document.getElementById('patientBirthDate');
            const guardianSections = document.querySelectorAll('.section');
            
            let guardianDiv = null;
            guardianSections.forEach(section => {
                const title = section.querySelector('.section-title');
                if (title && title.textContent.includes('Guardian/Parent Information')) {
                    guardianDiv = section;
                }
            });
            
            if (birthDate && guardianDiv && birthDate.value.length === 8) {
                const today = new Date();
                const birth = new Date(
                    birthDate.value.substring(0, 4),
                    birthDate.value.substring(4, 6) - 1,
                    birthDate.value.substring(6, 8)
                );
                
                const age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                
                if (age < 18 || (age === 18 && monthDiff < 0)) {
                    guardianDiv.style.display = 'block';
                } else {
                    guardianDiv.style.display = 'none';
                }
            }
        }

        function setupConditionalDisplays() {
            // Gender-based pregnancy field display
            const genderSelect = document.getElementById('patientGender');
            if (genderSelect) {
                genderSelect.addEventListener('change', togglePregnancyFields);
                togglePregnancyFields(); // Initial check
            }

            // Age-based guardian field display
            const birthDateInput = document.getElementById('patientBirthDate');
            if (birthDateInput) {
                birthDateInput.addEventListener('change', toggleGuardianFields);
                birthDateInput.addEventListener('blur', toggleGuardianFields);
            }
        }

        // Initialize the form
        document.addEventListener('DOMContentLoaded', function() {
            console.log('eICR Generator loaded');
            console.log('RCTC Metadata:', rctcData.metadata);
            setupConditionalDisplays();
        });
    </script>
</body>
</html>