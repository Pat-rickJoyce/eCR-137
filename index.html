<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eICR Form Generator - DQ Schematron Compliant</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9fafb;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        h1 {
            color: #1f2937;
            margin: 0;
            font-size: 2rem;
        }
        .subtitle {
            color: #6b7280;
            margin: 5px 0 0 0;
        }
        .rctc-info {
            background: #e0f2fe;
            border: 1px solid #81d4fa;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        .rctc-info h3 {
            margin: 0 0 10px 0;
            color: #0277bd;
        }
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn:hover { opacity: 0.9; }
        .section {
            margin-bottom: 30px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 20px 0;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        .textarea-group {
            grid-column: 1 / -1;
        }
        label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }
        input, textarea, select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        select[id*="diagnosis"] {
            min-width: 300px;
            max-width: 100%;
        }
        select[id*="diagnosis"] option[style*="font-weight: bold"] {
            background-color: #fef3c7;
            color: #92400e;
        }
        .footer-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            flex-wrap: wrap;
        }
        .code-search {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: #f9fafb;
            margin-top: 10px;
            display: none;
        }
        .result-item {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .result-item:hover {
            background-color: #e5e7eb;
        }
        .search-results-list {
            /* Container for search results */
        }
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .search-result-item:hover {
            background-color: #e5e7eb;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .no-results {
            padding: 10px;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }
        
        /* Lab Evidence Repeatable UI */
        .lab-evidence-controls {
            margin-bottom: 20px;
        }
        .lab-evidence-row {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f9fafb;
        }
        .lab-evidence-row h4 {
            margin: 0 0 15px 0;
            color: #374151;
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 8px;
        }
        .hidden {
            display: none !important;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .code-display {
            font-family: monospace;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        .hidden { display: none; }
        .trigger-indicator {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        .help-tooltip {
            cursor: help;
            margin-left: 5px;
            color: #6b7280;
        }
        .help-text {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
        }
        .help-text h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #374151;
        }
        .help-text ul {
            margin-bottom: 0;
            padding-left: 20px;
        }
        .help-text li {
            margin-bottom: 5px;
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; }
            .form-grid { grid-template-columns: 1fr; }
            .container { padding: 15px; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


  <!-- Clean UI v8.1 styles -->
  <link rel="stylesheet" href="css/ui.clean.v8_1.theme.css">
  <link rel="stylesheet" href="css/ui.clean.v8_1.components.css">

</head>
<body>
<div class="ui81-brand">
  <div class="name">eCR-endipity</div>
</div>

    <div class="container">
        <div class="header">
            <div>
                <h1>eICR Generator</h1>
                <p class="subtitle">Electronic Initial Case Report with Reportable Condition Trigger Codes</p>
            </div>
            <div class="buttons">
                <button class="btn btn-success" onclick="saveFormData()">üíæ Save Form Data</button>
                <button class="btn btn-primary" onclick="generateAndDownloadCDA()">üìÑ Generate CDA</button>
                <button class="btn btn-primary" onclick="generateAndDownloadRR()">üì® Generate RR</button>
                <button class="btn btn-info" onclick="downloadZipOfEICRandRR()">üì¶ Download ZIP (eICR + RR)</button>

            </div>
        </div>


        <div class="section">
            <h2 class="section-title">Patient Demographics</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Patient ID <span class="help-tooltip" title="Unique identifier that stays the same across all versions of the same logical document. Documents with the same Set ID represent different versions of the same document.">‚ÑπÔ∏è</span></label>
                    <input type="text" id="patientId" value="MRN-00234567">
                </div>
                <div class="input-group">
                    <label>Patient Name <span style="color: red;">*</span></label>
                    <input type="text" id="patientName" value="Emma Rose Johnson" required>
                </div>
                <div class="input-group">
                    <label>Phone</label>
                    <input type="text" id="patientPhone" value="+1-555-234-5678">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="patientEmail" value="johnson.family@email.com">
                </div>
                <div class="input-group">
                    <label>Address <span style="color: red;">*</span></label>
                    <input type="text" id="patientAddress" value="1247 Maple Street" required>
                </div>
                <div class="input-group">
                    <label>City <span style="color: red;">*</span></label>
                    <input type="text" id="patientCity" value="Springfield" required>
                </div>
                <div class="input-group">
                    <label>State <span style="color: red;">*</span></label>
                    <input type="text" id="patientState" value="Illinois" required>
                </div>
                <div class="input-group">
                    <label>ZIP Code <span style="color: red;">*</span></label>
                    <input type="text" id="patientZip" value="62701" required>
                </div>
                <div class="input-group">
                    <label>County</label>
                    <input type="text" id="patientCounty" value="Sangamon County">
                </div>
                <div class="input-group">
                    <label>Country</label>
                    <input type="text" id="patientCountry" value="United States">
                </div>
                <div class="input-group">
                    <label>Administrative Gender Code <span style="color: red;">*</span></label>
                    <select id="patientGender" required>
                        <option value="">Select Gender</option>
                        <option value="F" selected>Female</option>
                        <option value="M">Male</option>
                        <option value="UN">Undifferentiated</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Birth Date (YYYYMMDD)</label>
                    <input type="text" id="patientBirthDate" value="20240615">
                </div>
                <div class="input-group">
                    <label>Race Code <span style="color: red;">*</span></label>
                    <select id="patientRace" required>
                        <option value="">Select Race</option>
                        <option value="1002-5">American Indian or Alaska Native</option>
                        <option value="2028-9">Asian</option>
                        <option value="2054-5">Black or African American</option>
                        <option value="2076-8">Native Hawaiian or Other Pacific Islander</option>
                        <option value="2106-3" selected>White</option>
                        <option value="2131-1">Other Race</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Ethnicity Code <span style="color: red;">*</span></label>
                    <select id="patientEthnicity" required>
                        <option value="">Select Ethnicity</option>
                        <option value="2135-2">Hispanic or Latino</option>
                        <option value="2186-5" selected>Not Hispanic or Latino</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Birth Place</label>
                    <input type="text" id="patientBirthPlace" value="Memorial Hospital, Springfield, IL">
                </div>
                <div class="input-group">
                    <label>Birth Sex</label>
                    <select id="patientBirthSex">
                        <option value="F">Female</option>
                        <option value="M">Male</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Gender Identity</label>
                    <select id="patientGenderIdentity">
                        <option value="446151000124109">Identifies as female gender (finding)</option>
                        <option value="446141000124107">Identifies as male gender (finding)</option>
                        <option value="33791000087105">Identifies as nonbinary gender (finding)</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Detailed Race Code</label>
                    <select id="patientDetailedRace">
                        <option value="1004-1">American Indian</option>
                        <option value="1010-8">Alaska Native</option>
                        <option value="2029-7">Asian Indian</option>
                        <option value="2040-4">Chinese</option>
                        <option value="2047-9">Filipino</option>
                        <option value="2051-1">Japanese</option>
                        <option value="2054-5">Korean</option>
                        <option value="2058-6">Vietnamese</option>
                        <option value="2060-2">Other Asian</option>
                        <option value="2076-8">Black</option>
                        <option value="2108-9" selected>White</option>
                        <option value="2131-1">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Detailed Ethnicity Code</label>
                    <select id="patientDetailedEthnicity">
                        <option value="2137-8">Mexican</option>
                        <option value="2141-0">Puerto Rican</option>
                        <option value="2142-8">Cuban</option>
                        <option value="2148-5" selected>Not Hispanic or Latino</option>
                        <option value="2180-8">Other Hispanic or Latino</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Primary Language</label>
                    <input type="text" id="patientLanguage" value="en">
                </div>
                <div class="input-group">
                    <label>Death Indicator</label>
                    <select id="patientDeathIndicator">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Date of Death (YYYYMMDD)</label>
                    <input type="text" id="patientDeathDate" placeholder="Leave blank if alive">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Guardian/Parent Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Guardian Name</label>
                    <input type="text" id="guardianName" value="Sarah Michelle Johnson">
                </div>
                <div class="input-group">
                    <label>Guardian Phone</label>
                    <input type="text" id="guardianPhone" value="+1-555-234-5678">
                </div>
                <div class="input-group">
                    <label>Guardian Email</label>
                    <input type="email" id="guardianEmail" value="sarah.johnson@email.com">
                </div>
                <div class="input-group">
                    <label>Guardian Address</label>
                    <input type="text" id="guardianAddress" value="1247 Maple Street">
                </div>
                <div class="input-group">
                    <label>Guardian City</label>
                    <input type="text" id="guardianCity" value="Springfield">
                </div>
                <div class="input-group">
                    <label>Guardian State</label>
                    <input type="text" id="guardianState" value="Illinois">
                </div>
                <div class="input-group">
                    <label>Guardian ZIP Code</label>
                    <input type="text" id="guardianZip" value="62701">
                </div>
                <div class="input-group">
                    <label>Guardian Relationship Code</label>
                    <select id="guardianCode">
                        <option value="MTH">Mother</option>
                        <option value="FTH">Father</option>
                        <option value="GRMTH">Grandmother</option>
                        <option value="GRFTH">Grandfather</option>
                        <option value="GUARD">Guardian</option>
                        <option value="O">Other</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Provider Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Provider ID</label>
                    <input type="text" id="providerId" value="1234567890">
                </div>
                <div class="input-group">
                    <label>Provider Name</label>
                    <input type="text" id="providerName" value="Dr Royce Hemlock">
                </div>
                <div class="input-group">
                    <label>Provider Phone</label>
                    <input type="text" id="providerPhone" value="+1-555-777-0123">
                </div>
                <div class="input-group">
                    <label>Provider Email</label>
                    <input type="email" id="providerEmail" value="dr.hemlock@grmfc.gc.example.com">
                </div>
                <div class="input-group">
                    <label>Provider Fax</label>
                    <input type="text" id="providerFax" value="+1-555-777-0124">
                </div>
                <div class="input-group">
                    <label>Facility ID</label>
                    <input type="text" id="facilityId" value="FAC-987654321">
                </div>
                <div class="input-group">
                    <label>Facility Name</label>
                    <input type="text" id="facilityName" value="Grand Republic Medical Facility Clinic">
                </div>
                <div class="input-group">
                    <label>Facility Address</label>
                    <input type="text" id="facilityAddress" value="500 Republica Medical Plaza, Suite 1000">
                </div>
                <div class="input-group">
                    <label>Facility Type Code</label>
                    <select id="facilityTypeCode">
                        <option value="OF">Outpatient Facility</option>
                        <option value="HOSP">Hospital</option>
                        <option value="COMM">Community Hospital</option>
                        <option value="PROFF">Provider's Office</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Organization Name</label>
                    <input type="text" id="organizationName" value="Grand Republic Medical Corporation">
                </div>
                <div class="input-group">
                    <label>Organization ID</label>
                    <input type="text" id="organizationId" value="ORG-123456789">
                </div>
                <div class="input-group">
                    <label>Organization Phone</label>
                    <input type="text" id="organizationPhone" value="+1-555-777-1000">
                </div>
                <div class="input-group">
                    <label>Organization Email</label>
                    <input type="email" id="organizationEmail" value="info@grmfc.gc.example.com">
                </div>
                <div class="input-group">
                    <label>Organization Fax</label>
                    <input type="text" id="organizationFax" value="+1-555-777-1001">
                </div>
                <div class="input-group">
                    <label>Organization Address</label>
                    <input type="text" id="organizationAddress" value="500 Republica Medical Plaza">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Encounter Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Encounter ID</label>
                    <input type="text" id="encounterId" value="9937015">
                </div>
                <div class="input-group">
                    <label>Encounter Type</label>
                    <input type="text" id="encounterType" value="AMB">
                </div>
                <div class="input-group">
                    <label>Encounter Date (YYYYMMDD)</label>
                    <input type="text" id="encounterDate" value="20240615">
                </div>
                <div class="input-group">
                    <label>Encounter End Date (YYYYMMDD)</label>
                    <input type="text" id="encounterEndDate" value="20240615">
                </div>
                <div class="input-group">
                    <label>Encounter Disposition</label>
                    <select id="encounterDisposition">
                        <option value="01">Routine discharge/release to home or self care</option>
                        <option value="02">Discharge/transfer to another short term hospital</option>
                        <option value="03">Discharge/transfer to skilled nursing facility</option>
                        <option value="04">Discharge/transfer to an intermediate care facility</option>
                        <option value="05">Discharge/transfer to another type of institution</option>
                        <option value="06">Discharge/transfer to home under care of organized home health service</option>
                        <option value="07">Left against medical advice or discontinued care</option>
                        <option value="20">Expired</option>
                    </select>
                </div>
                <div class="input-group textarea-group">
                    <label>Chief Complaint</label>
                    <textarea id="chiefComplaint">fever, cough, exposure to COVID-19 hot zone</textarea>
                </div>
                <div class="input-group textarea-group">
                    <label>History of Present Illness</label>
                    <textarea id="presentIllness">The patient initially presented with difficulty breathing and fever. Patient disclosed recent travel to a known COVID-19 hot zone.</textarea>
                </div>
                <div class="input-group textarea-group">
                    <label>Reason for Visit</label>
                    <textarea id="reasonForVisit">Routine follow-up visit and COVID-19 screening due to exposure</textarea>
                </div>
                <div class="input-group textarea-group">
                    <label>Past Medical History</label>
                    <textarea id="pastMedicalHistory">No significant past medical history. No known allergies.</textarea>
                </div>
                <div class="input-group textarea-group">
                    <label>Review of Systems</label>
                    <textarea id="reviewOfSystems">Patient reports fever, fatigue, and mild cough. Denies chest pain, shortness of breath at rest.</textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Diagnoses with RCTC Trigger Codes</h2>
            <div class="form-grid">
                <!-- Diagnosis 1: Tetralogy of Fallot (Critical Cardiac Condition) -->
                <div class="input-group">
                    <label>Diagnosis 1 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="diagnosis1Code" value="67531005" onblur="validateTriggerCode('diagnosis1Code')">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('diagnosis1Code')">üîç</button>
                    </div>
                    <div id="diagnosis1Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Diagnosis 1 Name</label>
                    <div class="code-search">
                        <input type="text" id="diagnosis1Name" value="Down syndrome (disorder)">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('diagnosis1Name')">üîç</button>
                    </div>
                    <div id="diagnosis1Name_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Date of Diagnosis 1 (YYYYMMDD)</label>
                    <input type="text" id="diagnosis1Date" value="20240601">
                </div>
                <div class="input-group">
                    <label>Date of Onset 1 (YYYYMMDD)</label>
                    <input type="text" id="diagnosis1OnsetDate" value="20240601">
                </div>
                
                <!-- Diagnosis 2: Spina bifida (Neural Tube Defect) -->
                <div class="input-group">
                    <label>Diagnosis 2 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="diagnosis2Code" value="" onblur="validateTriggerCode('diagnosis2Code')">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('diagnosis2Code')">üîç</button>
                    </div>
                    <div id="diagnosis2Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Diagnosis 2 Name</label>
                    <div class="code-search">
                        <input type="text" id="diagnosis2Name" value="Spina bifida (disorder)">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('diagnosis2Name')">üîç</button>
                    </div>
                    <div id="diagnosis2Name_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Date of Diagnosis 2 (YYYYMMDD)</label>
                    <input type="text" id="diagnosis2Date" value="20240601">
                </div>
                <div class="input-group">
                    <label>Date of Onset 2 (YYYYMMDD)</label>
                    <input type="text" id="diagnosis2OnsetDate" value="20240601">
                </div>
                
                <!-- Diagnosis 3: Neonatal abstinence syndrome (Treatment-related Condition) -->
                <div class="input-group">
                    <label>Diagnosis 3 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="diagnosis3Code" value="" onblur="validateTriggerCode('diagnosis3Code')">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('diagnosis3Code')">üîç</button>
                    </div>
                    <div id="diagnosis3Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Diagnosis 3 Name</label>
                    <div class="code-search">
                        <input type="text" id="diagnosis3Name" value="Neonatal abstinence syndrome (disorder)">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('diagnosis3Name')">üîç</button>
                    </div>
                    <div id="diagnosis3Name_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Date of Diagnosis 3 (YYYYMMDD)</label>
                    <input type="text" id="diagnosis3Date" value="20240610">
                </div>
                <div class="input-group">
                    <label>Date of Onset 3 (YYYYMMDD)</label>
                    <input type="text" id="diagnosis3OnsetDate" value="20240610">
                </div>
                <div class="input-group">
                    <label>Problem Type</label>
                    <select id="problemType">
                        <option value="55607006">Problem</option>
                        <option value="282291009">Diagnosis</option>
                        <option value="404684003">Finding</option>
                        <option value="418799008">Symptom</option>
                    </select>
                </div>
                <div class="input-group textarea-group">
                    <label>Symptoms</label>
                    <textarea id="symptoms">Fever, cough, fatigue, and respiratory symptoms consistent with viral infection</textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Laboratory Tests with RCTC Trigger Codes</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Lab Test 1 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="labTest1Code" value="94310-0" onblur="validateTriggerCode('labTest1Code')">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('labTest1Code')">üîç</button>
                    </div>
                    <div id="labTest1Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Lab Test 1 Name</label>
                    <div class="code-search">
                        <input type="text" id="labTest1Name" value="SARS-like Coronavirus N gene [Presence] in Unspecified specimen by NAA with probe detection">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('labTest1Name')">üîç</button>
                    </div>
                    <div id="labTest1Name_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Lab Test 1 Result</label>
                    <select id="labTest1Result">
                        <option value="Detected">Detected</option>
                        <option value="Not Detected">Not Detected</option>
                        <option value="Positive">Positive</option>
                        <option value="Negative">Negative</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="labTest2Code" value="34487-9" onblur="validateTriggerCode('labTest2Code')">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('labTest2Code')">üîç</button>
                    </div>
                    <div id="labTest2Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Name</label>
                    <div class="code-search">
                        <input type="text" id="labTest2Name" value="Influenza virus A RNA [Presence] in Respiratory specimen by NAA with probe detection">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('labTest2Name')">üîç</button>
                    </div>
                    <div id="labTest2Name_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Result</label>
                    <select id="labTest2Result">
                        <option value="Detected">Detected</option>
                        <option value="Not Detected">Not Detected</option>
                        <option value="Positive">Positive</option>
                        <option value="Negative">Negative</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Lab Order 1 Code</label>
                    <input type="text" id="labOrder1Code" value="19080-1">
                </div>
                <div class="input-group">
                    <label>Lab Order 1 ID</label>
                    <input type="text" id="labOrder1Id" value="ORD-2024-001">
                </div>
                <div class="input-group">
                    <label>Lab Order 1 Time (YYYYMMDDHHMMSS)</label>
                    <input type="text" id="labOrder1Time" value="20240615080000">
                </div>
                <div class="input-group">
                    <label>Lab Test 1 Status</label>
                    <select id="labTest1Status">
                        <option value="completed">Completed</option>
                        <option value="active">Active</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Lab Test 1 Time (YYYYMMDDHHMMSS)</label>
                    <input type="text" id="labTest1Time" value="20240615100000">
                </div>
                <div class="input-group">
                    <label>Lab Test 1 Interpretation</label>
                    <select id="labTest1Interpretation">
                        <option value="A">Abnormal</option>
                        <option value="N">Normal</option>
                        <option value="H">High</option>
                        <option value="L">Low</option>
                        <option value="HH">Critical high</option>
                        <option value="LL">Critical low</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Lab Test 1 Reference Range</label>
                    <input type="text" id="labTest1ReferenceRange" value="2.5-15.0 ng/mL">
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Status</label>
                    <select id="labTest2Status">
                        <option value="completed">Completed</option>
                        <option value="active">Active</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Time (YYYYMMDDHHMMSS)</label>
                    <input type="text" id="labTest2Time" value="20240615110000">
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Interpretation</label>
                    <select id="labTest2Interpretation">
                        <option value="A">Abnormal</option>
                        <option value="N">Normal</option>
                        <option value="H">High</option>
                        <option value="L">Low</option>
                        <option value="HH">Critical high</option>
                        <option value="LL">Critical low</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Lab Test 2 Reference Range</label>
                    <input type="text" id="labTest2ReferenceRange" value="Negative-Positive">
                </div>
            </div>
        </div>

        <!-- Lab Orders and Results Section -->
        <div class="section">
            <h2 class="section-title">Lab Orders and Results</h2>
            
            <div class="lab-evidence-controls">
                <button class="btn btn-primary" type="button" onclick="addLabEvidence()">‚ûï Add Lab Order and Result</button>
            </div>
            
            <div id="labEvidenceList"></div>
            
            <template id="labEvidenceTemplate">
                <div class="lab-evidence-row">
                    <h4>Lab Order and Result Entry</h4>
                    <div class="form-grid">
                        <!-- Test Information -->
                        <div class="input-group">
                            <label>Test Code (LOINC) <span class="trigger-indicator">RCTC TRIGGER</span></label>
                            <div class="code-search">
                                <input type="text" class="le-test-code" placeholder="ex. 94310-0">
                                <button class="btn btn-secondary" type="button" onclick="searchRCTCForTest(this)">üîç</button>
                            </div>
                            <div class="le-test-code-results search-results"></div>
                        </div>
                        <div class="input-group">
                            <label>Test Name</label>
                            <div class="code-search">
                                <input type="text" class="le-test-name" placeholder="SARS-like Coronavirus N gene">
                                <button class="btn btn-secondary" type="button" onclick="searchRCTCForTestByName(this)">üîç</button>
                            </div>
                            <div class="le-test-name-results search-results"></div>
                        </div>
                        
                        <!-- Result Value Type Selector -->
                        <div class="input-group">
                            <label>Result Kind</label>
                            <select class="le-value-kind" onchange="toggleValueEditors(this)">
                                <option value="coded" selected>Coded (organism/substance)</option>
                                <option value="quantity">Quantity</option>
                                <option value="text">Text</option>
                            </select>
                        </div>
                        
                        <!-- Coded Value (SNOMED CT) -->
                        <div class="input-group le-coded">
                            <label>Organism/Substance Code (SNOMED CT)</label>
                            <div class="code-search">
                                <input type="text" class="le-value-code" placeholder="ex. 840539006">
                                <button class="btn btn-secondary" type="button" onclick="searchRCTCForOrganism(this)">üîç</button>
                            </div>
                            <div class="le-value-code-results search-results"></div>
                        </div>
                        <div class="input-group le-coded">
                            <label>Organism/Substance Name</label>
                            <div class="code-search">
                                <input type="text" class="le-value-name" placeholder="Disease caused by 2019-nCoV">
                                <button class="btn btn-secondary" type="button" onclick="searchRCTCForOrganismByName(this)">üîç</button>
                            </div>
                            <div class="le-value-name-results search-results"></div>
                        </div>
                        
                        <!-- Quantity Value -->
                        <div class="input-group le-qty hidden">
                            <label>Value</label>
                            <input type="number" step="0.01" class="le-qty-value" placeholder="ex. 100">
                        </div>
                        <div class="input-group le-qty hidden">
                            <label>Unit</label>
                            <input type="text" class="le-qty-unit" placeholder="[iU]/mL">
                        </div>
                        
                        <!-- Text Value -->
                        <div class="input-group le-text hidden">
                            <label>Text Result</label>
                            <input type="text" class="le-text-value" placeholder="Detected / Not detected">
                        </div>
                        
                        <!-- Timing/Status -->
                        <div class="input-group">
                            <label>Result Time (YYYYMMDDHHMMSS)</label>
                            <input type="text" class="le-time" placeholder="20240615103000">
                        </div>
                        <div class="input-group">
                            <label>Status</label>
                            <select class="le-status">
                                <option value="completed" selected>completed</option>
                                <option value="active">active</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Interpretation</label>
                            <select class="le-interpretation">
                                <option value=""></option>
                                <option value="A">Abnormal</option>
                                <option value="N">Normal</option>
                                <option value="H">High</option>
                                <option value="L">Low</option>
                            </select>
                        </div>
                        
                        
                        <div>
                            <button class="btn btn-warning" type="button" onclick="removeLabEvidence(this)">üóë Remove</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

<!-- ‚ñë‚ñë‚ñë  MEDICATIONS  ‚ñë‚ñë‚ñë================================================ -->
<div class="section">
  <h2 class="section-title">Medications</h2>

  <div class="form-grid">

   <!-- Administering Provider (single provider for ALL administered meds) -->
<div class="input-group">
  <label>Administering Provider NPI</label>
  <input type="text" id="administeringProviderNPI" inputmode="numeric" pattern="\d{10}" placeholder="10-digit NPI">
</div>

<div class="input-group">
  <label>First</label>
  <input type="text" id="administeringProviderGiven">
</div>

<div class="input-group">
  <label>Last</label>
  <input type="text" id="administeringProviderFamily">
</div>

<div class="input-group">
  <label>Phone (opt)</label>
  <input type="tel" id="administeringProviderPhone" placeholder="555-555-5555">
</div>

<div class="input-group">
  <label>Organization (opt)</label>
  <input type="text" id="administeringProviderOrgName">
</div>

<div class="input-group">
  <label>Org ID (extension) (opt)</label>
  <input type="text" id="administeringProviderOrgId" placeholder="Facility ID/Code">
</div>

<div class="input-group">
  <label>Org ID Root (OID) (opt)</label>
  <input type="text" id="administeringProviderOrgIdRoot" value="2.16.840.1.113883.19">
</div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Administered Medication 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="input-group">
      <label>Administered Medication 1 Code</label>
      <input type="text" id="adminMed1Code" value="42946">
    </div>

    <div class="input-group">
      <label>Administered Medication 1 Name</label>
      <input type="text" id="adminMed1Name" value="Folic acid">
    </div>

    <div class="input-group">
      <label>Administration ID 1</label>
      <input type="text" id="adminMed1Id" value="MED-2024-001">
    </div>

    <div class="input-group">
      <label>Administration Status 1</label>
      <select id="adminMed1Status">
        <option value="completed">Completed</option>
        <option value="active">Active</option>
        <option value="suspended">Suspended</option>
        <option value="aborted">Aborted</option>
      </select>
    </div>

    <div class="input-group">
      <label>Administration Time 1 (YYYYMMDDHHMMSS)</label>
      <input type="text" id="adminMed1Time" value="20240615120000">
    </div>

    <div class="input-group">
      <label>Route 1</label>
      <select id="adminMed1Route">
        <option value="PO">Oral</option>
        <option value="IV">Intravenous</option>
        <option value="IM">Intramuscular</option>
        <option value="SC">Subcutaneous</option>
        <option value="SL">Sublingual</option>
        <option value="TOP">Topical</option>
        <option value="INH">Inhalation</option>
      </select>
    </div>

    <!-- ‚Äî NEW dose widgets ‚Äî -->
    <div class="input-group">
      <label>Dose 1 ‚Ä¢ Amount</label>
      <input type="number" step="0.01" id="adminMed1DoseValue" value="0.4">
    </div>

    <div class="input-group">
      <label>Dose 1 ‚Ä¢ Unit</label>
      <select id="adminMed1DoseUnit">
        <option value="mg">mg</option>
        <option value="mcg">mcg</option>
        <option value="g">g</option>
        <option value="mL">mL</option>
        <option value="1">each / tablet</option>
      </select>
    </div>

    <div class="input-group">
      <label>Dose 1 ‚Ä¢ Volume (opt)</label>
      <input type="number" step="0.01" id="adminMed1VolValue" placeholder="0.5">
    </div>

    <div class="input-group">
      <label>Vol ‚Ä¢ Unit</label>
      <select id="adminMed1VolUnit">
        <option value=""></option>
        <option value="mL">mL</option>
        <option value="L">L</option>
      </select>
    </div>

    <div class="input-group">
      <label><input type="checkbox" id="adminMed1Negated"> NOT given</label>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Administered Medication 2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="input-group">
      <label>Administered Medication 2 Code</label>
      <input type="text" id="adminMed2Code" value="161">
    </div>

    <div class="input-group">
      <label>Administered Medication 2 Name</label>
      <input type="text" id="adminMed2Name" value="Multivitamin preparation">
    </div>

    <div class="input-group">
      <label>Administration ID 2</label>
      <input type="text" id="adminMed2Id" value="MED-2024-002">
    </div>

    <div class="input-group">
      <label>Administration Status 2</label>
      <select id="adminMed2Status">
        <option value="completed">Completed</option>
        <option value="active">Active</option>
        <option value="suspended">Suspended</option>
        <option value="aborted">Aborted</option>
      </select>
    </div>

    <div class="input-group">
      <label>Administration Time 2 (YYYYMMDDHHMMSS)</label>
      <input type="text" id="adminMed2Time" value="20240615130000">
    </div>

    <div class="input-group">
      <label>Route 2</label>
      <select id="adminMed2Route">
        <option value="PO">Oral</option>
        <option value="IV">Intravenous</option>
        <option value="IM">Intramuscular</option>
        <option value="SC">Subcutaneous</option>
        <option value="SL">Sublingual</option>
        <option value="TOP">Topical</option>
        <option value="INH">Inhalation</option>
      </select>
    </div>

    <!-- ‚Äî NEW dose widgets ‚Äî -->
    <div class="input-group">
      <label>Dose 2 ‚Ä¢ Amount</label>
      <input type="number" step="0.01" id="adminMed2DoseValue" value="1">
    </div>

    <div class="input-group">
      <label>Dose 2 ‚Ä¢ Unit</label>
      <select id="adminMed2DoseUnit">
        <option value="mg">mg</option>
        <option value="mcg">mcg</option>
        <option value="g">g</option>
        <option value="mL">mL</option>
        <option value="1" selected>each / tablet</option>
      </select>
    </div>

    <div class="input-group">
      <label>Dose 2 ‚Ä¢ Volume (opt)</label>
      <input type="number" step="0.01" id="adminMed2VolValue" placeholder="">
    </div>

    <div class="input-group">
      <label>Vol ‚Ä¢ Unit</label>
      <select id="adminMed2VolUnit">
        <option value=""></option>
        <option value="mL">mL</option>
        <option value="L">L</option>
      </select>
    </div>

    <div class="input-group">
      <label><input type="checkbox" id="adminMed2Negated"> NOT given</label>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Planned Medication (unchanged) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="input-group">
      <label>Planned Medication 1 Code</label>
      <input type="text" id="plannedMed1Code" value="161">
    </div>

    <div class="input-group">
      <label>Planned Medication 1 Name</label>
      <input type="text" id="plannedMed1Name" value="Multivitamin with iron">
    </div>

    <div class="input-group">
      <label>Planned Medication 1 Instructions</label>
      <textarea id="plannedMed1Instructions">
Take 1 tablet daily with food for nutritional support during neural tube defect management
      </textarea>
    </div>

  </div>
</div>
<!-- ‚ñë‚ñë‚ñë=============================================================== -->


        <div class="section">
            <h2 class="section-title">Immunizations</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Immunization 1 Status</label>
                    <select id="immunization1Status">
                        <option value="completed" selected>Completed</option>
                        <option value="not-done">Not Done</option>
                        <option value="refused">Refused</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Immunization 1 ID</label>
                    <input type="text" id="immunization1Id" placeholder="e.g., IMM-001" value="HepB-NB-001">
                </div>
                <div class="input-group">
                    <label>Immunization 1 Date (YYYYMMDD)</label>
                    <input type="text" id="immunization1Date" placeholder="e.g., 20250201" value="20240615">
                </div>
                <div class="input-group">
                    <label>Vaccine 1 Code</label>
                    <input type="text" id="vaccine1Code" placeholder="e.g., 207" value="08">
                </div>
                <div class="input-group">
                    <label>Vaccine 1 Name</label>
                    <input type="text" id="vaccine1Name" placeholder="e.g., COVID-19 mRNA vaccine" value="Hepatitis B vaccine, pediatric or pediatric/adolescent dosage">
                </div>
                <div class="input-group">
                    <label>Dose Quantity 1</label>
                    <input type="text" id="vaccine1Dose" placeholder="e.g., 0.3 mL" value="0.5 mL">
                </div>
                <div class="input-group">
                    <label>Route 1</label>
                    <select id="vaccine1Route">
                        <option value="IM" selected>Intramuscular</option>
                        <option value="SC">Subcutaneous</option>
                        <option value="ID">Intradermal</option>
                        <option value="PO">Oral</option>
                        <option value="IN">Intranasal</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Manufacturer 1</label>
                    <input type="text" id="vaccine1Manufacturer" placeholder="e.g., Pfizer-BioNTech" value="Merck Co, Inc.">
                </div>
                <div class="input-group">
                    <label>Immunization 2 Status</label>
                    <select id="immunization2Status">
                        <option value="completed" selected>Completed</option>
                        <option value="not-done">Not Done</option>
                        <option value="refused">Refused</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Immunization 2 ID</label>
                    <input type="text" id="immunization2Id" placeholder="e.g., IMM-002" value="VitK-NB-001">
                </div>
                <div class="input-group">
                    <label>Immunization 2 Date (YYYYMMDD)</label>
                    <input type="text" id="immunization2Date" placeholder="e.g., 20250101" value="20240615">
                </div>
                <div class="input-group">
                    <label>Vaccine 2 Code</label>
                    <input type="text" id="vaccine2Code" placeholder="e.g., 141" value="87567">
                </div>
                <div class="input-group">
                    <label>Vaccine 2 Name</label>
                    <input type="text" id="vaccine2Name" placeholder="e.g., Influenza vaccine" value="Vitamin K1 injection (phytonadione)">
                </div>
                <div class="input-group">
                    <label>Dose Quantity 2</label>
                    <input type="text" id="vaccine2Dose" placeholder="e.g., 0.5 mL" value="1 mg (0.5 mL)">
                </div>
                <div class="input-group">
                    <label>Route 2</label>
                    <select id="vaccine2Route">
                        <option value="IM" selected>Intramuscular</option>
                        <option value="SC">Subcutaneous</option>
                        <option value="ID">Intradermal</option>
                        <option value="PO">Oral</option>
                        <option value="IN">Intranasal</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Manufacturer 2</label>
                    <input type="text" id="vaccine2Manufacturer" placeholder="e.g., Sanofi Pasteur" value="Hospira Inc.">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Pregnancy Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Pregnancy Status</label>
                    <select id="pregnancyStatus">
                        <option value="77386006">Pregnant</option>
                        <option value="60001007" selected>Not pregnant</option>
                        <option value="102874004">Possible pregnancy</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Pregnancy Effective Time (YYYYMMDD)</label>
                    <input type="text" id="pregnancyEffectiveTime" placeholder="Date of assessment" value="20240615">
                </div>
                <div class="input-group">
                    <label>Estimated Delivery Date (YYYYMMDD)</label>
                    <input type="text" id="estimatedDeliveryDate" placeholder="Expected delivery date" value="20240615">
                </div>
                <div class="input-group">
                    <label>Pregnancy Determination Method</label>
                    <select id="pregnancyDeterminationMethod">
                        <option value="169560004">Urine pregnancy test</option>
                        <option value="167252002">Serum pregnancy test</option>
                        <option value="12611008" selected>Ultrasound examination</option>
                        <option value="271900007">Patient reported</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Gestational Age (weeks)</label>
                    <input type="text" id="gestationalAge" placeholder="e.g., 12" value="39">
                </div>
                <div class="input-group">
                    <label>Last Menstrual Period (YYYYMMDD)</label>
                    <input type="text" id="lastMenstrualPeriod" placeholder="Date of LMP" value="20230906">
                </div>
                <div class="input-group">
                    <label>Pregnancy Outcome</label>
                    <select id="pregnancyOutcome">
                        <option value="281050002" selected>Live birth</option>
                        <option value="237364002">Stillbirth</option>
                        <option value="17369002">Miscarriage</option>
                        <option value="69422002">Elective termination</option>
                        <option value="N/A">Not applicable</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Postpartum Status</label>
                    <select id="postpartumStatus">
                        <option value="255410009" selected>Postpartum</option>
                        <option value="255409004">Not postpartum</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Travel History</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Travel Start Date (YYYYMMDD)</label>
                    <input type="text" id="travelStartDate" value="20240515">
                </div>
                <div class="input-group">
                    <label>Travel End Date (YYYYMMDD)</label>
                    <input type="text" id="travelEndDate" value="20240520">
                </div>
                <div class="input-group">
                    <label>Travel Location</label>
                    <input type="text" id="travelLocation" value="Chicago, Illinois">
                </div>
                <div class="input-group">
                    <label>Travel Location Code</label>
                    <input type="text" id="travelLocationCode" value="IL">
                </div>
                <div class="input-group">
                    <label>Travel Address</label>
                    <input type="text" id="travelAddress" value="123 Oak Street, Springfield, IL 62701">
                </div>
                <div class="input-group">
                    <label>Purpose of Travel</label>
                    <select id="purposeOfTravel">
                        <option value="224930009">Business</option>
                        <option value="289049007" selected>Leisure</option>
                        <option value="385731004">Medical</option>
                        <option value="224930009">Educational</option>
                        <option value="O">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Transportation Type</label>
                    <select id="transportationType">
                        <option value="73957001">Air transport</option>
                        <option value="49122002" selected>Ground transport</option>
                        <option value="272125009">Water transport</option>
                        <option value="34965002">Public transport</option>
                        <option value="71783008">Private transport</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Transportation Details</label>
                    <textarea id="transportationDetails">Personal vehicle - 2022 Honda Pilot, License plate: ABC-1234</textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Occupation Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Current Occupation</label>
                    <input type="text" id="currentOccupation" value="Marketing Manager">
                </div>
                <div class="input-group">
                    <label>Usual Occupation</label>
                    <input type="text" id="usualOccupation" value="Marketing Manager">
                </div>
                <div class="input-group">
                    <label>Current Industry</label>
                    <input type="text" id="currentIndustry" value="Healthcare Services">
                </div>
                <div class="input-group">
                    <label>Usual Industry</label>
                    <input type="text" id="usualIndustry" value="Healthcare Services">
                </div>
                <div class="input-group">
                    <label>Current Job Title</label>
                    <input type="text" id="currentJobTitle" value="Senior Marketing Manager">
                </div>
                <div class="input-group">
                    <label>Current Employer Name</label>
                    <input type="text" id="currentEmployerName" value="Springfield Medical Center">
                </div>
                <div class="input-group">
                    <label>Current Employer Phone</label>
                    <input type="text" id="currentEmployerPhone" value="+1-217-555-0155">
                </div>
                <div class="input-group">
                    <label>Current Employer Address</label>
                    <input type="text" id="currentEmployerAddress" value="800 E Capitol Ave, Springfield, IL 62701">
                </div>
                <div class="input-group">
                    <label>Occupational Exposure</label>
                    <select id="occupationalExposure">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Employment Status</label>
                    <select id="employmentStatus">
                        <option value="1" selected>Employed</option>
                        <option value="2">Unemployed</option>
                        <option value="3">Not in labor force</option>
                        <option value="4">Retired</option>
                        <option value="5">Student</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Specimen Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Specimen 1 Source</label>
                    <select id="specimen1Source">
                        <option value="258500001">Nasopharyngeal swab</option>
                        <option value="461911000124106">Oropharyngeal swab</option>
                        <option value="258580003" selected>Whole blood sample</option>
                        <option value="122555007">Venous blood sample</option>
                        <option value="309051001">Body fluid sample</option>
                        <option value="119295008">Specimen obtained by aspiration</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Specimen 1 Type</label>
                    <input type="text" id="specimen1Type" placeholder="e.g., Swab" value="Whole blood">
                </div>
                <div class="input-group">
                    <label>Specimen 1 ID</label>
                    <input type="text" id="specimen1Id" placeholder="e.g., SPEC-001" value="NB-BLOOD-20240615-001">
                </div>
                <div class="input-group">
                    <label>Collection Date 1 (YYYYMMDDHHMMSS)</label>
                    <input type="text" id="collection1Date" placeholder="e.g., 20250216110000" value="20240615083000">
                </div>
                <div class="input-group">
                    <label>Specimen 2 Source</label>
                    <select id="specimen2Source">
                        <option value="258500001">Nasopharyngeal swab</option>
                        <option value="461911000124106">Oropharyngeal swab</option>
                        <option value="258580003">Whole blood sample</option>
                        <option value="122555007">Venous blood sample</option>
                        <option value="309051001" selected>Body fluid sample</option>
                        <option value="119295008">Specimen obtained by aspiration</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Specimen 2 Type</label>
                    <input type="text" id="specimen2Type" placeholder="e.g., Blood" value="Cerebrospinal fluid">
                </div>
                <div class="input-group">
                    <label>Specimen 2 ID</label>
                    <input type="text" id="specimen2Id" placeholder="e.g., SPEC-002" value="NB-CSF-20240615-001">
                </div>
                <div class="input-group">
                    <label>Collection Date 2 (YYYYMMDDHHMMSS)</label>
                    <input type="text" id="collection2Date" placeholder="e.g., 20250216120000" value="20240615093000">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Additional Clinical Data</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Temperature (¬∞F)</label>
                    <input type="text" id="temperature" placeholder="e.g., 98.6" value="97.8">
                </div>
                <div class="input-group">
                    <label>Blood Pressure (mmHg)</label>
                    <input type="text" id="bloodPressure" placeholder="e.g., 120/80" value="65/42">
                </div>
                <div class="input-group">
                    <label>Heart Rate (bpm)</label>
                    <input type="text" id="heartRate" placeholder="e.g., 72" value="145">
                </div>
                <div class="input-group">
                    <label>Respiratory Rate (breaths/min)</label>
                    <input type="text" id="respiratoryRate" placeholder="e.g., 16" value="38">
                </div>
                <div class="input-group">
                    <label>Oxygen Saturation (%)</label>
                    <input type="text" id="oxygenSaturation" placeholder="e.g., 98" value="97">
                </div>
                <div class="input-group">
                    <label>Weight (lbs)</label>
                    <input type="text" id="weight" placeholder="e.g., 150" value="6.2">
                </div>
                <div class="input-group">
                    <label>Height (inches)</label>
                    <input type="text" id="height" placeholder="e.g., 68" value="19.5">
                </div>
                <div class="input-group">
                    <label>BMI</label>
                    <input type="text" id="bmi" placeholder="e.g., 22.8" value="13.2">
                </div>
                <div class="input-group">
                    <label>Therapeutic Response</label>
                    <select id="therapeuticResponse">
                        <option value="182840001" selected>Good response</option>
                        <option value="182841002">Poor response</option>
                        <option value="182842009">No response</option>
                        <option value="182843004">Partial response</option>
                        <option value="385655000">Not applicable</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Homeless Status</label>
                    <select id="homelessStatus">
                        <option value="105526001">Homeless</option>
                        <option value="105529008" selected>Not homeless</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Congregate Living</label>
                    <select id="congregateLiving">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Congregate Living Type</label>
                    <select id="congregateLivingType">
                        <option value="224683003">Nursing home</option>
                        <option value="42665001">School</option>
                        <option value="264362003">Prison</option>
                        <option value="257656006">Dormitory</option>
                        <option value="224891009">Shelter</option>
                        <option value="O" selected>Other</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Procedures</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Current Procedure 1 Code</label>
                    <input type="text" id="currentProc1Code" placeholder="e.g., 33747-0" value="80146002">
                </div>
                <div class="input-group">
                    <label>Current Procedure 1 Name</label>
                    <input type="text" id="currentProc1Name" placeholder="e.g., Bronchoscopy" value="Excision of spinal lesion">
                </div>
                <div class="input-group">
                    <label>Current Procedure 1 Date (YYYYMMDD)</label>
                    <input type="text" id="currentProc1Date" placeholder="e.g., 20250216" value="20240615">
                </div>
                <div class="input-group">
                    <label>Current Procedure 1 Type</label>
                    <select id="currentProc1Type">
                        <option value="act">Act</option>
                        <option value="observation">Observation</option>
                        <option value="procedure" selected>Procedure</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Current Procedure 2 Code</label>
                    <input type="text" id="currentProc2Code" placeholder="e.g., 71388002" value="241615005">
                </div>
                <div class="input-group">
                    <label>Current Procedure 2 Name</label>
                    <input type="text" id="currentProc2Name" placeholder="e.g., Chest X-ray" value="Magnetic resonance imaging of spine">
                </div>
                <div class="input-group">
                    <label>Current Procedure 2 Date (YYYYMMDD)</label>
                    <input type="text" id="currentProc2Date" placeholder="e.g., 20250216" value="20240615">
                </div>
                <div class="input-group">
                    <label>Current Procedure 2 Type</label>
                    <select id="currentProc2Type">
                        <option value="act">Act</option>
                        <option value="observation" selected>Observation</option>
                        <option value="procedure">Procedure</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Trigger Procedure 1 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="triggerProc1Code" placeholder="e.g., 168731009" onblur="validateTriggerCode('triggerProc1Code')" value="230690007">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('triggerProc1Code')">üîç</button>
                    </div>
                    <div id="triggerProc1Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Trigger Procedure 1 Name</label>
                    <input type="text" id="triggerProc1Name" placeholder="e.g., Intubation" value="Stroke">
                </div>
                <div class="input-group">
                    <label>Trigger Procedure 1 Date (YYYYMMDD)</label>
                    <input type="text" id="triggerProc1Date" placeholder="e.g., 20250216" value="20240615">
                </div>
                <div class="input-group">
                    <label>Trigger Procedure 1 Type</label>
                    <select id="triggerProc1Type">
                        <option value="act">Act</option>
                        <option value="observation" selected>Observation</option>
                        <option value="procedure">Procedure</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Planned Procedure 1 Code</label>
                    <input type="text" id="plannedProc1Code" placeholder="e.g., 182836005" value="182836005">
                </div>
                <div class="input-group">
                    <label>Planned Procedure 1 Name</label>
                    <input type="text" id="plannedProc1Name" placeholder="e.g., Follow-up CT scan" value="Neurosurgical follow-up">
                </div>
                <div class="input-group">
                    <label>Planned Procedure 1 Date (YYYYMMDD)</label>
                    <input type="text" id="plannedProc1Date" placeholder="e.g., 20250220" value="20240715">
                </div>
                <div class="input-group">
                    <label>Planned Procedure 1 Type</label>
                    <select id="plannedProc1Type">
                        <option value="act" selected>Act</option>
                        <option value="observation">Observation</option>
                        <option value="procedure">Procedure</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Special Populations and Demographics</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Disability Status</label>
                    <select id="disabilityStatus">
                        <option value="21134002" selected>Disabled</option>
                        <option value="405159006">Not disabled</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Disability Type</label>
                    <input type="text" id="disabilityType" value="Spina bifida - congenital neural tube defect">
                </div>
                <div class="input-group">
                    <label>Tribal Affiliation</label>
                    <input type="text" id="tribalAffiliation" value="Not applicable">
                </div>
                <div class="input-group">
                    <label>Tribal Enrollment</label>
                    <select id="tribalEnrollment">
                        <option value="true">Yes</option>
                        <option value="false" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Country of Nationality</label>
                    <input type="text" id="countryOfNationality" value="United States">
                </div>
                <div class="input-group">
                    <label>Country of Nationality Code</label>
                    <input type="text" id="countryOfNationalityCode" value="US">
                </div>
                <div class="input-group">
                    <label>Country of Residence</label>
                    <input type="text" id="countryOfResidence" value="United States">
                </div>
                <div class="input-group">
                    <label>Country of Residence Code</label>
                    <input type="text" id="countryOfResidenceCode" value="US">
                </div>
                <div class="input-group">
                    <label>Immigration Status</label>
                    <select id="immigrationStatus">
                        <option value="160542002" selected>US Citizen</option>
                        <option value="160540005">Permanent Resident</option>
                        <option value="160541006">Temporary Resident</option>
                        <option value="160543007">Undocumented</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Preferred Language</label>
                    <input type="text" id="preferredLanguage" value="English">
                </div>
                <div class="input-group">
                    <label>Interpreter Needed</label>
                    <select id="interpreterNeeded">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Insurance Status</label>
                    <select id="insuranceStatus">
                        <option value="48758009" selected>Insured</option>
                        <option value="182890002">Uninsured</option>
                        <option value="182891003">Self-pay</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Emergency and Public Health</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Emergency Outbreak Information</label>
                    <select id="emergencyOutbreakInfo">
                        <option value="443684005">Disease outbreak</option>
                        <option value="410546004">Public health emergency</option>
                        <option value="N/A" selected>Not applicable</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Outbreak Details</label>
                    <textarea id="outbreakDetails">No current outbreak or emergency situation related to this case</textarea>
                </div>
                <div class="input-group">
                    <label>Exposure/Contact Information</label>
                    <select id="exposureContactInfo">
                        <option value="24932003">Exposed</option>
                        <option value="84100007">Contact</option>
                        <option value="373068000" selected>No exposure</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Exposure Type</label>
                    <select id="exposureType">
                        <option value="409822003">Direct contact</option>
                        <option value="417746004">Airborne</option>
                        <option value="418038007">Droplet</option>
                        <option value="447964005">Contact precaution</option>
                        <option value="OTH" selected>Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Exposure Location</label>
                    <input type="text" id="exposureLocation" value="Not applicable - congenital condition">
                </div>
                <div class="input-group">
                    <label>Exposure Date (YYYYMMDD)</label>
                    <input type="text" id="exposureDate" value="Not applicable">
                </div>
                <div class="input-group">
                    <label>Contact Person Name</label>
                    <input type="text" id="contactPersonName" value="Dr. Patricia Williams, MD">
                </div>
                <div class="input-group">
                    <label>Contact Person Phone</label>
                    <input type="text" id="contactPersonPhone" value="+1-217-555-0199">
                </div>
                <div class="input-group">
                    <label>Vaccine Credential Patient Assertion</label>
                    <select id="vaccineCredentialAssertion">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Vaccine Card Available</label>
                    <select id="vaccineCardAvailable">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Quarantine Status</label>
                    <select id="quarantineStatus">
                        <option value="182856006">In quarantine</option>
                        <option value="182857002">Released from quarantine</option>
                        <option value="405178008" selected>Not in quarantine</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Isolation Status</label>
                    <select id="isolationStatus">
                        <option value="40174006">In isolation</option>
                        <option value="182840001">Released from isolation</option>
                        <option value="385432009" selected>Not in isolation</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Related Document Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Document ID</label>
                    <input type="text" id="documentId" value="10c13861-86a8-4a9a-aec6-b615921178df">
                </div>
                <div class="input-group">
                    <label>Effective Time</label>
                    <input type="text" id="effectiveTime" value="20240615150000-0500">
                </div>
                <div class="input-group">
                    <label>Document Relationship Type <span class="help-tooltip" title="Defines how this document relates to other documents. Use 'New Document' for standalone documents, or 'Replace/Update Document' to supersede or modify an existing document.">‚ÑπÔ∏è</span></label>
                    <select id="documentRelationshipType" onchange="handleRelationshipTypeChange()">
                        <option value="NEW" selected>New Document</option>
                        <option value="RPLC">Replace/Update Document</option>
                    </select>
                </div>
                <div class="input-group" id="relatedDocIdGroup" style="display: none;">
                    <label>Related Document Set ID <span style="color: red;">*</span> <span class="help-tooltip" title="The Set ID of the original document you are replacing/updating. This will become the Set ID for this new version. Required when relationship type is not 'New Document'.">‚ÑπÔ∏è</span></label>
                    <input type="text" id="relatedDocumentId" placeholder="Enter the Set ID of the original document" onchange="handleRelatedDocumentIdChange()">
                </div>
                <div class="input-group" id="setIdGroup">
                    <label>Set ID <span class="help-tooltip" title="Unique identifier that stays the same across all versions of the same logical document. Documents with the same Set ID represent different versions of the same document.">‚ÑπÔ∏è</span></label>
                    <input type="text" id="setId" value="8d86218e-0fea-11eb-8216-a80388425cfb">
                </div>
                <div class="input-group">
                    <label>Version Number <span class="help-tooltip" title="Sequential number that increments with each new version of the document. Same Set ID + higher version number = newer version.">‚ÑπÔ∏è</span></label>
                    <input type="text" id="versionNumber" value="3">
                </div>
                <div class="help-text">
                    <h4>Document Relationship Guide:</h4>
                    <ul>
                        <li><strong>New Document:</strong> Creates a standalone document with a unique Set ID and version 1</li>
                        <li><strong>Replace/Update Document:</strong> Creates a new version of an existing document by entering the original document's Set ID and incrementing the version number</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Local XSLT files (no CORS issues)
        const EICR_XSL_URL = './CDAR2_eCR_eICR-2.xsl';
        const RR_XSL_URL   = './CDAR2_eCR_RR.xsl';

        // Global variable to store lab observation data
        let labObsData = [];
        let labObsLoaded = false;

        // Global variable to store diagnosis data
        let diagnosisData = [];
        let diagnosisLoaded = false;

        // Global variables for new lab order, organism, and test data
        let labOrderData = [];
        let labOrderLoaded = false;
        let organismData = [];
        let organismLoaded = false;
        let testData = [];
        let testLoaded = false;

        // Load lab observations from RCTC Excel file
        async function loadLabObsFromRCTC() {
            try {
                const response = await fetch('./assets/xslt/RCTC_Release (2025-03-18).xlsx');
                if (!response.ok) {
                    throw new Error(`Failed to load RCTC Excel file: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                const allLabObs = [];
                
                // Look for "Lab Obs Test Name S4" sheet
                const targetSheetName = workbook.SheetNames.find(name => 
                    name.toLowerCase().includes('lab obs test name s4') || 
                    name.toLowerCase().includes('lab_obs_test_name_s4')
                );
                
                if (targetSheetName) {
                    const worksheet = workbook.Sheets[targetSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Skip empty sheets
                    if (jsonData.length > 1) {
                        // Debug: log the first few rows to see the actual structure
                        console.log('Sheet name:', targetSheetName);
                        console.log('First 3 data rows:', jsonData.slice(0, 4));
                        
                        // Process data rows - let's try different column combinations
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length > 2) {
                                // Try to find which column has the actual test names (longest text usually)
                                let codeCol = row[1] || '';
                                let nameCol = row[2] || '';
                                
                                // If Column C is just "LOINC", try a different column for the name
                                if (nameCol === 'LOINC' && row[3]) {
                                    nameCol = row[3]; // Try Column D
                                } else if (nameCol === 'LOINC' && row[4]) {
                                    nameCol = row[4]; // Try Column E
                                }
                                
                                allLabObs.push({
                                    code: codeCol,
                                    name: nameCol,
                                    description: row[0] || ''
                                });
                            }
                        }
                    }
                }
                
                labObsData = allLabObs;
                labObsLoaded = true;
                
                console.log(`Loaded ${labObsData.length} lab observations from RCTC file`);
                console.log('Sample data:', labObsData.slice(0, 3));
                return labObsData;
                
            } catch (error) {
                console.warn('Failed to load lab observations from RCTC file:', error);
                // Fallback to hardcoded values if RCTC file can't be loaded
                labObsData = getHardcodedLabObs();
                labObsLoaded = true;
                return labObsData;
            }
        }

        // Fallback hardcoded lab observations
        function getHardcodedLabObs() {
            return [
                { code: "94310-0", name: "SARS-like Coronavirus N gene [Presence] in Unspecified specimen by NAA with probe detection", description: "LOINC" },
                { code: "34487-9", name: "Influenza virus A RNA [Presence] in Respiratory specimen by NAA with probe detection", description: "LOINC" },
                { code: "19080-1", name: "Choriogonadotropin.beta subunit [Units/volume] in Serum or Plasma", description: "LOINC" }
            ];
        }

        // Load diagnosis data from RCTC Excel file
       // STRICT loader: uses ONLY "diagnosis_problem s1" (B=code, C=name)
async function loadDiagnosisFromRCTC() {
  try {
    const res = await fetch('./assets/xslt/RCTC_Release (2025-03-18).xlsx');
    if (!res.ok) throw new Error(`Failed to load RCTC Excel file: ${res.status}`);

    const ab = await res.arrayBuffer();
    const wb = XLSX.read(ab, { type: 'array' });

    const SHEET_NAME = 'Diagnosis_Problem S1';
    const ws = wb.Sheets[SHEET_NAME];
    if (!ws) throw new Error(`Sheet "${SHEET_NAME}" not found in RCTC release.`);

    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

    // normalize helper: trims & removes NBSPs
    const norm = v => String(v ?? '').replace(/\u00A0/g, ' ').trim();

    const allDiagnosis = [];
    // Row 0 = header; start from 1. B (idx 1) = code, C (idx 2) = name. A (idx 0) optional description.
    for (let i = 1; i < rows.length; i++) {
      const r = rows[i];
      if (!r || r.length < 3) continue;
      const code = norm(r[1]);
      const name = norm(r[2]);
      const description = norm(r[0]);
      if (code && name) allDiagnosis.push({ code, name, description });
    }

    diagnosisData = allDiagnosis;
    diagnosisLoaded = true;
    console.log(`Loaded ${diagnosisData.length} diagnoses from "${SHEET_NAME}"`);
    return diagnosisData;
  } catch (error) {
    console.warn('Failed to load diagnoses from RCTC file:', error);
    diagnosisData = getHardcodedDiagnosis(); // keep your existing fallback
    diagnosisLoaded = true;
    return diagnosisData;
  }
}


        // Fallback hardcoded diagnosis data
        function getHardcodedDiagnosis() {
            return [
                { code: "67531005", name: "Down syndrome (disorder)", description: "SNOMEDCT" },
                { code: "414819007", name: "Disease caused by Bordetella pertussis (disorder)", description: "SNOMEDCT" },
                { code: "86299006", name: "Gonorrhea (disorder)", description: "SNOMEDCT" }
            ];
        }

        // Load lab order data from RCTC Excel file - Lab Order Test Name S3 tab
        async function loadLabOrderFromRCTC() {
            try {
                const response = await fetch('./assets/xslt/RCTC_Release (2025-03-18).xlsx');
                if (!response.ok) {
                    throw new Error(`Failed to load RCTC Excel file: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                const allLabOrders = [];
                
                // Look for "Lab Order Test Name S3" sheet
                const targetSheetName = workbook.SheetNames.find(name => 
                    name.toLowerCase().includes('lab order test name s3') || 
                    name.toLowerCase().includes('lab_order_test_name_s3') ||
                    name.toLowerCase().includes('lab order test name s3')
                );
                
                if (targetSheetName) {
                    const worksheet = workbook.Sheets[targetSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    console.log('Lab Order sheet name:', targetSheetName);
                    console.log('First 3 lab order rows:', jsonData.slice(0, 4));
                    
                    if (jsonData.length > 1) {
                        // Process data rows - Column B for code, Column C for name
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length > 2 && row[1] && row[2]) {
                                allLabOrders.push({
                                    code: row[1] || '', // Column B for code
                                    name: row[2] || '', // Column C for name
                                    description: row[0] || '' // Column A for description (if available)
                                });
                            }
                        }
                    }
                }
                
                labOrderData = allLabOrders;
                labOrderLoaded = true;
                
                console.log(`Loaded ${labOrderData.length} lab orders from RCTC file`);
                return labOrderData;
                
            } catch (error) {
                console.warn('Failed to load lab orders from RCTC file:', error);
                labOrderData = getHardcodedLabOrders();
                labOrderLoaded = true;
                return labOrderData;
            }
        }

        // Fallback hardcoded lab orders
        function getHardcodedLabOrders() {
            return [
                { code: "94310-0", name: "SARS-like Coronavirus N gene [Presence] in Unspecified specimen by NAA with probe detection", description: "LOINC" },
                { code: "34487-9", name: "Influenza virus A RNA [Presence] in Respiratory specimen by NAA with probe detection", description: "LOINC" },
                { code: "19080-1", name: "Choriogonadotropin.beta subunit [Units/volume] in Serum or Plasma", description: "LOINC" }
            ];
        }

        // Load organism data from RCTC Excel file - Organism_Substance S2 tab
        async function loadOrganismFromRCTC() {
          try {
            const url = './assets/xslt/RCTC_Release (2025-03-18).xlsx';
            const resp = await fetch(url);
            if (!resp.ok) throw new Error(`Fetch failed (${resp.status}) for ${url}`);

            const arrayBuffer = await resp.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });

            // Normalize names to avoid subtle spacing/underscore/case mismatches
            const normalize = s => String(s || '')
              .toLowerCase()
              .replace(/[\s_]+/g, '');

            // Prefer exact normalized match first, then relaxed "includes"
            const wanted = 'organismsubstances2';
            let targetSheetName =
              workbook.SheetNames.find(n => normalize(n) === wanted) ||
              workbook.SheetNames.find(n => normalize(n).includes(wanted));

            if (!targetSheetName) {
              throw new Error('Sheet "Organism_Substance S2" not found in workbook');
            }

            const ws = workbook.Sheets[targetSheetName];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });

            // Expect header row at index 0, then data; B=code (idx 1), C=name (idx 2)
            const out = [];
            for (let i = 1; i < rows.length; i++) {
              const r = rows[i] || [];
              const code = String(r[1] || '').trim();
              const name = String(r[2] || '').trim();
              if (!code || !name) continue;
              out.push({
                code,
                name,
                description: String(r[0] || '').trim() // A if present
              });
            }

            if (!out.length) {
              throw new Error(`Sheet "${targetSheetName}" parsed but 0 usable rows (check B/C columns).`);
            }

            organismData = out;
            organismLoaded = true;
            console.log(`Loaded ${organismData.length} organisms from "${targetSheetName}"`);
            return organismData;
          } catch (err) {
            organismData = getHardcodedOrganisms(); // your existing tiny fallback
            organismLoaded = true;

            // Surface the real reason to the user so it's obvious when the fallback is in play
            alert(`Could not load Organism_Substance S2 from RCTC file.\nReason: ${err.message}\nUsing a small fallback list.`);
            console.warn('Organism load error:', err);
            return organismData;
          }
        }

        // Load test data from RCTC Excel file - LAB_OBS Test Name S4 tab
        async function loadTestsFromRCTC() {
          try {
            const url = './assets/xslt/RCTC_Release (2025-03-18).xlsx';
            const resp = await fetch(url);
            if (!resp.ok) throw new Error(`Fetch failed (${resp.status}) for ${url}`);

            const arrayBuffer = await resp.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });

            // Normalize names to handle spaces/underscores/case
            const normalize = s => String(s || '')
              .toLowerCase()
              .replace(/[\s_]+/g, '');

            // Target "LAB_OBS Test Name S4" and common variants
            const wanted = 'labobstestnames4';
            let targetSheetName =
              workbook.SheetNames.find(n => normalize(n) === wanted) ||
              workbook.SheetNames.find(n => normalize(n).includes(wanted));

            if (!targetSheetName) {
              throw new Error('Sheet "LAB_OBS Test Name S4" not found in workbook');
            }

            const ws = workbook.Sheets[targetSheetName];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });

            // Expect header at row 0; B=code(idx1), C=name(idx2)
            const out = [];
            for (let i = 1; i < rows.length; i++) {
              const r = rows[i] || [];
              const code = String(r[1] || '').trim();   // Column B
              const name = String(r[2] || '').trim();   // Column C
              if (!code || !name) continue;
              out.push({
                code,                      // LOINC code
                name,                      // Test name
                description: String(r[0] || '').trim() // Optional: Column A if present
              });
            }

            if (!out.length) {
              throw new Error(`Sheet "${targetSheetName}" parsed but 0 usable rows (check B/C columns).`);
            }

            testData = out;
            testLoaded = true;
            console.log(`Loaded ${testData.length} tests from "${targetSheetName}"`);
            return testData;
          } catch (err) {
            testData = [];
            testLoaded = true;
            alert(`Could not load "LAB_OBS Test Name S4". Reason: ${err.message}`);
            console.warn('Test load error:', err);
            return testData;
          }
        }

        // Fallback hardcoded organisms
        function getHardcodedOrganisms() {
            return [
                { code: "840539006", name: "Disease caused by 2019-nCoV", description: "SNOMEDCT" },
                { code: "409822003", name: "Domain Bacteria", description: "SNOMEDCT" },
                { code: "84676004", name: "Severe acute respiratory syndrome coronavirus", description: "SNOMEDCT" }
            ];
        }

        // Search RCTC codes function
       // Tailored search: for any *diagnosis* field, search ONLY diagnosis_problem s1 data.
// Clicking a result fills BOTH Code & Name from the same row.
async function searchRCTCCodes(fieldId) {
  const el = document.getElementById(fieldId);
  if (!el) return;

  // Decide dataset
  let data;
  if (fieldId.toLowerCase().includes('diagnosis')) {
    if (!diagnosisLoaded) await loadDiagnosisFromRCTC();
    data = diagnosisData || [];
  } else {
    if (!labObsLoaded) await loadLabObsFromRCTC(); // keep your existing lab behavior
    data = labObsData || [];
  }

  // results container
  const resultsDiv = document.getElementById(fieldId + '_results');
  if (!resultsDiv) return;
  resultsDiv.innerHTML = '';
  resultsDiv.style.display = 'none';

  const q = String(el.value ?? '').replace(/\u00A0/g, ' ').trim().toLowerCase();
  if (!q || data.length === 0) return;

  const asCode = r => String(r.code ?? '').toLowerCase();
  const asName = r => String((r.name ?? r.description ?? '')).toLowerCase();

  const searchingName = /Name$/i.test(fieldId);
  const digitsOnly = /^[0-9]+$/.test(q);

  let matches = [];
  if (!searchingName && digitsOnly) {
    // Code box, numeric: try exact match first
    const exact = data.filter(r => asCode(r) === q);
    const fuzzy = data.filter(r => asCode(r).includes(q) || asName(r).includes(q));
    const seen = new Set();
    matches = [...exact, ...fuzzy].filter(r => {
      const k = r.code + '|' + r.name;
      if (seen.has(k)) return false;
      seen.add(k);
      return true;
    });
  } else {
    // General contains; prioritize the field‚Äôs primary dimension
    const primary   = data.filter(r => (searchingName ? asName(r) : asCode(r)).includes(q));
    const secondary = data.filter(r => (searchingName ? asCode(r) : asName(r)).includes(q));
    const seen = new Set();
    matches = [...primary, ...secondary].filter(r => {
      const k = r.code + '|' + r.name;
      if (seen.has(k)) return false;
      seen.add(k);
      return true;
    });
  }

  if (matches.length === 0) {
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="no-results">No matching codes found</div>';
    return;
  }

  const list = document.createElement('div');
  list.className = 'search-results-list';

  matches.slice(0, 10).forEach(row => {
    const item = document.createElement('div');
    item.className = 'search-result-item';

    // Show code + name; keep your light description if present
    item.innerHTML = searchingName
      ? `<strong>${row.name}</strong><br><small>Code: ${row.code}</small>${row.description ? `<br><small>${row.description}</small>` : ''}`
      : `<strong>${row.code}</strong>: ${row.name}${row.description ? `<br><small>${row.description}</small>` : ''}`;

    item.onclick = () => {
      if (searchingName) {
        // Fill Name + its paired Code
        el.value = row.name;
        const codeField = document.getElementById(fieldId.replace('Name', 'Code'));
        if (codeField) {
          codeField.value = row.code;
          // keep your trigger validation semantics on the code field
          if (typeof validateTriggerCode === 'function') validateTriggerCode(codeField.id);
        }
      } else {
        // Fill Code + its paired Name
        el.value = row.code;
        const nameField = document.getElementById(fieldId.replace('Code', 'Name'));
        if (nameField) nameField.value = row.name;
        if (typeof validateTriggerCode === 'function') validateTriggerCode(el.id);
      }
      resultsDiv.style.display = 'none';
    };

    list.appendChild(item);
  });

  resultsDiv.appendChild(list);
  resultsDiv.style.display = 'block';
}


        // Fetch local XSLT files (no CORS issues)
        async function fetchXslt(url) {
          try {
            const res = await fetch(url);
            if (!res.ok) {
              throw new Error(`Failed to load local XSLT file: ${url} (Status: ${res.status})`);
            }
            return res.text();
          } catch (error) {
            console.error(`Failed to fetch XSLT file ${url}:`, error);
            throw new Error(`Cannot load XSLT file: ${url}. Make sure the file exists in your project directory.`);
          }
        }

        // Add this function to debug XSLT content
        async function debugXsltFiles() {
          try {
            console.log('=== DEBUGGING XSLT FILES ===');
            
            const eicrXsl = await fetchXslt(EICR_XSL_URL);
            const rrXsl = await fetchXslt(RR_XSL_URL);
            
            console.log('eICR XSLT length:', eicrXsl.length, 'characters');
            console.log('eICR XSLT starts with:', eicrXsl.substring(0, 200));
            console.log('eICR XSLT contains stylesheet?', eicrXsl.includes('xsl:stylesheet'));
            
            console.log('RR XSLT length:', rrXsl.length, 'characters');
            console.log('RR XSLT starts with:', rrXsl.substring(0, 200));
            console.log('RR XSLT contains stylesheet?', rrXsl.includes('xsl:stylesheet'));
            
            // Check if files look like proper XSLT
            if (!eicrXsl.includes('<?xml') || !eicrXsl.includes('xsl:stylesheet')) {
              console.error('eICR XSLT appears to be invalid or corrupted');
            }
            if (!rrXsl.includes('<?xml') || !rrXsl.includes('xsl:stylesheet')) {
              console.error('RR XSLT appears to be invalid or corrupted');
            }
            
          } catch (error) {
            console.error('Failed to debug XSLT files:', error);
          }
        }

        // Debug XML structure
        function debugXmlStructure(xmlString, docType) {
          console.log(`=== DEBUGGING ${docType} XML ===`);
          console.log('XML length:', xmlString.length);
          console.log('First 500 characters:', xmlString.substring(0, 500));
          
          // Check for key elements the XSLT might be looking for
          const parser = new DOMParser();
          const doc = parser.parseFromString(xmlString, 'application/xml');
          
          console.log('Root element:', doc.documentElement?.tagName);
          console.log('Namespace URI:', doc.documentElement?.namespaceURI);
          
          // Look for common CDA elements
          const commonElements = ['ClinicalDocument', 'component', 'structuredBody', 'section'];
          commonElements.forEach(element => {
            const found = doc.getElementsByTagName(element).length;
            console.log(`${element} elements found:`, found);
          });
        }

        // Add this function to scan for invalid XML comments
        function validateXMLComments(xmlString, docType) {
          console.log(`Validating ${docType} XML comments...`);
          
          // Find all comments using a simple approach
          const comments = [];
          let startIndex = 0;
          while (true) {
            const start = xmlString.indexOf('<!--', startIndex);
            if (start === -1) break;
            const end = xmlString.indexOf('-->', start + 4);
            if (end === -1) break;
            comments.push(xmlString.substring(start, end + 3));
            startIndex = end + 3;
          }
          
          comments.forEach((comment, index) => {
            // Check for double hyphens in the middle of comments
            const innerContent = comment.slice(4, -3); // Remove <!-- and -->
            if (innerContent.includes('--')) {
              console.error(`Invalid comment #${index + 1} in ${docType}:`, comment);
              console.error('Contains double hyphens which violate XML specification');
            }
          });
          
          console.log(`Found ${comments.length} comments total in ${docType}`);
          return comments.length;
        }

        // Enhanced XML ‚Üí HTML transformation with better error handling
        function xmlToHtml(xmlString, xsltString) {
          try {
            console.log('Starting XML transformation...');
            console.log('XML length:', xmlString.length);
            console.log('XSLT length:', xsltString.length);
            
            const parser = new DOMParser();
            
            // Parse XML
            const xml = parser.parseFromString(xmlString, 'application/xml');
            const xmlParseErrors = xml.getElementsByTagName('parsererror');
            if (xmlParseErrors.length > 0) {
              console.error('XML parsing error:', xmlParseErrors[0].textContent);
              throw new Error('Invalid XML document');
            }
            
            // Parse XSLT
            const xsl = parser.parseFromString(xsltString, 'application/xml');
            const xslParseErrors = xsl.getElementsByTagName('parsererror');
            if (xslParseErrors.length > 0) {
              console.error('XSLT parsing error:', xslParseErrors[0].textContent);
              throw new Error('Invalid XSLT stylesheet');
            }
            
            // Create and configure processor
            const processor = new XSLTProcessor();
            processor.importStylesheet(xsl);
            
            // Transform
            const resultDocument = processor.transformToDocument(xml);
            
            // Check if transformation produced anything
            if (!resultDocument || !resultDocument.documentElement) {
              console.error('XSLT transformation produced no output');
              throw new Error('XSLT transformation failed - no output generated');
            }
            
            // Serialize result
            const serializer = new XMLSerializer();
            const htmlString = '<!DOCTYPE html>\n' + serializer.serializeToString(resultDocument);
            
            console.log('Transformation successful. Output length:', htmlString.length);
            console.log('Output starts with:', htmlString.substring(0, 200));
            
            return htmlString;
            
          } catch (error) {
            console.error('XML to HTML transformation failed:', error);
            throw new Error(`XSLT transformation error: ${error.message}`);
          }
        }

        // If your app already has these, keep them; otherwise adapt.
        function generateEICRXml() { return buildEICRXml(); }

        function getEffectiveSetId(data) {
            // For Replace/Update documents, use the relatedDocumentId as the setId
            // For New documents, use the setId field
            if (data.documentRelationshipType === 'RPLC') {
                return data.relatedDocumentId || data.setId;
            }
            return data.setId;
        }

        function generateRelatedDocumentXml(data) {
            // Only generate relatedDocument element if not a new document
            if (!data.documentRelationshipType || data.documentRelationshipType === 'NEW') {
                return '';
            }

            const relatedSetId = data.relatedDocumentId || '';
            const typeCode = data.documentRelationshipType || 'RPLC';

            return `
  <!-- Related Document Information -->
  <relatedDocument typeCode="${typeCode}">
    <parentDocument>
      <setId extension="${relatedSetId}" root="1.2.840.114350.1.13.380.3.7.1.1" />
      <code code="55751-2" codeSystem="2.16.840.1.113883.6.1" 
            codeSystemName="LOINC" displayName="Public Health Case Report" />
    </parentDocument>
  </relatedDocument>`;
        }
        function generateRRXml()   { return buildRRXml();   }

        // Global RCTC data storage
        let rctcData = {
            diagnosis: [],
            labOrder: [],
            labObs: [],
            medications: [],
            organism: [],
            metadata: {
                oid: '2.16.840.1.113762.1.4.1146.2260', // RCTC Birth Defect Trigger Codes OID
                version: '2.0.1',
                effectiveDate: '2025-06-01',
                releaseDate: '2025-03-18'
            }
        };

        // Condition-specific value set mapping function
        function getConditionSpecificValueSet(code, codeSystem = '2.16.840.1.113883.6.96') {
            const valueSetMap = {
                // COVID-19 Trigger Codes
                '840539006': { // Disease caused by 2019-nCoV
                    oid: '2.16.840.1.114222.4.11.7508',
                    version: '1.2.0.0',
                    name: 'COVID-19 (Diagnosis, Symptom, Condition, or Healthcare Encounter)'
                },
                '840544004': { // Suspected disease caused by 2019-nCoV
                    oid: '2.16.840.1.114222.4.11.7508',
                    version: '1.2.0.0',
                    name: 'COVID-19 (Diagnosis, Symptom, Condition, or Healthcare Encounter)'
                },
                '94500-6': { // SARS-CoV-2 RNA [Presence] in Respiratory specimen by NAA with probe detection
                    oid: '2.16.840.1.114222.4.11.7508',
                    version: '1.2.0.0',
                    name: 'COVID-19 (Laboratory Test)'
                },
                '94310-0': { // SARS-like Coronavirus N gene [Presence] in Unspecified specimen by NAA with probe detection
                    oid: '2.16.840.1.114222.4.11.7508',
                    version: '1.2.0.0',
                    name: 'COVID-19 (Laboratory Test)'
                },
                
                // Influenza Trigger Codes
                '719865001': { // Influenza A virus infection
                    oid: '2.16.840.1.114222.4.11.1009',
                    version: '2.0.0',
                    name: 'Influenza (Diagnosis, Symptom, Condition, or Healthcare Encounter)'
                },
                '34487-9': { // Influenza virus A RNA [Presence] in Respiratory specimen by NAA with probe detection
                    oid: '2.16.840.1.114222.4.11.1009',
                    version: '2.0.0',
                    name: 'Influenza (Laboratory Test)'
                },
                
                // Birth Defects (current focus)
                '67531005': { // Spina bifida
                    oid: '2.16.840.1.113762.1.4.1146.2260',
                    version: '2.0.1',
                    name: 'Birth Defects Trigger Codes'
                },
                '86299006': { // Tetralogy of Fallot
                    oid: '2.16.840.1.113762.1.4.1146.2260',
                    version: '2.0.1',
                    name: 'Birth Defects Trigger Codes'
                },
                '414819007': { // Neonatal abstinence syndrome
                    oid: '2.16.840.1.113762.1.4.1146.2260',
                    version: '2.0.1',
                    name: 'Birth Defects Trigger Codes'
                },
                
                // Default fallback
                'default': {
                    oid: '2.16.840.1.113762.1.4.1146.2260',
                    version: '2.0.1',
                    name: 'RCTC Master List'
                }
            };
            
            return valueSetMap[code] || valueSetMap['default'];
        }

        function getFormData() {
            const fields = [
                // Patient Demographics
                'patientId', 'patientName', 'patientPhone', 'patientEmail', 'patientAddress',
                'patientCity', 'patientState', 'patientZip', 'patientCounty', 'patientCountry',
                'patientGender', 'patientBirthDate', 'patientRace', 'patientEthnicity',
                'patientBirthPlace', 'patientBirthSex', 'patientGenderIdentity', 'patientDetailedRace',
                'patientDetailedEthnicity', 'patientLanguage', 'patientDeathIndicator', 'patientDeathDate',
                
                // Guardian Information
                'guardianName', 'guardianPhone', 'guardianEmail', 'guardianAddress', 'guardianCity',
                'guardianState', 'guardianZip', 'guardianCode',
                
                // Provider Information
                'providerId', 'providerName', 'providerPhone', 'providerEmail', 'providerFax',
                'facilityId', 'facilityName', 'facilityAddress', 'facilityTypeCode',
                'organizationName', 'organizationId', 'organizationPhone', 'organizationEmail',
                'organizationFax', 'organizationAddress',
                
                // Encounter Information
                'encounterId', 'encounterType', 'encounterDate', 'encounterEndDate', 'encounterDisposition',
                'chiefComplaint', 'presentIllness', 'reasonForVisit', 'pastMedicalHistory', 'reviewOfSystems',
                
                // Diagnoses
                'diagnosis1Code', 'diagnosis1Name', 'diagnosis2Code', 'diagnosis2Name', 'diagnosis3Code', 'diagnosis3Name',
                'diagnosis1Date', 'diagnosis1OnsetDate', 'diagnosis2Date', 'diagnosis2OnsetDate',
                'diagnosis3Date', 'diagnosis3OnsetDate', 'problemType', 'symptoms',
                
                // Laboratory Tests
                'labTest1Code', 'labTest1Name', 'labTest1Result', 'labTest2Code', 'labTest2Name', 'labTest2Result',
                'labOrder1Code', 'labOrder1Id', 'labOrder1Time', 'labTest1Status', 'labTest1Time',
                'labTest1Interpretation', 'labTest1ReferenceRange', 'labTest2Status', 'labTest2Time',
                'labTest2Interpretation', 'labTest2ReferenceRange',
                
                // Medications
'adminMed1Code', 'adminMed1Name', 'adminMed1Id', 'adminMed1Status', 'adminMed1Time',
'adminMed1Route',
'adminMed1DoseValue', 'adminMed1DoseUnit', 'adminMed1VolValue', 'adminMed1VolUnit', 'adminMed1Negated',

'adminMed2Code', 'adminMed2Name', 'adminMed2Id', 'adminMed2Status', 'adminMed2Time',
'adminMed2Route',
'adminMed2DoseValue', 'adminMed2DoseUnit', 'adminMed2VolValue', 'adminMed2VolUnit', 'adminMed2Negated',

// Medications
'adminMed1Code', 'adminMed1Name', 'adminMed1Id', 'adminMed1Status', 'adminMed1Time',
'adminMed1Route',
'adminMed1DoseValue', 'adminMed1DoseUnit', 'adminMed1VolValue', 'adminMed1VolUnit', 'adminMed1Negated',

'adminMed2Code', 'adminMed2Name', 'adminMed2Id', 'adminMed2Status', 'adminMed2Time',
'adminMed2Route',
'adminMed2DoseValue', 'adminMed2DoseUnit', 'adminMed2VolValue', 'adminMed2VolUnit', 'adminMed2Negated',

// Administering Provider (applies to ALL administered meds)
'administeringProviderNPI',
'administeringProviderGiven',
'administeringProviderMiddle',
'administeringProviderFamily',
'administeringProviderPhone',
'administeringProviderOrgName',
'administeringProviderOrgId',
'administeringProviderOrgIdRoot',

// Planned medication stays as-is
'plannedMed1Code', 'plannedMed1Name', 'plannedMed1Instructions',

                
                // Immunizations
                'immunization1Status', 'immunization1Id', 'immunization1Date', 'vaccine1Code', 'vaccine1Name',
                'vaccine1Dose', 'vaccine1Route', 'vaccine1Manufacturer', 'immunization2Status', 'immunization2Id',
                'immunization2Date', 'vaccine2Code', 'vaccine2Name', 'vaccine2Dose', 'vaccine2Route', 'vaccine2Manufacturer',
                
                // Pregnancy Information
                'pregnancyStatus', 'pregnancyEffectiveTime', 'estimatedDeliveryDate', 'pregnancyDeterminationMethod',
                'gestationalAge', 'lastMenstrualPeriod', 'pregnancyOutcome', 'postpartumStatus',
                
                // Travel History
                'travelStartDate', 'travelEndDate', 'travelLocation', 'travelLocationCode', 'travelAddress',
                'purposeOfTravel', 'transportationType', 'transportationDetails',
                
                // Occupation Information
                'currentOccupation', 'usualOccupation', 'currentIndustry', 'usualIndustry', 'currentJobTitle',
                'currentEmployerName', 'currentEmployerPhone', 'currentEmployerAddress', 'occupationalExposure', 'employmentStatus',
                
                // Specimen Information
                'specimen1Source', 'specimen1Type', 'specimen1Id', 'collection1Date',
                'specimen2Source', 'specimen2Type', 'specimen2Id', 'collection2Date',
                
                // Additional Clinical Data
                'temperature', 'bloodPressure', 'heartRate', 'respiratoryRate', 'oxygenSaturation',
                'weight', 'height', 'bmi', 'therapeuticResponse', 'homelessStatus', 'congregateLiving', 'congregateLivingType',
                
                // Procedures
                'currentProc1Code', 'currentProc1Name', 'currentProc1Date', 'currentProc1Type',
                'currentProc2Code', 'currentProc2Name', 'currentProc2Date', 'currentProc2Type',
                'triggerProc1Code', 'triggerProc1Name', 'triggerProc1Date', 'triggerProc1Type',
                'plannedProc1Code', 'plannedProc1Name', 'plannedProc1Date', 'plannedProc1Type',
                
                // Special Populations and Demographics
                'disabilityStatus', 'disabilityType', 'tribalAffiliation', 'tribalEnrollment',
                'countryOfNationality', 'countryOfNationalityCode', 'countryOfResidence', 'countryOfResidenceCode',
                'immigrationStatus', 'preferredLanguage', 'interpreterNeeded', 'insuranceStatus',
                
                // Emergency and Public Health
                'emergencyOutbreakInfo', 'outbreakDetails', 'exposureContactInfo', 'exposureType',
                'exposureLocation', 'exposureDate', 'contactPersonName', 'contactPersonPhone',
                'vaccineCredentialAssertion', 'vaccineCardAvailable', 'quarantineStatus', 'isolationStatus',
                
                // Document Information
                'documentId', 'effectiveTime', 'documentRelationshipType', 'relatedDocumentId', 'setId', 'versionNumber'
            ];
            
            const data = {};
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    data[field] = element.value;
                }
            });
            
            // ADD THIS: Collect lab evidence
            data.labEvidence = collectLabEvidence();
            
            return data;
        }

        function setFormData(data) {
            Object.keys(data).forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.value = data[field];
                }
            });
        }

        function loadRCTCFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = handleRCTCFile;
            input.click();
        }

        function handleRCTCFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            alert('RCTC file processing would require additional libraries in a real implementation. For now, the generator uses hardcoded RCTC OID and version information.');
            
            console.log('RCTC file selected:', file.name);
        }

        function handleRelationshipTypeChange() {
            const relationshipType = document.getElementById('documentRelationshipType').value;
            const relatedDocIdGroup = document.getElementById('relatedDocIdGroup');
            const relatedDocIdField = document.getElementById('relatedDocumentId');
            const setIdGroup = document.getElementById('setIdGroup');
            const setIdField = document.getElementById('setId');
            const versionNumberField = document.getElementById('versionNumber');

            if (relationshipType === 'NEW') {
                // Show Set ID field, hide Related Document Set ID field
                setIdGroup.style.display = 'block';
                relatedDocIdGroup.style.display = 'none';
                relatedDocIdField.required = false;
                relatedDocIdField.value = '';
                
                // Generate new setId for new document
                generateNewSetId();
                versionNumberField.value = '1';
            } else {
                // Hide Set ID field, show Related Document Set ID field
                setIdGroup.style.display = 'none';
                relatedDocIdGroup.style.display = 'block';
                relatedDocIdField.required = true;
                
                // For Replace/Update relationship, increment version
                if (relationshipType === 'RPLC') {
                    const currentVersion = parseInt(versionNumberField.value) || 1;
                    versionNumberField.value = currentVersion + 1;
                }
            }
        }

        function handleRelatedDocumentIdChange() {
            // This function can be simplified since we're no longer copying values between fields
            // The relatedDocumentId field serves as the Set ID when in Replace/Update mode
            console.log('Related Document Set ID updated');
        }

        function generateNewSetId() {
            // Generate a new UUID for setId
            const setIdField = document.getElementById('setId');
            setIdField.value = generateUUID();
        }

        function generateUUID() {
            // Simple UUID v4 generator
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function validateRelatedDocumentFields() {
            const relationshipType = document.getElementById('documentRelationshipType').value;
            const relatedDocIdField = document.getElementById('relatedDocumentId');

            if (relationshipType !== 'NEW' && !relatedDocIdField.value.trim()) {
                alert('Related Document ID is required when relationship type is not "New Document".');
                relatedDocIdField.focus();
                return false;
            }
            return true;
        }


        function isRCTCTriggerCode(code) {
            const triggerCodes = ['840539006', '719865001', '3928002', '94310-0', '34487-9', '168731009',
                                 '41040004', '72951007', '67531005', '86299006', '414819007'];
            return triggerCodes.includes(code);
        }

        function validateTriggerCode(fieldId) {
            const code = document.getElementById(fieldId).value;
            
            if (code && !isRCTCTriggerCode(code)) {
                console.log('Warning: Code', code, 'may not be a valid RCTC trigger code');
            }
        }

        function getRaceDisplayName(raceCode) {
            const raceCodes = {
                '1002-5': 'American Indian or Alaska Native',
                '2028-9': 'Asian',
                '2054-5': 'Black or African American',
                '2076-8': 'Native Hawaiian or Other Pacific Islander',
                '2106-3': 'White',
                '2131-1': 'Other Race',
                'UNK': 'Unknown',
                'ASKU': 'Asked but unknown'
            };
            return raceCodes[raceCode] || 'Race';
        }

        function getEthnicityDisplayName(ethnicityCode) {
            const ethnicityCodes = {
                '2135-2': 'Hispanic or Latino',
                '2186-5': 'Not Hispanic or Latino',
                'UNK': 'Unknown',
                'ASKU': 'Asked but unknown'
            };
            return ethnicityCodes[ethnicityCode] || 'Ethnicity';
        }

        function validateDateFormat(dateString, fieldName) {
            if (!dateString) return true; // Allow empty dates
            
            const datePattern = /^\d{8}$/; // YYYYMMDD
            const dateTimePattern = /^\d{14}$/; // YYYYMMDDHHMMSS
            
            if (!datePattern.test(dateString) && !dateTimePattern.test(dateString)) {
                alert(`${fieldName} must be in YYYYMMDD or YYYYMMDDHHMMSS format`);
                return false;
            }
            
            // Additional date validation can be added here
            return true;
        }

        function validateRequiredFields() {
            const requiredFields = [
                { id: 'patientId', name: 'Patient ID' },
                { id: 'patientName', name: 'Patient Name' },
                { id: 'patientBirthDate', name: 'Patient Birth Date' },
                { id: 'providerId', name: 'Provider ID' },
                { id: 'providerName', name: 'Provider Name' },
                { id: 'encounterId', name: 'Encounter ID' },
                { id: 'encounterDate', name: 'Encounter Date' },
                { id: 'documentId', name: 'Document ID' },
                { id: 'effectiveTime', name: 'Effective Time' }
            ];
            
            for (let field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    alert(`${field.name} is required`);
                    element?.focus();
                    return false;
                }
            }
            return true;
        }

        // DQ Schematron ValueSets
        const DQ_VALUESETS = {
            administrativeGender: {
                oid: '2.16.840.1.113883.5.1',
                values: ['F', 'M', 'UN']
            },
            raceCategory: {
                oid: '2.16.840.1.113883.6.238',
                values: ['1002-5', '2028-9', '2054-5', '2076-8', '2106-3', '2131-1']
            },
            ethnicity: {
                oid: '2.16.840.1.113883.6.238', 
                values: ['2135-2', '2186-5']
            },
            specimenType: {
                oid: '2.16.840.1.113883.21.327',
                values: ['258500001', '461911000124106', '258580003', '122555007', '309051001', '119295008', '119297000', '122552005', '168139001', '258467004', '441620008']
            },
            bodySite: {
                oid: '2.16.840.1.113883.3.88.12.3221.8.9',
                values: ['71341001', '123851003', '181216001', '258435002', '272673000', '362837007']
            }
        };

        // DQ Validation Functions
        function validateDQPatientName() {
            const errors = [];
            const nameField = document.getElementById('patientName');
            
            if (!nameField || !nameField.value || nameField.value.trim() === '') {
                errors.push('dq-patientName-001: Patient name cannot be nullFlavor or empty');
            } else {
                const nameParts = nameField.value.trim().split(' ');
                if (nameParts.length < 2) {
                    errors.push('dq-patientName-002/004: Patient must have both family and given name');
                }
            }
            
            return errors;
        }

        function validateDQPatientAddress() {
            const errors = [];
            const addressField = document.getElementById('patientAddress');
            const cityField = document.getElementById('patientCity');
            const stateField = document.getElementById('patientState');
            const zipField = document.getElementById('patientZip');
            
            if (!addressField?.value?.trim()) {
                errors.push('dq-patientAddress-002/003/004: Street address line cannot be nullFlavor or blank');
            }
            if (!cityField?.value?.trim()) {
                errors.push('dq-patientAddress-005/006: City cannot be nullFlavor or blank');
            }
            if (!stateField?.value?.trim()) {
                errors.push('dq-patientAddress-007/008: State cannot be nullFlavor or blank');
            }
            if (!zipField?.value?.trim()) {
                errors.push('dq-patientAddress-009/010: Postal code cannot be nullFlavor or blank');
            }
            
            return errors;
        }

        function validateDQAdministrativeGender() {
            const errors = [];
            const genderField = document.getElementById('patientGender');
            
            if (!genderField?.value) {
                errors.push('dq-administrativeGenderCode-001: Administrative gender code cannot be nullFlavor');
            } else if (!DQ_VALUESETS.administrativeGender.values.includes(genderField.value)) {
                errors.push('dq-administrativeGenderCode-002: Administrative gender code must be M, F, or UN');
            }
            
            return errors;
        }

        function validateDQRaceCode() {
            const errors = [];
            const raceField = document.getElementById('patientRace');
            
            if (!raceField?.value) {
                errors.push('dq-raceCode-001: Race code cannot be nullFlavor');
            } else if (!DQ_VALUESETS.raceCategory.values.includes(raceField.value) && raceField.value !== 'UNK') {
                errors.push('dq-raceCode-002: Race code must be from Race Category Excluding Nulls ValueSet');
            }
            
            return errors;
        }

        function validateDQEthnicityCode() {
            const errors = [];
            const ethnicityField = document.getElementById('patientEthnicity');
            
            if (!ethnicityField?.value) {
                errors.push('dq-ethnicGroupCode-001: Ethnicity code cannot be nullFlavor');
            } else if (!DQ_VALUESETS.ethnicity.values.includes(ethnicityField.value) && ethnicityField.value !== 'UNK') {
                errors.push('dq-ethnicGroupCode-002: Ethnicity code must be from Ethnicity ValueSet');
            }
            
            return errors;
        }

        function validateDQDateFormats() {
            const errors = [];
            const dateFields = [
                { id: 'patientBirthDate', name: 'Patient Birth Date' },
                { id: 'encounterDate', name: 'Encounter Date' },
                { id: 'patientDeathDate', name: 'Patient Death Date' },
                { id: 'diagnosis1Date', name: 'Diagnosis 1 Date' },
                { id: 'diagnosis1OnsetDate', name: 'Diagnosis 1 Onset Date' },
                { id: 'labTest1Time', name: 'Lab Test 1 Time' },
                { id: 'immunization1Date', name: 'Immunization 1 Date' },
                { id: 'specimenCollectionDate', name: 'Specimen Collection Date' }
            ];

            dateFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element?.value) {
                    if (!validateDateFormat(element.value, field.name)) {
                        errors.push(`dq-dateFormat: ${field.name} must be at least 8 characters (YYYYMMDD)`);
                    }
                }
            });

            return errors;
        }

        function validateDQSpecimen() {
            const errors = [];
            
            // Check specimen 1
            const spec1Source = document.getElementById('specimen1Source');
            const spec1Type = document.getElementById('specimen1Type');  
            const spec1Id = document.getElementById('specimen1Id');
            const collect1Date = document.getElementById('collection1Date');
            
            if (spec1Source?.value && !DQ_VALUESETS.specimenType.values.includes(spec1Source.value)) {
                errors.push('dq-specimenType-002: Specimen 1 source must be from HL7 Specimen Type ValueSet');
            }
            
            if (collect1Date?.value && collect1Date.value.length < 8) {
                errors.push('dq-specimenCollectionDate-002: Specimen 1 collection date must be at least 8 characters');
            }
            
            if (spec1Id?.value && !spec1Id.value.trim()) {
                errors.push('dq-specimenId-001: Specimen 1 ID cannot be nullFlavor or empty');
            }
            
            // Check specimen 2
            const spec2Source = document.getElementById('specimen2Source');
            const spec2Type = document.getElementById('specimen2Type');
            const spec2Id = document.getElementById('specimen2Id');
            const collect2Date = document.getElementById('collection2Date');
            
            if (spec2Source?.value && !DQ_VALUESETS.specimenType.values.includes(spec2Source.value)) {
                errors.push('dq-specimenType-002: Specimen 2 source must be from HL7 Specimen Type ValueSet');
            }
            
            if (collect2Date?.value && collect2Date.value.length < 8) {
                errors.push('dq-specimenCollectionDate-002: Specimen 2 collection date must be at least 8 characters');
            }
            
            if (spec2Id?.value && !spec2Id.value.trim()) {
                errors.push('dq-specimenId-001: Specimen 2 ID cannot be nullFlavor or empty');
            }
            
            return errors;
        }

        function validateDQTriggerCodes() {
            const errors = [];
            const data = getFormData();
            const triggerFields = [
                'diagnosis1Code', 'diagnosis2Code', 'diagnosis3Code',
                'labTest1Code', 'labTest2Code', 'labOrder1Code',
                'adminMed1Code', 'adminMed2Code', 'vaccine1Code', 'vaccine2Code'
            ];
            
            let hasTriggerCode = false;
            
            // Check existing fields
            triggerFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element?.value?.trim()) {
                    hasTriggerCode = true;
                }
            });
            
            // NEW: Check lab evidence
            if (!hasTriggerCode && Array.isArray(data.labEvidence)) {
                hasTriggerCode = data.labEvidence.some(ev => 
                    ev.isRCTC || 
                    isRCTCTriggerCode(ev.testCode) || 
                    isRCTCTriggerCode(ev.valueCode)
                );
            }
            
            if (!hasTriggerCode) {
                errors.push('FATAL: At least one trigger code template must be present (eICR requirement)');
            }
            
            return errors;
        }

        function validateDQDeathIndicator() {
            const errors = [];
            const deathIndicator = document.getElementById('patientDeathIndicator');
            const deathDate = document.getElementById('patientDeathDate');
            
            if (deathIndicator?.value === 'true' && !deathDate?.value) {
                errors.push('dq-deceasedTime: Death date cannot be nullFlavor when death indicator is true');
            }
            
            return errors;
        }

        function validateDQLabObservations() {
            const errors = [];
            
            // Lab Test 1 validation
            const lab1Code = document.getElementById('labTest1Code');
            const lab1Status = document.getElementById('labTest1Status');
            const lab1Result = document.getElementById('labTest1Result');
            
            if (lab1Code?.value && (!lab1Code.value.trim() || lab1Code.value === 'nullFlavor')) {
                errors.push('dq-resultObservation-002: Lab test 1 code cannot be nullFlavor');
            }
            
            if (lab1Status?.value && (!lab1Status.value.trim() || lab1Status.value === 'nullFlavor')) {
                errors.push('dq_lab_result_statusCode_001: Lab test 1 status code cannot be nullFlavor');
            }
            
            if (lab1Result?.value && (!lab1Result.value.trim() || lab1Result.value === 'nullFlavor')) {
                errors.push('dq-resultObservation-001: Lab test 1 result value cannot be nullFlavor');
            }
            
            // Lab Test 2 validation
            const lab2Code = document.getElementById('labTest2Code');
            const lab2Status = document.getElementById('labTest2Status');
            const lab2Result = document.getElementById('labTest2Result');
            
            if (lab2Code?.value && (!lab2Code.value.trim() || lab2Code.value === 'nullFlavor')) {
                errors.push('dq-resultObservation-002: Lab test 2 code cannot be nullFlavor');
            }
            
            if (lab2Status?.value && (!lab2Status.value.trim() || lab2Status.value === 'nullFlavor')) {
                errors.push('dq_lab_result_statusCode_001: Lab test 2 status code cannot be nullFlavor');
            }
            
            if (lab2Result?.value && (!lab2Result.value.trim() || lab2Result.value === 'nullFlavor')) {
                errors.push('dq-resultObservation-001: Lab test 2 result value cannot be nullFlavor');
            }
            
            return errors;
        }

        function validateDQMedicationAdministration() {
            const errors = [];
            
            // Medication 1 validation  
            const med1Id = document.getElementById('adminMed1Id');
            const med1Code = document.getElementById('adminMed1Code');
            
            if (med1Id?.value && (!med1Id.value.trim() || med1Id.value === 'nullFlavor')) {
                errors.push('dq-medicationAdministration-id-001: Medication 1 ID cannot be nullFlavor');
            }
            
            if (med1Code?.value && (!med1Code.value.trim() || med1Code.value === 'nullFlavor')) {
                errors.push('dq_medicationsAdministered-001: Medication 1 code cannot be nullFlavor');
            }
            
            // Medication 2 validation
            const med2Id = document.getElementById('adminMed2Id');
            const med2Code = document.getElementById('adminMed2Code');
            
            if (med2Id?.value && (!med2Id.value.trim() || med2Id.value === 'nullFlavor')) {
                errors.push('dq-medicationAdministration-id-001: Medication 2 ID cannot be nullFlavor');
            }
            
            if (med2Code?.value && (!med2Code.value.trim() || med2Code.value === 'nullFlavor')) {
                errors.push('dq_medicationsAdministered-001: Medication 2 code cannot be nullFlavor');
            }
            
            return errors;
        }

        function validateDQImmunizations() {
            const errors = [];
            
            // Immunization 1 validation
            const imm1Id = document.getElementById('immunization1Id');
            const imm1Date = document.getElementById('immunization1Date');
            const vac1Code = document.getElementById('vaccine1Code');
            
            if (imm1Id?.value && (!imm1Id.value.trim() || imm1Id.value === 'nullFlavor')) {
                errors.push('dq-immunizationActivity-id-001: Immunization 1 ID cannot be nullFlavor');
            }
            
            if (imm1Date?.value && (!imm1Date.value.trim() || imm1Date.value === 'nullFlavor')) {
                errors.push('dq-immunization-effectiveTime-001: Immunization 1 effective time cannot be nullFlavor');
            }
            
            if (imm1Date?.value && imm1Date.value.length < 8) {
                errors.push('dq-immunization-effectiveTime-003: Immunization 1 effective time must be at least 8 characters (YYYYMMDD)');
            }
            
            if (vac1Code?.value && (!vac1Code.value.trim() || vac1Code.value === 'nullFlavor')) {
                errors.push('dq-immunization-vaccineCode-001/002: Vaccine 1 code cannot be blank or nullFlavor');
            }
            
            // Immunization 2 validation
            const imm2Id = document.getElementById('immunization2Id');
            const imm2Date = document.getElementById('immunization2Date');
            const vac2Code = document.getElementById('vaccine2Code');
            
            if (imm2Id?.value && (!imm2Id.value.trim() || imm2Id.value === 'nullFlavor')) {
                errors.push('dq-immunizationActivity-id-001: Immunization 2 ID cannot be nullFlavor');
            }
            
            if (imm2Date?.value && (!imm2Date.value.trim() || imm2Date.value === 'nullFlavor')) {
                errors.push('dq-immunization-effectiveTime-001: Immunization 2 effective time cannot be nullFlavor');
            }
            
            if (imm2Date?.value && imm2Date.value.length < 8) {
                errors.push('dq-immunization-effectiveTime-003: Immunization 2 effective time must be at least 8 characters (YYYYMMDD)');
            }
            
            if (vac2Code?.value && (!vac2Code.value.trim() || vac2Code.value === 'nullFlavor')) {
                errors.push('dq-immunization-vaccineCode-001/002: Vaccine 2 code cannot be blank or nullFlavor');
            }
            
            return errors;
        }

        function validateDQProblemObservations() {
            const errors = [];
            
            // Diagnosis validation
            const diag1Code = document.getElementById('diagnosis1Code');
            const diag1Date = document.getElementById('diagnosis1Date');
            const diag1OnsetDate = document.getElementById('diagnosis1OnsetDate');
            
            if (diag1Code?.value && (!diag1Code.value.trim() || diag1Code.value === 'nullFlavor')) {
                errors.push('dq-problemObservation-002: Diagnosis 1 code cannot be nullFlavor');
            }
            
            if (diag1Date?.value && (!diag1Date.value.trim() || diag1Date.value === 'nullFlavor')) {
                errors.push('dq-validate_problem_DateofDiagnosis-001: Diagnosis 1 effective time cannot be nullFlavor');
            }
            
            if (diag1OnsetDate?.value && diag1OnsetDate.value.length < 8) {
                errors.push('dq-validate_problem_DateofDiagnosis-003: Diagnosis 1 onset date must be at least 8 characters (YYYYMMDD)');
            }
            
            return errors;
        }

        function validateFormData() {
            const allErrors = [];
            
            // Run all DQ validation functions
            allErrors.push(...validateDQPatientName());
            allErrors.push(...validateDQPatientAddress());
            allErrors.push(...validateDQAdministrativeGender());
            allErrors.push(...validateDQRaceCode());
            allErrors.push(...validateDQEthnicityCode());
            allErrors.push(...validateDQDateFormats());
            allErrors.push(...validateDQSpecimen());
            allErrors.push(...validateDQTriggerCodes());
            allErrors.push(...validateDQDeathIndicator());
            allErrors.push(...validateDQLabObservations());
            allErrors.push(...validateDQMedicationAdministration());
            allErrors.push(...validateDQImmunizations());
            allErrors.push(...validateDQProblemObservations());
            
            // Legacy required fields validation
            if (!validateRequiredFields()) {
                allErrors.push('Required field validation failed');
            }
            
            // Related document validation
            if (!validateRelatedDocumentFields()) {
                allErrors.push('Related document field validation failed');
            }
            
            if (allErrors.length > 0) {
                displayValidationErrors(allErrors);
                return false;
            }
            
            // Clear any existing errors and show success message
            const existingErrors = document.getElementById('validation-errors');
            if (existingErrors) {
                existingErrors.style.display = 'none';
            }
            
            displayValidationSuccess();
            return true;
        }

        function displayValidationErrors(errors) {
            const errorContainer = document.getElementById('validation-errors') || createErrorContainer();
            errorContainer.innerHTML = '<h3>DQ Schematron Validation Errors:</h3>';
            
            const errorList = document.createElement('ul');
            errors.forEach(error => {
                const errorItem = document.createElement('li');
                errorItem.textContent = error;
                errorItem.style.color = 'red';
                errorItem.style.marginBottom = '5px';
                errorList.appendChild(errorItem);
            });
            
            errorContainer.appendChild(errorList);
            errorContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function createErrorContainer() {
            const container = document.createElement('div');
            container.id = 'validation-errors';
            container.style.cssText = 'background: #fee; border: 2px solid #f00; padding: 20px; margin: 20px 0; border-radius: 5px;';
            document.querySelector('.container').insertBefore(container, document.querySelector('.footer-buttons'));
            return container;
        }

        function displayValidationSuccess() {
            let successContainer = document.getElementById('validation-success');
            if (!successContainer) {
                successContainer = document.createElement('div');
                successContainer.id = 'validation-success';
                successContainer.style.cssText = 'background: #efe; border: 2px solid #0a0; padding: 20px; margin: 20px 0; border-radius: 5px; color: #060;';
                document.querySelector('.container').insertBefore(successContainer, document.querySelector('.footer-buttons'));
            }
            
            successContainer.innerHTML = `
                <h3>‚úÖ Validation Passed!</h3>
                <p>The form is ready for CDA generation.</p>
            `;
            successContainer.style.display = 'block';
            successContainer.scrollIntoView({ behavior: 'smooth' });
            
            // Hide success message after 5 seconds
            setTimeout(() => {
                successContainer.style.display = 'none';
            }, 5000);
        }

        // Helper functions for CDA generation

// Helper functions for CDA generation
function xmlEscape(str = '') {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;');
}

function buildRRXml () {
  const d = getFormData();
  const labEvidence = (d.labEvidence || []);
  const x = s => xmlEscape(s || '');       // one-letter alias = escape **everything**
  const guid = () => generateGUID();

  /* =============== STATIC RR CONSTANTS =============== */
  const authorOrgOID    = '2.16.840.1.114222.4.1.217446';  // AIMS
  const custodianOrgOID = '2.16.840.1.114222.4.1.217446';  // APHL
  const rrDocOID        = guid();                          // doc ID for THIS RR
  const rrCreateTS      = new Date().toISOString()
                               .replace(/[-:T]/g,'')
                               .substring(0,14) + '-0000';

  /* =============== REPORTABLE CONDITIONS =============== */
  // Grab every diagnosis that has a code + name ‚Äì you can refine this
  // to only pull RCTC matches if desired.
  const conditions = [
    { code: d.diagnosis1Code, name: d.diagnosis1Name },
    { code: d.diagnosis2Code, name: d.diagnosis2Name },
    { code: d.diagnosis3Code, name: d.diagnosis3Name }
  ].filter(c => c.code && c.name);

  // Very simple classification: everything marked R1 (reportable)
  // Swap this for your own logic if you also emit R3 / R5 etc.
  const classify = () => 'R1';                      // R1 = ‚Äúreportable‚Äù
  const jurisdiction = () => `${x(d.patientCounty)} Health Department`;

  /* ---------- Build <text> table & machine-readable entries ---------- */
  let condRows   = '';
  let condEntries = '';

  conditions.forEach((c, idx) => {
    const resultCode = classify(c);      // e.g. R1, R3 ‚Ä¶
    const entryId    = guid();

    /* human-readable table row */
    condRows += `
      <tr>
        <td>${x(c.name)}</td>
        <td>${x(c.code)}</td>
        <td>${resultCode}</td>
        <td>${jurisdiction()}</td>
      </tr>`;

    /* machine-readable observation (Reportability Result Observation) */
    condEntries += `
      <entry>
        <observation classCode="OBS" moodCode="EVN">
          <!-- Reportability Result Observation (RR-O) -->
          <templateId root="2.16.840.1.113883.10.20.15.2.3.8" extension="2017-04-01"/>
          <id root="${entryId}"/>
          <code code="RR" codeSystem="2.16.840.1.114222.4.5.274"
                displayName="Reportability Result"/>
          <statusCode code="completed"/>
          <effectiveTime value="${rrCreateTS}"/>
          <value xsi:type="CD"
                 code="${resultCode}"
                 codeSystem="2.16.840.1.114222.4.5.232"
                 displayName="${resultCode === 'R1' ? 'Reportable' : 'Not Reportable'}"/>
          <entryRelationship typeCode="SUBJ">
            <observation classCode="OBS" moodCode="EVN">
              <!-- Condition that triggered the rule -->
              <templateId root="2.16.840.1.113883.10.20.15.2.3.3"/>
              <id root="${guid()}"/>
              <code code="75323-6" codeSystem="2.16.840.1.113883.6.1"
                    displayName="Condition"/>
              <statusCode code="completed"/>
              <value xsi:type="CD"
                     code="${x(c.code)}"
                     codeSystem="2.16.840.1.113883.6.96"
                     displayName="${x(c.name)}"/>
            </observation>
          </entryRelationship>
          ${labEvidence.map(ev => `
          <entryRelationship typeCode="SPRT">
            <observation classCode="OBS" moodCode="EVN">
              <id root="${guid()}"/>
              <statusCode code="completed"/>
              ${ev.time ? `<effectiveTime value="${x(ev.time)}"/>` : ''}
              ${(ev.testCode || ev.testName) ? `
                <code code="${x(ev.testCode||'')}" codeSystem="2.16.840.1.113883.6.1" displayName="${x(ev.testName||'Laboratory test')}"/>` : `
                <code nullFlavor="UNK"/>`}
              ${(ev.valueKind==='coded' && (ev.valueCode || ev.valueName)) ? `
                <value xsi:type="CD" code="${x(ev.valueCode||'')}" codeSystem="2.16.840.1.113883.6.96" displayName="${x(ev.valueName||'')}"/>` : ''}
              ${(ev.valueKind==='quantity' && ev.qtyValue) ? `
                <value xsi:type="PQ" value="${x(ev.qtyValue)}"${ev.qtyUnit?` unit="${x(ev.qtyUnit)}"`:''}/>` : ''}
              ${(ev.valueKind==='text' && ev.textValue) ? `
                <value xsi:type="ST">${x(ev.textValue)}</value>` : ''}
              ${mapInterp(ev.interpretation) ? `
                <interpretationCode code="${mapInterp(ev.interpretation)}" codeSystem="2.16.840.1.113883.5.83"/>` : ''}
            </observation>
          </entryRelationship>`).join('')}
          <participant typeCode="DST">
            <participantRole classCode="AGNT">
              <addr><state>${x(d.patientState)}</state></addr>
              <playingEntity classCode="PLC">
                <name>${jurisdiction()}</name>
              </playingEntity>
            </participantRole>
          </participant>
        </observation>
      </entry>`;
  });

  /* =============== THE RR XML =============== */
  return `<?xml version="1.0" encoding="UTF-8"?>
<ClinicalDocument xmlns="urn:hl7-org:v3" xmlns:sdtc="urn:hl7-org:sdtc"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!-- HEADER -->
  <realmCode code="US"/>
  <typeId root="2.16.840.1.113883.1.3" extension="POCD_HD000040"/>
  <templateId root="2.16.840.1.113883.10.20.15.2.1.2" extension="2017-04-01"/>
  <id root="${rrDocOID}"/>
  <code code="88085-6" codeSystem="2.16.840.1.113883.6.1"
        displayName="Reportability response report Document Public health"/>
  <title>Reportability Response</title>
  <effectiveTime value="${rrCreateTS}"/>
  <confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25"/>
  <languageCode code="en-US"/>

  <!-- PATIENT -->
  <recordTarget>
    <patientRole>
      <id extension="${x(d.patientId)}" root="2.16.840.1.113883.19.5"/>
      <addr use="H">
        <streetAddressLine>${x(d.patientAddress)}</streetAddressLine>
        <city>${x(d.patientCity)}</city><state>${x(d.patientState)}</state>
        <postalCode>${x(d.patientZip)}</postalCode>
        <country>${x(d.patientCountry) || 'US'}</country>
      </addr>
      <telecom value="tel:${x(d.patientPhone)}" use="MC"/>
      <patient>
        <name use="L">
          <given>${x((d.patientName||' ').split(' ')[0])}</given>
          <family>${x((d.patientName||' ').split(' ').slice(1).join(' '))}</family>
        </name>
        <administrativeGenderCode code="${x(d.patientGender)}"
                                  codeSystem="2.16.840.1.113883.5.1"/>
        <birthTime value="${x(d.patientBirthDate)}"/>
      </patient>
    </patientRole>
  </recordTarget>

  <!-- AUTHOR (AIMS) -->
  <author>
    <time value="${rrCreateTS}"/>
    <assignedAuthor>
      <id root="${authorOrgOID}"/>
      <assignedAuthoringDevice>
        <manufacturerModelName>AIMS</manufacturerModelName>
        <softwareName>AIMS</softwareName>
      </assignedAuthoringDevice>
    </assignedAuthor>
  </author>

  <!-- CUSTODIAN (APHL) -->
  <custodian>
    <assignedCustodian>
      <representedCustodianOrganization>
        <id root="${custodianOrgOID}"/>
        <name>APHL | Association of Public Health Laboratories</name>
      </representedCustodianOrganization>
    </assignedCustodian>
  </custodian>

  <!-- INFO RECIPIENT (Provider) -->
  <informationRecipient typeCode="PRCP">
    <intendedRecipient>
      <id extension="${x(d.providerId)}" root="2.16.840.1.113883.4.6"/>
      <informationRecipient>
        <name>
          <given>${x((d.providerName||' ').split(' ')[0])}</given>
          <family>${x((d.providerName||' ').split(' ').slice(1).join(' '))}</family>
        </name>
      </informationRecipient>
      <receivedOrganization><name>${x(d.facilityName)}</name></receivedOrganization>
    </intendedRecipient>
  </informationRecipient>

  <!-- ENCOMPASSING ENCOUNTER -->
  <componentOf>
    <encompassingEncounter>
      <id extension="${x(d.encounterId)}" root="2.16.840.1.113883.19"/>
      <effectiveTime><low value="${x(d.encounterDate)}"/></effectiveTime>
    </encompassingEncounter>
  </componentOf>

  <!-- BODY -->
  <component><structuredBody>

    <!-- SUBJECT section (88084-9) -->
    <component><section>
      <templateId root="2.16.840.1.113883.10.20.15.2.2.1" extension="2017-04-01"/>
      <code code="88084-9" codeSystem="2.16.840.1.113883.6.1"/>
      <text>
        <paragraph>This response indicates that public-health has processed the
        incoming eICR. <strong>${x(conditions[0]?.name || 'A condition')}</strong>
        is reportable for <em>${jurisdiction()}</em>.</paragraph>
      </text>
    </section></component>

    <!-- PROCESSING-INFO section (88082-3) -->
    <component><section>
      <templateId root="2.16.840.1.113883.10.20.15.2.2.3" extension="2017-04-01"/>
      <code code="88082-3" codeSystem="2.16.840.1.113883.6.1"/>
      <entry>
        <act classCode="ACT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.10.20.15.2.3.9" extension="2017-04-01"/>
          <code code="RR5" codeSystem="2.16.840.1.114222.4.5.232"
                 displayName="Received eICR Information"/>
          <statusCode code="completed"/>
          <reference typeCode="REFR">
            <externalDocument classCode="DOCCLIN" moodCode="EVN">
              <id root="${x(d.documentId)}"/>
              <code code="55751-2" codeSystem="2.16.840.1.113883.6.1"
                     displayName="Public Health Case Report (eICR)"/>
              <setId extension="${x(d.setId)}"
                     root="1.2.840.114350.1.13.380.3.7.1.1"/>
              <versionNumber value="${x(d.versionNumber)}"/>
            </externalDocument>
          </reference>
        </act>
      </entry>
      <entry>
        <act classCode="ACT" moodCode="EVN">
          <templateId extension="2017-04-01" root="2.16.840.1.113883.10.20.15.2.3.29"/>
          <id root="${guid()}"/>
          <code code="RRVS20" codeSystem="2.16.840.1.114222.4.5.274"
                codeSystemName="PHIN VS (CDC Local Coding System)"
                displayName="eICR was processed - with a warning"/>
          <entryRelationship typeCode="RSON">
            <observation classCode="OBS" moodCode="EVN">
              <templateId extension="2017-04-01" root="2.16.840.1.113883.10.20.15.2.3.21"/>
              <id root="${guid()}"/>
              <code code="RR6" codeSystem="2.16.840.1.114222.4.5.232"
                    displayName="eICR processing status reason"/>
              <value code="RRVS29" codeSystem="2.16.840.1.114222.4.5.274"
                     displayName="The eICR was processed with the warning of: outdated eRSD (RCTC) version."
                     xsi:type="CD"/>
              <entryRelationship typeCode="RSON">
                <observation classCode="OBS" moodCode="EVN">
                  <templateId extension="2017-04-01" root="2.16.840.1.113883.10.20.15.2.3.32"/>
                  <id root="${guid()}"/>
                  <code code="RRVS31" codeSystem="2.16.840.1.114222.4.5.274"
                        displayName="Outdated eRSD (RCTC) Version Detail"/>
                  <value xsi:type="ST">2.0.1</value>
                </observation>
              </entryRelationship>
              <entryRelationship typeCode="RSON">
                <observation classCode="OBS" moodCode="EVN">
                  <templateId extension="2017-04-01" root="2.16.840.1.113883.10.20.15.2.3.32"/>
                  <id root="${guid()}"/>
                  <code code="RRVS33" codeSystem="2.16.840.1.114222.4.5.274"
                        displayName="Expected eRSD (RCTC) Version Detail"/>
                  <value xsi:type="ST">The expected eRSD (RCTC) version should be one of the following: ["2025-02-28","2.0.0","3.0.1"]</value>
                </observation>
              </entryRelationship>
            </observation>
          </entryRelationship>
        </act>
      </entry>
    </section></component>

    <!-- REPORTABILITY RESULTS section (88083-1)  ‚Üê NEW -->
    <component><section>
      <templateId root="2.16.840.1.113883.10.20.15.2.2.2" extension="2017-04-01"/>
      <code code="88083-1" codeSystem="2.16.840.1.113883.6.1"/>
      <title>Reportability Results</title>
      <text>
        <table border="1">
          <thead><tr><th>Condition</th><th>Code</th><th>Classification</th><th>Jurisdiction</th></tr></thead>
          <tbody>${condRows}</tbody>
        </table>
      </text>
      ${condEntries}
    </section></component>

  </structuredBody></component>
</ClinicalDocument>`;
}

function generateRR() {
    return buildRRXml();
}

// Updated ZIP builder using local XSLT files with debugging
async function downloadZipOfEICRandRR() {
  try {
    if (!validateFormData()) return;
    
    console.log('Starting ZIP generation with debugging...');
    
    // Generate XML
    const eicrXml = generateEICRXml();
    const rrXml = generateRRXml();
    
    // Debug XML structure
    debugXmlStructure(eicrXml, 'eICR');
    debugXmlStructure(rrXml, 'RR');
    
    // Validate XML comments
    validateXMLComments(eicrXml, 'eICR');
    validateXMLComments(rrXml, 'RR');
    
    // Load XSLT files
    console.log('Loading XSLT files...');
    const eicrXsl = await fetchXslt(EICR_XSL_URL);
    const rrXsl = await fetchXslt(RR_XSL_URL);
    
    // Verify XSLT files
    if (eicrXsl.length < 1000 || !eicrXsl.includes('xsl:stylesheet')) {
      throw new Error('eICR XSLT appears to be invalid or incomplete');
    }
    if (rrXsl.length < 1000 || !rrXsl.includes('xsl:stylesheet')) {
      throw new Error('RR XSLT appears to be invalid or incomplete');
    }
    
    // Transform to HTML
    console.log('Transforming eICR...');
    const eicrHtml = xmlToHtml(eicrXml, eicrXsl);
    
    console.log('Transforming RR...');
    const rrHtml = xmlToHtml(rrXml, rrXsl);

    // Generate filenames
    const data = getFormData();
    const stamp = new Date().toISOString().split('T')[0];
    const base = (data.patientName || 'Patient').replace(/[^A-Za-z0-9]/g,'_') + '_' + (data.setId || 'Unknown') + '_' + stamp;

    // Create ZIP with all files
    console.log('Creating ZIP package...');
    const zip = new JSZip();
    zip.file(`eICR_${base}.xml`, eicrXml);
    zip.file(`RR_${base}.xml`, rrXml);
    zip.file(`eICR_${base}.html`, eicrHtml);
    zip.file(`RR_${base}.html`, rrHtml);

    // Add metadata if function exists
    if (typeof buildMetadataXml === 'function') {
      const metadata = buildMetadataXml([
        { fileName: `eICR_${base}.xml`, mimeType: 'application/xml' },
        { fileName: `RR_${base}.xml`, mimeType: 'application/xml' },
        { fileName: `eICR_${base}.html`, mimeType: 'text/html' },
        { fileName: `RR_${base}.html`, mimeType: 'text/html' },
      ]);
      zip.file('metadata.xml', metadata);
      console.log('Added metadata.xml to ZIP package');
    }

    console.log('Generating ZIP file...');
    const blob = await zip.generateAsync({ type: 'blob' });
    const filename = generateDynamicFilename('eCR', 'zip');
    
    // Try to use File System Access API (Chrome/Edge) to prompt for save location
    if ('showSaveFilePicker' in window) {
      try {
        const fileHandle = await window.showSaveFilePicker({
          suggestedName: filename,
          types: [
            {
              description: 'ZIP files',
              accept: { 'application/zip': ['.zip'] }
            }
          ]
        });
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();
        console.log('File saved with user-selected location');
        return;
      } catch (err) {
        if (err.name !== 'AbortError') {
          console.warn('File System Access API failed, falling back to download:', err);
        } else {
          console.log('User cancelled save dialog');
          return;
        }
      }
    }
    
    // Fallback: traditional download (goes to Downloads folder)
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { 
      href: url, 
      download: filename
    });
    document.body.appendChild(a); 
    a.click(); 
    a.remove(); 
    URL.revokeObjectURL(url);
    
    console.log('ZIP download completed successfully with 5 files (XML + HTML + metadata)');
    
  } catch (error) {
    console.error('Detailed error:', error);
    if (error.message.includes('XSLT file') || error.message.includes('XSLT transformation')) {
      alert(`Transformation failed: ${error.message}\n\nCheck the console for detailed debugging information.`);
    } else {
      alert(`Failed to build ZIP package: ${error.message}\n\nSee console for detailed error information.`);
    }
  }
}

async function generateAndDownloadRR() {
    try {
        const rrXml = generateRR();          // build the RR XML
        const blob = new Blob([rrXml], { type: 'application/xml' });
        const filename = generateDynamicFilename('RR', 'xml');

        // Try to use File System Access API (Chrome/Edge) to prompt for save location
        if ('showSaveFilePicker' in window) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: filename,
                    types: [
                        {
                            description: 'XML files',
                            accept: { 'application/xml': ['.xml'] }
                        }
                    ]
                });
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                console.log('RR file saved with user-selected location');
                return;
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.warn('File System Access API failed for RR, falling back to download:', err);
                } else {
                    console.log('User cancelled RR save dialog');
                    return;
                }
            }
        }

        // Fallback to traditional download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (e) {
        alert(`RR build failed: ${e.message}`);
        console.error(e);
    }
}
        
        function generateGUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Utility function to extract condition names from form data
        function extractConditionNames() {
            const data = getFormData();
            const conditions = [];

            // Extract all diagnosis entries that have both code and name
            if (data.diagnosis1Code && data.diagnosis1Name) {
                conditions.push(data.diagnosis1Name);
            }
            if (data.diagnosis2Code && data.diagnosis2Name) {
                conditions.push(data.diagnosis2Name);
            }
            if (data.diagnosis3Code && data.diagnosis3Name) {
                conditions.push(data.diagnosis3Name);
            }

            return conditions;
        }

        // Utility function to sanitize and format condition name for filename
        function sanitizeConditionName(conditionNames) {
            if (!conditionNames || conditionNames.length === 0) {
                return 'Unknown';
            }

            let result;
            if (conditionNames.length === 1) {
                result = conditionNames[0];
            } else {
                // Multiple conditions - use first + "Multi"
                result = conditionNames[0] + '_Multi';
            }

            // Apply common abbreviations
            const abbreviations = {
                'COVID-19': 'COVID19',
                'Coronavirus Disease 2019': 'COVID19',
                'Severe Acute Respiratory Syndrome Coronavirus 2': 'SARS_CoV2',
                'Tuberculosis': 'TB',
                'Human Immunodeficiency Virus': 'HIV',
                'Acquired Immunodeficiency Syndrome': 'AIDS',
                'Hepatitis A': 'HepA',
                'Hepatitis B': 'HepB',
                'Hepatitis C': 'HepC',
                'Influenza': 'Flu',
                'Pertussis': 'Whooping_Cough',
                'Salmonella': 'Salmonella',
                'Escherichia coli': 'E_coli',
                'Streptococcus': 'Strep',
                'Meningitis': 'Meningitis',
                'Down syndrome': 'Down_Syndrome',
                'Spina bifida': 'Spina_Bifida',
                'Tetralogy of Fallot': 'TOF'
            };

            // Check for exact matches first
            for (const [full, abbrev] of Object.entries(abbreviations)) {
                if (result.toLowerCase().includes(full.toLowerCase())) {
                    result = result.replace(new RegExp(full, 'gi'), abbrev);
                    break;
                }
            }

            // Remove disorder/disease/syndrome suffixes
            result = result.replace(/\s*\(disorder\)$/i, '')
                          .replace(/\s*\(disease\)$/i, '')
                          .replace(/\s*syndrome$/i, '')
                          .replace(/\s*disease$/i, '');

            // Sanitize for filename: remove invalid characters and spaces
            result = result.replace(/[\/\\:*?"<>|]/g, '')  // Remove invalid filename chars
                          .replace(/\s+/g, '_')             // Replace spaces with underscores
                          .replace(/[^\w\-_]/g, '')         // Keep only alphanumeric, dash, underscore
                          .replace(/_+/g, '_')              // Collapse multiple underscores
                          .replace(/^_|_$/g, '');           // Trim leading/trailing underscores

            // Limit length to ~20 characters
            if (result.length > 20) {
                result = result.substring(0, 20).replace(/_$/, '');
            }

            return result || 'Unknown';
        }

        // Utility function to generate timestamp in YYYYMMDD_HHMMSS format
        function generateTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            return `${year}${month}${day}_${hours}${minutes}${seconds}`;
        }

        // Utility function to generate dynamic filename
        function generateDynamicFilename(fileType, extension) {
            const conditionNames = extractConditionNames();
            const conditionName = sanitizeConditionName(conditionNames);
            const timestamp = generateTimestamp();

            return `${fileType}_${conditionName}_${timestamp}.${extension}`;
        }

        /* ---------- Vital-signs & anthropometrics ---------- */
function generateVitalSignsEntries(data) {

  // nothing to do?
  if (
    !data.temperature && !data.bloodPressure && !data.heartRate &&
    !data.respiratoryRate && !data.oxygenSaturation &&
    !data.weight && !data.height && !data.bmi
  ) { return ''; }

  // helper so we don‚Äôt repeat the templateId stanza 8 times
  const vital = (code, display, value, unit) => `
      <component>
        <observation classCode="OBS" moodCode="EVN">
          <templateId root="2.16.840.1.113883.10.20.22.4.27"
                      extension="2014-06-09"/>
          <id root="${generateGUID()}"/>
          <code code="${code}" codeSystem="2.16.840.1.113883.6.1"
                displayName="${display}"/>
          <statusCode code="completed"/>
          <effectiveTime value="${data.encounterDate}"/>
          <value xsi:type="PQ" value="${value}" unit="${unit}"/>
        </observation>
      </component>`;

  return `
    <entry typeCode="DRIV">
      <organizer classCode="CLUSTER" moodCode="EVN">
        <templateId root="2.16.840.1.113883.10.20.22.4.26"
                    extension="2015-08-01"/>
        <id root="${generateGUID()}"/>
        <code code="46680005" codeSystem="2.16.840.1.113883.6.96"
              displayName="Vital signs"/>
        <statusCode code="completed"/>
        <effectiveTime value="${data.encounterDate}"/>

        ${data.temperature         ? vital('8310-5', 'Body temperature',          data.temperature,      '[degF]')     : ''}
        ${data.bloodPressure       ? vital('8480-6', 'Systolic blood pressure',   data.bloodPressure.split('/')[0], 'mm[Hg]') : ''}
        ${data.heartRate           ? vital('8867-4', 'Heart rate',                data.heartRate,        '/min')       : ''}
        ${data.respiratoryRate     ? vital('9279-1', 'Respiratory rate',          data.respiratoryRate,  '/min')       : ''}
        ${data.oxygenSaturation    ? vital('59408-5','Oxygen saturation (SpO‚ÇÇ)',  data.oxygenSaturation, '%')          : ''}
        ${data.weight              ? vital('3141-9', 'Body weight',               data.weight,           'kg')         : ''}
        ${data.height              ? vital('8302-2', 'Body height',               data.height,           'cm')         : ''}
        ${data.bmi                 ? vital('39156-5','Body Mass Index',           data.bmi,              'kg/m2')      : ''}

      </organizer>
    </entry>`;
}
        /* ---------- Specimen Information (up to two specimens) ---------- */
function buildSpecimenSection(d) {
  // bail if the form is blank
  if (!d.specimen1Id && !d.specimen2Id) return '';

  // ---------- human-readable rows ----------
  const rows = [];
  const addRow = (src, type, id, dt) => rows.push(
    `<tr><td>${xmlEscape(src)}</td><td>${xmlEscape(type)}</td>` +
    `<td>${xmlEscape(id)}</td><td>${xmlEscape(dt)}</td></tr>`
  );

  // ---------- machine-readable entries ----------
  const entries = [];
  const addEntry = (src, type, id, dt) => entries.push(`
    <entry typeCode="DRIV">
      <procedure classCode="PROC" moodCode="EVN">
        <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
        <id root="${generateGUID()}" />
        <code code="33747-0" codeSystem="2.16.840.1.113883.6.1" displayName="General procedure" />
        <statusCode code="completed" />
        <effectiveTime value="${xmlEscape(dt)}"/>
        <targetSiteCode displayName="${xmlEscape(src)}" codeSystem="2.16.840.1.113883.6.96" />
        <participant typeCode="PRD">
          <participantRole classCode="SPEC">
            <templateId root="2.16.840.1.113883.10.20.22.4.410" extension="2019-06-21" />
            <id root="2.16.840.1.113883.3.72.5.9.1" extension="${xmlEscape(id)}"/>
            <code displayName="${xmlEscape(type)}" codeSystem="2.16.840.1.113883.6.96"/>
          </participantRole>
        </participant>
      </procedure>
    </entry>`);

  // specimen 1
if (d.specimen1Id) {
  addRow(d.specimen1Source, d.specimen1Type, d.specimen1Id, d.collection1Date);
  addEntry(d.specimen1Source, d.specimen1Type, d.specimen1Id, d.collection1Date);
}

// specimen 2
if (d.specimen2Id) {
  addRow(d.specimen2Source, d.specimen2Type, d.specimen2Id, d.collection2Date);
  addEntry(d.specimen2Source, d.specimen2Type, d.specimen2Id, d.collection2Date);
}


  // ---------- wrap it all in a section ----------
  return `
    <component>
      <section>
        <!-- *Consolidated CDA* Specimen section -->
        <templateId root="2.16.840.1.113883.10.20.22.2.3"/>
        <code code="30954-2" codeSystem="2.16.840.1.113883.6.1" displayName="Specimen"/>
        <title>Specimen Information</title>
        <text>
          <table border="1">
            <thead><tr><th>Source</th><th>Type</th><th>ID</th><th>Collection Date</th></tr></thead>
            <tbody>${rows.join('')}</tbody>
          </table>
        </text>
        ${entries.join('\n')}
      </section>
    </component>`;
}

/* helper to emit dose + optional rate  ---------------------- */
function buildDoseXML (dVal, dUnit, vVal, vUnit) {
  let xml = `          <doseQuantity value="${dVal}" unit="${dUnit}"/>\n`;
  if (vVal && vUnit) {
    xml += `          <rateQuantity value="${vVal}" unit="${vUnit}"/>\n`;
  }
  return xml;
}

       /* ---------- Medication entries (schema-compliant) ---------- */
function generateMedicationEntries (d) {

  const meds = [
    {
      code:d.adminMed1Code, name:d.adminMed1Name, id:d.adminMed1Id,
      status:d.adminMed1Status, time:d.adminMed1Time, route:d.adminMed1Route,
      dVal:d.adminMed1DoseValue, dUnit:d.adminMed1DoseUnit,
      vVal:d.adminMed1VolValue, vUnit:d.adminMed1VolUnit,
      neg:d.adminMed1Negated ? 'true' : 'false'
    },
    {
      code:d.adminMed2Code, name:d.adminMed2Name, id:d.adminMed2Id,
      status:d.adminMed2Status, time:d.adminMed2Time, route:d.adminMed2Route,
      dVal:d.adminMed2DoseValue, dUnit:d.adminMed2DoseUnit,
      vVal:d.adminMed2VolValue, vUnit:d.adminMed2VolUnit,
      neg:d.adminMed2Negated ? 'true' : 'false'
    }
  ];

  return meds.filter(m => m.code && m.name).map(m => `
        <entry typeCode="DRIV">
          <substanceAdministration classCode="SBADM" moodCode="EVN"
                                   negationInd="${m.neg}">
            <templateId root="2.16.840.1.113883.10.20.22.4.16"
                        extension="2014-06-09"/>
            <id root="${generateGUID()}"/>
            <statusCode code="${m.status}"/>
            <effectiveTime xsi:type="IVL_TS">
              <low value="${m.time}"/>
            </effectiveTime>
            <routeCode code="${m.route}"
                       codeSystem="2.16.840.1.113883.3.26.1.1"/>
${buildDoseXML(m.dVal, m.dUnit, m.vVal, m.vUnit)}            <consumable>
              <manufacturedProduct classCode="MANU">
                <templateId root="2.16.840.1.113883.10.20.22.4.23"
                            extension="2014-06-09"/>
                <manufacturedMaterial>
                  <code code="${m.code}"
                        codeSystem="2.16.840.1.113883.6.88"
                        displayName="${xmlEscape(m.name)}"/>
                </manufacturedMaterial>
              </manufacturedProduct>
            </consumable>
          </substanceAdministration>
        </entry>`).join('');
}


        function generateImmunizationEntries(data) {
            let entries = '';
            
            if (data.vaccine1Code && data.vaccine1Name) {
                entries += `
                <entry typeCode="DRIV">
                    <substanceAdministration classCode="SBADM" moodCode="EVN" negationInd="false">
                        <templateId root="2.16.840.1.113883.10.20.22.4.52" extension="2015-08-01" />
                        <id root="${generateGUID()}" />
                        <statusCode code="${data.immunization1Status || 'completed'}" />
                        <effectiveTime value="${data.immunization1Date}" />
                        <routeCode code="${data.vaccine1Route || 'IM'}" codeSystem="2.16.840.1.113883.3.26.1.1" />
                        <doseQuantity value="${data.vaccine1Dose ? data.vaccine1Dose.split(' ')[0] : ''}" unit="${data.vaccine1Dose ? data.vaccine1Dose.split(' ')[1] || 'mL' : 'mL'}" />
                        <consumable>
                            <manufacturedProduct classCode="MANU">
                                <templateId root="2.16.840.1.113883.10.20.22.4.54" extension="2014-06-09" />
                                <manufacturedMaterial>
                                    <code code="${data.vaccine1Code}" codeSystem="2.16.840.1.113883.12.292" displayName="${data.vaccine1Name}" />
                                </manufacturedMaterial>
                                <manufacturerOrganization>
                                    <name>${data.vaccine1Manufacturer}</name>
                                </manufacturerOrganization>
                            </manufacturedProduct>
                        </consumable>
                    </substanceAdministration>
                </entry>`;
            }
            
            if (data.vaccine2Code && data.vaccine2Name) {
                entries += `
                <entry typeCode="DRIV">
                    <substanceAdministration classCode="SBADM" moodCode="EVN" negationInd="false">
                        <templateId root="2.16.840.1.113883.10.20.22.4.52" extension="2015-08-01" />
                        <id root="${generateGUID()}" />
                        <statusCode code="${data.immunization2Status || 'completed'}" />
                        <effectiveTime value="${data.immunization2Date}" />
                        <routeCode code="${data.vaccine2Route || 'IM'}" codeSystem="2.16.840.1.113883.3.26.1.1" />
                        <doseQuantity value="${data.vaccine2Dose ? data.vaccine2Dose.split(' ')[0] : ''}" unit="${data.vaccine2Dose ? data.vaccine2Dose.split(' ')[1] || 'mL' : 'mL'}" />
                        <consumable>
                            <manufacturedProduct classCode="MANU">
                                <templateId root="2.16.840.1.113883.10.20.22.4.54" extension="2014-06-09" />
                                <manufacturedMaterial>
                                    <code code="${data.vaccine2Code}" codeSystem="2.16.840.1.113883.12.292" displayName="${data.vaccine2Name}" />
                                </manufacturedMaterial>
                                <manufacturerOrganization>
                                    <name>${data.vaccine2Manufacturer}</name>
                                </manufacturerOrganization>
                            </manufacturedProduct>
                        </consumable>
                    </substanceAdministration>
                </entry>`;
            }
            
            return entries;
        }

        function generateProcedureEntries(data) {
            let entries = '';
            
            if (data.currentProc1Code && data.currentProc1Name) {
                entries += `
                <entry typeCode="DRIV">
                    <procedure classCode="PROC" moodCode="EVN">
                        <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
                        <id root="${generateGUID()}" />
                        <code code="${data.currentProc1Code}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.currentProc1Name}" />
                        <statusCode code="completed" />
                        <effectiveTime value="${data.currentProc1Date}" />
                    </procedure>
                </entry>`;
            }
            
            if (data.currentProc2Code && data.currentProc2Name) {
                entries += `
                <entry typeCode="DRIV">
                    <procedure classCode="PROC" moodCode="EVN">
                        <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
                        <id root="${generateGUID()}" />
                        <code code="${data.currentProc2Code}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.currentProc2Name}" />
                        <statusCode code="completed" />
                        <effectiveTime value="${data.currentProc2Date}" />
                    </procedure>
                </entry>`;
            }
            
            // Add specimen collection procedures
            if (data.specimen1Id && data.collection1Date) {
                entries += `
                <entry typeCode="DRIV">
                    <procedure classCode="PROC" moodCode="EVN">
                        <templateId root="2.16.840.1.113883.10.20.22.4.415" extension="2019-06-21" />
                        <id root="${generateGUID()}" />
                        <code code="33747-0" codeSystem="2.16.840.1.113883.6.1" displayName="General procedure" />
                        <statusCode code="completed" />
                        <effectiveTime value="${data.collection1Date}" />
                        <targetSiteCode code="${data.specimen1Source}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.specimen1Type}" />
                        <participant typeCode="PRD">
                            <participantRole classCode="SPEC">
                                <templateId root="2.16.840.1.113883.10.20.22.4.410" extension="2019-06-21" />
                                <id root="${generateGUID()}" extension="${data.specimen1Id}" />
                                <code code="${data.specimen1Source}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.specimen1Type}" />
                            </participantRole>
                        </participant>
                    </procedure>
                </entry>`;
            }
            
            if (data.specimen2Id && data.collection2Date) {
                entries += `
                <entry typeCode="DRIV">
                    <procedure classCode="PROC" moodCode="EVN">
                        <templateId root="2.16.840.1.113883.10.20.22.4.415" extension="2019-06-21" />
                        <id root="${generateGUID()}" />
                        <code code="33747-0" codeSystem="2.16.840.1.113883.6.1" displayName="General procedure" />
                        <statusCode code="completed" />
                        <effectiveTime value="${data.collection2Date}" />
                        <targetSiteCode code="${data.specimen2Source}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.specimen2Type}" />
                        <participant typeCode="PRD">
                            <participantRole classCode="SPEC">
                                <templateId root="2.16.840.1.113883.10.20.22.4.410" extension="2019-06-21" />
                                <id root="${generateGUID()}" extension="${data.specimen2Id}" />
                                <code code="${data.specimen2Source}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.specimen2Type}" />
                            </participantRole>
                        </participant>
                    </procedure>
                </entry>`;
            }
            
            return entries;
        }

        // Lab Evidence Repeater Functions
        function addLabEvidence(prefill = {}) {
            const template = document.getElementById('labEvidenceTemplate');
            const clone = template.content.cloneNode(true);
            const row = clone.querySelector('.lab-evidence-row');
            
            // Populate with prefill data if provided
            if (prefill.testCode) row.querySelector('.le-test-code').value = prefill.testCode;
            if (prefill.testName) row.querySelector('.le-test-name').value = prefill.testName;
            if (prefill.valueKind) {
                row.querySelector('.le-value-kind').value = prefill.valueKind;
                toggleValueEditors(row.querySelector('.le-value-kind'));
            }
            if (prefill.valueCode) row.querySelector('.le-value-code').value = prefill.valueCode;
            if (prefill.valueName) row.querySelector('.le-value-name').value = prefill.valueName;
            if (prefill.qtyValue) row.querySelector('.le-qty-value').value = prefill.qtyValue;
            if (prefill.qtyUnit) row.querySelector('.le-qty-unit').value = prefill.qtyUnit;
            if (prefill.textValue) row.querySelector('.le-text-value').value = prefill.textValue;
            if (prefill.time) row.querySelector('.le-time').value = prefill.time;
            if (prefill.status) row.querySelector('.le-status').value = prefill.status;
            if (prefill.interpretation) row.querySelector('.le-interpretation').value = prefill.interpretation;
            // RCTC flag removed - auto-detect based on RCTC trigger codes
            
            document.getElementById('labEvidenceList').appendChild(clone);
        }

        function removeLabEvidence(btn) {
            btn.closest('.lab-evidence-row')?.remove();
        }

        function toggleValueEditors(sel) {
            const row = sel.closest('.lab-evidence-row');
            row.querySelectorAll('.le-coded,.le-qty,.le-text').forEach(el => el.classList.add('hidden'));
            const kind = sel.value;
            if (kind === 'coded') row.querySelectorAll('.le-coded').forEach(el => el.classList.remove('hidden'));
            if (kind === 'quantity') row.querySelectorAll('.le-qty').forEach(el => el.classList.remove('hidden'));
            if (kind === 'text') row.querySelectorAll('.le-text').forEach(el => el.classList.remove('hidden'));
        }

        // Search functions for lab orders and organisms
        async function searchRCTCForTest(btn) {
          const row = btn.closest('.lab-evidence-row');
          const codeInput  = row.querySelector('.le-test-code');
          const nameInput  = row.querySelector('.le-test-name');
          const resultsDiv = row.querySelector('.le-test-code-results');

          // UI: loading state
          btn.textContent = '‚è≥';
          btn.disabled = true;
          if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

          try {
            if (!testLoaded) await loadTestsFromRCTC();
            if (!Array.isArray(testData) || testData.length === 0) {
              alert('Test list is empty. The RCTC file may not have loaded.');
              return;
            }

            const q = String(codeInput.value || '').trim().toLowerCase();
            if (!q) { alert('Enter a LOINC code to search'); return; }

            const exact = testData.filter(t => String(t.code || '').toLowerCase() === q);
            const starts = testData.filter(t => String(t.code || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === t.code));
            const contains = testData.filter(t => String(t.code || '').toLowerCase().includes(q)
              && !exact.some(e => e.code === t.code)
              && !starts.some(s => s.code === t.code));

            const matches = [...exact, ...starts, ...contains];

            if (!matches.length) {
              if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="no-results">No matching test codes found</div>';
              }
              return;
            }

            if (resultsDiv) {
              const list = document.createElement('div');
              list.className = 'search-results-list';

              matches.slice(0, 10).forEach(t => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<strong>${t.code}</strong> ‚Äî ${t.name}${t.description ? `<br><small>${t.description}</small>` : ''}`;
                item.onclick = () => {
                  codeInput.value = t.code;
                  nameInput.value = t.name;
                  resultsDiv.style.display = 'none';
                };
                list.appendChild(item);
              });

              resultsDiv.appendChild(list);
              resultsDiv.style.display = 'block';
            } else {
              codeInput.value = matches[0].code;
              nameInput.value = matches[0].name;
            }
          } catch (err) {
            console.error('Test code search error:', err);
            alert('Error searching tests (code). See console for details.');
          } finally {
            btn.textContent = 'üîç';
            btn.disabled = false;
          }
        }

        async function searchRCTCForOrganism(btn) {
          const row = btn.closest('.lab-evidence-row');
          const codeInput   = row.querySelector('.le-value-code');
          const nameInput   = row.querySelector('.le-value-name');
          const resultsDiv  = row.querySelector('.le-value-code-results');

          // UI: loading state
          btn.textContent = '‚è≥';
          btn.disabled = true;
          if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

          try {
            if (!organismLoaded) await loadOrganismFromRCTC();
            if (!Array.isArray(organismData) || organismData.length === 0) {
              alert('Organism list is empty. The RCTC file may not have loaded.');
              return;
            }

            const q = String(codeInput.value || '').trim().toLowerCase();
            if (!q) { alert('Enter a code to search'); return; }

            const exact = organismData.filter(o => String(o.code || '').toLowerCase() === q);
            const starts = organismData.filter(o => String(o.code || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === o.code));
            const contains = organismData.filter(o => String(o.code || '').toLowerCase().includes(q)
              && !exact.some(e => e.code === o.code)
              && !starts.some(s => s.code === o.code));

            const matches = [...exact, ...starts, ...contains];

            if (!matches.length) {
              if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="no-results">No matching organisms found</div>';
              }
              return;
            }

            if (resultsDiv) {
              const list = document.createElement('div');
              list.className = 'search-results-list';

              matches.slice(0, 10).forEach(o => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<strong>${o.code}</strong> ‚Äî ${o.name}${o.description ? `<br><small>${o.description}</small>` : ''}`;
                item.onclick = () => {
                  codeInput.value = o.code;
                  nameInput.value = o.name;
                  resultsDiv.style.display = 'none';
                };
                list.appendChild(item);
              });

              resultsDiv.appendChild(list);
              resultsDiv.style.display = 'block';
            } else {
              // Fallback
              codeInput.value = matches[0].code;
              nameInput.value = matches[0].name;
            }
          } catch (err) {
            console.error('Organism code search error:', err);
            alert('Error searching organisms. See console for details.');
          } finally {
            btn.textContent = 'üîç';
            btn.disabled = false;
          }
        }

        // Search by test name
        async function searchRCTCForTestByName(btn) {
          const row = btn.closest('.lab-evidence-row');
          const codeInput  = row.querySelector('.le-test-code');
          const nameInput  = row.querySelector('.le-test-name');
          const resultsDiv = row.querySelector('.le-test-name-results');

          btn.textContent = '‚è≥';
          btn.disabled = true;
          if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

          try {
            if (!testLoaded) await loadTestsFromRCTC();
            if (!Array.isArray(testData) || testData.length === 0) {
              alert('Test list is empty. The RCTC file may not have loaded.');
              return;
            }

            const q = String(nameInput.value || '').trim().toLowerCase();
            if (!q) { alert('Enter a test name to search'); return; }

            const exact = testData.filter(t => String(t.name || '').toLowerCase() === q);
            const starts = testData.filter(t => String(t.name || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === t.code));
            const contains = testData.filter(t => String(t.name || '').toLowerCase().includes(q)
              && !exact.some(e => e.code === t.code)
              && !starts.some(s => s.code === t.code));

            const matches = [...exact, ...starts, ...contains];

            if (!matches.length) {
              if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="no-results">No matching test names found</div>';
              } else {
                alert(`No tests found for "${q}".`);
              }
              return;
            }

            if (resultsDiv) {
              const list = document.createElement('div');
              list.className = 'search-results-list';

              matches.slice(0, 10).forEach(t => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<strong>${t.name}</strong> ‚Äî ${t.code}${t.description ? `<br><small>${t.description}</small>` : ''}`;
                item.onclick = () => {
                  codeInput.value = t.code;
                  nameInput.value = t.name;
                  resultsDiv.style.display = 'none';
                };
                list.appendChild(item);
              });

              resultsDiv.appendChild(list);
              resultsDiv.style.display = 'block';
            } else {
              codeInput.value = matches[0].code;
              nameInput.value = matches[0].name;
            }
          } catch (err) {
            console.error('Test name search error:', err);
            alert('Error searching tests (name). See console for details.');
          } finally {
            btn.textContent = 'üîç';
            btn.disabled = false;
          }
        }

        // Search by organism name
        async function searchRCTCForOrganismByName(btn) {
          const row = btn.closest('.lab-evidence-row');
          const codeInput   = row.querySelector('.le-value-code');
          const nameInput   = row.querySelector('.le-value-name');
          const resultsDiv  = row.querySelector('.le-value-name-results');

          btn.textContent = '‚è≥';
          btn.disabled = true;
          if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

          try {
            if (!organismLoaded) await loadOrganismFromRCTC();
            if (!Array.isArray(organismData) || organismData.length === 0) {
              alert('Organism list is empty. The RCTC file may not have loaded.');
              return;
            }

            const q = String(nameInput.value || '').trim().toLowerCase();
            if (!q) { alert('Enter a name to search'); return; }

            const exact = organismData.filter(o => String(o.name || '').toLowerCase() === q);
            const starts = organismData.filter(o => String(o.name || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === o.code));
            const contains = organismData.filter(o => String(o.name || '').toLowerCase().includes(q)
              && !exact.some(e => e.code === o.code)
              && !starts.some(s => s.code === o.code));

            const matches = [...exact, ...starts, ...contains];

            if (!matches.length) {
              if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="no-results">No matching organisms found</div>';
              } else {
                alert(`No organisms found for "${q}".`);
              }
              return;
            }

            if (resultsDiv) {
              const list = document.createElement('div');
              list.className = 'search-results-list';

              matches.slice(0, 10).forEach(o => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<strong>${o.name}</strong> ‚Äî ${o.code}${o.description ? `<br><small>${o.description}</small>` : ''}`;
                item.onclick = () => {
                  codeInput.value = o.code;
                  nameInput.value = o.name;
                  resultsDiv.style.display = 'none';
                };
                list.appendChild(item);
              });

              resultsDiv.appendChild(list);
              resultsDiv.style.display = 'block';
            } else {
              codeInput.value = matches[0].code;
              nameInput.value = matches[0].name;
            }
          } catch (err) {
            console.error('Organism name search error:', err);
            alert('Error searching organisms. See console for details.');
          } finally {
            btn.textContent = 'üîç';
            btn.disabled = false;
          }
        }

        function collectLabEvidence() {
            return Array.from(document.querySelectorAll('.lab-evidence-row')).map(r => {
                const kind = r.querySelector('.le-value-kind').value;
                return {
                    testCode: r.querySelector('.le-test-code').value.trim(),
                    testName: r.querySelector('.le-test-name').value.trim(),
                    valueKind: kind,
                    valueCode: r.querySelector('.le-value-code').value.trim(),
                    valueName: r.querySelector('.le-value-name').value.trim(),
                    qtyValue: r.querySelector('.le-qty-value').value.trim(),
                    qtyUnit: r.querySelector('.le-qty-unit').value.trim(),
                    textValue: r.querySelector('.le-text-value').value.trim(),
                    time: r.querySelector('.le-time').value.trim(),
                    status: r.querySelector('.le-status').value,
                    interpretation: r.querySelector('.le-interpretation').value,
                    isRCTC: isRCTCTriggerCode(r.querySelector('.le-test-code').value) || isRCTCTriggerCode(r.querySelector('.le-value-code').value)
                };
            }).filter(x => x.testCode || x.testName);
        }

        // Interpretation mapping
        function mapInterp(v) {
            switch ((v||'').toLowerCase()) {
                case 'positive': return 'POS';
                case 'negative': return 'NEG';
                case 'detected': return 'DET';
                case 'not detected': return 'NDET';
                case 'a': return 'A';
                case 'n': return 'N';
                case 'h': return 'H';
                case 'l': return 'L';
                default: return '';
            }
        }

        function buildResultsSectionXML(labEvidence, rctcVersion = '2016-12-01') {
            if (!labEvidence || labEvidence.length === 0) return '';
            
            const esc = s => xmlEscape(s || '');
            
            const obsXml = labEvidence.map(le => {
                const id = generateGUID();
                const vsOID = '2.16.840.1.114222.4.11.7508'; // Default COVID-19 valueset
                
                const codeAttrs = [
                    le.testCode ? `code="${esc(le.testCode)}"` : 'nullFlavor="UNK"',
                    `codeSystem="2.16.840.1.113883.6.1"`,
                    `codeSystemName="LOINC"`,
                    le.testName ? `displayName="${esc(le.testName)}"` : null,
                    le.isRCTC && le.testCode ? `sdtc:valueSet="${vsOID}" sdtc:valueSetVersion="${esc(rctcVersion)}"` : null
                ].filter(Boolean).join(' ');

                // vsOID and rctcVersion should already be computed for this observation
const vsPair = (le.isRCTC && vsOID && rctcVersion)
  ? ` sdtc:valueSet="${esc(vsOID)}" sdtc:valueSetVersion="${esc(rctcVersion)}"`
  : '';

let valueXml = `<value xsi:type="CD" nullFlavor="UNK"/>`; // safe default

if (le.valueKind === 'coded') {
  valueXml = le.valueCode
    ? `<value xsi:type="CD"
         code="${esc(le.valueCode)}"
         ${le.valueName ? `displayName="${esc(le.valueName)}"` : ''}
         codeSystem="2.16.840.1.113883.6.96"
         codeSystemName="SNOMED CT"${vsPair}/>`
    : `<value xsi:type="CD" nullFlavor="UNK"/>`; // avoid code=""
} else if (le.valueKind === 'quantity' && le.qtyValue) {
  // Numeric result
  valueXml = `<value xsi:type="PQ" value="${esc(le.qtyValue)}"${le.qtyUnit ? ` unit="${esc(le.qtyUnit)}"` : ''}/>`;
  // If this observation is also RCTC-bound, add a coded translation carrying the sdtc pair
  if (le.isRCTC && le.interpretationCode) {
    const trans = `<translation xsi:type="CD"
                     code="${esc(le.interpretationCode)}"
                     ${le.interpretationName ? `displayName="${esc(le.interpretationName)}"` : ''}
                     codeSystem="2.16.840.1.113883.6.96"
                     codeSystemName="SNOMED CT"${vsPair}/>`;
    valueXml = valueXml.replace('/>', `>${trans}</value>`);
  }
} else if (le.valueKind === 'text' && le.textValue) {
  // Text result
  valueXml = `<value xsi:type="ST">${esc(le.textValue)}</value>`;
  // Same idea: optional coded translation to carry the sdtc pair
  if (le.isRCTC && le.interpretationCode) {
    const trans = `<translation xsi:type="CD"
                     code="${esc(le.interpretationCode)}"
                     ${le.interpretationName ? `displayName="${esc(le.interpretationName)}"` : ''}
                     codeSystem="2.16.840.1.113883.6.96"
                     codeSystemName="SNOMED CT"${vsPair}/>`;
    valueXml = valueXml.replace('</value>', `${trans}</value>`);
  }
}


                const interp = mapInterp(le.interpretation) ? `<interpretationCode code="${mapInterp(le.interpretation)}" codeSystem="2.16.840.1.113883.5.83"/>` : '';

                return `
                <entry>
                    <organizer classCode="CLUSTER" moodCode="EVN">
                    <!-- Result Organizer (V3) -->
                    <templateId root="2.16.840.1.113883.10.20.22.4.1" extension="2015-08-01"/>
                   <id root="${id}"/>
    <code code="${esc(le.testCode||'')}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="${esc(le.testName||'Laboratory studies')}"/>
    <statusCode code="completed"/>
                    <component>
                        <observation classCode="OBS" moodCode="EVN">
                        <!-- Result Observation (V3) -->
                        <templateId root="2.16.840.1.113883.10.20.22.4.2"/>
                        <templateId root="2.16.840.1.113883.10.20.22.4.2" extension="2015-08-01"/>
                        <!-- Initial Case Report Trigger Code Result Observation (eICR) -->
                        <templateId root="2.16.840.1.113883.10.20.15.2.3.2" extension="2016-12-01"/>
                        <id root="${id}"/>
                        <code ${codeAttrs}/>
                        <statusCode code="${esc(le.status||'completed')}"/>
                        ${le.time ? `<effectiveTime value="${esc(le.time)}"/>` : ''}
                        ${valueXml}
                        ${interp}
                        </observation>
                    </component>
                    </organizer>
                </entry>`;
            }).join('\n');

            const narrative = labEvidence.map(le => `
                <tr>
                <td>${esc(le.testName||le.testCode||'')}</td>
                <td>${le.valueKind==='coded' ? esc(le.valueName||le.valueCode||'') : le.valueKind==='quantity' ? `${esc(le.qtyValue||'')} ${esc(le.qtyUnit||'')}` : esc(le.textValue||'')}</td>
                <td>${esc(le.status||'')}</td>
                <td>${esc(le.time||'')}</td>
                </tr>`).join('');

            return `
                <component>
                <section>
                    <!-- Results Section (entries required) -->
                    <templateId root="2.16.840.1.113883.10.20.22.2.3.1" extension="2015-08-01"/>
                    <code code="30954-2" codeSystem="2.16.840.1.113883.6.1" displayName="Relevant diagnostic tests and/or laboratory data"/>
                    <title>Results</title>
                    <text>
                    <table border="1">
                        <thead><tr><th>Test</th><th>Value</th><th>Status</th><th>Time</th></tr></thead>
                        <tbody>${narrative}</tbody>
                    </table>
                    </text>
                    ${obsXml}
                </section>
                </component>`;
        }

        function buildEICRXml() {
            // Run comprehensive DQ Schematron validation first
            if (!validateFormData()) {
                throw new Error('Form data does not pass DQ Schematron validation. Please correct the errors and try again.');
            }
            
            const data = getFormData();
            
            // Additional CDA-specific validation
            if (!data.patientId || !data.patientName || !data.providerId) {
                throw new Error('Missing required patient or provider information for CDA generation');
            }
            
            if (!data.providerPhone) {
                throw new Error('Provider phone is required for author telecom compliance (CONF:1198-5428)');
            }
            
            if (!data.facilityAddress || !data.patientCity || !data.patientState || !data.patientZip) {
                throw new Error('Complete facility address is required for US Realm compliance (CONF:1198-5452)');
            }
            
            const cdaTemplate = `<?xml version="1.0" encoding="UTF-8"?>
<!-- 
  HL7 CDA-compliant eICR Document
  Generated by eICR Form Generator v1.0

-->
<ClinicalDocument xmlns="urn:hl7-org:v3" xmlns:cda="urn:hl7-org:v3" xmlns:sdtc="urn:hl7-org:sdtc"
  xmlns:voc="http://www.lantanagroup.com/voc"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="urn:hl7-org:v3 ../../schema/infrastructure/cda/CDA_SDTC.xsd">
  <realmCode code="US" />
  <typeId extension="POCD_HD000040" root="2.16.840.1.113883.1.3" />
  <templateId root="2.16.840.1.113883.10.20.22.1.1" />
  <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.1.1" />
  <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2" />
  <templateId extension="2022-05-01" root="2.16.840.1.113883.10.20.15.2" />
  <id root="${data.documentId}" />
  <code code="55751-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
    displayName="Public Health Case Report" />
  <title>Initial Public Health Case Report</title>
  <effectiveTime value="${data.effectiveTime}" />
  <confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25" displayName="Normal" />
  <languageCode code="en-US" />
  <setId extension="${getEffectiveSetId(data)}" root="1.2.840.114350.1.13.380.3.7.1.1" />
  <versionNumber value="${data.versionNumber}" />
  ${generateRelatedDocumentXml(data)}
  
  <!-- Patient Information -->
 <recordTarget>
    <patientRole>
      <id extension="${data.patientId}" root="2.16.840.1.113883.19.5" />
      <addr use="H">
        <streetAddressLine>${data.patientAddress}</streetAddressLine>
        <city>${data.patientCity}</city>
        <state>${data.patientState}</state>
        <postalCode>${data.patientZip}</postalCode>
        <county>${data.patientCounty}</county>
        <country>${data.patientCountry || 'US'}</country>
      </addr>
      <telecom use="MC" value="tel:${data.patientPhone}" />
      <telecom use="WP" value="mailto:${data.patientEmail}" />
    <patient>
      <!-- CDA Schema Compliant Patient Element Order -->
      <name use="L">
        <given>${data.patientName.split(' ')[0]}</given>
        <family>${data.patientName.split(' ').slice(1).join(' ')}</family>
      </name>
      <administrativeGenderCode code="${data.patientGender}" codeSystem="2.16.840.1.113883.5.1"
        displayName="${data.patientGender === 'F' ? 'Female' : 'Male'}" />
      <birthTime value="${data.patientBirthDate}" />
<sdtc:deceasedInd value="${data.patientDeathIndicator || 'false'}" />
      ${data.patientDeathDate ? `<sdtc:deceasedTime value="${data.patientDeathDate}" />` : ''}

      <raceCode code="${data.patientRace}" codeSystem="2.16.840.1.113883.6.238"
        codeSystemName="Race &amp; Ethnicity - CDC" displayName="${getRaceDisplayName(data.patientRace)}" />
      ${data.patientDetailedRace ? `<sdtc:raceCode code="${data.patientDetailedRace}" codeSystem="2.16.840.1.113883.6.238" />` : ''}
      <ethnicGroupCode code="${data.patientEthnicity}" codeSystem="2.16.840.1.113883.6.238"
        codeSystemName="Race &amp; Ethnicity - CDC" displayName="${getEthnicityDisplayName(data.patientEthnicity)}" />
      ${data.patientDetailedEthnicity ? `<sdtc:ethnicGroupCode code="${data.patientDetailedEthnicity}" codeSystem="2.16.840.1.113883.6.238" />` : ''}
      ${data.guardianName ? `
      <guardian>
        <code code="${data.guardianCode || 'GUARD'}" codeSystem="2.16.840.1.113883.5.111" />
        <addr use="H">
          <streetAddressLine>${data.guardianAddress || ''}</streetAddressLine>
          <city>${data.guardianCity || ''}</city>
          <state>${data.guardianState || ''}</state>
          <postalCode>${data.guardianZip || ''}</postalCode>
        </addr>
        ${data.guardianPhone ? `<telecom use="HP" value="tel:${data.guardianPhone}" />` : ''}
        ${data.guardianEmail ? `<telecom use="WP" value="mailto:${data.guardianEmail}" />` : ''}
        <guardianPerson>
          <name use="L">
            <given>${data.guardianName.split(' ')[0] || ''}</given>
            <family>${data.guardianName.split(' ').slice(1).join(' ') || ''}</family>
          </name>
        </guardianPerson>
      </guardian>` : ''}
      <birthplace>
        <place>
          <addr>
            <city>${data.patientBirthPlace || data.patientCity}</city>
          </addr>
        </place>
      </birthplace>
      <languageCommunication>
        <languageCode code="${data.patientLanguage || 'en'}" />
        <preferenceInd value="true" />
      </languageCommunication>
      
    </patient>
    </patientRole>
  </recordTarget>

  <!-- Provider Information -->
  <author>
    <time value="${data.effectiveTime}" />
    <assignedAuthor>
      <id extension="${data.providerId}" root="2.16.840.1.113883.4.6" />
      <addr use="WP">
        <streetAddressLine>${data.facilityAddress}</streetAddressLine>
        <city>${data.patientCity}</city>
        <state>${data.patientState}</state>
        <postalCode>${data.patientZip}</postalCode>
        <country>US</country>
      </addr>
      <telecom use="WP" value="tel:${data.providerPhone}" />
      ${data.providerEmail ? `<telecom use="WP" value="mailto:${data.providerEmail}" />` : ''}
      <assignedAuthoringDevice>
        <manufacturerModelName>eICR Generator - Version 1.0</manufacturerModelName>
        <softwareName>eICR Generator - Version 1.0</softwareName>
      </assignedAuthoringDevice>
      <representedOrganization>
        <id extension="${data.organizationId || data.facilityId || data.providerId}" root="2.16.840.1.113883.4.6" />
        <name>${data.organizationName || data.facilityName}</name>
        <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}" />
        <addr use="WP">
          <streetAddressLine>${data.organizationAddress || data.facilityAddress}</streetAddressLine>
          <city>${data.patientCity}</city>
          <state>${data.patientState}</state>
          <postalCode>${data.patientZip}</postalCode>
          <country>US</country>
        </addr>
      </representedOrganization>
    </assignedAuthor>
  </author>

  <custodian>
    <assignedCustodian>
      <representedCustodianOrganization>
        <id extension="${data.organizationId || data.facilityId}" root="2.16.840.1.113883.4.6" />
        <name>${data.organizationName || data.facilityName}</name>
        <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}" />
        <addr use="WP">
          <streetAddressLine>${data.organizationAddress || data.facilityAddress}</streetAddressLine>
          <city>${data.patientCity}</city>
          <state>${data.patientState}</state>
          <postalCode>${data.patientZip}</postalCode>
          <country>US</country>
        </addr>
      </representedCustodianOrganization>
    </assignedCustodian>
  </custodian>

  <!-- Encounter Information -->
  <componentOf>
    <encompassingEncounter>
      <id extension="${data.encounterId}" root="2.16.840.1.113883.19" />
      <code code="${data.encounterType}" codeSystem="2.16.840.1.113883.5.4"
        codeSystemName="HL7 ActEncounterCode" displayName="Ambulatory" />
      <effectiveTime>
        <low value="${data.encounterDate}" />
        <high value="${data.encounterEndDate || data.encounterDate}" />
      </effectiveTime>
      ${data.encounterDisposition ? `<dischargeDispositionCode code="${data.encounterDisposition}" codeSystem="2.16.840.1.113883.12.112" />` : ''}
      <responsibleParty>
        <assignedEntity>
          <id extension="${data.providerId}" root="2.16.840.1.113883.4.6" />
          <addr use="WP">
            <streetAddressLine>${data.facilityAddress}</streetAddressLine>
            <city>${data.patientCity}</city>
            <state>${data.patientState}</state>
            <postalCode>${data.patientZip}</postalCode>
            <country>US</country>
          </addr>
          <telecom use="WP" value="tel:${data.providerPhone}" />
          <assignedPerson>
            <name>
              <given>${data.providerName.split(' ')[1]}</given>
              <family>${data.providerName.split(' ')[2]}</family>
            </name>
          </assignedPerson>
          <representedOrganization>
            <name>${data.facilityName}</name>
            <addr use="WP">
              <streetAddressLine>${data.facilityAddress}</streetAddressLine>
              <city>${data.patientCity}</city>
              <state>${data.patientState}</state>
              <postalCode>${data.patientZip}</postalCode>
              <country>US</country>
            </addr>
          </representedOrganization>
        </assignedEntity>
      </responsibleParty>
      <location>
        <healthCareFacility>
          <id extension="${data.facilityId || data.providerId}" root="2.16.840.1.113883.4.6" />
          <code code="${data.facilityTypeCode || 'OF'}" codeSystem="2.16.840.1.113883.5.111"
            codeSystemName="HL7RoleCode" displayName="Healthcare Facility" />
          <location>
            <name>${data.facilityName}</name>
            <addr use="WP">
              <streetAddressLine>${data.facilityAddress}</streetAddressLine>
              <city>${data.patientCity}</city>
              <state>${data.patientState}</state>
              <postalCode>${data.patientZip}</postalCode>
              <country>US</country>
            </addr>
          </location>
          <serviceProviderOrganization>
            <id extension="${data.organizationId || data.facilityId}" root="2.16.840.1.113883.4.6" />
            <name>${data.organizationName || data.facilityName}</name>
            <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}" />
            ${data.organizationEmail ? `<telecom use="WP" value="mailto:${data.organizationEmail}" />` : ''}
            ${data.organizationFax ? `<telecom use="WP" value="fax:${data.organizationFax}" />` : ''}
            <addr use="WP">
              <streetAddressLine>${data.organizationAddress || data.facilityAddress}</streetAddressLine>
              <city>${data.patientCity}</city>
              <state>${data.patientState}</state>
              <postalCode>${data.patientZip}</postalCode>
            </addr>
          </serviceProviderOrganization>
        </healthCareFacility>
      </location>
    </encompassingEncounter>
  </componentOf>

  <component>
    <structuredBody>
      <!-- Encounters Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.22" />
          <templateId root="2.16.840.1.113883.10.20.22.2.22" extension="2015-08-01" />
          <templateId root="2.16.840.1.113883.10.20.22.2.22.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.22.1" extension="2015-08-01" />
          <code code="46240-8" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
            displayName="History of encounters" />
          <title>Encounters</title>
          <text>
            <table>
              <thead>
                <tr><th>Encounter</th><th>Date</th><th>Location</th></tr>
              </thead>
              <tbody><tr><td>Office outpatient visit</td><td>${data.encounterDate}</td><td>${data.facilityName}</td></tr></tbody>
            </table>
          </text>
          <entry typeCode="DRIV">
            <encounter classCode="ENC" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.49" />
              <templateId root="2.16.840.1.113883.10.20.22.4.49" extension="2015-08-01" />
              <id root="2.16.840.1.113883.19.${data.encounterId}" />
              <code code="99213" codeSystem="2.16.840.1.113883.6.12" codeSystemName="CPT-4"
                displayName="Office outpatient visit" />
              <effectiveTime>
                <low value="${data.encounterDate}" />
                <high value="${data.encounterDate}" />
              </effectiveTime>
            </encounter>
          </entry>
        </section>
      </component>

         ${buildSpecimenSection(data)}  

      <!-- Reason for Visit Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.12" />
          <code code="29299-5" codeSystem="2.16.840.1.113883.6.1" displayName="Reason for visit" />
          <title>Reason for visit</title>
          <text>${data.chiefComplaint}</text>
        </section>
      </component>

      <!-- History of Present Illness -->
      <component>
        <section>
          <templateId root="1.3.6.1.4.1.19376.1.5.3.1.3.4" />
          <code code="10164-2" codeSystem="2.16.840.1.113883.6.1" displayName="History of Present Illness" />
          <title>History of Present Illness</title>
          <text>${data.presentIllness}</text>
        </section>
      </component>

      <!-- Medications Administered Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.38" />
          <templateId extension="2014-06-09" root="2.16.840.1.113883.10.20.22.2.38" />
          <code code="29549-3" codeSystem="2.16.840.1.113883.6.1"
            codeSystemName="LOINC" displayName="Medications Administered" />
          <title>Medications Administered</title>
          <text>
      <table border="1" width="100%">
        <thead>
          <tr>
            <th>Medication</th>
            <th>Dose</th>
            <th>Route</th>
            <th>Administration Time</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <content ID="MedAdministered_1">${data.adminMed1Name}</content>
            </td>
            <td>${data.adminMed1DoseValue} ${data.adminMed1DoseUnit}${data.adminMed1VolValue ? ` (${data.adminMed1VolValue} ${data.adminMed1VolUnit})` : ''}</td>
            <td>${data.adminMed1Route}</td>
            <td>${data.adminMed1Time}</td>
            <td>${data.adminMed1Negated ? 'Not Given' : data.adminMed1Status}</td>
          </tr>
          <tr>
            <td>
              <content ID="MedAdministered_2">${data.adminMed2Name}</content>
            </td>
            <td>${data.adminMed2DoseValue} ${data.adminMed2DoseUnit}${data.adminMed2VolValue ? ` (${data.adminMed2VolValue} ${data.adminMed2VolUnit})` : ''}</td>
            <td>${data.adminMed2Route}</td>
            <td>${data.adminMed2Time}</td>
            <td>${data.adminMed2Negated ? 'Not Given' : data.adminMed2Status}</td>
          </tr>
        </tbody>
      </table>
    </text>
    
    <!-- First Medication Entry -->
    <entry typeCode="DRIV">
      <substanceAdministration classCode="SBADM" moodCode="EVN" ${data.adminMed1Negated ? 'negationInd="true"' : ''}>
        <templateId root="2.16.840.1.113883.10.20.22.4.16" extension="2014-06-09" />
        <id extension="${data.adminMed1Id}" root="2.16.840.1.113883.19.5.99999.1" />
        <statusCode code="${data.adminMed1Status}" />
        <effectiveTime value="${data.adminMed1Time}" />
        <routeCode code="${data.adminMed1Route}" codeSystem="2.16.840.1.113883.5.112" />
        <doseQuantity value="${data.adminMed1DoseValue}" unit="${data.adminMed1DoseUnit}" />
        ${data.adminMed1VolValue ? `<maxDoseQuantity><numerator value="${data.adminMed1VolValue}" unit="${data.adminMed1VolUnit}" /></maxDoseQuantity>` : ''}
        <consumable>
          <manufacturedProduct classCode="MANU">
            <templateId root="2.16.840.1.113883.10.20.22.4.23" extension="2014-06-09"/>
            <manufacturedMaterial>
              <code code="${data.adminMed1Code}" codeSystem="2.16.840.1.113883.6.88">
                <originalText>
                  <reference value="#MedAdministered_1" />
                </originalText>
              </code>
              <name>${data.adminMed1Name}</name>
            </manufacturedMaterial>
          </manufacturedProduct>
        </consumable>
         ${ (data.administeringProviderNPI || data.administeringProviderGiven || data.administeringProviderFamily) ? `
    <performer typeCode="PRF">
      <assignedEntity>
        ${data.administeringProviderNPI ? `<id root="2.16.840.1.113883.4.6" extension="${data.administeringProviderNPI}"/>` : ''}
        ${data.administeringProviderPhone ? `<telecom use="WP" value="tel:${data.administeringProviderPhone}"/>` : ''}
        <assignedPerson>
          <name>
            ${data.administeringProviderGiven ? `<given>${data.administeringProviderGiven}</given>` : ''}
            ${data.administeringProviderMiddle ? `<given>${data.administeringProviderMiddle}</given>` : ''}
            ${data.administeringProviderFamily ? `<family>${data.administeringProviderFamily}</family>` : ''}
          </name>
        </assignedPerson>
        ${data.administeringProviderOrgName ? `
        <representedOrganization>
          ${data.administeringProviderOrgId ? `<id root="${data.administeringProviderOrgIdRoot || '2.16.840.1.113883.19'}" extension="${data.administeringProviderOrgId}"/>` : ''}
          <name>${data.administeringProviderOrgName}</name>
        </representedOrganization>` : ''}
      </assignedEntity>
    </performer>` : '' }
      </substanceAdministration>
    </entry>
    
    <!-- Second Medication Entry -->
    <entry typeCode="DRIV">
      <substanceAdministration classCode="SBADM" moodCode="EVN" ${data.adminMed2Negated ? 'negationInd="true"' : ''}>
        <templateId root="2.16.840.1.113883.10.20.22.4.16" extension="2014-06-09" />
        <id extension="${data.adminMed2Id}" root="2.16.840.1.113883.19.5.99999.1" />
        <statusCode code="${data.adminMed2Status}" />
        <effectiveTime value="${data.adminMed2Time}" />
        <routeCode code="${data.adminMed2Route}" codeSystem="2.16.840.1.113883.5.112" />
        <doseQuantity value="${data.adminMed2DoseValue}" unit="${data.adminMed2DoseUnit}" />
        ${data.adminMed2VolValue ? `<maxDoseQuantity><numerator value="${data.adminMed2VolValue}" unit="${data.adminMed2VolUnit}" /></maxDoseQuantity>` : ''}
        <consumable>
          <manufacturedProduct classCode="MANU">
            <templateId root="2.16.840.1.113883.10.20.22.4.23" extension="2014-06-09"/>
            <manufacturedMaterial>
              <code code="${data.adminMed2Code}" codeSystem="2.16.840.1.113883.6.88">
                <originalText>
                  <reference value="#MedAdministered_2" />
                </originalText>
              </code>
              <name>${data.adminMed2Name}</name>
            </manufacturedMaterial>
          </manufacturedProduct>
        </consumable>
         ${ (data.administeringProviderNPI || data.administeringProviderGiven || data.administeringProviderFamily) ? `
    <performer typeCode="PRF">
      <assignedEntity>
        ${data.administeringProviderNPI ? `<id root="2.16.840.1.113883.4.6" extension="${data.administeringProviderNPI}"/>` : ''}
        ${data.administeringProviderPhone ? `<telecom use="WP" value="tel:${data.administeringProviderPhone}"/>` : ''}
        <assignedPerson>
          <name>
            ${data.administeringProviderGiven ? `<given>${data.administeringProviderGiven}</given>` : ''}
            ${data.administeringProviderMiddle ? `<given>${data.administeringProviderMiddle}</given>` : ''}
            ${data.administeringProviderFamily ? `<family>${data.administeringProviderFamily}</family>` : ''}
          </name>
        </assignedPerson>
        ${data.administeringProviderOrgName ? `
        <representedOrganization>
          ${data.administeringProviderOrgId ? `<id root="${data.administeringProviderOrgIdRoot || '2.16.840.1.113883.19'}" extension="${data.administeringProviderOrgId}"/>` : ''}
          <name>${data.administeringProviderOrgName}</name>
        </representedOrganization>` : ''}
      </assignedEntity>
    </performer>` : '' }
      </substanceAdministration>
    </entry>
        </section>
      </component>

      <!-- Problems Section with RCTC Trigger Codes -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.5" />
          <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.5" />
          <templateId root="2.16.840.1.113883.10.20.22.2.5.1" />
          <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.5.1" />
          <code code="11450-4" codeSystem="2.16.840.1.113883.6.1" displayName="Problem List" />
          <title>Problem List</title>
          <text>
            <table>
              <thead>
                <tr><th>Problem</th><th>Code</th><th>Date</th><th>RCTC Trigger</th></tr>
              </thead>
              <tbody><tr><td>${data.diagnosis1Name}</td><td>${data.diagnosis1Code}</td><td>${data.encounterDate}</td><td>Yes</td></tr><tr><td>${data.diagnosis2Name}</td><td>${data.diagnosis2Code}</td><td>${data.encounterDate}</td><td>Yes</td></tr><tr><td>${data.diagnosis3Name}</td><td>${data.diagnosis3Code}</td><td>${data.encounterDate}</td><td>Yes</td></tr></tbody>
            </table>
          </text>
          <entry typeCode="DRIV">
            <act classCode="ACT" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.3" />
              <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.3" />
              <id root="a1c0c380-eacc-4b40-9207-85164185558d" />
              <code code="CONC" codeSystem="2.16.840.1.113883.5.6" displayName="Concern" />
              <statusCode code="active" />
              <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
              
              <!-- Diagnosis with RCTC Trigger Code Template -->
              <entryRelationship typeCode="SUBJ">
                <observation classCode="OBS" moodCode="EVN" negationInd="false">
                  <templateId root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.3" />
                  <id root="5e3c9b57-fa2e-48a2-be29-47d9873e3c13" />
                  <code code="75323-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                    displayName="Condition">
                    <translation code="282291009" codeSystem="2.16.840.1.113883.6.96"
                      codeSystemName="SNOMED CT" displayName="Diagnosis" />
                  </code>
                  <statusCode code="completed" />
                  <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
                   ${data.diagnosis1Code
  ? `<value xsi:type="CD"
            code="${data.diagnosis1Code}"
            codeSystem="2.16.840.1.113883.6.96"
            codeSystemName="SNOMED CT"
            displayName="${data.diagnosis1Name}"
            sdtc:valueSet="${getConditionSpecificValueSet(data.diagnosis1Code).oid}"
            sdtc:valueSetVersion="${getConditionSpecificValueSet(data.diagnosis1Code).version}" />`
  : `<value xsi:type="CD"
            nullFlavor="UNK"
            displayName="${data.diagnosis1Name}" 
             sdtc:valueSet="2.16.840.1.113762.1.4.1146.2260" 
       sdtc:valueSetVersion="2.0.1" />`
}
                </observation>
              </entryRelationship>

              <!-- Diagnosis with RCTC Trigger Code Template -->
              <entryRelationship typeCode="SUBJ">
                <observation classCode="OBS" moodCode="EVN" negationInd="false">
                  <templateId root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.3" />
                  <id root="7f32bd91-c5f3-422b-8a9d-3bc24c1e8bc1" />
                  <code code="75323-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                    displayName="Condition">
                    <translation code="282291009" codeSystem="2.16.840.1.113883.6.96"
                      codeSystemName="SNOMED CT" displayName="Diagnosis" />
                  </code>
                  <statusCode code="completed" />
                  <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
                 ${data.diagnosis2Code
  ? `<value xsi:type="CD"
            code="${data.diagnosis2Code}"
            codeSystem="2.16.840.1.113883.6.96"
            codeSystemName="SNOMED CT"
            displayName="${data.diagnosis2Name}"
            sdtc:valueSet="${getConditionSpecificValueSet(data.diagnosis2Code).oid}"
            sdtc:valueSetVersion="${getConditionSpecificValueSet(data.diagnosis2Code).version}" />`
  : `<value xsi:type="CD"
            nullFlavor="UNK"
            displayName="${data.diagnosis2Name}" 
             sdtc:valueSet="2.16.840.1.113762.1.4.1146.2260" 
       sdtc:valueSetVersion="2.0.1" />`
}
                </observation>
              </entryRelationship>

              <!-- Diagnosis with RCTC Trigger Code Template -->
              <entryRelationship typeCode="SUBJ">
                <observation classCode="OBS" moodCode="EVN" negationInd="false">
                  <templateId root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.3" />
                  <id root="b0ea9e52-4e54-4c22-8dc3-4bd390e10eef" />
                  <code code="75323-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                    displayName="Condition">
                    <translation code="282291009" codeSystem="2.16.840.1.113883.6.96"
                      codeSystemName="SNOMED CT" displayName="Diagnosis" />
                  </code>
                  <statusCode code="completed" />
                  <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
                 ${data.diagnosis3Code 
  ? `<value xsi:type="CD" code="${data.diagnosis3Code}" codeSystem="2.16.840.1.113883.6.96"
       codeSystemName="SNOMED-CT" displayName="${data.diagnosis3Name}"
       sdtc:valueSet="${getConditionSpecificValueSet(data.diagnosis3Code).oid}" 
       sdtc:valueSetVersion="${getConditionSpecificValueSet(data.diagnosis3Code).version}" />`
  : `<value xsi:type="CD" nullFlavor="UNK" displayName="${data.diagnosis3Name}"
       sdtc:valueSet="2.16.840.1.113762.1.4.1146.2260" 
       sdtc:valueSetVersion="2.0.1" />`
}
                </observation>
              </entryRelationship>
            </act>
          </entry>
        </section>
      </component>

      <!-- Replace existing Results Section with Lab Evidence -->
     ${(data.labEvidence && data.labEvidence.length) 
  ? buildResultsSectionXML(data.labEvidence, '2016-12-01')
  : `<!-- Fallback Results Section for Legacy Support -->
     <component>
       <section>
         <templateId root="2.16.840.1.113883.10.20.22.2.3" />
         <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.3" />
         <templateId root="2.16.840.1.113883.10.20.22.2.3.1" />
         <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.3.1" />
         <code code="30954-2" codeSystem="2.16.840.1.113883.6.1" displayName="Relevant diagnostic tests and/or laboratory data" />
         <title>Results</title>
         <text>
           <table>
             <thead>
               <tr><th>Test</th><th>Result</th><th>Date</th><th>RCTC Trigger</th></tr>
             </thead>
             <tbody>
               <tr><td>${data.labTest1Name || ''}</td><td>${data.labTest1Result || ''}</td><td>${data.encounterDate || ''}</td><td>Yes</td></tr>
               <tr><td>${data.labTest2Name || ''}</td><td>${data.labTest2Result || ''}</td><td>${data.encounterDate || ''}</td><td>Yes</td></tr>
             </tbody>  
           </table>
         </text>
         
         <!-- COVID-19 Test Result with RCTC Trigger Code Template -->
         <entry typeCode="DRIV">
           <organizer classCode="BATTERY" moodCode="EVN">
             <templateId root="2.16.840.1.113883.10.20.22.4.1" />
             <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.1" />
             <id root="2047cca3-559f-45da-8775-406538fa4815" />
             <code code="${data.labTest1Code || ''}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
               displayName="${data.labTest1Name || ''}" />
             <statusCode code="completed" />
             <effectiveTime>
               <low value="${data.encounterDate || ''}" />
               <high value="${data.encounterDate || ''}" />
             </effectiveTime>
             <component>
               <observation classCode="OBS" moodCode="EVN">
                 <templateId root="2.16.840.1.113883.10.20.22.4.2" />
                 <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.2" />
                 <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.2" />
                 <id root="9890e2c3-019a-4168-8403-a0a069994440" />
                 <code code="${data.labTest1Code || ''}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                   displayName="${data.labTest1Name || ''}"
                   sdtc:valueSet="${getConditionSpecificValueSet(data.labTest1Code, '2.16.840.1.113883.6.1').oid}"
                   sdtc:valueSetVersion="${getConditionSpecificValueSet(data.labTest1Code, '2.16.840.1.113883.6.1').version}" />
                 <statusCode code="completed" />
                 <effectiveTime value="${data.encounterDate || ''}" />
                 <value code="260373001" codeSystem="2.16.840.1.113883.6.96"
                   codeSystemName="SNOMED-CT" displayName="${data.labTest1Result || ''}" xsi:type="CD" />
               </observation>
             </component>
           </organizer>
         </entry>

         <!-- Influenza Test Result with RCTC Trigger Code Template -->
         <entry typeCode="DRIV">
           <organizer classCode="BATTERY" moodCode="EVN">
             <templateId root="2.16.840.1.113883.10.20.22.4.1" />
             <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.1" />
             <id root="3f4b84f1-d3f6-4731-8e61-7c63d8f39a70" />
             <code code="${data.labTest2Code || ''}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
               displayName="${data.labTest2Name || ''}" />
             <statusCode code="completed" />
             <effectiveTime>
               <low value="${data.encounterDate || ''}" />
               <high value="${data.encounterDate || ''}" />
             </effectiveTime>
             <component>
               <observation classCode="OBS" moodCode="EVN">
                 <templateId root="2.16.840.1.113883.10.20.22.4.2" />
                 <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.2" />
                 <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.2" />
                 <id root="6c53c5ff-42a9-4f3c-a2c0-d412f019c0de" />
                 <code code="${data.labTest2Code || ''}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                   displayName="${data.labTest2Name || ''}"
                   sdtc:valueSet="${getConditionSpecificValueSet(data.labTest2Code, '2.16.840.1.113883.6.1').oid}"
                   sdtc:valueSetVersion="${getConditionSpecificValueSet(data.labTest2Code, '2.16.840.1.113883.6.1').version}" />
                 <statusCode code="completed" />
                 <effectiveTime value="${data.encounterDate || ''}" />
                 <value code="260373001" codeSystem="2.16.840.1.113883.6.96"
                   codeSystemName="SNOMED-CT" displayName="${data.labTest2Result || ''}" xsi:type="CD" />
               </observation>
             </component>
           </organizer>
         </entry>
       </section>
     </component>`
}

      <!-- Social History Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.17" />
          <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.17" />
          <code code="29762-2" codeSystem="2.16.840.1.113883.6.1" displayName="Social History" />
          <title>Social History</title>
          <text>
            <table>
              <thead>
                <tr><th>Travel History</th><th>Dates</th><th>Location</th></tr>
              </thead>
              <tbody><tr><td>Recent travel</td><td>${data.travelStartDate} - ${data.travelEndDate}</td><td>${data.travelLocation}</td></tr></tbody>
            </table>
          </text>
          <entry typeCode="DRIV">
            <act classCode="ACT" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.15.2.3.1" />
              <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.1" />
              <id root="79565142-eae0-4213-a3b3-b73cdf474682" />
              <code code="420008001" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT"
                displayName="Travel" />
              <text>Recent travel to ${data.travelLocation}</text>
              <statusCode code="completed" />
              <effectiveTime>
                <low value="${data.travelStartDate}" />
                <high value="${data.travelEndDate}" />
              </effectiveTime>
            </act>
          </entry>
          
          <!-- Birth Sex Observation -->
          <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.200" extension="2016-06-01" />
              <id root="${generateGUID()}" />
              <code code="76689-9" codeSystem="2.16.840.1.113883.6.1" displayName="Sex Assigned At Birth" />
              <statusCode code="completed" />
              <effectiveTime value="${data.patientBirthDate}" />
              <value xsi:type="CD" code="${data.patientBirthSex || data.patientGender}" codeSystem="2.16.840.1.113883.5.1" />
            </observation>
          </entry>
          
          <!-- Gender Identity Observation -->
          <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.34.3.45" extension="2022-06-01" />
              <id root="${generateGUID()}" />
              <code code="76691-5" codeSystem="2.16.840.1.113883.6.1" displayName="Gender identity" />
              <statusCode code="completed" />
              <effectiveTime value="${data.patientBirthDate}" />
              <value xsi:type="CD" code="${data.patientGenderIdentity || data.patientGender}" codeSystem="2.16.840.1.113883.6.96" />
            </observation>
          </entry>
          
          <!-- Occupation Information -->
          ${data.currentOccupation ? `
          <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.217" extension="2022-06-01" />
              <id root="${generateGUID()}" />
              <code code="87729-0" codeSystem="2.16.840.1.113883.6.1" displayName="Current occupation" />
              <statusCode code="active" />
              <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
              <value xsi:type="ST">${data.currentOccupation}</value>
              <participant typeCode="IND">
                <participantRole classCode="ASSIGNED">
                   
                  ${data.currentEmployerAddress ? `<addr><streetAddressLine>${data.currentEmployerAddress}</streetAddressLine></addr>` : ''}
                   ${data.currentEmployerPhone ? `<telecom value="tel:${data.currentEmployerPhone}" />` : ''}
                  <playingEntity classCode="ORG">
                    <name>${data.currentEmployerName || 'Unknown'}</name>
                  </playingEntity>
                </participantRole>
              </participant>
            </observation>
          </entry>
          
          <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.216" extension="2022-06-01" />
              <id root="${generateGUID()}" />
              <code code="21843-8" codeSystem="2.16.840.1.113883.6.1" displayName="History of Occupation industry" />
              <statusCode code="active" />
              <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
              <value xsi:type="ST">${data.currentIndustry || 'Unknown'}</value>
            </observation>
          </entry>` : ''}
        </section>
      </component>

      <!-- Vital Signs Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.4" />
          <templateId root="2.16.840.1.113883.10.20.22.2.4" extension="2015-08-01" />
          <templateId root="2.16.840.1.113883.10.20.22.2.4.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.4.1" extension="2015-08-01" />
          <code code="8716-3" codeSystem="2.16.840.1.113883.6.1" displayName="Vital signs" />
          <title>Vital Signs</title>
          <text>
            <table>
              <thead>
                <tr><th>Vital Sign</th><th>Value</th><th>Unit</th><th>Date</th></tr>
              </thead>
              <tbody>${data.temperature ? `<tr><td>Temperature</td><td>${data.temperature}</td><td>¬∞F</td><td>${data.encounterDate}</td></tr>` : ''}${data.bloodPressure ? `<tr><td>Blood Pressure</td><td>${data.bloodPressure}</td><td>mmHg</td><td>${data.encounterDate}</td></tr>` : ''}${data.heartRate ? `<tr><td>Heart Rate</td><td>${data.heartRate}</td><td>bpm</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.respiratoryRate  ? `<tr><td>Respiratory Rate</td><td>${data.respiratoryRate}</td><td>/min</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.oxygenSaturation ? `<tr><td>Oxygen Saturation</td><td>${data.oxygenSaturation}</td><td>%</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.weight           ? `<tr><td>Weight</td><td>${data.weight}</td><td>kg</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.height           ? `<tr><td>Height</td><td>${data.height}</td><td>cm</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.bmi              ? `<tr><td>BMI</td><td>${data.bmi}</td><td>kg/m¬≤</td><td>${data.encounterDate}</td></tr>` : ''}
</tbody>

            </table>
          </text>
          ${generateVitalSignsEntries(data)}
        </section>
      </component>

      <!-- Medications Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.1" extension="2014-06-09" />
          <templateId root="2.16.840.1.113883.10.20.22.2.1.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.1.1" extension="2014-06-09" />
          <code code="10160-0" codeSystem="2.16.840.1.113883.6.1" displayName="Medications" />
          <title>Medications</title>
          <text>
            <table>
              <thead>
                <tr><th>Medication</th><th>Dose</th><th>Route</th><th>Date</th><th>Status</th></tr>
              </thead>
              <tbody>${data.adminMed1Name ? `<tr><td>${data.adminMed1Name}</td><td>${data.adminMed1DoseValue} ${data.adminMed1DoseUnit}${data.adminMed1VolValue ? ' (' + data.adminMed1VolValue + ' ' + data.adminMed1VolUnit + ')' : ''}</td><td>${data.adminMed1Route}</td><td>${data.adminMed1Time}</td><td>${data.adminMed1Status}</td></tr>` : ''}${data.adminMed2Name ? `<tr><td>${data.adminMed2Name}</td><td>${data.adminMed2DoseValue} ${data.adminMed2DoseUnit}${data.adminMed2VolValue ? ' (' + data.adminMed2VolValue + ' ' + data.adminMed2VolUnit + ')' : ''}</td><td>${data.adminMed2Route}</td><td>${data.adminMed2Time}</td><td>${data.adminMed2Status}</td></tr>` : ''}</tbody>
            </table>
          </text>
          ${generateMedicationEntries(data)}
        </section>
      </component>

      <!-- Immunizations Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.2" />
          <templateId root="2.16.840.1.113883.10.20.22.2.2" extension="2015-08-01" />
          <templateId root="2.16.840.1.113883.10.20.22.2.2.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.2.1" extension="2015-08-01" />
          <code code="11369-6" codeSystem="2.16.840.1.113883.6.1" displayName="Immunizations" />
          <title>Immunizations</title>
          <text>
            <table>
              <thead>
                <tr><th>Vaccine</th><th>Date</th><th>Status</th><th>Manufacturer</th></tr>
              </thead>
              <tbody>${data.vaccine1Name ? `<tr><td>${data.vaccine1Name}</td><td>${data.immunization1Date}</td><td>${data.immunization1Status}</td><td>${data.vaccine1Manufacturer}</td></tr>` : ''}${data.vaccine2Name ? `<tr><td>${data.vaccine2Name}</td><td>${data.immunization2Date}</td><td>${data.immunization2Status}</td><td>${data.vaccine2Manufacturer}</td></tr>` : ''}</tbody>
            </table>
          </text>
          ${generateImmunizationEntries(data)}
        </section>
      </component>

      <!-- Procedures Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.7" />
          <templateId root="2.16.840.1.113883.10.20.22.2.7" extension="2014-06-09" />
          <templateId root="2.16.840.1.113883.10.20.22.2.7.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.7.1" extension="2014-06-09" />
          <code code="47519-4" codeSystem="2.16.840.1.113883.6.1" displayName="Procedures" />
          <title>Procedures</title>
          <text>
            <table>
              <thead>
                <tr><th>Procedure</th><th>Date</th><th>Type</th></tr>
              </thead>
              <tbody>${data.currentProc1Name ? `<tr><td>${data.currentProc1Name}</td><td>${data.currentProc1Date}</td><td>${data.currentProc1Type}</td></tr>` : ''}${data.currentProc2Name ? `<tr><td>${data.currentProc2Name}</td><td>${data.currentProc2Date}</td><td>${data.currentProc2Type}</td></tr>` : ''}${data.triggerProc1Name ? `<tr><td>${data.triggerProc1Name}</td><td>${data.triggerProc1Date}</td><td>${data.triggerProc1Type}</td></tr>` : ''}
              </tbody>
            </table>
          </text>
          ${generateProcedureEntries(data)}
        </section>
      </component>

      <!-- Allergies Section -->
      <component>
        <section nullFlavor="NI">
          <templateId root="2.16.840.1.113883.10.20.22.2.6.1" extension="2015-08-01"/>
          <code code="48765-2" codeSystem="2.16.840.1.113883.6.1" displayName="Allergies and adverse reactions Document"/>
          <title>Allergies</title>
          <text>No Known Allergies</text>
        </section>
      </component>

      <!-- Admission Medications Section -->
      <component>
        <section nullFlavor="NI">
          <templateId root="2.16.840.1.113883.10.20.22.2.44" extension="2015-08-01"/>
          <code code="42346-7" codeSystem="2.16.840.1.113883.6.1" displayName="Medications on admission (narrative) Document"/>
          <title>Admission Medications</title>
          <text>See Medications Administered Section for all Medications</text>
        </section>
      </component>

      <!-- Hospital Admission Diagnosis -->
      <component>
        <section nullFlavor="NI">
          <templateId root="2.16.840.1.113883.10.20.22.2.43" extension="2015-08-01"/>
          <code code="46241-6" codeSystem="2.16.840.1.113883.6.1" displayName="Hospital admission diagnosis Narrative - Reported"/>
          <title>Hospital Admission Diagnosis</title>
          <text>See Encounters Section and Problems Section</text>
        </section>
      </component>

      <!-- Hospital Discharge Diagnosis -->
      <component>
        <section nullFlavor="NI">
          <templateId root="2.16.840.1.113883.10.20.22.2.24" extension="2015-08-01"/>
          <code code="11535-2" codeSystem="2.16.840.1.113883.6.1" displayName="Hospital discharge diagnosis Narrative"/>
          <title>Hospital Discharge Diagnosis</title>
          <text>See Encounters Section and Problems Section</text>
        </section>
      </component>

      <!-- Past Medical History -->
      <component>
        <section nullFlavor="NI">
          <templateId root="2.16.840.1.113883.10.20.22.2.20" extension="2015-08-01"/>
          <code code="11348-0" codeSystem="2.16.840.1.113883.6.1" displayName="History of Past illness Narrative"/>
          <title>Past Medical History</title>
          <text>${data.pastMedicalHistory}</text>
        </section>
      </component>

      <!-- Review of Systems -->
      <component>
        <section nullFlavor="NI">
          <templateId root="1.3.6.1.4.1.19376.1.5.3.1.3.18"/>
          <code code="10187-3" codeSystem="2.16.840.1.113883.6.1" displayName="Review of systems Narrative - Reported"/>
          <title>Review of Systems</title>
          <text>${data.reviewOfSystems}</text>
        </section>
      </component>

      <!-- Chief Complaint -->
      <component>
        <section nullFlavor="NI">
          <templateId root="1.3.6.1.4.1.19376.1.5.3.1.1.13.2.1"/>
          <code code="10154-3" codeSystem="2.16.840.1.113883.6.1" displayName="Chief complaint Narrative - Reported"/>
          <title>Chief Complaint</title>
          <text>${data.chiefComplaint}</text>
        </section>
      </component>

    </structuredBody>
  </component>
</ClinicalDocument>`;
            return cdaTemplate;
        }

        function generateCDA() {
            return buildEICRXml();
        }

        async function generateAndDownloadCDA() {
            if (!validateFormData()) {
                return;
            }

            try {
                const cdaContent = generateCDA();
                const data = getFormData();

                // Additional CDA-specific validation
                if (!cdaContent.includes('<ClinicalDocument')) {
                    throw new Error('Invalid CDA document structure generated');
                }

                const blob = new Blob([cdaContent], { type: 'application/xml' });
                const filename = generateDynamicFilename('eICR', 'xml');

                // Try to use File System Access API (Chrome/Edge) to prompt for save location
                if ('showSaveFilePicker' in window) {
                    try {
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: filename,
                            types: [
                                {
                                    description: 'XML files',
                                    accept: { 'application/xml': ['.xml'] }
                                }
                            ]
                        });
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        console.log('CDA file saved with user-selected location');
                        return;
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.warn('File System Access API failed for CDA, falling back to download:', err);
                        } else {
                            console.log('User cancelled CDA save dialog');
                            return;
                        }
                    }
                }

                // Fallback to traditional download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                
            } catch (error) {
                console.error('CDA Generation Error:', error);
                alert(`Error generating CDA document: ${error.message}\n\nPlease check that all required fields are completed correctly.`);
            }
        }


        function saveFormData() {
            const data = getFormData();
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RCTC_eICR_form_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function loadFormData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        setFormData(data);
                        alert('Form data loaded successfully!');
                    } catch (error) {
                        alert('Error loading file: Invalid JSON format');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            const searchResults = document.querySelectorAll('.search-results');
            searchResults.forEach(result => {
                if (!result.parentElement.contains(e.target)) {
                    result.style.display = 'none';
                }
            });
        });

        function togglePregnancyFields() {
            const genderSelect = document.getElementById('patientGender');
            const pregnancySections = document.querySelectorAll('.section');
            
            let pregnancyDiv = null;
            pregnancySections.forEach(section => {
                const title = section.querySelector('.section-title');
                if (title && title.textContent.includes('Pregnancy Information')) {
                    pregnancyDiv = section;
                }
            });
            
            if (genderSelect && pregnancyDiv) {
                if (genderSelect.value === 'F') {
                    pregnancyDiv.style.display = 'block';
                } else {
                    pregnancyDiv.style.display = 'none';
                }
            }
        }

        function toggleGuardianFields() {
            const birthDate = document.getElementById('patientBirthDate');
            const guardianSections = document.querySelectorAll('.section');
            
            let guardianDiv = null;
            guardianSections.forEach(section => {
                const title = section.querySelector('.section-title');
                if (title && title.textContent.includes('Guardian/Parent Information')) {
                    guardianDiv = section;
                }
            });
            
            if (birthDate && guardianDiv && birthDate.value.length === 8) {
                const today = new Date();
                const birth = new Date(
                    birthDate.value.substring(0, 4),
                    birthDate.value.substring(4, 6) - 1,
                    birthDate.value.substring(6, 8)
                );
                
                const age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                
                if (age < 18 || (age === 18 && monthDiff < 0)) {
                    guardianDiv.style.display = 'block';
                } else {
                    guardianDiv.style.display = 'none';
                }
            }
        }

        function setupConditionalDisplays() {
            // Gender-based pregnancy field display
            const genderSelect = document.getElementById('patientGender');
            if (genderSelect) {
                genderSelect.addEventListener('change', togglePregnancyFields);
                togglePregnancyFields(); // Initial check
            }

            // Age-based guardian field display
            const birthDateInput = document.getElementById('patientBirthDate');
            if (birthDateInput) {
                birthDateInput.addEventListener('change', toggleGuardianFields);
                birthDateInput.addEventListener('blur', toggleGuardianFields);
            }
        }

        // Global variable to store conditions data
        let conditionsData = [];
        let conditionsLoaded = false;

        // Load conditions from Excel file
        async function loadConditionsFromExcel() {
            try {
                const response = await fetch('./assets/xslt/conditions.xlsx');
                if (!response.ok) {
                    throw new Error(`Failed to load Excel file: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                const allConditions = [];
                
                // Process all sheets
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Skip empty sheets or sheets with no data rows
                    if (jsonData.length <= 1) return;
                    
                    const headers = jsonData[0];
                    const conditionIndex = headers.findIndex(h => h && h.toLowerCase().includes('condition'));
                    const codeTypeIndex = headers.findIndex(h => h && h.toLowerCase().includes('code_type'));
                    const codeIndex = headers.findIndex(h => h && (h.toLowerCase().includes('code') && !h.toLowerCase().includes('code_type')));
                    const descriptionIndex = headers.findIndex(h => h && h.toLowerCase().includes('description'));
                    
                    // Process data rows
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row && row[codeIndex]) {
                            allConditions.push({
                                condition: row[conditionIndex] || '',
                                codeType: row[codeTypeIndex] || '',
                                code: row[codeIndex] || '',
                                description: row[descriptionIndex] || ''
                            });
                        }
                    }
                });
                
                conditionsData = allConditions;
                conditionsLoaded = true;
                
                // Populate dropdowns after loading
                populateConditionDropdowns(conditionsData);
                
                console.log(`Loaded ${conditionsData.length} conditions from Excel file`);
                return conditionsData;
                
            } catch (error) {
                console.warn('Failed to load conditions from Excel file:', error);
                // Fallback to hardcoded values if Excel file can't be loaded
                conditionsData = getHardcodedConditions();
                conditionsLoaded = true;
                populateConditionDropdowns(conditionsData);
                return conditionsData;
            }
        }

        // Fallback hardcoded conditions
        function getHardcodedConditions() {
            return [
                { condition: "Down Syndrome", code: "67531005", codeType: "SNOMEDCT", description: "Down syndrome (disorder)" },
                { condition: "Pertussis", code: "414819007", codeType: "SNOMEDCT", description: "Disease caused by Bordetella pertussis (disorder)" },
                { condition: "Gonorrhea", code: "86299006", codeType: "SNOMEDCT", description: "Gonorrhea (disorder)" }
            ];
        }

        // Populate condition dropdowns
        function populateConditionDropdowns(conditions) {
            const diagnosisFields = ['diagnosis1Code', 'diagnosis2Code', 'diagnosis3Code'];
            const defaultValues = ['67531005', '414819007', '86299006']; // Original hardcoded values
            
            diagnosisFields.forEach((fieldId, index) => {
                const select = document.getElementById(fieldId);
                if (select && select.tagName === 'SELECT') {
                    // Clear existing options except the first placeholder
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    // Add conditions as options
                    conditions.forEach(condition => {
                        const option = document.createElement('option');
                        option.value = condition.code;
                        option.textContent = `${condition.code} - ${condition.description} (${condition.condition})`;
                        
                        // Mark RCTC trigger codes
                        if (isRCTCTriggerCode(condition.code)) {
                            option.textContent += ' [RCTC]';
                            option.style.fontWeight = 'bold';
                        }
                        
                        select.appendChild(option);
                    });
                    
                    // Set default value and trigger auto-population
                    if (defaultValues[index]) {
                        select.value = defaultValues[index];
                        handleDiagnosisSelection(fieldId, defaultValues[index], conditions);
                    }
                }
            });
        }

        // Handle diagnosis code selection
        function handleDiagnosisSelection(fieldId, selectedCode, conditions) {
            const nameFieldId = fieldId.replace('Code', 'Name');
            const nameField = document.getElementById(nameFieldId);
            
            if (nameField && selectedCode) {
                const selectedCondition = conditions.find(c => c.code === selectedCode);
                if (selectedCondition) {
                    nameField.value = selectedCondition.condition;
                }
            }
            
            // Validate trigger code
            validateTriggerCode(fieldId);
        }

        // Initialize the form
        function migrateLegacyLabsIntoEvidence() {
            const d = getFormData();
            const rows = [];
            
            if (d.labTest1Code || d.labTest1Name) {
                rows.push({
                    testCode: d.labTest1Code,
                    testName: d.labTest1Name,
                    valueKind: 'text',
                    textValue: d.labTest1Result || '',
                    time: d.labTest1Time || '',
                    status: d.labTest1Status || 'completed',
                    interpretation: d.labTest1Interpretation || '',
                    isRCTC: isRCTCTriggerCode(d.labTest1Code)
                });
            }
            
            if (d.labTest2Code || d.labTest2Name) {
                rows.push({
                    testCode: d.labTest2Code,
                    testName: d.labTest2Name,
                    valueKind: 'text',
                    textValue: d.labTest2Result || '',
                    time: d.labTest2Time || '',
                    status: d.labTest2Status || 'completed',
                    interpretation: d.labTest2Interpretation || '',
                    isRCTC: isRCTCTriggerCode(d.labTest2Code)
                });
            }
            
            rows.forEach(r => addLabEvidence(r));
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('eICR Generator loaded');
            console.log('RCTC Metadata:', rctcData.metadata);
            
            // Load conditions from Excel file
            loadConditionsFromExcel().then(() => {
                console.log('Conditions loaded successfully');
            });
            
            setupConditionalDisplays();
            
            // Initialize document relationship fields
            handleRelationshipTypeChange();
            
            // NEW: Initialize lab evidence
            if (!document.querySelector('.lab-evidence-row')) {
                addLabEvidence();
            }
            
        });
    </script>


  <!-- Clean UI v8.1 overlay -->
  <script type="module" src="js/ui.clean.v8_1.refresh.js" defer></script>

</body>
</html>