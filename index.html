<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eICR Form Generator - DQ Schematron Compliant</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9fafb;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        h1 {
            color: #1f2937;
            margin: 0;
            font-size: 2rem;
        }
        .subtitle {
            color: #6b7280;
            margin: 5px 0 0 0;
        }
        .rctc-info {
            background: #e0f2fe;
            border: 1px solid #81d4fa;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        .rctc-info h3 {
            margin: 0 0 10px 0;
            color: #0277bd;
        }
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn:hover { opacity: 0.9; }
        .section {
            margin-bottom: 30px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 20px 0;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        .textarea-group {
            grid-column: 1 / -1;
        }
        label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }
        input, textarea, select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        select[id*="diagnosis"] {
            min-width: 300px;
            max-width: 100%;
        }
        select[id*="diagnosis"] option[style*="font-weight: bold"] {
            background-color: #fef3c7;
            color: #92400e;
        }
        .footer-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            flex-wrap: wrap;
        }
        .code-search {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: #f9fafb;
            margin-top: 10px;
            display: none;
        }
        .result-item {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .result-item:hover {
            background-color: #e5e7eb;
        }
        .search-results-list {
            /* Container for search results */
        }
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .search-result-item:hover {
            background-color: #e5e7eb;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .no-results {
            padding: 10px;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }
        
        /* Lab Evidence Repeatable UI */
        .lab-evidence-controls {
            margin-bottom: 20px;
        }
        .lab-evidence-row {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f9fafb;
        }
        .lab-evidence-row h4 {
            margin: 0 0 15px 0;
            color: #374151;
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 8px;
        }

        /* Diagnosis Evidence Repeatable UI */
        .diagnosis-evidence-controls {
            margin-bottom: 20px;
        }
        .diagnosis-evidence-row {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f9fafb;
        }
        .diagnosis-evidence-row h4 {
            margin: 0 0 15px 0;
            color: #374151;
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 8px;
        }

        .hidden {
            display: none !important;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .code-display {
            font-family: monospace;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        .hidden { display: none; }
        .trigger-indicator {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        .help-tooltip {
            cursor: help;
            margin-left: 5px;
            color: #6b7280;
        }
        .help-text {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
        }
        .help-text h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #374151;
        }
        .help-text ul {
            margin-bottom: 0;
            padding-left: 20px;
        }
        .help-text li {
            margin-bottom: 5px;
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; }
            .form-grid { grid-template-columns: 1fr; }
            .container { padding: 15px; }
        }
        .ui81-brand {
            position: fixed;
            left: var(--sidenav-gap);
            top: 10px;
            width: var(--sidenav-w);
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px 12px;
            box-shadow: var(--shadow-1);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ui81-brand .penguin-logo {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .ui81-brand .name {
            font-weight: 800;
            letter-spacing: .2px;
            font-size: 18px;
            line-height: 1.2;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


  <!-- Clean UI v8.1 styles -->
  <link rel="stylesheet" href="css/ui.clean.v8_1.theme.css">
  <link rel="stylesheet" href="css/ui.clean.v8_1.components.css">

</head>
<body>
<div class="ui81-brand">
  <img src="./assets/xslt/penguin-logo.png" alt="eCeleRate" class="penguin-logo">
  <div class="name">eCeleRate</div>
</div>

    <div class="container">
        <div class="header">
            <div>
                <h1>eICR Generator</h1>
                <p class="subtitle">Electronic Initial Case Report with Reportable Condition Trigger Codes</p>
            </div>
            <div class="buttons">
    <button class="btn btn-success" onclick="saveFormData()">💾 Save Form Data</button>
    <button class="btn btn-primary" onclick="generateAndDownloadCDA()">📄 Generate CDA</button>
    <button class="btn btn-primary" onclick="generateAndDownloadRR()">📨 Generate RR</button>
    <button class="btn btn-info" onclick="downloadZipOfEICRandRR()">📦 Download ZIP (eICR + RR)</button>
    
    <!-- Hidden buttons for Clean UI system -->
    <button onclick="loadFormDataDialog()" style="display:none">Load Form Data</button>
    <button onclick="saveFormData()" style="display:none">Save Form Data</button>
</div>

<!-- File input goes outside the buttons div -->
<input type="file" id="loadFormDataInput" accept=".json" style="display:none" onchange="loadFormData(event)">
        </div>


        <div class="section">
            <h2 class="section-title"><i class="fas fa-user"></i> Patient Demographics</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Patient ID <span class="help-tooltip" title="Unique identifier that stays the same across all versions of the same logical document. Documents with the same Set ID represent different versions of the same document.">ℹ️</span></label>
                    <input type="text" id="patientId" value="MRN-00234567">
                </div>
                <div class="input-group">
                    <label>Patient Name <span style="color: red;">*</span></label>
                    <input type="text" id="patientName" value="Emma Rose Johnson" required>
                </div>
                <div class="input-group">
                    <label>Phone</label>
                    <input type="text" id="patientPhone" value="+1-555-234-5678">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="patientEmail" value="johnson.family@email.com">
                </div>
                <div class="input-group">
                    <label>Address <span style="color: red;">*</span></label>
                    <input type="text" id="patientAddress" value="1247 Maple Street" required>
                </div>
                <div class="input-group">
                    <label>City <span style="color: red;">*</span></label>
                    <input type="text" id="patientCity" value="Springfield" required>
                </div>
                <div class="input-group">
                    <label>State <span style="color: red;">*</span></label>
                    <input type="text" id="patientState" value="IL" required>
                </div>
                <div class="input-group">
                    <label>ZIP Code <span style="color: red;">*</span></label>
                    <input type="text" id="patientZip" value="62701" required>
                </div>
                <div class="input-group">
                    <label>County</label>
                    <input type="text" id="patientCounty" value="Sangamon County">
                </div>
                <div class="input-group">
                    <label>Country</label>
                    <input type="text" id="patientCountry" value="US">
                </div>
                <div class="input-group">
                    <label>Administrative Gender Code <span style="color: red;">*</span></label>
                    <select id="patientGender" required>
                        <option value="">Select Gender</option>
                        <option value="F" selected>Female</option>
                        <option value="M">Male</option>
                        <option value="UN">Undifferentiated</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Birth Date</label>
                    <input type="datetime-local" id="patientBirthDate" value="2024-06-15T00:00">
                </div>
                <div class="input-group">
                    <label>Race Code <span style="color: red;">*</span></label>
                    <select id="patientRace" required>
                        <option value="">Select Race</option>
                        <option value="1002-5">American Indian or Alaska Native</option>
                        <option value="2028-9">Asian</option>
                        <option value="2054-5">Black or African American</option>
                        <option value="2076-8">Native Hawaiian or Other Pacific Islander</option>
                        <option value="2106-3" selected>White</option>
                        <option value="2131-1">Other Race</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Ethnicity Code <span style="color: red;">*</span></label>
                    <select id="patientEthnicity" required>
                        <option value="">Select Ethnicity</option>
                        <option value="2135-2">Hispanic or Latino</option>
                        <option value="2186-5" selected>Not Hispanic or Latino</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
    <label>Birth Place City</label>
    <input type="text" id="patientBirthPlaceCity" value="Springfield">
</div>
<div class="input-group">
    <label>Birth Place State</label>
    <input type="text" id="patientBirthPlaceState" value="IL">
</div>
<div class="input-group">
    <label>Birth Place Country</label>
    <input type="text" id="patientBirthPlaceCountry" value="US">
</div>
<div class="input-group">
    <label>Birth Place Facility</label>
    <input type="text" id="patientBirthPlaceFacility" value="Memorial Hospital">
</div>
                <div class="input-group">
                    <label>Birth Sex</label>
                    <select id="patientBirthSex">
                        <option value="F">Female</option>
                        <option value="M">Male</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                 <div class="input-group" style="display:none">
                   <label>Gender Identity</label>
                   <select id="patientGenderIdentity">
                     <option value="446151000124109">Identifies as female gender (finding)</option>
                       <option value="446141000124107">Identifies as male gender (finding)</option>
                      <option value="33791000087105">Identifies as nonbinary gender (finding)</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Detailed Race Code</label>
                    <select id="patientDetailedRace">
                        <option value="1004-1">American Indian</option>
                        <option value="1010-8">Alaska Native</option>
                        <option value="2029-7">Asian Indian</option>
                        <option value="2040-4">Chinese</option>
                        <option value="2047-9">Filipino</option>
                        <option value="2051-1">Japanese</option>
                        <option value="2054-5">Korean</option>
                        <option value="2058-6">Vietnamese</option>
                        <option value="2060-2">Other Asian</option>
                        <option value="2076-8">Black</option>
                        <option value="2108-9" selected>White</option>
                        <option value="2131-1">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Detailed Ethnicity Code</label>
                    <select id="patientDetailedEthnicity">
                        <option value="2137-8">Mexican</option>
                        <option value="2141-0">Puerto Rican</option>
                        <option value="2142-8">Cuban</option>
                        <option value="2148-5" selected>Not Hispanic or Latino</option>
                        <option value="2180-8">Other Hispanic or Latino</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Primary Language</label>
                    <input type="text" id="patientLanguage" value="en">
                </div>
                <div class="input-group">
                    <label>Death Indicator</label>
                    <select id="patientDeathIndicator">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Date of Death (YYYYMMDD)</label>
                    <input type="text" id="patientDeathDate" placeholder="Leave blank if alive">
                </div>
                <div class="input-group">
                    <label>Disability Status</label>
                    <select id="disabilityStatus">
                        <option value="21134002" selected>Disabled</option>
                        <option value="405159006">Not disabled</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Disability Type</label>
                    <input type="text" id="disabilityType" value="Spina bifida - congenital neural tube defect">
                </div>
                <div class="input-group">
                    <label>Tribal Affiliation</label>
                    <input type="text" id="tribalAffiliation" value="Not applicable">
                </div>
                <div class="input-group">
                    <label>Tribal Enrollment</label>
                    <select id="tribalEnrollment">
                        <option value="true">Yes</option>
                        <option value="false" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>               
                <div class="input-group">
                    <label>Immigration Status</label>
                    <select id="immigrationStatus">
                        <option value="160542002" selected>US Citizen</option>
                        <option value="160540005">Permanent Resident</option>
                        <option value="160541006">Temporary Resident</option>
                        <option value="160543007">Undocumented</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Preferred Language</label>
                    <input type="text" id="preferredLanguage" value="English">
                </div>
                <div class="input-group">
                    <label>Interpreter Needed</label>
                    <select id="interpreterNeeded">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Insurance Status</label>
                    <select id="insuranceStatus">
                        <option value="48758009" selected>Insured</option>
                        <option value="182890002">Uninsured</option>
                        <option value="182891003">Self-pay</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-briefcase"></i> Occupation Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Current Occupation</label>
                    <input type="text" id="currentOccupation" value="Marketing Manager">
                </div>
                <div class="input-group">
                    <label>Usual Occupation</label>
                    <input type="text" id="usualOccupation" value="Marketing Manager">
                </div>
                <div class="input-group">
                    <label>Current Industry</label>
                    <input type="text" id="currentIndustry" value="Healthcare Services">
                </div>
                <div class="input-group">
                    <label>Usual Industry</label>
                    <input type="text" id="usualIndustry" value="Healthcare Services">
                </div>
                <div class="input-group">
                    <label>Current Job Title</label>
                    <input type="text" id="currentJobTitle" value="Senior Marketing Manager">
                </div>
                <div class="input-group">
                    <label>Current Employer Name</label>
                    <input type="text" id="currentEmployerName" value="Springfield Medical Center">
                </div>
                <div class="input-group">
                    <label>Current Employer Phone</label>
                    <input type="text" id="currentEmployerPhone" value="+1-217-555-0155">
                </div>
                <div class="input-group">
                    <label>Current Employer Address</label>
                    <input type="text" id="currentEmployerAddress" value="800 E Capitol Ave, Springfield, IL 62701">
                </div>
                <div class="input-group">
                    <label>Occupational Exposure</label>
                    <select id="occupationalExposure">
                        <option value="">-- Select Occupational Exposure --</option>
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Employment Status</label>
                    <select id="employmentStatus">
                       <option value="">-- Select Employment Status --</option>
                        <option value="1" selected>Employed</option>
                        <option value="2">Unemployed</option>
                        <option value="3">Not in labor force</option>
                        <option value="4">Retired</option>
                        <option value="5">Student</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-users"></i> Guardian/Parent Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Guardian Name</label>
                    <input type="text" id="guardianName" value="Sarah Michelle Johnson">
                </div>
                <div class="input-group">
                    <label>Guardian Phone</label>
                    <input type="text" id="guardianPhone" value="+1-555-234-5678">
                </div>
                <div class="input-group">
                    <label>Guardian Email</label>
                    <input type="email" id="guardianEmail" value="sarah.johnson@email.com">
                </div>
                <div class="input-group">
                    <label>Guardian Address</label>
                    <input type="text" id="guardianAddress" value="1247 Maple Street">
                </div>
                <div class="input-group">
                    <label>Guardian City</label>
                    <input type="text" id="guardianCity" value="Springfield">
                </div>
                <div class="input-group">
                    <label>Guardian State</label>
                    <input type="text" id="guardianState" value="IL">
                </div>
                <div class="input-group">
                    <label>Guardian ZIP Code</label>
                    <input type="text" id="guardianZip" value="62701">
                </div>
                <div class="input-group">
                    <label>Guardian Relationship Code</label>
                    <select id="guardianCode">
                        <option value="MTH">Mother</option>
                        <option value="FTH">Father</option>
                        <option value="GRMTH">Grandmother</option>
                        <option value="GRFTH">Grandfather</option>
                        <option value="GUARD">Guardian</option>
                        <option value="O">Other</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-user-md"></i> Provider Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Provider ID</label>
                    <input type="text" id="providerId" value="1234567890">
                </div>
                <div class="input-group">
                    <label>Provider Name</label>
                    <input type="text" id="providerName" value="Dr Royce Hemlock">
                </div>
                <div class="input-group">
                    <label>Provider Phone</label>
                    <input type="text" id="providerPhone" value="+1-555-777-0123">
                </div>
                <div class="input-group">
                    <label>Provider Email</label>
                    <input type="email" id="providerEmail" value="dr.hemlock@grmfc.gc.example.com">
                </div>
                <div class="input-group">
                    <label>Provider Fax</label>
                    <input type="text" id="providerFax" value="+1-555-777-0124">
                </div>
                <div class="input-group">
                    <label>Facility ID</label>
                    <input type="text" id="facilityId" value="FAC-987654321">
                </div>
                <div class="input-group">
                    <label>Facility Name</label>
                    <input type="text" id="facilityName" value="Grand Republic Medical Facility Clinic">
                </div>
                <div class="input-group">
                    <label>Facility Address</label>
                    <input type="text" id="facilityAddress" value="500 Republica Medical Plaza, Suite 1000">
                </div>
                <div class="input-group">
                    <label>Facility Type Code</label>
                    <select id="facilityTypeCode">
                        <option value="OF">Outpatient Facility</option>
                        <option value="HOSP">Hospital</option>
                        <option value="COMM">Community Hospital</option>
                        <option value="PROFF">Provider's Office</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Organization Name</label>
                    <input type="text" id="organizationName" value="Grand Republic Medical Corporation">
                </div>
                <div class="input-group">
                    <label>Organization ID</label>
                    <input type="text" id="organizationId" value="ORG-123456789">
                </div>
                <div class="input-group">
                    <label>Organization Phone</label>
                    <input type="text" id="organizationPhone" value="+1-555-777-1000">
                </div>
                <div class="input-group">
                    <label>Organization Email</label>
                    <input type="email" id="organizationEmail" value="info@grmfc.gc.example.com">
                </div>
                <div class="input-group">
                    <label>Organization Fax</label>
                    <input type="text" id="organizationFax" value="+1-555-777-1001">
                </div>
                <div class="input-group">
                    <label>Organization Address</label>
                    <input type="text" id="organizationAddress" value="500 Republica Medical Plaza">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-hospital"></i> Encounter Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Encounter ID</label>
                    <input type="text" id="encounterId" value="9937015">
                </div>
                <div class="input-group">
                    <label>Encounter Type</label>
                    <input type="text" id="encounterType" value="AMB">
                </div>
                <div class="input-group">
                    <label>Encounter Date (YYYYMMDD)</label>
                    <input type="text" id="encounterDate" value="20240615">
                </div>
                <div class="input-group">
                    <label>Encounter End Date (YYYYMMDD)</label>
                    <input type="text" id="encounterEndDate" value="20240615">
                </div>
                <div class="input-group">
                    <label>Encounter Disposition</label>
                    <select id="encounterDisposition">
                        <option value="01">Routine discharge/release to home or self care</option>
                        <option value="02">Discharge/transfer to another short term hospital</option>
                        <option value="03">Discharge/transfer to skilled nursing facility</option>
                        <option value="04">Discharge/transfer to an intermediate care facility</option>
                        <option value="05">Discharge/transfer to another type of institution</option>
                        <option value="06">Discharge/transfer to home under care of organized home health service</option>
                        <option value="07">Left against medical advice or discontinued care</option>
                        <option value="20">Expired</option>
                    </select>
                </div>
                <div class="input-group textarea-group">
                    <label>Chief Complaint</label>
                    <textarea id="chiefComplaint">fever, cough, exposure to COVID-19 hot zone</textarea>
                </div>
                <div class="input-group textarea-group">
                    <label>History of Present Illness</label>
                    <textarea id="presentIllness">The patient initially presented with difficulty breathing and fever. Patient disclosed recent travel to a known COVID-19 hot zone.</textarea>
                </div>
                <div class="input-group textarea-group">
                    <label>Reason for Visit</label>
                    <textarea id="reasonForVisit">Routine follow-up visit and COVID-19 screening due to exposure</textarea>
                </div>
                <div class="input-group textarea-group">
                    <label>Past Medical History</label>
                    <textarea id="pastMedicalHistory">No significant past medical history. No known allergies.</textarea>
                </div>
                <div class="input-group textarea-group">
                    <label>Review of Systems</label>
                    <textarea id="reviewOfSystems">Patient reports fever, fatigue, and mild cough. Denies chest pain, shortness of breath at rest.</textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-stethoscope"></i> Diagnoses with RCTC Trigger Codes</h2>
            <div class="diagnosis-evidence-controls">
        <button class="btn btn-primary" type="button" onclick="addDiagnosisEvidence()">➕ Add Diagnosis</button>
    </div>

    <div id="diagnosisEvidenceList"></div>
    
    <template id="diagnosisEvidenceTemplate">
        <div class="diagnosis-evidence-row">
            <h4>Diagnosis Entry</h4>
            <div class="form-grid">
                <div class="input-group">
                    <label>Diagnosis Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" class="de-diagnosis-code" placeholder="ex. 67531005">
                        <button class="btn btn-secondary" type="button" onclick="searchRCTCForDiagnosis(this)">🔍</button>
                    </div>
                    <div class="de-diagnosis-code-results search-results"></div>
                </div>
                
                <div class="input-group">
                    <label>Diagnosis Name</label>
                    <div class="code-search">
                        <input type="text" class="de-diagnosis-name" placeholder="Down syndrome (disorder)">
                        <button class="btn btn-secondary" type="button" onclick="searchRCTCForDiagnosisByName(this)">🔍</button>
                    </div>
                    <div class="de-diagnosis-name-results search-results"></div>
                </div>
                
                <div class="input-group">
                    <label>Date of Diagnosis (YYYYMMDD)</label>
                    <input type="text" class="de-diagnosis-date" placeholder="20240601">
                </div>
                
                <div class="input-group">
                    <label>Date of Onset (YYYYMMDD)</label>
                    <input type="text" class="de-onset-date" placeholder="20240601">
                </div>
                
                <div class="input-group">
                    <label>Status</label>
                    <select class="de-status">
                        <option value="completed" selected>Completed</option>
                        <option value="active">Active</option>
                        <option value="resolved">Resolved</option>
                    </select>
                </div>
                
                <div>
                    <button class="btn btn-warning" type="button" onclick="removeDiagnosisEvidence(this)">🗑️ Remove</button>
                </div>
            </div>
        </div>
    </template>
</div>

<!-- Problems Section -->
<div class="section">
    <h2 class="section-title"><i class="fas fa-exclamation-circle"></i> Problems</h2>
    <div class="problem-evidence-controls">
        <button class="btn btn-primary" type="button" onclick="addProblemEvidence()">➕ Add Problem</button>
    </div>

    <div id="problemEvidenceList"></div>

    <template id="problemEvidenceTemplate">
        <div class="problem-evidence-row">
            <h4>Problem Entry</h4>
            <div class="form-grid">
                <div class="input-group">
                    <label>Problem Code</label>
                    <div class="code-search">
                        <input type="text" class="pe-problem-code" placeholder="ex. 385093006">
                        <button class="btn btn-secondary" type="button" onclick="searchSNOMEDForProblem(this)">🔍</button>
                    </div>
                    <div class="pe-problem-code-results search-results"></div>
                </div>

                <div class="input-group">
                    <label>Problem Name</label>
                    <div class="code-search">
                        <input type="text" class="pe-problem-name" placeholder="Community acquired pneumonia">
                        <button class="btn btn-secondary" type="button" onclick="searchSNOMEDForProblemByName(this)">🔍</button>
                    </div>
                    <div class="pe-problem-name-results search-results"></div>
                </div>

                <div class="input-group">
                    <label>Problem Onset Date (YYYYMMDD)</label>
                    <input type="text" class="pe-onset-date" placeholder="20240227">
                </div>

                <div class="input-group">
                    <label>Problem Status</label>
                    <select class="pe-status">
                        <option value="active" selected>Active</option>
                        <option value="completed">Resolved</option>
                        <option value="suspended">Suspended</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Concern Status</label>
                    <select class="pe-concern-status">
                        <option value="active" selected>Active</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>

                <div>
                    <button class="btn btn-warning" type="button" onclick="removeProblemEvidence(this)">🗑️ Remove</button>
                </div>
            </div>
        </div>
    </template>
</div>

        <!-- Lab Orders and Results Section -->
        <div class="section">
            <h2 class="section-title"><i class="fas fa-vial"></i> Lab Orders and Results</h2>
            
            <div class="lab-evidence-controls">
                <button class="btn btn-primary" type="button" onclick="addLabEvidence()">➕ Add Lab Order and Result</button>
            </div>

            <!-- ── Results Providers (applies to *all* result observations) ── -->
            <div class="subsection">
                <h4>Performing Laboratory & Ordering Physician</h4>
                <div class="form-grid">
                    <!-- Performing lab (organization) -->
                    <div class="input-group">
                        <label>Performing Lab • CLIA (opt)</label>
                        <input type="text" id="resultLabCLIA" value="12D3456789">
                    </div>
                    <div class="input-group">
                        <label>Performing Lab • Name (opt)</label>
                        <input type="text" id="resultLabName" value="Good Health Lab">
                    </div>

                    <!-- Resulting performer (person) -->
                    <div class="input-group">
                        <label>Resulting Performer • NPI (opt)</label>
                        <input type="text" id="resultPerformerNPI" inputmode="numeric" pattern="\d{10}">
                    </div>
                    <div class="input-group">
                        <label>Resulting Performer • First (opt)</label>
                        <input type="text" id="resultPerformerGiven">
                    </div>
                    <div class="input-group">
                        <label>Resulting Performer • Last (opt)</label>
                        <input type="text" id="resultPerformerFamily">
                    </div>

                    <!-- Ordering provider (author) -->
                    <div class="input-group">
                        <label>Ordering Provider • NPI (opt)</label>
                        <input type="text" id="resultOrderingNPI" inputmode="numeric" pattern="\d{10}">
                    </div>
                    <div class="input-group">
                        <label>Ordering Provider • First (opt)</label>
                        <input type="text" id="resultOrderingGiven">
                    </div>
                    <div class="input-group">
                        <label>Ordering Provider • Last (opt)</label>
                        <input type="text" id="resultOrderingFamily">
                    </div>
                </div>
            </div>

            <div id="labEvidenceList"></div>
            
            <template id="labEvidenceTemplate">
                <div class="lab-evidence-row">
                    <h4>Lab Order and Result Entry</h4>
                    <div class="form-grid">
                        <!-- Order Information -->
                        <div class="input-group">
                            <label>Order Code (LOINC) <span class="trigger-indicator">RCTC TRIGGER</span></label>
                            <div class="code-search">
                                <input type="text" class="le-order-code" placeholder="ex. 94310-0">
                                <button class="btn btn-secondary" type="button" onclick="searchRCTCForLabOrder(this)">🔍</button>
                            </div>
                            <div class="le-order-code-results search-results"></div>
                        </div>
                        <div class="input-group">
                            <label>Order Name</label>
                            <div class="code-search">
                                <input type="text" class="le-order-name" placeholder="SARS-like Coronavirus N gene">
                                <button class="btn btn-secondary" type="button" onclick="searchRCTCForLabOrderByName(this)">🔍</button>
                            </div>
                            <div class="le-order-name-results search-results"></div>
                        </div>
                        <div class="input-group">
                            <label>Order ID</label>
                            <input type="text" class="le-order-id" placeholder="ORD-2024-001">
                        </div>
                        <div class="input-group">
                            <label>Order Time (YYYYMMDDHHMMSS)</label>
                            <input type="text" class="le-order-time" placeholder="20240615080000">
                        </div>

                        <!-- Test/Result Information -->
                        <div class="input-group">
                            <label>Test Code (LOINC) <span class="trigger-indicator">RCTC TRIGGER</span></label>
                            <div class="code-search">
                                <input type="text" class="le-test-code" placeholder="ex. 94310-0">
                                <button class="btn btn-secondary" type="button" onclick="searchRCTCForTest(this)">🔍</button>
                            </div>
                            <div class="le-test-code-results search-results"></div>
                        </div>
                        <div class="input-group">
                            <label>Test Name</label>
                            <div class="code-search">
                                <input type="text" class="le-test-name" placeholder="SARS-like Coronavirus N gene">
                                <button class="btn btn-secondary" type="button" onclick="searchRCTCForTestByName(this)">🔍</button>
                            </div>
                            <div class="le-test-name-results search-results"></div>
                        </div>

                        <!-- Result Value Type Selector -->
                        <div class="input-group">
                            <label>Result Kind</label>
                            <select class="le-value-kind" onchange="toggleValueEditors(this)">
                                <option value="coded" selected>Coded (organism/substance)</option>
                                <option value="quantity">Quantity</option>
                                <option value="text">Text</option>
                            </select>
                        </div>

                        <!-- Coded Value (SNOMED CT) -->
                        <div class="input-group le-coded">
                            <label>Organism/Substance Code (SNOMED CT)</label>
                            <div class="code-search">
                                <input type="text" class="le-value-code" placeholder="ex. 840539006">
                                <button class="btn btn-secondary" type="button" onclick="searchRCTCForOrganism(this)">🔍</button>
                            </div>
                            <div class="le-value-code-results search-results"></div>
                        </div>
                        <div class="input-group le-coded">
                            <label>Organism/Substance Name</label>
                            <div class="code-search">
                                <input type="text" class="le-value-name" placeholder="Disease caused by 2019-nCoV">
                                <button class="btn btn-secondary" type="button" onclick="searchRCTCForOrganismByName(this)">🔍</button>
                            </div>
                            <div class="le-value-name-results search-results"></div>
                        </div>

                        <!-- Quantity Value -->
                        <div class="input-group le-qty hidden">
                            <label>Value</label>
                            <input type="number" step="0.01" class="le-qty-value" placeholder="ex. 100">
                        </div>
                        <div class="input-group le-qty hidden">
                            <label>Unit</label>
                            <input type="text" class="le-qty-unit" placeholder="[iU]/mL">
                        </div>

                        <!-- Text Value -->
                        <div class="input-group le-text hidden">
                            <label>Text Result</label>
                            <input type="text" class="le-text-value" placeholder="Detected / Not detected">
                        </div>

                        <!-- Timing/Status/Interpretation -->
                        <div class="input-group">
                            <label>Result Time (YYYYMMDDHHMMSS)</label>
                            <input type="text" class="le-time" placeholder="20240615103000">
                        </div>
                        <div class="input-group">
                            <label>Status</label>
                            <select class="le-status">
                                <option value="completed" selected>completed</option>
                                <option value="active">active</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Interpretation</label>
                            <select class="le-interpretation">
                                <option value=""></option>
                                <option value="A">Abnormal</option>
                                <option value="N">Normal</option>
                                <option value="H">High</option>
                                <option value="L">Low</option>
                                <option value="HH">Critical high</option>
                                <option value="LL">Critical low</option>
                            </select>
                        </div>

                        <!-- Reference Range -->
                        <div class="input-group">
                            <label>Reference Range</label>
                            <input type="text" class="le-reference-range" placeholder="2.5-15.0 ng/mL or Not Detected">
                        </div>

                        <div>
                            <button class="btn btn-warning" type="button" onclick="removeLabEvidence(this)">🗑️ Remove</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

<!-- ░░░  MEDICATIONS  ░░░================================================ -->
<div class="section">
  <h2 class="section-title"><i class="fas fa-pills"></i> Medications</h2>

  <div class="form-grid">

   <!-- Administering Provider (single provider for ALL administered meds) -->
<div class="input-group">
  <label>Administering Provider NPI</label>
  <input type="text" id="administeringProviderNPI" inputmode="numeric" pattern="\d{10}" value="1234567890">
</div>

<div class="input-group">
  <label>First</label>
  <input type="text" id="administeringProviderGiven" value="Je Suis">
</div>

<div class="input-group">
  <label>Last</label>
  <input type="text" id="administeringProviderFamily" value="Médecin">
</div>

<div class="input-group">
  <label>Phone (opt)</label>
  <input type="tel" id="administeringProviderPhone" placeholder="555-555-5555">
</div>

<div class="input-group">
  <label>Organization (opt)</label>
  <input type="text" id="administeringProviderOrgName">
</div>

<div class="input-group">
  <label>Org ID (extension) (opt)</label>
  <input type="text" id="administeringProviderOrgId" placeholder="Facility ID/Code">
</div>

<div class="input-group">
  <label>Org ID Root (OID) (opt)</label>
  <input type="text" id="administeringProviderOrgIdRoot" value="2.16.840.1.113883.19">
</div>

    <!-- ───────────── Administered Medication 1 ───────────── -->
    <div class="input-group">
      <label>Administered Medication 1 Code</label>
      <input type="text" id="adminMed1Code" value="42946">
    </div>

    <div class="input-group">
      <label>Administered Medication 1 Name</label>
      <input type="text" id="adminMed1Name" value="Folic acid">
    </div>

    <div class="input-group">
      <label>Administration ID 1</label>
      <input type="text" id="adminMed1Id" value="MED-2024-001">
    </div>

    <div class="input-group">
      <label>Administration Status 1</label>
      <select id="adminMed1Status">
        <option value="completed">Completed</option>
        <option value="active">Active</option>
        <option value="suspended">Suspended</option>
        <option value="aborted">Aborted</option>
      </select>
    </div>

    <div class="input-group">
      <label>Administration Time 1 (YYYYMMDDHHMMSS)</label>
      <input type="text" id="adminMed1Time" value="20240615120000">
    </div>

    <div class="input-group">
      <label>Route 1</label>
      <select id="adminMed1Route">
        <option value="PO">Oral</option>
        <option value="IV">Intravenous</option>
        <option value="IM">Intramuscular</option>
        <option value="SC">Subcutaneous</option>
        <option value="SL">Sublingual</option>
        <option value="TOP">Topical</option>
        <option value="INH">Inhalation</option>
      </select>
    </div>

    <!-- — NEW dose widgets — -->
    <div class="input-group">
      <label>Dose 1 • Amount</label>
      <input type="number" step="0.01" id="adminMed1DoseValue" value="0.4">
    </div>

    <div class="input-group">
      <label>Dose 1 • Unit</label>
      <select id="adminMed1DoseUnit">
        <option value="mg">mg</option>
        <option value="mcg">mcg</option>
        <option value="g">g</option>
        <option value="mL">mL</option>
        <option value="1">each / tablet</option>
      </select>
    </div>

    <div class="input-group">
      <label>Dose 1 • Volume (opt)</label>
      <input type="number" step="0.01" id="adminMed1VolValue" placeholder="0.5">
    </div>

    <div class="input-group">
      <label>Vol • Unit</label>
      <select id="adminMed1VolUnit">
        <option value=""></option>
        <option value="mL">mL</option>
        <option value="L">L</option>
      </select>
    </div>

    <div class="input-group">
      <label><input type="checkbox" id="adminMed1Negated"> NOT given</label>
    </div>

    <!-- ───────────── Administered Medication 2 ───────────── -->
    <div class="input-group">
      <label>Administered Medication 2 Code</label>
      <input type="text" id="adminMed2Code" value="161">
    </div>

    <div class="input-group">
      <label>Administered Medication 2 Name</label>
      <input type="text" id="adminMed2Name" value="Multivitamin preparation">
    </div>

    <div class="input-group">
      <label>Administration ID 2</label>
      <input type="text" id="adminMed2Id" value="MED-2024-002">
    </div>

    <div class="input-group">
      <label>Administration Status 2</label>
      <select id="adminMed2Status">
        <option value="completed">Completed</option>
        <option value="active">Active</option>
        <option value="suspended">Suspended</option>
        <option value="aborted">Aborted</option>
      </select>
    </div>

    <div class="input-group">
      <label>Administration Time 2 (YYYYMMDDHHMMSS)</label>
      <input type="text" id="adminMed2Time" value="20240615130000">
    </div>

    <div class="input-group">
      <label>Route 2</label>
      <select id="adminMed2Route">
        <option value="PO">Oral</option>
        <option value="IV">Intravenous</option>
        <option value="IM">Intramuscular</option>
        <option value="SC">Subcutaneous</option>
        <option value="SL">Sublingual</option>
        <option value="TOP">Topical</option>
        <option value="INH">Inhalation</option>
      </select>
    </div>

    <!-- — NEW dose widgets — -->
    <div class="input-group">
      <label>Dose 2 • Amount</label>
      <input type="number" step="0.01" id="adminMed2DoseValue" value="1">
    </div>

    <div class="input-group">
      <label>Dose 2 • Unit</label>
      <select id="adminMed2DoseUnit">
        <option value="mg">mg</option>
        <option value="mcg">mcg</option>
        <option value="g">g</option>
        <option value="mL">mL</option>
        <option value="1" selected>each / tablet</option>
      </select>
    </div>

    <div class="input-group">
      <label>Dose 2 • Volume (opt)</label>
      <input type="number" step="0.01" id="adminMed2VolValue" placeholder="">
    </div>

    <div class="input-group">
      <label>Vol • Unit</label>
      <select id="adminMed2VolUnit">
        <option value=""></option>
        <option value="mL">mL</option>
        <option value="L">L</option>
      </select>
    </div>

    <div class="input-group">
      <label><input type="checkbox" id="adminMed2Negated"> NOT given</label>
    </div>

    <!-- ───────────── Planned Medication (unchanged) ───────────── -->
    <div class="input-group">
      <label>Planned Medication 1 Code</label>
      <input type="text" id="plannedMed1Code" value="161">
    </div>

    <div class="input-group">
      <label>Planned Medication 1 Name</label>
      <input type="text" id="plannedMed1Name" value="Multivitamin with iron">
    </div>

    <div class="input-group">
      <label>Planned Medication 1 Instructions</label>
      <textarea id="plannedMed1Instructions">
Take 1 tablet daily with food for nutritional support during neural tube defect management
      </textarea>
    </div>

  </div>
</div>
<!-- ░░░=============================================================== -->


        <div class="section">
            <h2 class="section-title"><i class="fas fa-syringe"></i> Immunizations</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Immunization 1 Status</label>
                    <select id="immunization1Status">
                        <option value="completed" selected>Completed</option>
                        <option value="not-done">Not Done</option>
                        <option value="refused">Refused</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Immunization 1 ID</label>
                    <input type="text" id="immunization1Id" placeholder="e.g., IMM-001" value="HepB-NB-001">
                </div>
                <div class="input-group">
                    <label>Immunization 1 Date (YYYYMMDD)</label>
                    <input type="text" id="immunization1Date" placeholder="e.g., 20250201" value="20240615">
                </div>
                <div class="input-group">
                    <label>Vaccine 1 Code</label>
                    <input type="text" id="vaccine1Code" placeholder="e.g., 207" value="08">
                </div>
                <div class="input-group">
                    <label>Vaccine 1 Name</label>
                    <input type="text" id="vaccine1Name" placeholder="e.g., COVID-19 mRNA vaccine" value="Hepatitis B vaccine, pediatric or pediatric/adolescent dosage">
                </div>
                <div class="input-group">
               <label>Vaccine 1 Lot</label>
               <input type="text" id="vaccine1Lot" value="ABC12345">
               </div>
                <div class="input-group">
                    <label>Dose Quantity 1</label>
                    <input type="text" id="vaccine1Dose" placeholder="e.g., 0.3 mL" value="0.5 mL">
                </div>
                <div class="input-group">
                    <label>Route 1</label>
                    <select id="vaccine1Route">
                        <option value="IM" selected>Intramuscular</option>
                        <option value="SC">Subcutaneous</option>
                        <option value="ID">Intradermal</option>
                        <option value="PO">Oral</option>
                        <option value="IN">Intranasal</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Manufacturer 1</label>
                    <input type="text" id="vaccine1Manufacturer" placeholder="e.g., Pfizer-BioNTech" value="Merck Co, Inc.">
                </div>
                <div class="input-group">
                    <label>Immunization 2 Status</label>
                    <select id="immunization2Status">
                        <option value="completed" selected>Completed</option>
                        <option value="not-done">Not Done</option>
                        <option value="refused">Refused</option>
                        <option value="unknown">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Immunization 2 ID</label>
                    <input type="text" id="immunization2Id" placeholder="e.g., IMM-002" value="VitK-NB-001">
                </div>
                <div class="input-group">
                    <label>Immunization 2 Date (YYYYMMDD)</label>
                    <input type="text" id="immunization2Date" placeholder="e.g., 20250101" value="20240615">
                </div>
                <div class="input-group">
                    <label>Vaccine 2 Code</label>
                    <input type="text" id="vaccine2Code" placeholder="e.g., 141" value="87567">
                </div>
                <div class="input-group">
                    <label>Vaccine 2 Name</label>
                    <input type="text" id="vaccine2Name" placeholder="e.g., Influenza vaccine" value="Vitamin K1 injection (phytonadione)">
                </div>
                <div class="input-group">
                <label>Vaccine 2 Lot</label>
                <input type="text" id="vaccine2Lot" value="XYZ98765">
                </div>
                <div class="input-group">
                    <label>Dose Quantity 2</label>
                    <input type="text" id="vaccine2Dose" placeholder="e.g., 0.5 mL" value="1 mg (0.5 mL)">
                </div>
                <div class="input-group">
                    <label>Route 2</label>
                    <select id="vaccine2Route">
                        <option value="IM" selected>Intramuscular</option>
                        <option value="SC">Subcutaneous</option>
                        <option value="ID">Intradermal</option>
                        <option value="PO">Oral</option>
                        <option value="IN">Intranasal</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Manufacturer 2</label>
                    <input type="text" id="vaccine2Manufacturer" placeholder="e.g., Sanofi Pasteur" value="Hospira Inc.">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-baby"></i> Pregnancy Information</h2>
            <div class="form-grid">
                <div class="input-group">
    <label>Pregnancy Status</label>
    <select id="pregnancyStatus">
        <option value="77386006" selected>Pregnant</option>  
        <option value="60001007">Not pregnant</option>
        <option value="102874004">Possible pregnancy</option>
        <option value="261665006">Unknown</option>
    </select>
</div>
                <div class="input-group">
                    <label>Pregnancy Effective Time (YYYYMMDD)</label>
                    <input type="text" id="pregnancyEffectiveTime" placeholder="Date of assessment" value="20240615">
                </div>
                <div class="input-group">
                    <label>Estimated Delivery Date (YYYYMMDD)</label>
                    <input type="text" id="estimatedDeliveryDate" placeholder="Expected delivery date" value="20240615">
                </div>
                <div class="input-group">
                    <label>Pregnancy Determination Method</label>
                    <select id="pregnancyDeterminationMethod">
                        <option value="169560004">Urine pregnancy test</option>
                        <option value="167252002">Serum pregnancy test</option>
                        <option value="12611008" selected>Ultrasound examination</option>
                        <option value="271900007">Patient reported</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Gestational Age (weeks)</label>
                    <input type="text" id="gestationalAge" placeholder="e.g., 12" value="39">
                </div>
                <div class="input-group">
                    <label>Last Menstrual Period (YYYYMMDD)</label>
                    <input type="text" id="lastMenstrualPeriod" placeholder="Date of LMP" value="20230906">
                </div>
                <div class="input-group">
                    <label>Pregnancy Outcome</label>
                    <select id="pregnancyOutcome">
                        <option value="281050002" selected>Live birth</option>
                        <option value="237364002">Stillbirth</option>
                        <option value="17369002">Miscarriage</option>
                        <option value="69422002">Elective termination</option>
                        <option value="N/A">Not applicable</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Postpartum Status</label>
                    <select id="postpartumStatus">
                        <option value="255410009" selected>Postpartum</option>
                        <option value="255409004">Not postpartum</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-plane"></i> Travel History</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Travel Start Date (YYYYMMDD)</label>
                    <input type="text" id="travelStartDate" value="20240515">
                </div>
                <div class="input-group">
                    <label>Travel End Date (YYYYMMDD)</label>
                    <input type="text" id="travelEndDate" value="20240520">
                </div>
                <div class="input-group">
                    <label>Travel Location</label>
                    <input type="text" id="travelLocation" value="Chicago, Illinois">
                </div>
                <div class="input-group">
                    <label>Travel Location Code</label>
                    <input type="text" id="travelLocationCode" value="IL">
                </div>
                <div class="input-group">
                    <label>Travel Address</label>
                    <input type="text" id="travelAddress" value="123 Oak Street, Springfield, IL 62701">
                </div>
                <div class="input-group">
                    <label>Purpose of Travel</label>
                    <select id="purposeOfTravel">
                        <option value="">-- Select Purpose of Travel --</option>
                        <option value="224930009">Business</option>
                        <option value="289049007" selected>Leisure</option>
                        <option value="385731004">Medical</option>
                        <option value="224930009">Educational</option>
                        <option value="O">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Transportation Type</label>
                    <select id="transportationType">
                        <option value="">-- Select Transportation Type --</option>
                        <option value="73957001">Air transport</option>
                        <option value="49122002" selected>Ground transport</option>
                        <option value="272125009">Water transport</option>
                        <option value="34965002">Public transport</option>
                        <option value="71783008">Private transport</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Transportation Details</label>
                    <textarea id="transportationDetails">Personal vehicle - 2022 Honda Pilot, License plate: ABC-1234</textarea>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-microscope"></i> Specimen Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Specimen 1 Source</label>
                    <select id="specimen1Source">
                        <option value="258500001">Nasopharyngeal swab</option>
                        <option value="461911000124106">Oropharyngeal swab</option>
                        <option value="258580003" selected>Whole blood sample</option>
                        <option value="122555007">Venous blood sample</option>
                        <option value="309051001">Body fluid sample</option>
                        <option value="119295008">Specimen obtained by aspiration</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Specimen 1 Type</label>
                    <input type="text" id="specimen1Type" placeholder="e.g., Swab" value="Whole blood">
                </div>
                <div class="input-group">
                    <label>Specimen 1 ID</label>
                    <input type="text" id="specimen1Id" placeholder="e.g., SPEC-001" value="NB-BLOOD-20240615-001">
                </div>
                <div class="input-group">
                    <label>Collection Date 1 (YYYYMMDDHHMMSS)</label>
                    <input type="text" id="collection1Date" placeholder="e.g., 20250216110000" value="20240615083000">
                </div>
                <div class="input-group">
                    <label>Specimen 2 Source</label>
                    <select id="specimen2Source">
                        <option value="258500001">Nasopharyngeal swab</option>
                        <option value="461911000124106">Oropharyngeal swab</option>
                        <option value="258580003">Whole blood sample</option>
                        <option value="122555007">Venous blood sample</option>
                        <option value="309051001" selected>Body fluid sample</option>
                        <option value="119295008">Specimen obtained by aspiration</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Specimen 2 Type</label>
                    <input type="text" id="specimen2Type" placeholder="e.g., Blood" value="Cerebrospinal fluid">
                </div>
                <div class="input-group">
                    <label>Specimen 2 ID</label>
                    <input type="text" id="specimen2Id" placeholder="e.g., SPEC-002" value="NB-CSF-20240615-001">
                </div>
                <div class="input-group">
                    <label>Collection Date 2 (YYYYMMDDHHMMSS)</label>
                    <input type="text" id="collection2Date" placeholder="e.g., 20250216120000" value="20240615093000">
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-chart-line"></i> Additional Clinical Data</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Temperature (°F)</label>
                    <input type="text" id="temperature" placeholder="e.g., 98.6" value="97.8">
                </div>
                <div class="input-group">
                    <label>Blood Pressure (mmHg)</label>
                    <input type="text" id="bloodPressure" placeholder="e.g., 120/80" value="65/42">
                </div>
                <div class="input-group">
                    <label>Heart Rate (bpm)</label>
                    <input type="text" id="heartRate" placeholder="e.g., 72" value="145">
                </div>
                <div class="input-group">
                    <label>Respiratory Rate (breaths/min)</label>
                    <input type="text" id="respiratoryRate" placeholder="e.g., 16" value="38">
                </div>
                <div class="input-group">
                    <label>Oxygen Saturation (%)</label>
                    <input type="text" id="oxygenSaturation" placeholder="e.g., 98" value="97">
                </div>
                <div class="input-group">
                    <label>Weight (lbs)</label>
                    <input type="text" id="weight" placeholder="e.g., 150" value="6.2">
                </div>
                <div class="input-group">
                    <label>Height (inches)</label>
                    <input type="text" id="height" placeholder="e.g., 68" value="19.5">
                </div>
                <div class="input-group">
                    <label>BMI</label>
                    <input type="text" id="bmi" placeholder="e.g., 22.8" value="13.2">
                </div>
                <div class="input-group">
                    <label>Therapeutic Response</label>
                    <select id="therapeuticResponse">
                        <option value="182840001" selected>Good response</option>
                        <option value="182841002">Poor response</option>
                        <option value="182842009">No response</option>
                        <option value="182843004">Partial response</option>
                        <option value="385655000">Not applicable</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Homeless Status</label>
                    <select id="homelessStatus">
                        <option value="105526001">Homeless</option>
                        <option value="105529008" selected>Not homeless</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Congregate Living</label>
                    <select id="congregateLiving">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Congregate Living Type</label>
                    <select id="congregateLivingType">
                        <option value="224683003">Nursing home</option>
                        <option value="42665001">School</option>
                        <option value="264362003">Prison</option>
                        <option value="257656006">Dormitory</option>
                        <option value="224891009">Shelter</option>
                        <option value="O" selected>Other</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-procedures"></i> Procedures</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Current Procedure 1 Code</label>
                    <input type="text" id="currentProc1Code" placeholder="e.g., 33747-0" value="80146002">
                </div>
                <div class="input-group">
                    <label>Current Procedure 1 Name</label>
                    <input type="text" id="currentProc1Name" placeholder="e.g., Bronchoscopy" value="Excision of spinal lesion">
                </div>
                <div class="input-group">
                    <label>Current Procedure 1 Date (YYYYMMDD)</label>
                    <input type="text" id="currentProc1Date" placeholder="e.g., 20250216" value="20240615">
                </div>
                <div class="input-group">
                    <label>Current Procedure 1 Type <span class="help-tooltip" title="Act: Use for general healthcare activities and administrative actions that don't fit the specific criteria for observations or procedures.

Observation: Use for diagnostic activities that gather information about the patient (lab tests, imaging, assessments) without altering their physical condition.

Procedure: Use for therapeutic interventions that alter the patient's physical condition (surgeries, treatments, manipulations).">ℹ️</span></label>
                    <select id="currentProc1Type">
                        <option value="act">Act</option>
                        <option value="observation">Observation</option>
                        <option value="procedure" selected>Procedure</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Current Procedure 2 Code</label>
                    <input type="text" id="currentProc2Code" placeholder="e.g., 71388002" value="241615005">
                </div>
                <div class="input-group">
                    <label>Current Procedure 2 Name</label>
                    <input type="text" id="currentProc2Name" placeholder="e.g., Chest X-ray" value="Magnetic resonance imaging of spine">
                </div>
                <div class="input-group">
                    <label>Current Procedure 2 Date (YYYYMMDD)</label>
                    <input type="text" id="currentProc2Date" placeholder="e.g., 20250216" value="20240615">
                </div>
                <div class="input-group">
                    <label>Current Procedure 2 Type <span class="help-tooltip" title="Act: Use for general healthcare activities and administrative actions that don't fit the specific criteria for observations or procedures.

Observation: Use for diagnostic activities that gather information about the patient (lab tests, imaging, assessments) without altering their physical condition.

Procedure: Use for therapeutic interventions that alter the patient's physical condition (surgeries, treatments, manipulations).">ℹ️</span></label>
                    <select id="currentProc2Type">
                        <option value="act">Act</option>
                        <option value="observation" selected>Observation</option>
                        <option value="procedure">Procedure</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Trigger Procedure 1 Code <span class="trigger-indicator">RCTC TRIGGER</span></label>
                    <div class="code-search">
                        <input type="text" id="triggerProc1Code" placeholder="e.g., 168731009" onblur="validateTriggerCode('triggerProc1Code')" value="230690007">
                        <button type="button" class="btn btn-secondary" onclick="searchRCTCCodes('triggerProc1Code')">🔍</button>
                    </div>
                    <div id="triggerProc1Code_results" class="search-results"></div>
                </div>
                <div class="input-group">
                    <label>Trigger Procedure 1 Name</label>
                    <input type="text" id="triggerProc1Name" placeholder="e.g., Intubation" value="Stroke">
                </div>
                <div class="input-group">
                    <label>Trigger Procedure 1 Date (YYYYMMDD)</label>
                    <input type="text" id="triggerProc1Date" placeholder="e.g., 20250216" value="20240615">
                </div>
                <div class="input-group">
                    <label>Trigger Procedure 1 Type <span class="help-tooltip" title="Act: Use for general healthcare activities and administrative actions that don't fit the specific criteria for observations or procedures.

Observation: Use for diagnostic activities that gather information about the patient (lab tests, imaging, assessments) without altering their physical condition.

Procedure: Use for therapeutic interventions that alter the patient's physical condition (surgeries, treatments, manipulations).">ℹ️</span></label>
                    <select id="triggerProc1Type">
                        <option value="act">Act</option>
                        <option value="observation" selected>Observation</option>
                        <option value="procedure">Procedure</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Planned Procedure 1 Code</label>
                    <input type="text" id="plannedProc1Code" placeholder="e.g., 182836005" value="182836005">
                </div>
                <div class="input-group">
                    <label>Planned Procedure 1 Name</label>
                    <input type="text" id="plannedProc1Name" placeholder="e.g., Follow-up CT scan" value="Neurosurgical follow-up">
                </div>
                <div class="input-group">
                    <label>Planned Procedure 1 Date (YYYYMMDD)</label>
                    <input type="text" id="plannedProc1Date" placeholder="e.g., 20250220" value="20240715">
                </div>
                <div class="input-group">
                    <label>Planned Procedure 1 Type <span class="help-tooltip" title="Act: Use for general healthcare activities and administrative actions that don't fit the specific criteria for observations or procedures.

Observation: Use for diagnostic activities that gather information about the patient (lab tests, imaging, assessments) without altering their physical condition.

Procedure: Use for therapeutic interventions that alter the patient's physical condition (surgeries, treatments, manipulations).">ℹ️</span></label>
                    <select id="plannedProc1Type">
                        <option value="act" selected>Act</option>
                        <option value="observation">Observation</option>
                        <option value="procedure">Procedure</option>
                    </select>
                </div>
            </div>
        </div>


        <div class="section">
            <h2 class="section-title"><i class="fas fa-exclamation-triangle"></i> Emergency and Public Health</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Emergency Outbreak Information</label>
                    <select id="emergencyOutbreakInfo">
                        <option value="443684005">Disease outbreak</option>
                        <option value="410546004">Public health emergency</option>
                        <option value="N/A" selected>Not applicable</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Outbreak Details</label>
                    <textarea id="outbreakDetails">No current outbreak or emergency situation related to this case</textarea>
                </div>
                <div class="input-group">
                    <label>Exposure/Contact Information</label>
                    <select id="exposureContactInfo">
                        <option value="24932003">Exposed</option>
                        <option value="84100007">Contact</option>
                        <option value="373068000" selected>No exposure</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Exposure Type</label>
                    <select id="exposureType">
                        <option value="409822003">Direct contact</option>
                        <option value="417746004">Airborne</option>
                        <option value="418038007">Droplet</option>
                        <option value="447964005">Contact precaution</option>
                        <option value="OTH" selected>Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Exposure Location</label>
                    <input type="text" id="exposureLocation" value="Not applicable - congenital condition">
                </div>
                <div class="input-group">
                    <label>Exposure Date (YYYYMMDD)</label>
                    <input type="text" id="exposureDate" value="Not applicable">
                </div>
                <div class="input-group">
                    <label>Contact Person Name</label>
                    <input type="text" id="contactPersonName" value="Dr. Patricia Williams, MD">
                </div>
                <div class="input-group">
                    <label>Contact Person Phone</label>
                    <input type="text" id="contactPersonPhone" value="+1-217-555-0199">
                </div>
                <div class="input-group">
                    <label>Vaccine Credential Patient Assertion</label>
                    <select id="vaccineCredentialAssertion">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Vaccine Card Available</label>
                    <select id="vaccineCardAvailable">
                        <option value="Y">Yes</option>
                        <option value="N" selected>No</option>
                        <option value="UNK">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Quarantine Status</label>
                    <select id="quarantineStatus">
                        <option value="182856006">In quarantine</option>
                        <option value="182857002">Released from quarantine</option>
                        <option value="405178008" selected>Not in quarantine</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Isolation Status</label>
                    <select id="isolationStatus">
                        <option value="40174006">In isolation</option>
                        <option value="182840001">Released from isolation</option>
                        <option value="385432009" selected>Not in isolation</option>
                        <option value="261665006">Unknown</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-file-alt"></i> Related Document Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Document ID</label>
                    <input type="text" id="documentId" value="10c13861-86a8-4a9a-aec6-b615921178df">
                </div>
                <div class="input-group">
                    <label>Effective Time</label>
                    <input type="text" id="effectiveTime" value="20240615150000-0500">
                </div>
                <div class="input-group">
                    <label>Document Relationship Type <span class="help-tooltip" title="Defines how this document relates to other documents. Use 'New Document' for standalone documents, or 'Replace/Update Document' to supersede or modify an existing document.">ℹ️</span></label>
                    <select id="documentRelationshipType" onchange="handleRelationshipTypeChange()">
                        <option value="NEW" selected>New Document</option>
                        <option value="RPLC">Replace/Update Document</option>
                    </select>
                </div>
                <div class="input-group" id="relatedDocIdGroup" style="display: none;">
                    <label>Related Document Set ID <span style="color: red;">*</span> <span class="help-tooltip" title="The Set ID of the original document you are replacing/updating. This will become the Set ID for this new version. Required when relationship type is not 'New Document'.">ℹ️</span></label>
                    <input type="text" id="relatedDocumentId" placeholder="Enter the Set ID of the original document" onchange="handleRelatedDocumentIdChange()">
                </div>
                <div class="input-group" id="setIdGroup">
                    <label>Set ID <span class="help-tooltip" title="Unique identifier that stays the same across all versions of the same logical document. Documents with the same Set ID represent different versions of the same document.">ℹ️</span></label>
                    <input type="text" id="setId" value="8d86218e-0fea-11eb-8216-a80388425cfb">
                </div>
                <div class="input-group">
                    <label>Version Number <span class="help-tooltip" title="Sequential number that increments with each new version of the document. Same Set ID + higher version number = newer version.">ℹ️</span></label>
                    <input type="text" id="versionNumber" value="3">
                </div>
                <div class="help-text">
                    <h4>Document Relationship Guide:</h4>
                    <ul>
                        <li><strong>New Document:</strong> Creates a standalone document with a unique Set ID and version 1</li>
                        <li><strong>Replace/Update Document:</strong> Creates a new version of an existing document by entering the original document's Set ID and incrementing the version number</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Local XSLT files (no CORS issues)
        const EICR_XSL_URL = './CDAR2_eCR_eICR-2.xsl';
        const RR_XSL_URL   = './CDAR2_eCR_RR.xsl';

        // Global variable to store lab observation data
        let labObsData = [];
        let labObsLoaded = false;

        // Global variable to store diagnosis data
        let diagnosisData = [];
        let diagnosisLoaded = false;

        // Global variables for new lab order, organism, and test data
        let labOrderData = [];
        let labOrderLoaded = false;
        let organismData = [];
        let organismLoaded = false;
        let testData = [];
        let testLoaded = false;

        // Load lab observations from RCTC Excel file
        async function loadLabObsFromRCTC() {
            try {
                const response = await fetch('./assets/xslt/RCTC_Release (2025-03-18).xlsx');
                if (!response.ok) {
                    throw new Error(`Failed to load RCTC Excel file: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                const allLabObs = [];
                
                // Look for "Lab Obs Test Name S4" sheet
                const targetSheetName = workbook.SheetNames.find(name => 
                    name.toLowerCase().includes('lab obs test name s4') || 
                    name.toLowerCase().includes('lab_obs_test_name_s4')
                );
                
                if (targetSheetName) {
                    const worksheet = workbook.Sheets[targetSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Skip empty sheets
                    if (jsonData.length > 1) {
                        // Debug: log the first few rows to see the actual structure
                        console.log('Sheet name:', targetSheetName);
                        console.log('First 3 data rows:', jsonData.slice(0, 4));
                        
                        // Process data rows - let's try different column combinations
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length > 2) {
                                // Try to find which column has the actual test names (longest text usually)
                                let codeCol = row[1] || '';
                                let nameCol = row[2] || '';
                                
                                // If Column C is just "LOINC", try a different column for the name
                                if (nameCol === 'LOINC' && row[3]) {
                                    nameCol = row[3]; // Try Column D
                                } else if (nameCol === 'LOINC' && row[4]) {
                                    nameCol = row[4]; // Try Column E
                                }
                                
                                allLabObs.push({
                                    code: codeCol,
                                    name: nameCol,
                                    description: row[0] || ''
                                });
                            }
                        }
                    }
                }
                
                labObsData = allLabObs;
                labObsLoaded = true;
                
                console.log(`Loaded ${labObsData.length} lab observations from RCTC file`);
                console.log('Sample data:', labObsData.slice(0, 3));
                return labObsData;
                
            } catch (error) {
                console.warn('Failed to load lab observations from RCTC file:', error);
                // Fallback to hardcoded values if RCTC file can't be loaded
                labObsData = getHardcodedLabObs();
                labObsLoaded = true;
                return labObsData;
            }
        }

        function getRouteTranslation(routeCode) {
    const routeMap = {
        'PO': { fdaCode: 'C38288', snomedCode: '26643006', display: 'Oral route' },
        'IV': { fdaCode: 'C28161', snomedCode: '47625008', display: 'Intravenous route' },
        'IM': { fdaCode: 'C28161', snomedCode: '78421000', display: 'Intramuscular route' },
        'SC': { fdaCode: 'C38299', snomedCode: '34206005', display: 'Subcutaneous route' },
        'SL': { fdaCode: 'C38238', snomedCode: '37161004', display: 'Sublingual route' },
        'TOP': { fdaCode: 'C38675', snomedCode: '6064005', display: 'Topical route' },
        'INH': { fdaCode: 'C38284', snomedCode: '26643006', display: 'Inhalation route' }
    };
    return routeMap[routeCode] || routeMap['PO'];
}

function fixDoseUnit(unit) {
    if (unit === '1' || unit === 'each' || unit === 'tablet') return 'mg';
    if (unit === 'mcg') return 'ug';
    return unit;
}

        // Fallback hardcoded lab observations
        function getHardcodedLabObs() {
            return [
                { code: "94310-0", name: "SARS-like Coronavirus N gene [Presence] in Unspecified specimen by NAA with probe detection", description: "LOINC" },
                { code: "34487-9", name: "Influenza virus A RNA [Presence] in Respiratory specimen by NAA with probe detection", description: "LOINC" },
                { code: "19080-1", name: "Choriogonadotropin.beta subunit [Units/volume] in Serum or Plasma", description: "LOINC" }
            ];
        }

        // Simple unit fixer - converts "1" to "{tbl}" for tablets
function getValidDoseUnit(unit) {
    if (unit === '1' || unit === 'each' || unit === 'tablet') return '{tbl}';
    if (unit === 'mcg') return 'ug';
    return unit; // keep everything else the same
}

// Simple route fixer for immunizations
function getImmunizationRouteTranslation(routeCode) {
    if (routeCode === 'IM') return { code: 'C28161', display: 'Intramuscular route', snomed: '78421000' };
    if (routeCode === 'SC') return { code: 'C38299', display: 'Subcutaneous route', snomed: '34206005' };
    if (routeCode === 'PO') return { code: 'C38288', display: 'Oral route', snomed: '26643006' };
    // default to IM if unknown
    return { code: 'C28161', display: 'Intramuscular route', snomed: '78421000' };
}
        // Load diagnosis data from RCTC Excel file
       // STRICT loader: uses ONLY "diagnosis_problem s1" (B=code, C=name)
async function loadDiagnosisFromRCTC() {
  try {
    const res = await fetch('./assets/xslt/RCTC_Release (2025-03-18).xlsx');
    if (!res.ok) throw new Error(`Failed to load RCTC Excel file: ${res.status}`);

    const ab = await res.arrayBuffer();
    const wb = XLSX.read(ab, { type: 'array' });

    const SHEET_NAME = 'Diagnosis_Problem S1';
    const ws = wb.Sheets[SHEET_NAME];
    if (!ws) throw new Error(`Sheet "${SHEET_NAME}" not found in RCTC release.`);

    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

    // normalize helper: trims & removes NBSPs
    const norm = v => String(v ?? '').replace(/\u00A0/g, ' ').trim();

    const allDiagnosis = [];
    // Row 0 = header; start from 1. B (idx 1) = code, C (idx 2) = name. A (idx 0) optional description.
    for (let i = 1; i < rows.length; i++) {
      const r = rows[i];
      if (!r || r.length < 3) continue;
      const code = norm(r[1]);
      const name = norm(r[2]);
      const description = norm(r[0]);
      if (code && name) allDiagnosis.push({ code, name, description });
    }

    diagnosisData = allDiagnosis;
    diagnosisLoaded = true;
    console.log(`Loaded ${diagnosisData.length} diagnoses from "${SHEET_NAME}"`);
    return diagnosisData;
  } catch (error) {
    console.warn('Failed to load diagnoses from RCTC file:', error);
    diagnosisData = getHardcodedDiagnosis(); // keep your existing fallback
    diagnosisLoaded = true;
    return diagnosisData;
  }
}

// Save/Load Form Data Functions
function loadFormDataDialog() {
    const input = document.getElementById('loadFormDataInput') || createHiddenFileInput();
    input.click();
}

function createHiddenFileInput() {
    const input = document.createElement('input');
    input.type = 'file';
    input.id = 'loadFormDataInput';
    input.accept = '.json';
    input.style.display = 'none';
    input.onchange = loadFormData;
    document.body.appendChild(input);
    return input;
}

function loadFormData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            setFormData(data);
            
            // Handle lab evidence if present
            if (data.labEvidence && Array.isArray(data.labEvidence)) {
                const labList = document.getElementById('labEvidenceList');
                if (labList) {
                    labList.innerHTML = '';
                    data.labEvidence.forEach(labEntry => {
                        addLabEvidence(labEntry);
                    });
                }
            }

            // Handle diagnosis evidence if present
            if (data.diagnosisEvidence && Array.isArray(data.diagnosisEvidence)) {
                const diagnosisList = document.getElementById('diagnosisEvidenceList');
                if (diagnosisList) {
                    diagnosisList.innerHTML = '';
                    data.diagnosisEvidence.forEach(diagnosisEntry => {
                        addDiagnosisEvidence(diagnosisEntry);
                    });
                }
            }

            // Handle problem evidence if present
            if (data.problemEvidence && Array.isArray(data.problemEvidence)) {
                const problemList = document.getElementById('problemEvidenceList');
                if (problemList) {
                    problemList.innerHTML = '';
                    data.problemEvidence.forEach(problemEntry => {
                        addProblemEvidence(problemEntry);
                    });
                }
            }

            alert('Form data loaded successfully!');
        } catch (error) {
            alert('Error loading file: ' + error.message);
            console.error('Load error:', error);
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

// Note: saveFormData() function should already exist in your code
// If it doesn't exist, add this:
function saveFormData() {
    const data = getFormData();
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    
    const patientName = data.patientName ? 
        data.patientName.replace(/[^a-zA-Z0-9]/g, '_') : 'Patient';
    const timestamp = new Date().toISOString().split('T')[0];
    const filename = `eICR_${patientName}_${timestamp}.json`;
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

        // Fallback hardcoded diagnosis data
        function getHardcodedDiagnosis() {
            return [
                { code: "67531005", name: "Down syndrome (disorder)", description: "SNOMEDCT" },
                { code: "414819007", name: "Disease caused by Bordetella pertussis (disorder)", description: "SNOMEDCT" },
                { code: "86299006", name: "Gonorrhea (disorder)", description: "SNOMEDCT" }
            ];
        }

        // Load lab order data from RCTC Excel file - Lab Order Test Name S3 tab
        async function loadLabOrderFromRCTC() {
            try {
                const response = await fetch('./assets/xslt/RCTC_Release (2025-03-18).xlsx');
                if (!response.ok) {
                    throw new Error(`Failed to load RCTC Excel file: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                const allLabOrders = [];
                
                // Look for "Lab Order Test Name S3" sheet
                const targetSheetName = workbook.SheetNames.find(name => 
                    name.toLowerCase().includes('lab order test name s3') || 
                    name.toLowerCase().includes('lab_order_test_name_s3') ||
                    name.toLowerCase().includes('lab order test name s3')
                );
                
                if (targetSheetName) {
                    const worksheet = workbook.Sheets[targetSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    console.log('Lab Order sheet name:', targetSheetName);
                    console.log('First 3 lab order rows:', jsonData.slice(0, 4));
                    
                    if (jsonData.length > 1) {
                        // Process data rows - Column B for code, Column C for name
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length > 2 && row[1] && row[2]) {
                                allLabOrders.push({
                                    code: row[1] || '', // Column B for code
                                    name: row[2] || '', // Column C for name
                                    description: row[0] || '' // Column A for description (if available)
                                });
                            }
                        }
                    }
                }
                
                labOrderData = allLabOrders;
                labOrderLoaded = true;
                
                console.log(`Loaded ${labOrderData.length} lab orders from RCTC file`);
                return labOrderData;
                
            } catch (error) {
                console.warn('Failed to load lab orders from RCTC file:', error);
                labOrderData = getHardcodedLabOrders();
                labOrderLoaded = true;
                return labOrderData;
            }
        }

function getProviderTaxonomyCode(providerType = 'physician') {
    const taxonomyCodes = {
        'physician': { code: '207Q00000X', display: 'Family Medicine Physician' },
        'nurse': { code: '163W00000X', display: 'Registered Nurse' },
        'pa': { code: '363A00000X', display: 'Physician Assistant' },
        'np': { code: '363L00000X', display: 'Nurse Practitioner' }
    };
    return taxonomyCodes[providerType] || taxonomyCodes['physician'];
}

        // Fallback hardcoded lab orders
        function getHardcodedLabOrders() {
            return [
                { code: "94310-0", name: "SARS-like Coronavirus N gene [Presence] in Unspecified specimen by NAA with probe detection", description: "LOINC" },
                { code: "34487-9", name: "Influenza virus A RNA [Presence] in Respiratory specimen by NAA with probe detection", description: "LOINC" },
                { code: "19080-1", name: "Choriogonadotropin.beta subunit [Units/volume] in Serum or Plasma", description: "LOINC" }
            ];
        }

        // Load organism data from RCTC Excel file - Organism_Substance S2 tab
        async function loadOrganismFromRCTC() {
          try {
            const url = './assets/xslt/RCTC_Release (2025-03-18).xlsx';
            const resp = await fetch(url);
            if (!resp.ok) throw new Error(`Fetch failed (${resp.status}) for ${url}`);

            const arrayBuffer = await resp.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });

            // Normalize names to avoid subtle spacing/underscore/case mismatches
            const normalize = s => String(s || '')
              .toLowerCase()
              .replace(/[\s_]+/g, '');

            // Prefer exact normalized match first, then relaxed "includes"
            const wanted = 'organismsubstances2';
            let targetSheetName =
              workbook.SheetNames.find(n => normalize(n) === wanted) ||
              workbook.SheetNames.find(n => normalize(n).includes(wanted));

            if (!targetSheetName) {
              throw new Error('Sheet "Organism_Substance S2" not found in workbook');
            }

            const ws = workbook.Sheets[targetSheetName];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });

            // Expect header row at index 0, then data; B=code (idx 1), C=name (idx 2)
            const out = [];
            for (let i = 1; i < rows.length; i++) {
              const r = rows[i] || [];
              const code = String(r[1] || '').trim();
              const name = String(r[2] || '').trim();
              if (!code || !name) continue;
              out.push({
                code,
                name,
                description: String(r[0] || '').trim() // A if present
              });
            }

            if (!out.length) {
              throw new Error(`Sheet "${targetSheetName}" parsed but 0 usable rows (check B/C columns).`);
            }

            organismData = out;
            organismLoaded = true;
            console.log(`Loaded ${organismData.length} organisms from "${targetSheetName}"`);
            return organismData;
          } catch (err) {
            organismData = getHardcodedOrganisms(); // your existing tiny fallback
            organismLoaded = true;

            // Surface the real reason to the user so it's obvious when the fallback is in play
            alert(`Could not load Organism_Substance S2 from RCTC file.\nReason: ${err.message}\nUsing a small fallback list.`);
            console.warn('Organism load error:', err);
            return organismData;
          }
        }

        // Load test data from RCTC Excel file - LAB_OBS Test Name S4 tab
        async function loadTestsFromRCTC() {
          try {
            const url = './assets/xslt/RCTC_Release (2025-03-18).xlsx';
            const resp = await fetch(url);
            if (!resp.ok) throw new Error(`Fetch failed (${resp.status}) for ${url}`);

            const arrayBuffer = await resp.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });

            // Normalize names to handle spaces/underscores/case
            const normalize = s => String(s || '')
              .toLowerCase()
              .replace(/[\s_]+/g, '');

            // Target "LAB_OBS Test Name S4" and common variants
            const wanted = 'labobstestnames4';
            let targetSheetName =
              workbook.SheetNames.find(n => normalize(n) === wanted) ||
              workbook.SheetNames.find(n => normalize(n).includes(wanted));

            if (!targetSheetName) {
              throw new Error('Sheet "LAB_OBS Test Name S4" not found in workbook');
            }

            const ws = workbook.Sheets[targetSheetName];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });

            // Expect header at row 0; B=code(idx1), C=name(idx2)
            const out = [];
            for (let i = 1; i < rows.length; i++) {
              const r = rows[i] || [];
              const code = String(r[1] || '').trim();   // Column B
              const name = String(r[2] || '').trim();   // Column C
              if (!code || !name) continue;
              out.push({
                code,                      // LOINC code
                name,                      // Test name
                description: String(r[0] || '').trim() // Optional: Column A if present
              });
            }

            if (!out.length) {
              throw new Error(`Sheet "${targetSheetName}" parsed but 0 usable rows (check B/C columns).`);
            }

            testData = out;
            testLoaded = true;
            console.log(`Loaded ${testData.length} tests from "${targetSheetName}"`);
            return testData;
          } catch (err) {
            testData = [];
            testLoaded = true;
            alert(`Could not load "LAB_OBS Test Name S4". Reason: ${err.message}`);
            console.warn('Test load error:', err);
            return testData;
          }
        }

        // Fallback hardcoded organisms
        function getHardcodedOrganisms() {
            return [
                { code: "840539006", name: "Disease caused by 2019-nCoV", description: "SNOMEDCT" },
                { code: "409822003", name: "Domain Bacteria", description: "SNOMEDCT" },
                { code: "84676004", name: "Severe acute respiratory syndrome coronavirus", description: "SNOMEDCT" }
            ];
        }

        // Search RCTC codes function
       // Tailored search: for any *diagnosis* field, search ONLY diagnosis_problem s1 data.
// Clicking a result fills BOTH Code & Name from the same row.
async function searchRCTCCodes(fieldId) {
  const el = document.getElementById(fieldId);
  if (!el) return;

  // Decide dataset
  let data;
  if (fieldId.toLowerCase().includes('diagnosis')) {
    if (!diagnosisLoaded) await loadDiagnosisFromRCTC();
    data = diagnosisData || [];
  } else {
    if (!labObsLoaded) await loadLabObsFromRCTC(); // keep your existing lab behavior
    data = labObsData || [];
  }

  // results container
  const resultsDiv = document.getElementById(fieldId + '_results');
  if (!resultsDiv) return;
  resultsDiv.innerHTML = '';
  resultsDiv.style.display = 'none';

  const q = String(el.value ?? '').replace(/\u00A0/g, ' ').trim().toLowerCase();
  if (!q || data.length === 0) return;

  const asCode = r => String(r.code ?? '').toLowerCase();
  const asName = r => String((r.name ?? r.description ?? '')).toLowerCase();

  const searchingName = /Name$/i.test(fieldId);
  const digitsOnly = /^[0-9]+$/.test(q);

  let matches = [];
  if (!searchingName && digitsOnly) {
    // Code box, numeric: try exact match first
    const exact = data.filter(r => asCode(r) === q);
    const fuzzy = data.filter(r => asCode(r).includes(q) || asName(r).includes(q));
    const seen = new Set();
    matches = [...exact, ...fuzzy].filter(r => {
      const k = r.code + '|' + r.name;
      if (seen.has(k)) return false;
      seen.add(k);
      return true;
    });
  } else {
    // General contains; prioritize the field’s primary dimension
    const primary   = data.filter(r => (searchingName ? asName(r) : asCode(r)).includes(q));
    const secondary = data.filter(r => (searchingName ? asCode(r) : asName(r)).includes(q));
    const seen = new Set();
    matches = [...primary, ...secondary].filter(r => {
      const k = r.code + '|' + r.name;
      if (seen.has(k)) return false;
      seen.add(k);
      return true;
    });
  }

  if (matches.length === 0) {
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="no-results">No matching codes found</div>';
    return;
  }

  const list = document.createElement('div');
  list.className = 'search-results-list';

  matches.slice(0, 10).forEach(row => {
    const item = document.createElement('div');
    item.className = 'search-result-item';

    // Show code + name; keep your light description if present
    item.innerHTML = searchingName
      ? `<strong>${row.name}</strong><br><small>Code: ${row.code}</small>${row.description ? `<br><small>${row.description}</small>` : ''}`
      : `<strong>${row.code}</strong>: ${row.name}${row.description ? `<br><small>${row.description}</small>` : ''}`;

    item.onclick = () => {
      if (searchingName) {
        // Fill Name + its paired Code
        el.value = row.name;
        const codeField = document.getElementById(fieldId.replace('Name', 'Code'));
        if (codeField) {
          codeField.value = row.code;
          // keep your trigger validation semantics on the code field
          if (typeof validateTriggerCode === 'function') validateTriggerCode(codeField.id);
        }
      } else {
        // Fill Code + its paired Name
        el.value = row.code;
        const nameField = document.getElementById(fieldId.replace('Code', 'Name'));
        if (nameField) nameField.value = row.name;
        if (typeof validateTriggerCode === 'function') validateTriggerCode(el.id);
      }
      resultsDiv.style.display = 'none';
    };

    list.appendChild(item);
  });

  resultsDiv.appendChild(list);
  resultsDiv.style.display = 'block';
}


        // Fetch local XSLT files (no CORS issues)
        async function fetchXslt(url) {
          try {
            const res = await fetch(url);
            if (!res.ok) {
              throw new Error(`Failed to load local XSLT file: ${url} (Status: ${res.status})`);
            }
            return res.text();
          } catch (error) {
            console.error(`Failed to fetch XSLT file ${url}:`, error);
            throw new Error(`Cannot load XSLT file: ${url}. Make sure the file exists in your project directory.`);
          }
        }

        // Add this function to debug XSLT content
        async function debugXsltFiles() {
          try {
            console.log('=== DEBUGGING XSLT FILES ===');
            
            const eicrXsl = await fetchXslt(EICR_XSL_URL);
            const rrXsl = await fetchXslt(RR_XSL_URL);
            
            console.log('eICR XSLT length:', eicrXsl.length, 'characters');
            console.log('eICR XSLT starts with:', eicrXsl.substring(0, 200));
            console.log('eICR XSLT contains stylesheet?', eicrXsl.includes('xsl:stylesheet'));
            
            console.log('RR XSLT length:', rrXsl.length, 'characters');
            console.log('RR XSLT starts with:', rrXsl.substring(0, 200));
            console.log('RR XSLT contains stylesheet?', rrXsl.includes('xsl:stylesheet'));
            
            // Check if files look like proper XSLT
            if (!eicrXsl.includes('<?xml') || !eicrXsl.includes('xsl:stylesheet')) {
              console.error('eICR XSLT appears to be invalid or corrupted');
            }
            if (!rrXsl.includes('<?xml') || !rrXsl.includes('xsl:stylesheet')) {
              console.error('RR XSLT appears to be invalid or corrupted');
            }
            
          } catch (error) {
            console.error('Failed to debug XSLT files:', error);
          }
        }

        // Debug XML structure
        function debugXmlStructure(xmlString, docType) {
          console.log(`=== DEBUGGING ${docType} XML ===`);
          console.log('XML length:', xmlString.length);
          console.log('First 500 characters:', xmlString.substring(0, 500));
          
          // Check for key elements the XSLT might be looking for
          const parser = new DOMParser();
          const doc = parser.parseFromString(xmlString, 'application/xml');
          
          console.log('Root element:', doc.documentElement?.tagName);
          console.log('Namespace URI:', doc.documentElement?.namespaceURI);
          
          // Look for common CDA elements
          const commonElements = ['ClinicalDocument', 'component', 'structuredBody', 'section'];
          commonElements.forEach(element => {
            const found = doc.getElementsByTagName(element).length;
            console.log(`${element} elements found:`, found);
          });
        }

        // Add this function to scan for invalid XML comments
        function validateXMLComments(xmlString, docType) {
          console.log(`Validating ${docType} XML comments...`);
          
          // Find all comments using a simple approach
          const comments = [];
          let startIndex = 0;
          while (true) {
            const start = xmlString.indexOf('<!--', startIndex);
            if (start === -1) break;
            const end = xmlString.indexOf('-->', start + 4);
            if (end === -1) break;
            comments.push(xmlString.substring(start, end + 3));
            startIndex = end + 3;
          }
          
          comments.forEach((comment, index) => {
            // Check for double hyphens in the middle of comments
            const innerContent = comment.slice(4, -3); // Remove <!-- and -->
            if (innerContent.includes('--')) {
              console.error(`Invalid comment #${index + 1} in ${docType}:`, comment);
              console.error('Contains double hyphens which violate XML specification');
            }
          });
          
          console.log(`Found ${comments.length} comments total in ${docType}`);
          return comments.length;
        }

        // Enhanced XML → HTML transformation with better error handling
        function xmlToHtml(xmlString, xsltString) {
          try {
            console.log('Starting XML transformation...');
            console.log('XML length:', xmlString.length);
            console.log('XSLT length:', xsltString.length);
            
            const parser = new DOMParser();
            
            // Parse XML
            const xml = parser.parseFromString(xmlString, 'application/xml');
            const xmlParseErrors = xml.getElementsByTagName('parsererror');
            if (xmlParseErrors.length > 0) {
              console.error('XML parsing error:', xmlParseErrors[0].textContent);
              console.log('Full XML content length:', xmlString.length);
              console.log('XML starts with:', xmlString.substring(0, 200));
              console.log('XML around error area:', xmlString.substring(1680, 1700)); // Adjust numbers based on error line
              throw new Error('Invalid XML document');
            }
            
            // Parse XSLT
            const xsl = parser.parseFromString(xsltString, 'application/xml');
            const xslParseErrors = xsl.getElementsByTagName('parsererror');
            if (xslParseErrors.length > 0) {
              console.error('XSLT parsing error:', xslParseErrors[0].textContent);
              throw new Error('Invalid XSLT stylesheet');
            }
            
            // Create and configure processor
            const processor = new XSLTProcessor();
            processor.importStylesheet(xsl);
            
            // Transform
            const resultDocument = processor.transformToDocument(xml);
            
            // Check if transformation produced anything
            if (!resultDocument || !resultDocument.documentElement) {
              console.error('XSLT transformation produced no output');
              throw new Error('XSLT transformation failed - no output generated');
            }
            
            // Serialize result
            const serializer = new XMLSerializer();
            const htmlString = '<!DOCTYPE html>\n' + serializer.serializeToString(resultDocument);
            
            console.log('Transformation successful. Output length:', htmlString.length);
            console.log('Output starts with:', htmlString.substring(0, 200));
            
            return htmlString;
            
          } catch (error) {
            console.error('XML to HTML transformation failed:', error);
            throw new Error(`XSLT transformation error: ${error.message}`);
          }
        }

        // If your app already has these, keep them; otherwise adapt.
        function generateEICRXml() { return buildEICRXml(); }

        function getEffectiveSetId(data) {
            // For Replace/Update documents, use the relatedDocumentId as the setId
            // For New documents, use the setId field
            if (data.documentRelationshipType === 'RPLC') {
                return data.relatedDocumentId || data.setId;
            }
            return data.setId;
        }

        function generateRelatedDocumentXml(data) {
            // Only generate relatedDocument element if not a new document
            if (!data.documentRelationshipType || data.documentRelationshipType === 'NEW') {
                return '';
            }

            const relatedSetId = data.relatedDocumentId || '';
            const typeCode = data.documentRelationshipType || 'RPLC';

            return `
  <!-- Related Document Information -->
  <relatedDocument typeCode="${typeCode}">
    <parentDocument>
      <setId extension="${relatedSetId}" root="1.2.840.114350.1.13.380.3.7.1.1" />
      <code code="55751-2" codeSystem="2.16.840.1.113883.6.1" 
            codeSystemName="LOINC" displayName="Public Health Case Report" />
    </parentDocument>
  </relatedDocument>`;
        }
        function generateRRXml()   { return buildRRXml();   }

        // Global RCTC data storage
        let rctcData = {
            diagnosis: [],
            labOrder: [],
            labObs: [],
            medications: [],
            organism: [],
            metadata: {
                oid: '2.16.840.1.113762.1.4.1146.2260', // RCTC Birth Defect Trigger Codes OID
                version: '2.0.1',
                effectiveDate: '2025-06-01',
                releaseDate: '2025-03-18'
            }
        };

        // Condition-specific value set mapping function
        function getConditionSpecificValueSet(code, codeSystem = '2.16.840.1.113883.6.96') {
            const valueSetMap = {
                // COVID-19 Trigger Codes
                '840539006': { // Disease caused by 2019-nCoV
                    oid: '2.16.840.1.114222.4.11.7508',
                    version: '1.2.0.0',
                    name: 'COVID-19 (Diagnosis, Symptom, Condition, or Healthcare Encounter)'
                },
                '840544004': { // Suspected disease caused by 2019-nCoV
                    oid: '2.16.840.1.114222.4.11.7508',
                    version: '1.2.0.0',
                    name: 'COVID-19 (Diagnosis, Symptom, Condition, or Healthcare Encounter)'
                },
                '94500-6': { // SARS-CoV-2 RNA [Presence] in Respiratory specimen by NAA with probe detection
                    oid: '2.16.840.1.114222.4.11.7508',
                    version: '1.2.0.0',
                    name: 'COVID-19 (Laboratory Test)'
                },
                '94310-0': { // SARS-like Coronavirus N gene [Presence] in Unspecified specimen by NAA with probe detection
                    oid: '2.16.840.1.114222.4.11.7508',
                    version: '1.2.0.0',
                    name: 'COVID-19 (Laboratory Test)'
                },
                
                // Influenza Trigger Codes
                '719865001': { // Influenza A virus infection
                    oid: '2.16.840.1.114222.4.11.1009',
                    version: '2.0.0',
                    name: 'Influenza (Diagnosis, Symptom, Condition, or Healthcare Encounter)'
                },
                '34487-9': { // Influenza virus A RNA [Presence] in Respiratory specimen by NAA with probe detection
                    oid: '2.16.840.1.114222.4.11.1009',
                    version: '2.0.0',
                    name: 'Influenza (Laboratory Test)'
                },
                
                // Birth Defects (current focus)
                '67531005': { // Spina bifida
                    oid: '2.16.840.1.113762.1.4.1146.2260',
                    version: '2.0.1',
                    name: 'Birth Defects Trigger Codes'
                },
                '86299006': { // Tetralogy of Fallot
                    oid: '2.16.840.1.113762.1.4.1146.2260',
                    version: '2.0.1',
                    name: 'Birth Defects Trigger Codes'
                },
                '414819007': { // Neonatal abstinence syndrome
                    oid: '2.16.840.1.113762.1.4.1146.2260',
                    version: '2.0.1',
                    name: 'Birth Defects Trigger Codes'
                },
                
                // Default fallback
                'default': {
                    oid: '2.16.840.1.113762.1.4.1146.2260',
                    version: '2.0.1',
                    name: 'RCTC Master List'
                }
            };
            
            return valueSetMap[code] || valueSetMap['default'];
        }

        // Convert from CDA format (YYYYMMDDHHMMSS) to datetime-local format (YYYY-MM-DDTHH:MM)
        function cdaToDatetimeLocal(cdaDateTime) {
            if (!cdaDateTime || cdaDateTime.length < 8) return '';

            const year = cdaDateTime.substring(0, 4);
            const month = cdaDateTime.substring(4, 6);
            const day = cdaDateTime.substring(6, 8);
            const hour = cdaDateTime.substring(8, 10) || '00';
            const minute = cdaDateTime.substring(10, 12) || '00';

            return `${year}-${month}-${day}T${hour}:${minute}`;
        }

        // Convert from datetime-local format to CDA format
        function datetimeLocalToCda(datetimeLocal) {
            if (!datetimeLocal) return '';

            // Handle both with and without time
            const date = new Date(datetimeLocal);
            if (isNaN(date.getTime())) return '';

            const year = date.getFullYear().toString().padStart(4, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hour = date.getHours().toString().padStart(2, '0');
            const minute = date.getMinutes().toString().padStart(2, '0');
            const second = date.getSeconds().toString().padStart(2, '0');

            return `${year}${month}${day}${hour}${minute}${second}`;
        }

        function getFormData() {
            const fields = [
                // Patient Demographics
                'patientId', 'patientName', 'patientPhone', 'patientEmail', 'patientAddress',
                'patientCity', 'patientState', 'patientZip', 'patientCounty', 'patientCountry',
                'patientGender', 'patientBirthDate', 'patientRace', 'patientEthnicity',
                'patientBirthPlace', 'patientBirthSex', 'patientGenderIdentity', 'patientDetailedRace',
                'patientDetailedEthnicity', 'patientLanguage', 'patientDeathIndicator', 'patientDeathDate',
        'patientBirthPlaceCity', 'patientBirthPlaceState', 'patientBirthPlaceCountry', 'patientBirthPlaceFacility',
                
                // Guardian Information
                'guardianName', 'guardianPhone', 'guardianEmail', 'guardianAddress', 'guardianCity',
                'guardianState', 'guardianZip', 'guardianCode',
                
                // Provider Information
                'providerId', 'providerName', 'providerPhone', 'providerEmail', 'providerFax',
                'facilityId', 'facilityName', 'facilityAddress', 'facilityTypeCode',
                'organizationName', 'organizationId', 'organizationPhone', 'organizationEmail',
                'organizationFax', 'organizationAddress',
                
                // Encounter Information
                'encounterId', 'encounterType', 'encounterDate', 'encounterEndDate', 'encounterDisposition',
                'chiefComplaint', 'presentIllness', 'reasonForVisit', 'pastMedicalHistory', 'reviewOfSystems',
                
                // Diagnoses
                'diagnosis1Code', 'diagnosis1Name', 'diagnosis2Code', 'diagnosis2Name', 'diagnosis3Code', 'diagnosis3Name',
                'diagnosis1Date', 'diagnosis1OnsetDate', 'diagnosis2Date', 'diagnosis2OnsetDate',
                'diagnosis3Date', 'diagnosis3OnsetDate', 'problemType', 'symptoms',
                
                // Laboratory Tests
                'labTest1Code', 'labTest1Name', 'labTest1Result', 'labTest2Code', 'labTest2Name', 'labTest2Result',
                'labOrder1Code', 'labOrder1Id', 'labOrder1Time', 'labTest1Status', 'labTest1Time',
                'labTest1Interpretation', 'labTest1ReferenceRange', 'labTest2Status', 'labTest2Time',
                'labTest2Interpretation', 'labTest2ReferenceRange',
                'resultLabCLIA', 'resultLabName',
                'resultPerformerNPI', 'resultPerformerGiven', 'resultPerformerFamily',
                'resultOrderingNPI', 'resultOrderingGiven', 'resultOrderingFamily',
                
                // Medications
'adminMed1Code', 'adminMed1Name', 'adminMed1Id', 'adminMed1Status', 'adminMed1Time',
'adminMed1Route',
'adminMed1DoseValue', 'adminMed1DoseUnit', 'adminMed1VolValue', 'adminMed1VolUnit', 'adminMed1Negated',

'adminMed2Code', 'adminMed2Name', 'adminMed2Id', 'adminMed2Status', 'adminMed2Time',
'adminMed2Route',
'adminMed2DoseValue', 'adminMed2DoseUnit', 'adminMed2VolValue', 'adminMed2VolUnit', 'adminMed2Negated',

// Medications
'adminMed1Code', 'adminMed1Name', 'adminMed1Id', 'adminMed1Status', 'adminMed1Time',
'adminMed1Route',
'adminMed1DoseValue', 'adminMed1DoseUnit', 'adminMed1VolValue', 'adminMed1VolUnit', 'adminMed1Negated',

'adminMed2Code', 'adminMed2Name', 'adminMed2Id', 'adminMed2Status', 'adminMed2Time',
'adminMed2Route',
'adminMed2DoseValue', 'adminMed2DoseUnit', 'adminMed2VolValue', 'adminMed2VolUnit', 'adminMed2Negated',

// Administering Provider (applies to ALL administered meds)
'administeringProviderNPI',
'administeringProviderGiven',
'administeringProviderMiddle',
'administeringProviderFamily',
'administeringProviderPhone',
'administeringProviderOrgName',
'administeringProviderOrgId',
'administeringProviderOrgIdRoot',

// Planned medication stays as-is
'plannedMed1Code', 'plannedMed1Name', 'plannedMed1Instructions',

                
                // Immunizations
                'immunization1Status', 'immunization1Id', 'immunization1Date', 'vaccine1Code', 'vaccine1Name',
                'vaccine1Dose', 'vaccine1Route', 'vaccine1Manufacturer', 'vaccine1Lot','immunization2Status', 'immunization2Id',
                'immunization2Date', 'vaccine2Code', 'vaccine2Name', 'vaccine2Dose', 'vaccine2Route', 'vaccine2Manufacturer', 'vaccine2Lot',                
                // Pregnancy Information
                'pregnancyStatus', 'pregnancyEffectiveTime', 'estimatedDeliveryDate', 'pregnancyDeterminationMethod',
                'gestationalAge', 'lastMenstrualPeriod', 'pregnancyOutcome', 'postpartumStatus',
                
                // Travel History
                'travelStartDate', 'travelEndDate', 'travelLocation', 'travelLocationCode', 'travelAddress',
                'purposeOfTravel', 'transportationType', 'transportationDetails',
                
                // Occupation Information
                'currentOccupation', 'usualOccupation', 'currentIndustry', 'usualIndustry', 'currentJobTitle',
                'currentEmployerName', 'currentEmployerPhone', 'currentEmployerAddress', 'occupationalExposure', 'employmentStatus',
                
                // Specimen Information
                'specimen1Source', 'specimen1Type', 'specimen1Id', 'collection1Date',
                'specimen2Source', 'specimen2Type', 'specimen2Id', 'collection2Date',
                
                // Additional Clinical Data
                'temperature', 'bloodPressure', 'heartRate', 'respiratoryRate', 'oxygenSaturation',
                'weight', 'height', 'bmi', 'therapeuticResponse', 'homelessStatus', 'congregateLiving', 'congregateLivingType',
                
                // Procedures
                'currentProc1Code', 'currentProc1Name', 'currentProc1Date', 'currentProc1Type',
                'currentProc2Code', 'currentProc2Name', 'currentProc2Date', 'currentProc2Type',
                'triggerProc1Code', 'triggerProc1Name', 'triggerProc1Date', 'triggerProc1Type',
                'plannedProc1Code', 'plannedProc1Name', 'plannedProc1Date', 'plannedProc1Type',
                
                // Results / Lab providers
'ordProvNPI','ordProvGiven','ordProvMiddle','ordProvFamily','ordProvPhone',
'ordProvOrgName','ordProvOrgId','ordProvOrgIdRoot','ordProvTime',

'resPerfNPI','resPerfGiven','resPerfMiddle','resPerfFamily','resPerfPhone',
'resPerfOrgName','resPerfOrgId','resPerfOrgIdRoot',

                // Special Populations and Demographics
                'disabilityStatus', 'disabilityType', 'tribalAffiliation', 'tribalEnrollment',
                'countryOfNationality', 'countryOfNationalityCode', 'countryOfResidence', 'countryOfResidenceCode',
                'immigrationStatus', 'preferredLanguage', 'interpreterNeeded', 'insuranceStatus',
                
                // Emergency and Public Health
                'emergencyOutbreakInfo', 'outbreakDetails', 'exposureContactInfo', 'exposureType',
                'exposureLocation', 'exposureDate', 'contactPersonName', 'contactPersonPhone',
                'vaccineCredentialAssertion', 'vaccineCardAvailable', 'quarantineStatus', 'isolationStatus',
                
                // Document Information
                'documentId', 'effectiveTime', 'documentRelationshipType', 'relatedDocumentId', 'setId', 'versionNumber'
            ];
            
            const data = {};
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    // Special handling for datetime fields
                    if (field === 'patientBirthDate' && element.type === 'datetime-local') {
                        data[field] = datetimeLocalToCda(element.value);
                    } else {
                        data[field] = element.value;
                    }
                }
            });
            
            // ADD THIS: Collect lab evidence
            data.labEvidence = collectLabEvidence();

            // ADD THIS: Collect diagnosis evidence
            data.diagnosisEvidence = collectDiagnosisEvidence();
            console.log('getFormData diagnosis evidence:', data.diagnosisEvidence); // DEBUG

            // ADD THIS: Collect problem evidence
            data.problemEvidence = collectProblemEvidence();
            console.log('Form data problem evidence:', data.problemEvidence); // DEBUG LINE

            return data;
        }

        function setFormData(data) {
            Object.keys(data).forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    // Special handling for datetime fields
                    if (field === 'patientBirthDate' && element.type === 'datetime-local') {
                        element.value = cdaToDatetimeLocal(data[field]);
                    } else {
                        element.value = data[field];
                    }
                }
            });
        }

        // Make this function globally available for the Clean UI system
        window.loadFormDataFromAssets = async function(filename) {
            try {
                console.log(`Attempting to load: ./assets/xslt/${filename}`);

                const response = await fetch(`./assets/xslt/${filename}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`Form template file not found: ${filename}`);
                    }
                    throw new Error(`Failed to load form data file: ${response.status} ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.warn('File may not be JSON format, attempting to parse anyway');
                }

                const data = await response.json();

                // Validate that it's a form data object
                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid form data format - expected JSON object');
                }

                setFormData(data);

                // Handle lab evidence if present
                if (data.labEvidence && Array.isArray(data.labEvidence)) {
                    const labList = document.getElementById('labEvidenceList');
                    if (labList) {
                        labList.innerHTML = '';
                        data.labEvidence.forEach(labEntry => {
                            addLabEvidence(labEntry);
                        });
                    }
                }

                // Handle diagnosis evidence if present
                if (data.diagnosisEvidence && Array.isArray(data.diagnosisEvidence)) {
                    const diagnosisList = document.getElementById('diagnosisEvidenceList');
                    if (diagnosisList) {
                        diagnosisList.innerHTML = '';
                        data.diagnosisEvidence.forEach(diagnosisEntry => {
                            addDiagnosisEvidence(diagnosisEntry);
                        });
                    }
                }

                // Handle problem evidence if present
                if (data.problemEvidence && Array.isArray(data.problemEvidence)) {
                    const problemList = document.getElementById('problemEvidenceList');
                    if (problemList) {
                        problemList.innerHTML = '';
                        data.problemEvidence.forEach(problemEntry => {
                            addProblemEvidence(problemEntry);
                        });
                    }
                }

                console.log(`Successfully loaded form template: ${filename}`);

                // Show success message with Clean UI styling
                showCleanUINotification(`✅ ${filename.replace('.json', '')} template loaded successfully!`, 'success');
                return true;
            } catch (error) {
                console.error('Error loading form data from assets:', error);
                showCleanUINotification(`❌ Error loading ${filename}: ${error.message}`, 'error');
                return false;
            }
        };

        // Optional: Add a notification system that matches your Clean UI
        window.showCleanUINotification = function(message, type = 'info') {
            // Remove any existing notifications
            const existing = document.querySelector('.ui81-notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = 'ui81-notification';
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: ${type === 'error' ? '#fee2e2' : '#f0fdf4'};
                border: 1px solid ${type === 'error' ? '#fecaca' : '#bbf7d0'};
                color: ${type === 'error' ? '#dc2626' : '#16a34a'};
                border-radius: 12px; padding: 16px 20px;
                box-shadow: var(--shadow-2); max-width: 400px;
                font-size: 14px; font-weight: 500;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    notification.style.transition = 'all 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 4000);
        };

        function loadRCTCFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = handleRCTCFile;
            input.click();
        }

        function handleRCTCFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            alert('RCTC file processing would require additional libraries in a real implementation. For now, the generator uses hardcoded RCTC OID and version information.');
            
            console.log('RCTC file selected:', file.name);
        }

        function handleRelationshipTypeChange() {
            const relationshipType = document.getElementById('documentRelationshipType').value;
            const relatedDocIdGroup = document.getElementById('relatedDocIdGroup');
            const relatedDocIdField = document.getElementById('relatedDocumentId');
            const setIdGroup = document.getElementById('setIdGroup');
            const setIdField = document.getElementById('setId');
            const versionNumberField = document.getElementById('versionNumber');

            if (relationshipType === 'NEW') {
                // Show Set ID field, hide Related Document Set ID field
                setIdGroup.style.display = 'block';
                relatedDocIdGroup.style.display = 'none';
                relatedDocIdField.required = false;
                relatedDocIdField.value = '';
                
                // Generate new setId for new document
                generateNewSetId();
                versionNumberField.value = '1';
            } else {
                // Hide Set ID field, show Related Document Set ID field
                setIdGroup.style.display = 'none';
                relatedDocIdGroup.style.display = 'block';
                relatedDocIdField.required = true;
                
                // For Replace/Update relationship, increment version
                if (relationshipType === 'RPLC') {
                    const currentVersion = parseInt(versionNumberField.value) || 1;
                    versionNumberField.value = currentVersion + 1;
                }
            }
        }

        function handleRelatedDocumentIdChange() {
            // This function can be simplified since we're no longer copying values between fields
            // The relatedDocumentId field serves as the Set ID when in Replace/Update mode
            console.log('Related Document Set ID updated');
        }

        function generateNewSetId() {
            // Generate a new UUID for setId
            const setIdField = document.getElementById('setId');
            setIdField.value = generateUUID();
        }

        function generateUUID() {
            // Simple UUID v4 generator
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function validateRelatedDocumentFields() {
            const relationshipType = document.getElementById('documentRelationshipType').value;
            const relatedDocIdField = document.getElementById('relatedDocumentId');

            if (relationshipType !== 'NEW' && !relatedDocIdField.value.trim()) {
                alert('Related Document ID is required when relationship type is not "New Document".');
                relatedDocIdField.focus();
                return false;
            }
            return true;
        }


        function isRCTCTriggerCode(code) {
            const triggerCodes = ['840539006', '719865001', '3928002', '94310-0', '34487-9', '168731009',
                                 '41040004', '72951007', '67531005', '86299006', '414819007'];
            return triggerCodes.includes(code);
        }

        function validateTriggerCode(fieldId) {
            const code = document.getElementById(fieldId).value;
            
            if (code && !isRCTCTriggerCode(code)) {
                console.log('Warning: Code', code, 'may not be a valid RCTC trigger code');
            }
        }

        function getRaceDisplayName(raceCode) {
            const raceCodes = {
                '1002-5': 'American Indian or Alaska Native',
                '2028-9': 'Asian',
                '2054-5': 'Black or African American',
                '2076-8': 'Native Hawaiian or Other Pacific Islander',
                '2106-3': 'White',
                '2131-1': 'Other Race',
                'UNK': 'Unknown',
                'ASKU': 'Asked but unknown'
            };
            return raceCodes[raceCode] || 'Race';
        }

        function getEthnicityDisplayName(ethnicityCode) {
            const ethnicityCodes = {
                '2135-2': 'Hispanic or Latino',
                '2186-5': 'Not Hispanic or Latino',
                'UNK': 'Unknown',
                'ASKU': 'Asked but unknown'
            };
            return ethnicityCodes[ethnicityCode] || 'Ethnicity';
        }

        function validateDateFormat(dateString, fieldName) {
            if (!dateString) return true; // Allow empty dates

            // Check if it's already in CDA format (YYYYMMDD or YYYYMMDDHHMMSS)
            const cdaDatePattern = /^\d{8}$/; // YYYYMMDD
            const cdaDateTimePattern = /^\d{14}$/; // YYYYMMDDHHMMSS

            if (cdaDatePattern.test(dateString) || cdaDateTimePattern.test(dateString)) {
                return true;
            }

            // Check if it's a valid datetime-local format that we can convert
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return true;
            }

            alert(`${fieldName} must be a valid date/time format`);
            return false;
        }

        function validateRequiredFields() {
            const requiredFields = [
                { id: 'patientId', name: 'Patient ID' },
                { id: 'patientName', name: 'Patient Name' },
                { id: 'patientBirthDate', name: 'Patient Birth Date' },
                { id: 'providerId', name: 'Provider ID' },
                { id: 'providerName', name: 'Provider Name' },
                { id: 'encounterId', name: 'Encounter ID' },
                { id: 'encounterDate', name: 'Encounter Date' },
                { id: 'documentId', name: 'Document ID' },
                { id: 'effectiveTime', name: 'Effective Time' }
            ];
            
            for (let field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    alert(`${field.name} is required`);
                    element?.focus();
                    return false;
                }
            }
            return true;
        }

        // DQ Schematron ValueSets
        const DQ_VALUESETS = {
            administrativeGender: {
                oid: '2.16.840.1.113883.5.1',
                values: ['F', 'M', 'UN']
            },
            raceCategory: {
                oid: '2.16.840.1.113883.6.238',
                values: ['1002-5', '2028-9', '2054-5', '2076-8', '2106-3', '2131-1']
            },
            ethnicity: {
                oid: '2.16.840.1.113883.6.238', 
                values: ['2135-2', '2186-5']
            },
            specimenType: {
                oid: '2.16.840.1.113883.21.327',
                values: ['258500001', '461911000124106', '258580003', '122555007', '309051001', '119295008', '119297000', '122552005', '168139001', '258467004', '441620008']
            },
            bodySite: {
                oid: '2.16.840.1.113883.3.88.12.3221.8.9',
                values: ['71341001', '123851003', '181216001', '258435002', '272673000', '362837007']
            }
        };

        // Non-blocking DQ validation errors (still display but don't prevent CDA generation)
        const NON_BLOCKING_DQ = new Set([
            'dq-patientName-002/004'
        ]);

        // DQ Validation Functions
        function validateDQPatientName() {
            const errors = [];
            const nameField = document.getElementById('patientName');
            
            if (!nameField || !nameField.value || nameField.value.trim() === '') {
                errors.push('dq-patientName-001: Patient name cannot be nullFlavor or empty');
            } else {
                const nameParts = nameField.value.trim().split(' ');
                if (nameParts.length < 2) {
                    errors.push('dq-patientName-002/004: Patient must have both family and given name');
                }
            }
            
            return errors;
        }

        function validateDQPatientAddress() {
            const errors = [];
            const addressField = document.getElementById('patientAddress');
            const cityField = document.getElementById('patientCity');
            const stateField = document.getElementById('patientState');
            const zipField = document.getElementById('patientZip');
            
            if (!addressField?.value?.trim()) {
                errors.push('dq-patientAddress-002/003/004: Street address line cannot be nullFlavor or blank');
            }
            if (!cityField?.value?.trim()) {
                errors.push('dq-patientAddress-005/006: City cannot be nullFlavor or blank');
            }
            if (!stateField?.value?.trim()) {
                errors.push('dq-patientAddress-007/008: State cannot be nullFlavor or blank');
            }
            if (!zipField?.value?.trim()) {
                errors.push('dq-patientAddress-009/010: Postal code cannot be nullFlavor or blank');
            }
            
            return errors;
        }

        function validateDQAdministrativeGender() {
            const errors = [];
            const genderField = document.getElementById('patientGender');
            
            if (!genderField?.value) {
                errors.push('dq-administrativeGenderCode-001: Administrative gender code cannot be nullFlavor');
            } else if (!DQ_VALUESETS.administrativeGender.values.includes(genderField.value)) {
                errors.push('dq-administrativeGenderCode-002: Administrative gender code must be M, F, or UN');
            }
            
            return errors;
        }

        function validateDQRaceCode() {
            const errors = [];
            const raceField = document.getElementById('patientRace');
            
            if (!raceField?.value) {
                errors.push('dq-raceCode-001: Race code cannot be nullFlavor');
            } else if (!DQ_VALUESETS.raceCategory.values.includes(raceField.value) && raceField.value !== 'UNK') {
                errors.push('dq-raceCode-002: Race code must be from Race Category Excluding Nulls ValueSet');
            }
            
            return errors;
        }

        function validateDQEthnicityCode() {
            const errors = [];
            const ethnicityField = document.getElementById('patientEthnicity');
            
            if (!ethnicityField?.value) {
                errors.push('dq-ethnicGroupCode-001: Ethnicity code cannot be nullFlavor');
            } else if (!DQ_VALUESETS.ethnicity.values.includes(ethnicityField.value) && ethnicityField.value !== 'UNK') {
                errors.push('dq-ethnicGroupCode-002: Ethnicity code must be from Ethnicity ValueSet');
            }
            
            return errors;
        }

        function validateDQDateFormats() {
            const errors = [];
            const dateFields = [
                { id: 'patientBirthDate', name: 'Patient Birth Date' },
                { id: 'encounterDate', name: 'Encounter Date' },
                { id: 'patientDeathDate', name: 'Patient Death Date' },
                { id: 'diagnosis1Date', name: 'Diagnosis 1 Date' },
                { id: 'diagnosis1OnsetDate', name: 'Diagnosis 1 Onset Date' },
                { id: 'labTest1Time', name: 'Lab Test 1 Time' },
                { id: 'immunization1Date', name: 'Immunization 1 Date' },
                { id: 'specimenCollectionDate', name: 'Specimen Collection Date' }
            ];

            dateFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element?.value) {
                    if (!validateDateFormat(element.value, field.name)) {
                        errors.push(`dq-dateFormat: ${field.name} must be at least 8 characters (YYYYMMDD)`);
                    }
                }
            });

            return errors;
        }

        function validateDQSpecimen() {
            const errors = [];
            
            // Check specimen 1
            const spec1Source = document.getElementById('specimen1Source');
            const spec1Type = document.getElementById('specimen1Type');  
            const spec1Id = document.getElementById('specimen1Id');
            const collect1Date = document.getElementById('collection1Date');
            
            if (spec1Source?.value && !DQ_VALUESETS.specimenType.values.includes(spec1Source.value)) {
                errors.push('dq-specimenType-002: Specimen 1 source must be from HL7 Specimen Type ValueSet');
            }
            
            if (collect1Date?.value && collect1Date.value.length < 8) {
                errors.push('dq-specimenCollectionDate-002: Specimen 1 collection date must be at least 8 characters');
            }
            
            if (spec1Id?.value && !spec1Id.value.trim()) {
                errors.push('dq-specimenId-001: Specimen 1 ID cannot be nullFlavor or empty');
            }
            
            // Check specimen 2
            const spec2Source = document.getElementById('specimen2Source');
            const spec2Type = document.getElementById('specimen2Type');
            const spec2Id = document.getElementById('specimen2Id');
            const collect2Date = document.getElementById('collection2Date');
            
            if (spec2Source?.value && !DQ_VALUESETS.specimenType.values.includes(spec2Source.value)) {
                errors.push('dq-specimenType-002: Specimen 2 source must be from HL7 Specimen Type ValueSet');
            }
            
            if (collect2Date?.value && collect2Date.value.length < 8) {
                errors.push('dq-specimenCollectionDate-002: Specimen 2 collection date must be at least 8 characters');
            }
            
            if (spec2Id?.value && !spec2Id.value.trim()) {
                errors.push('dq-specimenId-001: Specimen 2 ID cannot be nullFlavor or empty');
            }
            
            return errors;
        }

        function validateDQTriggerCodes() {
            const errors = [];
            const data = getFormData();

            let hasTriggerCode = false;

            // Check diagnosis evidence
            if (Array.isArray(data.diagnosisEvidence)) {
                hasTriggerCode = data.diagnosisEvidence.some(d =>
                    isRCTCTriggerCode(d.diagnosisCode) || d.isRCTC
                );
            }

            // Check lab evidence
            if (!hasTriggerCode && Array.isArray(data.labEvidence)) {
                hasTriggerCode = data.labEvidence.some(ev =>
                    ev.isRCTC ||
                    isRCTCTriggerCode(ev.testCode) ||
                    isRCTCTriggerCode(ev.valueCode)
                );
            }

            // Check remaining legacy fields (remove these checks once you've fully migrated)
            const legacyTriggerFields = [
                'labTest1Code', 'labTest2Code', 'labOrder1Code',
                'adminMed1Code', 'adminMed2Code', 'vaccine1Code', 'vaccine2Code'
            ];

            if (!hasTriggerCode) {
                legacyTriggerFields.forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element?.value?.trim()) {
                        hasTriggerCode = true;
                    }
                });
            }

            if (!hasTriggerCode) {
                errors.push('FATAL: At least one trigger code template must be present (eICR requirement)');
            }
            
            return errors;
        }

        function validateDQDeathIndicator() {
            const errors = [];
            const deathIndicator = document.getElementById('patientDeathIndicator');
            const deathDate = document.getElementById('patientDeathDate');
            
            if (deathIndicator?.value === 'true' && !deathDate?.value) {
                errors.push('dq-deceasedTime: Death date cannot be nullFlavor when death indicator is true');
            }
            
            return errors;
        }

        function validateDQLabObservations() {
            const errors = [];
            
            // Lab Test 1 validation
            const lab1Code = document.getElementById('labTest1Code');
            const lab1Status = document.getElementById('labTest1Status');
            const lab1Result = document.getElementById('labTest1Result');
            
            if (lab1Code?.value && (!lab1Code.value.trim() || lab1Code.value === 'nullFlavor')) {
                errors.push('dq-resultObservation-002: Lab test 1 code cannot be nullFlavor');
            }
            
            if (lab1Status?.value && (!lab1Status.value.trim() || lab1Status.value === 'nullFlavor')) {
                errors.push('dq_lab_result_statusCode_001: Lab test 1 status code cannot be nullFlavor');
            }
            
            if (lab1Result?.value && (!lab1Result.value.trim() || lab1Result.value === 'nullFlavor')) {
                errors.push('dq-resultObservation-001: Lab test 1 result value cannot be nullFlavor');
            }
            
            // Lab Test 2 validation
            const lab2Code = document.getElementById('labTest2Code');
            const lab2Status = document.getElementById('labTest2Status');
            const lab2Result = document.getElementById('labTest2Result');
            
            if (lab2Code?.value && (!lab2Code.value.trim() || lab2Code.value === 'nullFlavor')) {
                errors.push('dq-resultObservation-002: Lab test 2 code cannot be nullFlavor');
            }
            
            if (lab2Status?.value && (!lab2Status.value.trim() || lab2Status.value === 'nullFlavor')) {
                errors.push('dq_lab_result_statusCode_001: Lab test 2 status code cannot be nullFlavor');
            }
            
            if (lab2Result?.value && (!lab2Result.value.trim() || lab2Result.value === 'nullFlavor')) {
                errors.push('dq-resultObservation-001: Lab test 2 result value cannot be nullFlavor');
            }
            
            return errors;
        }

        function validateDQMedicationAdministration() {
            const errors = [];
            
            // Medication 1 validation  
            const med1Id = document.getElementById('adminMed1Id');
            const med1Code = document.getElementById('adminMed1Code');
            
            if (med1Id?.value && (!med1Id.value.trim() || med1Id.value === 'nullFlavor')) {
                errors.push('dq-medicationAdministration-id-001: Medication 1 ID cannot be nullFlavor');
            }
            
            if (med1Code?.value && (!med1Code.value.trim() || med1Code.value === 'nullFlavor')) {
                errors.push('dq_medicationsAdministered-001: Medication 1 code cannot be nullFlavor');
            }
            
            // Medication 2 validation
            const med2Id = document.getElementById('adminMed2Id');
            const med2Code = document.getElementById('adminMed2Code');
            
            if (med2Id?.value && (!med2Id.value.trim() || med2Id.value === 'nullFlavor')) {
                errors.push('dq-medicationAdministration-id-001: Medication 2 ID cannot be nullFlavor');
            }
            
            if (med2Code?.value && (!med2Code.value.trim() || med2Code.value === 'nullFlavor')) {
                errors.push('dq_medicationsAdministered-001: Medication 2 code cannot be nullFlavor');
            }
            
            return errors;
        }

        function validateDQImmunizations() {
            const errors = [];
            
            // Immunization 1 validation
            const imm1Id = document.getElementById('immunization1Id');
            const imm1Date = document.getElementById('immunization1Date');
            const vac1Code = document.getElementById('vaccine1Code');
            
            if (imm1Id?.value && (!imm1Id.value.trim() || imm1Id.value === 'nullFlavor')) {
                errors.push('dq-immunizationActivity-id-001: Immunization 1 ID cannot be nullFlavor');
            }
            
            if (imm1Date?.value && (!imm1Date.value.trim() || imm1Date.value === 'nullFlavor')) {
                errors.push('dq-immunization-effectiveTime-001: Immunization 1 effective time cannot be nullFlavor');
            }
            
            if (imm1Date?.value && imm1Date.value.length < 8) {
                errors.push('dq-immunization-effectiveTime-003: Immunization 1 effective time must be at least 8 characters (YYYYMMDD)');
            }
            
            if (vac1Code?.value && (!vac1Code.value.trim() || vac1Code.value === 'nullFlavor')) {
                errors.push('dq-immunization-vaccineCode-001/002: Vaccine 1 code cannot be blank or nullFlavor');
            }
            
            // Immunization 2 validation
            const imm2Id = document.getElementById('immunization2Id');
            const imm2Date = document.getElementById('immunization2Date');
            const vac2Code = document.getElementById('vaccine2Code');
            
            if (imm2Id?.value && (!imm2Id.value.trim() || imm2Id.value === 'nullFlavor')) {
                errors.push('dq-immunizationActivity-id-001: Immunization 2 ID cannot be nullFlavor');
            }
            
            if (imm2Date?.value && (!imm2Date.value.trim() || imm2Date.value === 'nullFlavor')) {
                errors.push('dq-immunization-effectiveTime-001: Immunization 2 effective time cannot be nullFlavor');
            }
            
            if (imm2Date?.value && imm2Date.value.length < 8) {
                errors.push('dq-immunization-effectiveTime-003: Immunization 2 effective time must be at least 8 characters (YYYYMMDD)');
            }
            
            if (vac2Code?.value && (!vac2Code.value.trim() || vac2Code.value === 'nullFlavor')) {
                errors.push('dq-immunization-vaccineCode-001/002: Vaccine 2 code cannot be blank or nullFlavor');
            }
            
            return errors;
        }

        function validateDQProblemObservations() {
            const errors = [];
            
            // Diagnosis validation
            const diag1Code = document.getElementById('diagnosis1Code');
            const diag1Date = document.getElementById('diagnosis1Date');
            const diag1OnsetDate = document.getElementById('diagnosis1OnsetDate');
            
            if (diag1Code?.value && (!diag1Code.value.trim() || diag1Code.value === 'nullFlavor')) {
                errors.push('dq-problemObservation-002: Diagnosis 1 code cannot be nullFlavor');
            }
            
            if (diag1Date?.value && (!diag1Date.value.trim() || diag1Date.value === 'nullFlavor')) {
                errors.push('dq-validate_problem_DateofDiagnosis-001: Diagnosis 1 effective time cannot be nullFlavor');
            }
            
            if (diag1OnsetDate?.value && diag1OnsetDate.value.length < 8) {
                errors.push('dq-validate_problem_DateofDiagnosis-003: Diagnosis 1 onset date must be at least 8 characters (YYYYMMDD)');
            }
            
            return errors;
        }

        function validateFormData() {
            const allErrors = [];
            
            // Run all DQ validation functions
            allErrors.push(...validateDQPatientName());
            allErrors.push(...validateDQPatientAddress());
            allErrors.push(...validateDQAdministrativeGender());
            allErrors.push(...validateDQRaceCode());
            allErrors.push(...validateDQEthnicityCode());
            allErrors.push(...validateDQDateFormats());
            allErrors.push(...validateDQSpecimen());
            allErrors.push(...validateDQTriggerCodes());
            allErrors.push(...validateDQDeathIndicator());
            allErrors.push(...validateDQLabObservations());
            allErrors.push(...validateDQMedicationAdministration());
            allErrors.push(...validateDQImmunizations());
            allErrors.push(...validateDQProblemObservations());
            
            // Legacy required fields validation
            if (!validateRequiredFields()) {
                allErrors.push('Required field validation failed');
            }
            
            // Related document validation
            if (!validateRelatedDocumentFields()) {
                allErrors.push('Related document field validation failed');
            }
            
            if (allErrors.length > 0) {
                displayValidationErrors(allErrors);

                // Check if any errors are blocking (not in NON_BLOCKING_DQ set)
                const blockingErrors = allErrors.filter(error => {
                    const errorCode = error.split(':')[0];
                    return !NON_BLOCKING_DQ.has(errorCode);
                });

                // Only return false if there are blocking errors
                return blockingErrors.length === 0;
            }
            
            // Clear any existing errors and show success message
            const existingErrors = document.getElementById('validation-errors');
            if (existingErrors) {
                existingErrors.style.display = 'none';
            }
            
            displayValidationSuccess();
            return true;
        }

        function displayValidationErrors(errors) {
            const errorContainer = document.getElementById('validation-errors') || createErrorContainer();
            errorContainer.innerHTML = '<h3>DQ Schematron Validation Errors:</h3>';
            
            const errorList = document.createElement('ul');
            errors.forEach(error => {
                const errorItem = document.createElement('li');
                errorItem.textContent = error;
                errorItem.style.color = 'red';
                errorItem.style.marginBottom = '5px';
                errorList.appendChild(errorItem);
            });
            
            errorContainer.appendChild(errorList);
            errorContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function createErrorContainer() {
            const container = document.createElement('div');
            container.id = 'validation-errors';
            container.style.cssText = 'background: #fee; border: 2px solid #f00; padding: 20px; margin: 20px 0; border-radius: 5px;';
            document.querySelector('.container').insertBefore(container, document.querySelector('.footer-buttons'));
            return container;
        }

        function displayValidationSuccess() {
            let successContainer = document.getElementById('validation-success');
            if (!successContainer) {
                successContainer = document.createElement('div');
                successContainer.id = 'validation-success';
                successContainer.style.cssText = 'background: #efe; border: 2px solid #0a0; padding: 20px; margin: 20px 0; border-radius: 5px; color: #060;';
                document.querySelector('.container').insertBefore(successContainer, document.querySelector('.footer-buttons'));
            }
            
            successContainer.innerHTML = `
                <h3>✅ Validation Passed!</h3>
                <p>The form is ready for CDA generation.</p>
            `;
            successContainer.style.display = 'block';
            successContainer.scrollIntoView({ behavior: 'smooth' });
            
            // Hide success message after 5 seconds
            setTimeout(() => {
                successContainer.style.display = 'none';
            }, 5000);
        }

        // Helper functions for CDA generation

// Helper functions for CDA generation
function xmlEscape(str = '') {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;')
    .replace(/\(/g, '&#40;')   // Left parenthesis
    .replace(/\)/g, '&#41;')   // Right parenthesis  
    .replace(/\[/g, '&#91;')   // Left bracket
    .replace(/\]/g, '&#93;')   // Right bracket
    .replace(/\{/g, '&#123;')  // Left brace
    .replace(/\}/g, '&#125;');  // Right brace;
}


// Build metadata XML from form data
function buildMetadataXml(data, zipFilename) {
    const esc = s => xmlEscape(s || '');

    return `<?xml version="1.0" encoding="UTF-8"?>
<metadata>
    <filename>${esc(zipFilename)}</filename>
    <author>${esc(data.organizationName || data.facilityName || 'Unknown Organization')}</author>
    <authorID>${esc(data.organizationId || data.facilityId || data.providerId || 'Unknown')}</authorID>
    <serviceProviderOrg>${esc(data.facilityName || 'Unknown Facility')}</serviceProviderOrg>
    <serviceProviderOrgID>${esc(data.facilityId || data.organizationId || '1.2.840.114350.1.13.248.3.7.2.696570.1020')}</serviceProviderOrgID>
    <facility>${esc(data.facilityName || 'Unknown Facility')}</facility>
    <facilityID>${esc(data.facilityId || '1.2.840.114350.1.13.248.3.7.2.686980.1020251')}</facilityID>
    <sender>${esc(data.organizationEmail || data.providerEmail || 'unknown@facility.org')}</sender>
    <senderID>${esc(data.organizationName || data.facilityName || 'Unknown Organization System')}</senderID>
</metadata>`;
}

function buildRRXml () {
  const d = getFormData();
  const labEvidence = (d.labEvidence || []);
  const x = s => xmlEscape(s || '');       // one-letter alias = escape **everything**
  const guid = () => generateGUID();

  /* =============== STATIC RR CONSTANTS =============== */
  const authorOrgOID    = '2.16.840.1.114222.4.1.217446';  // AIMS
  const custodianOrgOID = '2.16.840.1.114222.4.1.217446';  // APHL
  const rrDocOID        = guid();                          // doc ID for THIS RR
  const rrCreateTS      = new Date().toISOString()
                               .replace(/[-:T]/g,'')
                               .substring(0,14) + '-0000';

  /* =============== REPORTABLE CONDITIONS =============== */
  // Grab every diagnosis that has a code + name – you can refine this
  // to only pull RCTC matches if desired.
  const conditions = [
    { code: d.diagnosis1Code, name: d.diagnosis1Name },
    { code: d.diagnosis2Code, name: d.diagnosis2Name },
    { code: d.diagnosis3Code, name: d.diagnosis3Name }
  ].filter(c => c.code && c.name);

  // Very simple classification: everything marked R1 (reportable)
  // Swap this for your own logic if you also emit R3 / R5 etc.
  const classify = () => 'R1';                      // R1 = “reportable”
  const jurisdiction = () => `${x(d.patientCounty)} Health Department`;

  /* ---------- Build <text> table & machine-readable entries ---------- */
  let condRows   = '';
  let condEntries = '';

  conditions.forEach((c, idx) => {
    const resultCode = classify(c);      // e.g. R1, R3 …
    const entryId    = guid();

    /* human-readable table row */
    condRows += `
      <tr>
        <td>${x(c.name)}</td>
        <td>${x(c.code)}</td>
        <td>${resultCode}</td>
        <td>${jurisdiction()}</td>
      </tr>`;

    /* machine-readable observation (Reportability Result Observation) */
    condEntries += `
      <entry>
        <observation classCode="OBS" moodCode="EVN">
          <!-- Reportability Result Observation (RR-O) -->
          <templateId root="2.16.840.1.113883.10.20.15.2.3.8" extension="2017-04-01"/>
          <id root="${entryId}"/>
          <code code="RR" codeSystem="2.16.840.1.114222.4.5.274"
                displayName="Reportability Result"/>
          <statusCode code="completed"/>
          <effectiveTime value="${rrCreateTS}"/>
          <value xsi:type="CD"
                 code="${resultCode}"
                 codeSystem="2.16.840.1.114222.4.5.232"
                 displayName="${resultCode === 'R1' ? 'Reportable' : 'Not Reportable'}"/>
          <entryRelationship typeCode="SUBJ">
            <observation classCode="OBS" moodCode="EVN">
              <!-- Condition that triggered the rule -->
              <templateId root="2.16.840.1.113883.10.20.15.2.3.3"/>
              <id root="${guid()}"/>
              <code code="75323-6" codeSystem="2.16.840.1.113883.6.1"
                    displayName="Condition"/>
              <statusCode code="completed"/>
              <value xsi:type="CD"
                     code="${x(c.code)}"
                     codeSystem="2.16.840.1.113883.6.96"
                     displayName="${x(c.name)}"/>
            </observation>
          </entryRelationship>
          ${labEvidence.map(ev => `
          <entryRelationship typeCode="SPRT">
            <observation classCode="OBS" moodCode="EVN">
              <id root="${guid()}"/>
              <statusCode code="completed"/>
              ${ev.time ? `<effectiveTime value="${x(ev.time)}"/>` : ''}
              ${(ev.testCode || ev.testName) ? `
                <code code="${x(ev.testCode||'')}" codeSystem="2.16.840.1.113883.6.1" displayName="${x(ev.testName||'Laboratory test')}"/>` : `
                <code nullFlavor="UNK"/>`}
              ${(ev.valueKind==='coded' && (ev.valueCode || ev.valueName)) ? `
                <value xsi:type="CD" code="${x(ev.valueCode||'')}" codeSystem="2.16.840.1.113883.6.96" displayName="${x(ev.valueName||'')}"/>` : ''}
              ${(ev.valueKind==='quantity' && ev.qtyValue) ? `
                <value xsi:type="PQ" value="${x(ev.qtyValue)}"${ev.qtyUnit?` unit="${x(ev.qtyUnit)}"`:''}/>` : ''}
              ${(ev.valueKind==='text' && ev.textValue) ? `
                <value xsi:type="ST">${x(ev.textValue)}</value>` : ''}
              ${mapInterp(ev.interpretation) ? `
                <interpretationCode code="${mapInterp(ev.interpretation)}" codeSystem="2.16.840.1.113883.5.83"/>` : ''}
            </observation>
          </entryRelationship>`).join('')}
          <participant typeCode="DST">
            <participantRole classCode="AGNT">
              <addr><state>${x(d.patientState)}</state></addr>
              <playingEntity classCode="PLC">
                <name>${jurisdiction()}</name>
              </playingEntity>
            </participantRole>
          </participant>
        </observation>
      </entry>`;
  });

  /* =============== THE RR XML =============== */
  return `<?xml version="1.0" encoding="UTF-8"?>
<ClinicalDocument xmlns="urn:hl7-org:v3" xmlns:sdtc="urn:hl7-org:sdtc"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!-- HEADER -->
  <realmCode code="US"/>
  <typeId root="2.16.840.1.113883.1.3" extension="POCD_HD000040"/>
  <templateId root="2.16.840.1.113883.10.20.15.2.1.2" extension="2017-04-01"/>
  <id root="${rrDocOID}"/>
  <code code="88085-6" codeSystem="2.16.840.1.113883.6.1"
        displayName="Reportability response report Document Public health"/>
  <title>Reportability Response</title>
  <effectiveTime value="${rrCreateTS}"/>
  <confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25"/>
  <languageCode code="en-US"/>

  <!-- PATIENT -->
  <recordTarget>
    <patientRole>
      <id extension="${x(d.patientId)}" root="2.16.840.1.113883.19.5"/>
      <addr use="H">
        <streetAddressLine>${x(d.patientAddress)}</streetAddressLine>
        <city>${x(d.patientCity)}</city><state>${x(d.patientState)}</state>
        <postalCode>${x(d.patientZip)}</postalCode>
        <country>${x(d.patientCountry) || 'US'}</country>
      </addr>
      <telecom value="tel:${x(d.patientPhone)}" use="MC"/>
      <patient>
        <name use="L">
          <given>${x((d.patientName||' ').split(' ')[0])}</given>
          <family>${x((d.patientName||' ').split(' ').slice(1).join(' '))}</family>
        </name>
        <administrativeGenderCode code="${x(d.patientGender)}"
                                  codeSystem="2.16.840.1.113883.5.1"/>
        <birthTime value="${x(d.patientBirthDate)}"/>
      </patient>
    </patientRole>
  </recordTarget>

  <!-- AUTHOR (AIMS) -->
  <author>
    <time value="${rrCreateTS}"/>
    <assignedAuthor>
      <id root="${authorOrgOID}"/>
      <assignedAuthoringDevice>
        <manufacturerModelName>AIMS</manufacturerModelName>
        <softwareName>AIMS</softwareName>
      </assignedAuthoringDevice>
    </assignedAuthor>
  </author>

  <!-- CUSTODIAN (APHL) -->
  <custodian>
    <assignedCustodian>
      <representedCustodianOrganization>
        <id root="${custodianOrgOID}"/>
        <name>APHL | Association of Public Health Laboratories</name>
      </representedCustodianOrganization>
    </assignedCustodian>
  </custodian>

  <!-- INFO RECIPIENT (Provider) -->
  <informationRecipient typeCode="PRCP">
    <intendedRecipient>
      <id extension="${x(d.providerId)}" root="2.16.840.1.113883.4.6"/>
      <informationRecipient>
        <name>
          <given>${x((d.providerName||' ').split(' ')[0])}</given>
          <family>${x((d.providerName||' ').split(' ').slice(1).join(' '))}</family>
        </name>
      </informationRecipient>
      <receivedOrganization><name>${x(d.facilityName)}</name></receivedOrganization>
    </intendedRecipient>
  </informationRecipient>

  <!-- ENCOMPASSING ENCOUNTER -->
  <componentOf>
    <encompassingEncounter>
      <id extension="${x(d.encounterId)}" root="2.16.840.1.113883.19"/>
      <effectiveTime><low value="${x(d.encounterDate)}"/></effectiveTime>
    </encompassingEncounter>
  </componentOf>

  <!-- BODY -->
  <component><structuredBody>

    <!-- SUBJECT section (88084-9) -->
    <component><section>
      <templateId root="2.16.840.1.113883.10.20.15.2.2.1" extension="2017-04-01"/>
      <code code="88084-9" codeSystem="2.16.840.1.113883.6.1"/>
      <text>
        <paragraph>This response indicates that public-health has processed the
        incoming eICR. <strong>${x(conditions[0]?.name || 'A condition')}</strong>
        is reportable for <em>${jurisdiction()}</em>.</paragraph>
      </text>
    </section></component>

    <!-- PROCESSING-INFO section (88082-3) -->
    <component><section>
      <templateId root="2.16.840.1.113883.10.20.15.2.2.3" extension="2017-04-01"/>
      <code code="88082-3" codeSystem="2.16.840.1.113883.6.1"/>
      <entry>
        <act classCode="ACT" moodCode="EVN">
          <templateId root="2.16.840.1.113883.10.20.15.2.3.9" extension="2017-04-01"/>
          <code code="RR5" codeSystem="2.16.840.1.114222.4.5.232"
                 displayName="Received eICR Information"/>
          <statusCode code="completed"/>
          <reference typeCode="REFR">
            <externalDocument classCode="DOCCLIN" moodCode="EVN">
              <id root="${x(d.documentId)}"/>
              <code code="55751-2" codeSystem="2.16.840.1.113883.6.1"
                     displayName="Public Health Case Report (eICR)"/>
              <setId extension="${x(d.setId)}"
                     root="1.2.840.114350.1.13.380.3.7.1.1"/>
              <versionNumber value="${x(d.versionNumber)}"/>
            </externalDocument>
          </reference>
        </act>
      </entry>
      <entry>
        <act classCode="ACT" moodCode="EVN">
          <templateId extension="2017-04-01" root="2.16.840.1.113883.10.20.15.2.3.29"/>
          <id root="${guid()}"/>
          <code code="RRVS20" codeSystem="2.16.840.1.114222.4.5.274"
                codeSystemName="PHIN VS (CDC Local Coding System)"
                displayName="eICR was processed - with a warning"/>
          <entryRelationship typeCode="RSON">
            <observation classCode="OBS" moodCode="EVN">
              <templateId extension="2017-04-01" root="2.16.840.1.113883.10.20.15.2.3.21"/>
              <id root="${guid()}"/>
              <code code="RR6" codeSystem="2.16.840.1.114222.4.5.232"
                    displayName="eICR processing status reason"/>
              <value code="RRVS29" codeSystem="2.16.840.1.114222.4.5.274"
                     displayName="The eICR was processed with the warning of: outdated eRSD (RCTC) version."
                     xsi:type="CD"/>
              <entryRelationship typeCode="RSON">
                <observation classCode="OBS" moodCode="EVN">
                  <templateId extension="2017-04-01" root="2.16.840.1.113883.10.20.15.2.3.32"/>
                  <id root="${guid()}"/>
                  <code code="RRVS31" codeSystem="2.16.840.1.114222.4.5.274"
                        displayName="Outdated eRSD (RCTC) Version Detail"/>
                  <value xsi:type="ST">2.0.1</value>
                </observation>
              </entryRelationship>
              <entryRelationship typeCode="RSON">
                <observation classCode="OBS" moodCode="EVN">
                  <templateId extension="2017-04-01" root="2.16.840.1.113883.10.20.15.2.3.32"/>
                  <id root="${guid()}"/>
                  <code code="RRVS33" codeSystem="2.16.840.1.114222.4.5.274"
                        displayName="Expected eRSD (RCTC) Version Detail"/>
                  <value xsi:type="ST">The expected eRSD (RCTC) version should be one of the following: ["2025-02-28","2.0.0","3.0.1"]</value>
                </observation>
              </entryRelationship>
            </observation>
          </entryRelationship>
        </act>
      </entry>
    </section></component>

    <!-- REPORTABILITY RESULTS section (88083-1)  ← NEW -->
    <component><section>
      <templateId root="2.16.840.1.113883.10.20.15.2.2.2" extension="2017-04-01"/>
      <code code="88083-1" codeSystem="2.16.840.1.113883.6.1"/>
      <title>Reportability Results</title>
      <text>
        <table border="1">
          <thead><tr><th>Condition</th><th>Code</th><th>Classification</th><th>Jurisdiction</th></tr></thead>
          <tbody>${condRows}</tbody>
        </table>
      </text>
      ${condEntries}
    </section></component>

  </structuredBody></component>
</ClinicalDocument>`;
}

function generateRR() {
    return buildRRXml();
}

// Updated ZIP builder using local XSLT files with debugging
async function downloadZipOfEICRandRR() {
  try {
    if (!validateFormData()) return;
    
    console.log('Starting ZIP generation with debugging...');
    
    // Generate XML
    const eicrXml = generateEICRXml();
    const rrXml = generateRRXml();
    
    // Debug XML structure
    debugXmlStructure(eicrXml, 'eICR');
    debugXmlStructure(rrXml, 'RR');
    
    // Validate XML comments
    validateXMLComments(eicrXml, 'eICR');
    validateXMLComments(rrXml, 'RR');
    
    // Load XSLT files
    console.log('Loading XSLT files...');
    const eicrXsl = await fetchXslt(EICR_XSL_URL);
    const rrXsl = await fetchXslt(RR_XSL_URL);
    
    // Verify XSLT files
    if (eicrXsl.length < 1000 || !eicrXsl.includes('xsl:stylesheet')) {
      throw new Error('eICR XSLT appears to be invalid or incomplete');
    }
    if (rrXsl.length < 1000 || !rrXsl.includes('xsl:stylesheet')) {
      throw new Error('RR XSLT appears to be invalid or incomplete');
    }
    
    // Transform to HTML
    console.log('Transforming eICR...');
    const eicrHtml = xmlToHtml(eicrXml, eicrXsl);
    
    console.log('Transforming RR...');
    const rrHtml = xmlToHtml(rrXml, rrXsl);

    // Generate filenames
    const data = getFormData();
    const stamp = new Date().toISOString().split('T')[0];
    const base = (data.patientName || 'Patient').replace(/[^A-Za-z0-9]/g,'_') + '_' + (data.setId || 'Unknown') + '_' + stamp;

    // Create ZIP with all files
    console.log('Creating ZIP package...');
    const zip = new JSZip();
    zip.file(`eICR_${base}.xml`, eicrXml);
    zip.file(`RR_${base}.xml`, rrXml);
    zip.file(`eICR_${base}.html`, eicrHtml);
    zip.file(`RR_${base}.html`, rrHtml);

    // Add metadata file with form data
    const metadata = buildMetadataXml(data, `${base}.zip`);
    zip.file('metadata.xml', metadata);

    console.log('Generating ZIP file...');
    const blob = await zip.generateAsync({ type: 'blob' });
    const filename = generateDynamicFilename('eCR', 'zip');
    
    // Try to use File System Access API (Chrome/Edge) to prompt for save location
    if ('showSaveFilePicker' in window) {
      try {
        const fileHandle = await window.showSaveFilePicker({
          suggestedName: filename,
          types: [
            {
              description: 'ZIP files',
              accept: { 'application/zip': ['.zip'] }
            }
          ]
        });
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();
        console.log('File saved with user-selected location');
        return;
      } catch (err) {
        if (err.name !== 'AbortError') {
          console.warn('File System Access API failed, falling back to download:', err);
        } else {
          console.log('User cancelled save dialog');
          return;
        }
      }
    }
    
    // Fallback: traditional download (goes to Downloads folder)
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { 
      href: url, 
      download: filename
    });
    document.body.appendChild(a); 
    a.click(); 
    a.remove(); 
    URL.revokeObjectURL(url);
    
    console.log('ZIP download completed successfully with 5 files (XML + HTML + metadata)');
    
  } catch (error) {
    console.error('Detailed error:', error);
    if (error.message.includes('XSLT file') || error.message.includes('XSLT transformation')) {
      alert(`Transformation failed: ${error.message}\n\nCheck the console for detailed debugging information.`);
    } else {
      alert(`Failed to build ZIP package: ${error.message}\n\nSee console for detailed error information.`);
    }
  }
}

async function generateAndDownloadRR() {
    try {
        const rrXml = generateRR();          // build the RR XML
        const blob = new Blob([rrXml], { type: 'application/xml' });
        const filename = generateDynamicFilename('RR', 'xml');

        // Try to use File System Access API (Chrome/Edge) to prompt for save location
        if ('showSaveFilePicker' in window) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: filename,
                    types: [
                        {
                            description: 'XML files',
                            accept: { 'application/xml': ['.xml'] }
                        }
                    ]
                });
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                console.log('RR file saved with user-selected location');
                return;
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.warn('File System Access API failed for RR, falling back to download:', err);
                } else {
                    console.log('User cancelled RR save dialog');
                    return;
                }
            }
        }

        // Fallback to traditional download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (e) {
        alert(`RR build failed: ${e.message}`);
        console.error(e);
    }
}
        
        function generateGUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Utility function to extract condition names from form data
        function extractConditionNames() {
            const data = getFormData();
            const conditions = [];

            // Extract from new dynamic diagnosis evidence array
            if (data.diagnosisEvidence && Array.isArray(data.diagnosisEvidence)) {
                data.diagnosisEvidence.forEach(diagnosis => {
                    if (diagnosis.diagnosisCode && diagnosis.diagnosisName) {
                        conditions.push(diagnosis.diagnosisName);
                    }
                });
            }

            // Fallback: check legacy fields if they still exist
            if (conditions.length === 0) {
                if (data.diagnosis1Code && data.diagnosis1Name) {
                    conditions.push(data.diagnosis1Name);
                }
                if (data.diagnosis2Code && data.diagnosis2Name) {
                    conditions.push(data.diagnosis2Name);
                }
                if (data.diagnosis3Code && data.diagnosis3Name) {
                    conditions.push(data.diagnosis3Name);
                }
            }

            return conditions;
        }

        // Utility function to sanitize and format condition name for filename
        function sanitizeConditionName(conditionNames) {
            if (!conditionNames || conditionNames.length === 0) {
                return 'Unknown';
            }

            let result;
            if (conditionNames.length === 1) {
                result = conditionNames[0];
            } else {
                // Multiple conditions - use first + "Multi"
                result = conditionNames[0] + '_Multi';
            }

            // Apply common abbreviations
            const abbreviations = {
                'COVID-19': 'COVID19',
                'Coronavirus Disease 2019': 'COVID19',
                'Severe Acute Respiratory Syndrome Coronavirus 2': 'SARS_CoV2',
                'Tuberculosis': 'TB',
                'Human Immunodeficiency Virus': 'HIV',
                'Acquired Immunodeficiency Syndrome': 'AIDS',
                'Hepatitis A': 'HepA',
                'Hepatitis B': 'HepB',
                'Hepatitis C': 'HepC',
                'Influenza': 'Flu',
                'Pertussis': 'Whooping_Cough',
                'Salmonella': 'Salmonella',
                'Escherichia coli': 'E_coli',
                'Streptococcus': 'Strep',
                'Meningitis': 'Meningitis',
                'Down syndrome': 'Down_Syndrome',
                'Spina bifida': 'Spina_Bifida',
                'Tetralogy of Fallot': 'TOF'
            };

            // Check for exact matches first
            for (const [full, abbrev] of Object.entries(abbreviations)) {
                if (result.toLowerCase().includes(full.toLowerCase())) {
                    result = result.replace(new RegExp(full, 'gi'), abbrev);
                    break;
                }
            }

            // Remove disorder/disease/syndrome suffixes
            result = result.replace(/\s*\(disorder\)$/i, '')
                          .replace(/\s*\(disease\)$/i, '')
                          .replace(/\s*syndrome$/i, '')
                          .replace(/\s*disease$/i, '');

            // Sanitize for filename: remove invalid characters and spaces
            result = result.replace(/[\/\\:*?"<>|]/g, '')  // Remove invalid filename chars
                          .replace(/\s+/g, '_')             // Replace spaces with underscores
                          .replace(/[^\w\-_]/g, '')         // Keep only alphanumeric, dash, underscore
                          .replace(/_+/g, '_')              // Collapse multiple underscores
                          .replace(/^_|_$/g, '');           // Trim leading/trailing underscores

            // Limit length to ~20 characters
            if (result.length > 20) {
                result = result.substring(0, 20).replace(/_$/, '');
            }

            return result || 'Unknown';
        }

        // Utility function to generate timestamp in YYYYMMDD_HHMMSS format
        function generateTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            return `${year}${month}${day}_${hours}${minutes}${seconds}`;
        }

        // Utility function to generate dynamic filename
        function generateDynamicFilename(fileType, extension) {
            const conditionNames = extractConditionNames();
            const conditionName = sanitizeConditionName(conditionNames);
            const timestamp = generateTimestamp();

            return `${fileType}_${conditionName}_${timestamp}.${extension}`;
        }

        /* ---------- Vital-signs & anthropometrics ---------- */
function generateVitalSignsEntries(data) {

  // nothing to do?
  if (
    !data.temperature && !data.bloodPressure && !data.heartRate &&
    !data.respiratoryRate && !data.oxygenSaturation &&
    !data.weight && !data.height && !data.bmi
  ) { return ''; }

  // helper so we don’t repeat the templateId stanza 8 times
  const vital = (code, display, value, unit) => `
      <component>
        <observation classCode="OBS" moodCode="EVN">
          <templateId root="2.16.840.1.113883.10.20.22.4.27"
                      extension="2014-06-09"/>
          <id root="${generateGUID()}"/>
          <code code="${code}" codeSystem="2.16.840.1.113883.6.1"
                displayName="${display}"/>
          <statusCode code="completed"/>
          <effectiveTime value="${data.encounterDate}"/>
          <value xsi:type="PQ" value="${value}" unit="${unit}"/>
          <author>
            <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
            <time value="${data.encounterDate}"/>
            <assignedAuthor>
              <id extension="${data.providerId}" root="2.16.840.1.113883.4.6"/>
              <code code="${getProviderTaxonomyCode('physician').code}" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="${getProviderTaxonomyCode('physician').display}"/>
              <assignedPerson>
                <name>
                  <given>${data.providerName.split(' ')[1] || 'Unknown'}</given>
                  <family>${data.providerName.split(' ')[2] || 'Provider'}</family>
                </name>
              </assignedPerson>
            </assignedAuthor>
          </author>
        </observation>
      </component>`;

  return `
    <entry typeCode="DRIV">
      <organizer classCode="CLUSTER" moodCode="EVN">
        <templateId root="2.16.840.1.113883.10.20.22.4.26"
                    extension="2015-08-01"/>
        <id root="${generateGUID()}"/>
        <code code="46680005" codeSystem="2.16.840.1.113883.6.96"
              displayName="Vital signs"/>
        <statusCode code="completed"/>
        <effectiveTime value="${data.encounterDate}"/>
        <author>
      <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
      <time value="20240615"/>
      <assignedAuthor>
        <id extension="1234567890" root="2.16.840.1.113883.4.6"/>
        <code code="207Q00000X" codeSystem="2.16.840.1.113883.6.101" displayName="Family Medicine Physician"/>
        <assignedPerson>
          <name>
            <given>Royce</given>
            <family>Hemlock</family>
          </name>
        </assignedPerson>
      </assignedAuthor>
    </author>

        ${data.temperature         ? vital('8310-5', 'Body temperature',          data.temperature,      '[degF]')     : ''}
        ${data.bloodPressure       ? vital('8480-6', 'Systolic blood pressure',   data.bloodPressure.split('/')[0], 'mm[Hg]') : ''}
        ${data.heartRate           ? vital('8867-4', 'Heart rate',                data.heartRate,        '/min')       : ''}
        ${data.respiratoryRate     ? vital('9279-1', 'Respiratory rate',          data.respiratoryRate,  '/min')       : ''}
        ${data.oxygenSaturation    ? vital('59408-5','Oxygen saturation (SpO₂)',  data.oxygenSaturation, '%')          : ''}
        ${data.weight              ? vital('3141-9', 'Body weight',               data.weight,           'kg')         : ''}
        ${data.height              ? vital('8302-2', 'Body height',               data.height,           'cm')         : ''}
        ${data.bmi                 ? vital('39156-5','Body Mass Index',           data.bmi,              'kg/m2')      : ''}

      </organizer>
    </entry>`;
}
        /* ---------- Specimen Information (up to two specimens) ---------- */
function buildSpecimenSection(d) {
  // bail if the form is blank
  if (!d.specimen1Id && !d.specimen2Id) return '';

  // ---------- human-readable rows ----------
  const rows = [];
  const addRow = (src, type, id, dt) => rows.push(
    `<tr><td>${xmlEscape(src)}</td><td>${xmlEscape(type)}</td>` +
    `<td>${xmlEscape(id)}</td><td>${xmlEscape(dt)}</td></tr>`
  );

  // ---------- machine-readable entries ----------
  const entries = [];
  const addEntry = (src, type, id, dt) => entries.push(`
    <entry typeCode="DRIV">
      <procedure classCode="PROC" moodCode="EVN">
        <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
        <id root="${generateGUID()}" />
         <code code="33747-0" codeSystem="2.16.840.1.113883.6.1" displayName="General procedure">
      <originalText>General procedure</originalText>
    </code>
        <statusCode code="completed" />
        <effectiveTime value="${xmlEscape(dt)}"/>
        <author>
            <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
            <time value="20240615"/>
            <assignedAuthor>
                <id extension="${d.providerId}" root="2.16.840.1.113883.4.6"/>
                <code code="${getProviderTaxonomyCode('physician').code}" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="${getProviderTaxonomyCode('physician').display}"/>
                <assignedPerson>
                    <name>
                        <given>${d.providerName.split(' ')[1] || 'Unknown'}</given>
                        <family>${d.providerName.split(' ')[2] || 'Provider'}</family>
                    </name>
                </assignedPerson>
            </assignedAuthor>
        </author>
        <performer>
  <assignedEntity>
    <id extension="${d.providerId}" root="2.16.840.1.113883.4.6"/>
    <addr use="WP">
      <streetAddressLine>${d.facilityAddress}</streetAddressLine>
      <city>${d.patientCity}</city>
      <state>${d.patientState}</state>
      <postalCode>${d.patientZip}</postalCode>
      <country>US</country>
    </addr>
    <telecom use="WP" value="tel:${d.providerPhone}"/>
    <assignedPerson>
      <name>
        <given>${(d.providerName || 'Unknown').split(' ')[0]}</given>
        <family>${(d.providerName || 'Unknown').split(' ').slice(1).join(' ') || 'Provider'}</family>
      </name>
    </assignedPerson>
    <representedOrganization>
      <id extension="${d.organizationId || d.facilityId}" root="2.16.840.1.113883.4.6"/>
      <name>${d.facilityName}</name>
      <telecom use="WP" value="tel:${d.organizationPhone || d.providerPhone}"/>
      <addr use="WP">
        <streetAddressLine>${d.facilityAddress}</streetAddressLine>
        <city>${d.patientCity}</city>
        <state>${d.patientState}</state>
        <postalCode>${d.patientZip}</postalCode>
        <country>US</country>
      </addr>
    </representedOrganization>
  </assignedEntity>
</performer>
        <targetSiteCode displayName="${xmlEscape(src)}" codeSystem="2.16.840.1.113883.6.96" />
        <participant typeCode="PRD">
          <participantRole classCode="SPEC">
            <templateId root="2.16.840.1.113883.10.20.22.4.410" extension="2019-06-21" />
            <id root="2.16.840.1.113883.3.72.5.9.1" extension="${xmlEscape(id)}"/>
            <code code="12345" displayName="${xmlEscape(type)}" codeSystem="2.16.840.1.113883.6.96"/>
          </participantRole>
        </participant>
      </procedure>
    </entry>`);

  // specimen 1
if (d.specimen1Id) {
  addRow(d.specimen1Source, d.specimen1Type, d.specimen1Id, d.collection1Date);
  addEntry(d.specimen1Source, d.specimen1Type, d.specimen1Id, d.collection1Date);
}

// specimen 2
if (d.specimen2Id) {
  addRow(d.specimen2Source, d.specimen2Type, d.specimen2Id, d.collection2Date);
  addEntry(d.specimen2Source, d.specimen2Type, d.specimen2Id, d.collection2Date);
}


  // ---------- wrap it all in a section ----------
  return `
    <component>
      <section>
        <!-- *Consolidated CDA* Specimen section -->
        <templateId root="2.16.840.1.113883.10.20.22.2.3"/>
        <code code="30954-2" codeSystem="2.16.840.1.113883.6.1" displayName="Specimen"/>

        <title>Specimen Information</title>
        <text>
          <table border="1">
            <thead><tr><th>Source</th><th>Type</th><th>ID</th><th>Collection Date</th></tr></thead>
            <tbody>${rows.join('')}</tbody>
          </table>
        </text>
        ${entries.join('\n')}
      </section>
    </component>`;
}

/* helper to emit dose + optional rate  ---------------------- */
function buildDoseXML (dVal, dUnit, vVal, vUnit) {
  let xml = `          <doseQuantity value="${dVal}" unit="${dUnit === '1' || dUnit === 'each' ? '{tbl}' : dUnit}"/>\n`;
  if (vVal && vUnit) {
    xml += `          <rateQuantity value="${vVal}" unit="${vUnit}"/>\n`;
  }
  return xml;
}

function getInterpretationCode(result, interpretation) {
    // Use the interpretation field if available
    if (interpretation) {
        const interpMap = {
            'A': 'A',     // Abnormal
            'N': 'N',     // Normal
            'H': 'H',     // High
            'L': 'L',     // Low
            'HH': 'HH',   // Critical high
            'LL': 'LL'    // Critical low
        };
        if (interpMap[interpretation]) return interpMap[interpretation];
    }
    
    // Fallback based on result text
    if (result) {
        const resultLower = result.toLowerCase();
        if (resultLower.includes('detected') || resultLower.includes('positive')) return 'A';
        if (resultLower.includes('not detected') || resultLower.includes('negative')) return 'N';
        if (resultLower.includes('high')) return 'H';
        if (resultLower.includes('low')) return 'L';
    }
    
    // Default fallback
    return 'A'; // Abnormal as default for lab results
}

function getEmergencyOutbreakDisplay(code) {
    const displays = {
        '443684005': 'Disease outbreak',
        '410546004': 'Public health emergency', 
        '261665006': 'Unknown',
        'N/A': 'Not applicable'
    };
    return displays[code] || 'Not specified';
}

function getReferenceRange(testCode, referenceRangeText) {
    if (referenceRangeText) {
        return `
        <referenceRange>
          <observationRange>
            <text>${referenceRangeText}</text>
          </observationRange>
        </referenceRange>`;
    }
    
    // Default reference ranges for common tests
    const defaultRanges = {
        '94310-0': 'Not Detected', // COVID-19
        '34487-9': 'Not Detected'  // Influenza
    };
    
    if (defaultRanges[testCode]) {
        return `
        <referenceRange>
          <observationRange>
            <text>${defaultRanges[testCode]}</text>
            <value xsi:type="CD" code="260415000" 
                   codeSystem="2.16.840.1.113883.6.96" 
                   displayName="Not detected"/>
          </observationRange>
        </referenceRange>`;
    }
    
    return '';
}

function getEmploymentStatusDisplay(status) {
    const displays = {
        '1': 'Employed',
        '2': 'Unemployed', 
        '3': 'Not in labor force',
        '4': 'Retired',
        '5': 'Student',
        'UNK': 'Unknown'
    };
    return displays[status] || 'Unknown';
}

function getExposureContactDisplay(code) {
    const displays = {
        '24932003': 'Exposed',
        '84100007': 'Contact',
        '373068000': 'No exposure',
        '261665006': 'Unknown'
    };
    return displays[code] || 'Unknown';
}

function getExposureTypeDisplay(code) {
    const displays = {
        '409822003': 'Direct contact',
        '417746004': 'Airborne',
        '418038007': 'Droplet', 
        '447964005': 'Contact precaution',
        'OTH': 'Other'
    };
    return displays[code] || 'Other';
}

function getQuarantineStatusDisplay(code) {
    const displays = {
        '182856006': 'In quarantine',
        '182857002': 'Released from quarantine',
        '405178008': 'Not in quarantine',
        '261665006': 'Unknown'
    };
    return displays[code] || 'Unknown';
}

function getIsolationStatusDisplay(code) {
    const displays = {
        '40174006': 'In isolation',
        '182840001': 'Released from isolation', 
        '385432009': 'Not in isolation',
        '261665006': 'Unknown'
    };
    return displays[code] || 'Unknown';
}


       /* ---------- Medication entries (schema-compliant) ---------- */
function generateMedicationEntries (d) {
  const meds = [
    {
      code:d.adminMed1Code, name:d.adminMed1Name, id:d.adminMed1Id,
      status:d.adminMed1Status, time:d.adminMed1Time, route:d.adminMed1Route,
      dVal:d.adminMed1DoseValue, dUnit:d.adminMed1DoseUnit,
      vVal:d.adminMed1VolValue, vUnit:d.adminMed1VolUnit,
      neg:d.adminMed1Negated ? 'true' : 'false'
    },
    {
      code:d.adminMed2Code, name:d.adminMed2Name, id:d.adminMed2Id,
      status:d.adminMed2Status, time:d.adminMed2Time, route:d.adminMed2Route,
      dVal:d.adminMed2DoseValue, dUnit:d.adminMed2DoseUnit,
      vVal:d.adminMed2VolValue, vUnit:d.adminMed2VolUnit,
      neg:d.adminMed2Negated ? 'true' : 'false'
    }
  ];

  return meds.filter(m => m.code && m.name).map(m => `
        <entry typeCode="DRIV">
          <substanceAdministration classCode="SBADM" moodCode="EVN"
                                   negationInd="${m.neg}">
            <templateId root="2.16.840.1.113883.10.20.22.4.16"
                        extension="2014-06-09"/>
            <id root="${generateGUID()}"/>
            <statusCode code="${m.status}"/>
            <effectiveTime xsi:type="IVL_TS">
              <low value="${m.time}"/>
            </effectiveTime>
           <routeCode code="${getRouteTranslation(m.route).fdaCode}" codeSystem="2.16.840.1.113883.3.26.1.1">
  <translation code="${getRouteTranslation(m.route).snomedCode}" 
               codeSystem="2.16.840.1.113883.6.96" 
               displayName="${getRouteTranslation(m.route).display}"/>
</routeCode>
${buildDoseXML(m.dVal, m.dUnit, m.vVal, m.vUnit)}            <!-- ADD THIS AUTHOR PARTICIPATION -->
            <author>
              <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
              <time value="${m.time}"/>
              <assignedAuthor>
                <id extension="${d.providerId || 'UNK'}" root="2.16.840.1.113883.4.6"/>
                <code code="${getProviderTaxonomyCode('physician').code}" 
                      codeSystem="2.16.840.1.113883.6.101" 
                      displayName="${getProviderTaxonomyCode('physician').display}"/>
                <assignedPerson>
                  <name>
                    <given>${(d.providerName || 'Unknown Provider').split(' ')[0]}</given>
                    <family>${(d.providerName || 'Unknown Provider').split(' ').slice(1).join(' ') || 'Provider'}</family>
                  </name>
                </assignedPerson>
              </assignedAuthor>
            </author>
            
            <consumable>
              <manufacturedProduct classCode="MANU">
                <templateId root="2.16.840.1.113883.10.20.22.4.23"
                            extension="2014-06-09"/>
                <manufacturedMaterial>
                  <code code="${m.code}"
                        codeSystem="2.16.840.1.113883.6.88"
                        displayName="${xmlEscape(m.name)}"/>
                </manufacturedMaterial>
              </manufacturedProduct>
            </consumable>
          </substanceAdministration>
        </entry>`).join('');
}

// ... existing functions like generateImmunizationEntries ...

 function generatePregnancyObservation(data) {
    // Only generate if patient is female and has pregnancy status
    if (data.patientGender !== 'F' || !data.pregnancyStatus) {
        return '';
    }

    // Only include delivery date and gestational age if actually pregnant
    const isPregnant = data.pregnancyStatus === '77386006';
    
    // Ensure we have a properly formatted date (at least 8 characters YYYYMMDD)
    const effectiveDate = data.pregnancyEffectiveTime || data.encounterDate || '20240615';
    
    return `
        <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
                <!-- Pregnancy Observation -->
                <templateId root="2.16.840.1.113883.10.20.15.3.8"/>
                <id root="${generateGUID()}"/>
                <code code="ASSERTION" codeSystem="2.16.840.1.113883.5.4" 
                      codeSystemName="HL7ActCode" displayName="Assertion"/>
                <statusCode code="completed"/>
                <effectiveTime>
                    <low value="${effectiveDate}"/>
                    <high nullFlavor="UNK"/>
                </effectiveTime>
                <value xsi:type="CD" 
                       code="${data.pregnancyStatus}" 
                       codeSystem="2.16.840.1.113883.6.96" 
                       codeSystemName="SNOMED CT"
                       displayName="${getPregnancyStatusDisplay(data.pregnancyStatus)}"/>
                
                ${isPregnant && data.estimatedDeliveryDate ? generateEstimatedDeliveryDate(data.estimatedDeliveryDate) : ''}
                ${isPregnant && data.gestationalAge ? generateGestationalAgeObservation(data.gestationalAge) : ''}
            </observation>
        </entry>`;
}

        function getPregnancyStatusDisplay(code) {
            const displays = {
                '77386006': 'Pregnant',
                '60001007': 'Not pregnant', 
                '102874004': 'Possible pregnancy',
                '261665006': 'Unknown'
            };
            return displays[code] || 'Unknown';
        }

        function generateEstimatedDeliveryDate(deliveryDate) {
    return `
        <entryRelationship typeCode="REFR">
            <observation classCode="OBS" moodCode="EVN">
                <!-- Estimated Date of Delivery -->
                <templateId root="2.16.840.1.113883.10.20.15.3.1"/>
                <id root="${generateGUID()}"/>
                <code code="11778-8" codeSystem="2.16.840.1.113883.6.1" 
                      codeSystemName="LOINC" displayName="Delivery date Estimated"/>
                <statusCode code="completed"/>
                <value xsi:type="TS" value="${deliveryDate}"/>
            </observation>
        </entryRelationship>`;
}

        function generateGestationalAgeObservation(gestationalAge) {
            return `
                        <entryRelationship typeCode="COMP">
                            <observation classCode="OBS" moodCode="EVN">
                                <templateId root="2.16.840.1.113883.10.20.22.4.38"/>
                                <id root="${generateGUID()}"/>
                                <code code="18185-9" codeSystem="2.16.840.1.113883.6.1" 
                                      displayName="Gestational age"/>
                                <statusCode code="completed"/>
                                <value xsi:type="PQ" value="${gestationalAge}" unit="wk"/>
                            </observation>
                        </entryRelationship>`;
        }

 // Fixed route code mapping function using FDA Route of Administration Terminology
function getImmunizationRouteTranslation(routeCode) {
    const routeMap = {
        'IM': { code: 'C28161', display: 'Intramuscular route', snomed: '78421000' },
        'SC': { code: 'C38299', display: 'Subcutaneous route', snomed: '34206005' }, 
        'ID': { code: 'C38238', display: 'Intradermal route', snomed: '72607000' },
        'PO': { code: 'C38288', display: 'Oral route', snomed: '26643006' },
        'IN': { code: 'C38284', display: 'Intranasal route', snomed: '46713006' }
    };
    return routeMap[routeCode] || routeMap['IM'];
}

function generateImmunizationEntries(data) {
  const mkEntry = (i) => {
    const code  = data[`vaccine${i}Code`];
    const name  = data[`vaccine${i}Name`];
    if (!code || !name) return '';

    const status   = data[`immunization${i}Status`] || 'completed';
    const negation = (status === 'not-done' || status === 'refused') ? 'true' : 'false';
    const date     = data[`immunization${i}Date`] || '';
    const route    = data[`vaccine${i}Route`] || 'IM';
    const doseStr  = (data[`vaccine${i}Dose`] || '').trim();
    const [doseValue, doseUnitRaw] = doseStr.split(/\s+/, 2);
    const doseUnit = (doseUnitRaw === '1' || doseUnitRaw === 'each') ? '{tbl}' : (doseUnitRaw || 'mL');
    const mfr      = data[`vaccine${i}Manufacturer`] || '';
    const lot      = data[`vaccine${i}Lot`] || '';
    
    // Get the correct route translation
    const routeTranslation = getImmunizationRouteTranslation(route);

    return `
    <entry typeCode="DRIV">
      <substanceAdministration classCode="SBADM" moodCode="EVN" negationInd="${negation}">
        <templateId root="2.16.840.1.113883.10.20.22.4.52" extension="2015-08-01" />
        <id root="${generateGUID()}" />
        <statusCode code="${status}" />
        <effectiveTime value="${date}" />
        <entryRelationship typeCode="COMP" inversionInd="true">
  <act classCode="ACT" moodCode="EVN">
    <templateId root="2.16.840.1.113883.10.20.22.4.118"/>
    <id root="${generateGUID()}"/>
    <code code="416118004"
          codeSystem="2.16.840.1.113883.6.96"
          displayName="Administration of substance (procedure)"/>
    <statusCode code="completed"/>
    ${date ? `<effectiveTime value="${date}"/>` : ''}
  </act>
</entryRelationship>
        ${route ? `<routeCode code="${routeTranslation.code}" codeSystem="2.16.840.1.113883.3.26.1.1" displayName="${routeTranslation.display}">
          <translation code="${routeTranslation.snomed}" 
                       codeSystem="2.16.840.1.113883.6.96" 
                       displayName="${routeTranslation.display}"/>
        </routeCode>` : ''}
        ${doseValue ? `<doseQuantity value="${doseValue}" unit="${doseUnit}" />` : ''}
        <author>
          <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
          <time value="20240615120000"/>
          <assignedAuthor>
            <id extension="${data.providerId}" root="2.16.840.1.113883.4.6"/>
            <code code="${getProviderTaxonomyCode('physician').code}" 
                  codeSystem="2.16.840.1.113883.6.101" 
                  displayName="${getProviderTaxonomyCode('physician').display}"/>
            <assignedPerson>
              <name>
                <given>${data.providerName.split(' ')[1] || 'Unknown'}</given>
                <family>${data.providerName.split(' ')[2] || 'Provider'}</family>
              </name>
            </assignedPerson>
          </assignedAuthor>
        </author>
        <consumable>
          <manufacturedProduct classCode="MANU">
            <templateId root="2.16.840.1.113883.10.20.22.4.54" extension="2014-06-09" />
            <manufacturedMaterial>
              <code code="${code}" codeSystem="2.16.840.1.113883.12.292" displayName="${name}" />
              ${lot ? `<lotNumberText>${lot}</lotNumberText>` : ''}
            </manufacturedMaterial>
            ${mfr ? `<manufacturerOrganization><name>${mfr}</name></manufacturerOrganization>` : ''}
          </manufacturedProduct>
        </consumable>

        ${(data.administeringProviderNPI
           || data.administeringProviderGiven
           || data.administeringProviderMiddle
           || data.administeringProviderFamily
           || data.administeringProviderPhone
           || data.administeringProviderOrgName) ? `
        <performer typeCode="PRF">
          <assignedEntity>
            ${data.administeringProviderNPI ? `<id root="2.16.840.1.113883.4.6" extension="${data.administeringProviderNPI}" />` : ''}
            ${data.administeringProviderPhone ? `<telecom use="WP" value="tel:${data.administeringProviderPhone}" />` : ''}
            <assignedPerson>
              <name>
                ${data.administeringProviderGiven ? `<given>${data.administeringProviderGiven}</given>` : ''}
                ${data.administeringProviderMiddle ? `<given>${data.administeringProviderMiddle}</given>` : ''}
                ${data.administeringProviderFamily ? `<family>${data.administeringProviderFamily}</family>` : ''}
              </name>
            </assignedPerson>
            ${data.administeringProviderOrgName ? `
            <representedOrganization>
              ${data.administeringProviderOrgId ? `<id root="${data.administeringProviderOrgIdRoot || '2.16.840.1.113883.19'}" extension="${data.administeringProviderOrgId}" />` : ''}
              <name>${data.administeringProviderOrgName}</name>
            </representedOrganization>` : ''}
          </assignedEntity>
        </performer>` : ''}

      </substanceAdministration>
    </entry>`;
  };

  return mkEntry(1) + mkEntry(2);
}


        function generateProcedureEntries(data) {
            let entries = '';
            
            if (data.currentProc1Code && data.currentProc1Name) {
                entries += `
                <entry typeCode="DRIV">
                    <procedure classCode="PROC" moodCode="EVN">
                        <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
                        <id root="${generateGUID()}" />
                        <code code="${data.currentProc1Code}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.currentProc1Name}">
          <originalText>${data.currentProc1Name}</originalText>
        </code>
                        <statusCode code="completed" />
                        <effectiveTime value="${data.currentProc1Date}" />
                        <author>
                    <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
                    <time value="${data.currentProc1Date}"/>
                    <assignedAuthor>
                        <id extension="${data.providerId}" root="2.16.840.1.113883.4.6"/>
                        <code code="${getProviderTaxonomyCode('physician').code}" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="${getProviderTaxonomyCode('physician').display}"/>
                        <assignedPerson>
                            <name>
                                <given>${data.providerName.split(' ')[1] || 'Unknown'}</given>
                                <family>${data.providerName.split(' ')[2] || 'Provider'}</family>
                            </name>
                        </assignedPerson>
                    </assignedAuthor>
                </author>
                <performer>
        <assignedEntity>
            <id extension="${data.providerId}" root="2.16.840.1.113883.4.6"/>
            <addr use="WP">
                <streetAddressLine>${data.facilityAddress}</streetAddressLine>
                <city>${data.patientCity}</city>
                <state>${data.patientState}</state>
                <postalCode>${data.patientZip}</postalCode>
                <country>US</country>
            </addr>
            <telecom use="WP" value="tel:${data.providerPhone}"/>
            <assignedPerson>
                <name>
                    <given>${(data.providerName || 'Unknown').split(' ')[0]}</given>
                    <family>${(data.providerName || 'Unknown').split(' ').slice(1).join(' ') || 'Provider'}</family>
                </name>
            </assignedPerson>
            <representedOrganization>
                <id extension="${data.organizationId || data.facilityId}" root="2.16.840.1.113883.4.6"/>
                <name>${data.facilityName}</name>
                <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}"/>
                <addr use="WP">
                    <streetAddressLine>${data.facilityAddress}</streetAddressLine>
                    <city>${data.patientCity}</city>
                    <state>${data.patientState}</state>
                    <postalCode>${data.patientZip}</postalCode>
                    <country>US</country>
                </addr>
            </representedOrganization>
        </assignedEntity>
    </performer>
                <targetSiteCode code="421060004" codeSystem="2.16.840.1.113883.6.96" 
                    displayName="Structure of vertebral column"/>
                    </procedure>
                </entry>`;
            }
            
            if (data.currentProc2Code && data.currentProc2Name) {
                entries += `
                <entry typeCode="DRIV">
                    <procedure classCode="PROC" moodCode="EVN">
                        <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
                        <id root="${generateGUID()}" />
                        <code code="${data.currentProc2Code}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.currentProc2Name}">
          <originalText>${data.currentProc2Name}</originalText>
        </code>
                        <statusCode code="completed" />
                        <effectiveTime value="${data.currentProc2Date}" />
                        <author>
                    <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
                    <time value="${data.currentProc2Date}"/>
                    <assignedAuthor>
                        <id extension="${data.providerId}" root="2.16.840.1.113883.4.6"/>
                        <code code="${getProviderTaxonomyCode('physician').code}" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="${getProviderTaxonomyCode('physician').display}"/>
                        <assignedPerson>
                            <name>
                                <given>${data.providerName.split(' ')[1] || 'Unknown'}</given>
                                <family>${data.providerName.split(' ')[2] || 'Provider'}</family>
                            </name>
                        </assignedPerson>
                    </assignedAuthor>
                </author>
                 <performer>
            <assignedEntity>
                <id extension="${data.providerId}" root="2.16.840.1.113883.4.6"/>
                <addr use="WP">
                    <streetAddressLine>${data.facilityAddress}</streetAddressLine>
                    <city>${data.patientCity}</city>
                    <state>${data.patientState}</state>
                    <postalCode>${data.patientZip}</postalCode>
                    <country>US</country>
                </addr>
                <telecom use="WP" value="tel:${data.providerPhone}"/>
                <assignedPerson>
                    <name>
                        <given>${(data.providerName || 'Unknown').split(' ')[0]}</given>
                        <family>${(data.providerName || 'Unknown').split(' ').slice(1).join(' ') || 'Provider'}</family>
                    </name>
                </assignedPerson>
                <representedOrganization>
                    <id extension="${data.organizationId || data.facilityId}" root="2.16.840.1.113883.4.6"/>
                    <name>${data.facilityName}</name>
                    <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}"/>
                    <addr use="WP">
                        <streetAddressLine>${data.facilityAddress}</streetAddressLine>
                        <city>${data.patientCity}</city>
                        <state>${data.patientState}</state>
                        <postalCode>${data.patientZip}</postalCode>
                        <country>US</country>
                    </addr>
                </representedOrganization>
            </assignedEntity>
        </performer>
                 <targetSiteCode code="421060004" 
                       codeSystem="2.16.840.1.113883.6.96" 
                       displayName="Structure of vertebral column"/>
                    </procedure>
                </entry>`;
            }
            
            // Add specimen collection procedures
            if (data.specimen1Id && data.collection1Date) {
                entries += `
                <entry typeCode="DRIV">
                    <procedure classCode="PROC" moodCode="EVN">
                        <templateId root="2.16.840.1.113883.10.20.22.4.415" extension="2019-06-21" />
                        <id root="${generateGUID()}" />
                         <code code="33747-0" codeSystem="2.16.840.1.113883.6.1" displayName="General procedure">
          <originalText>General procedure</originalText>
        </code>
                        <statusCode code="completed" />
                        <effectiveTime value="${data.collection1Date}" />
                        <targetSiteCode code="${data.specimen1Source}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.specimen1Type}" />
                        <participant typeCode="PRD">
                            <participantRole classCode="SPEC">
                                <templateId root="2.16.840.1.113883.10.20.22.4.410" extension="2019-06-21" />
                                <id root="${generateGUID()}" extension="${data.specimen1Id}" />
                                <code code="${data.specimen1Source}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.specimen1Type}" />
                            </participantRole>
                        </participant>
                    </procedure>
                </entry>`;
            }
            
            if (data.specimen2Id && data.collection2Date) {
                entries += `
                <entry typeCode="DRIV">
                    <procedure classCode="PROC" moodCode="EVN">
                        <templateId root="2.16.840.1.113883.10.20.22.4.415" extension="2019-06-21" />
                        <id root="${generateGUID()}" />
                        <code code="33747-0" codeSystem="2.16.840.1.113883.6.1" displayName="General procedure">
          <originalText>General procedure</originalText>
        </code>
                        <statusCode code="completed" />
                        <effectiveTime value="${data.collection2Date}" />
                        <targetSiteCode code="${data.specimen2Source}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.specimen2Type}" />
                        <participant typeCode="PRD">
                            <participantRole classCode="SPEC">
                                <templateId root="2.16.840.1.113883.10.20.22.4.410" extension="2019-06-21" />
                                <id root="${generateGUID()}" extension="${data.specimen2Id}" />
                                <code code="${data.specimen2Source}" codeSystem="2.16.840.1.113883.6.96" displayName="${data.specimen2Type}" />
                            </participantRole>
                        </participant>
                    </procedure>
                </entry>`;
            }
            
            return entries;
        }

       // Add diagnosis evidence row
function addDiagnosisEvidence(prefill = {}) {
    const template = document.getElementById('diagnosisEvidenceTemplate');
    const clone = template.content.cloneNode(true);
    const row = clone.querySelector('.diagnosis-evidence-row');
    
    // Populate with prefill data if provided
    if (prefill.diagnosisCode) row.querySelector('.de-diagnosis-code').value = prefill.diagnosisCode;
    if (prefill.diagnosisName) row.querySelector('.de-diagnosis-name').value = prefill.diagnosisName;
    if (prefill.diagnosisDate) row.querySelector('.de-diagnosis-date').value = prefill.diagnosisDate;
    if (prefill.onsetDate) row.querySelector('.de-onset-date').value = prefill.onsetDate;
    if (prefill.status) row.querySelector('.de-status').value = prefill.status;
    
    document.getElementById('diagnosisEvidenceList').appendChild(clone);
}

// Remove diagnosis evidence row
function removeDiagnosisEvidence(btn) {
    btn.closest('.diagnosis-evidence-row')?.remove();
}

// Search RCTC for diagnosis codes
async function searchRCTCForDiagnosis(btn) {
    const row = btn.closest('.diagnosis-evidence-row');
    const codeInput = row.querySelector('.de-diagnosis-code');
    const nameInput = row.querySelector('.de-diagnosis-name');
    const resultsDiv = row.querySelector('.de-diagnosis-code-results');

    btn.textContent = '⏳';
    btn.disabled = true;
    if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

    try {
        if (!diagnosisLoaded) await loadDiagnosisFromRCTC();
        if (!Array.isArray(diagnosisData) || diagnosisData.length === 0) {
            alert('Diagnosis list is empty. The RCTC file may not have loaded.');
            return;
        }

        const q = String(codeInput.value || '').trim().toLowerCase();
        if (!q) { alert('Enter a diagnosis code to search'); return; }

        const exact = diagnosisData.filter(d => String(d.code || '').toLowerCase() === q);
        const starts = diagnosisData.filter(d => String(d.code || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === d.code));
        const contains = diagnosisData.filter(d => String(d.code || '').toLowerCase().includes(q)
            && !exact.some(e => e.code === d.code)
            && !starts.some(s => s.code === d.code));

        const matches = [...exact, ...starts, ...contains];

        if (!matches.length) {
            if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="no-results">No matching diagnosis codes found</div>';
            }
            return;
        }

        if (resultsDiv) {
            const list = document.createElement('div');
            list.className = 'search-results-list';

            matches.slice(0, 10).forEach(d => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<strong>${d.code}</strong> – ${d.name}${d.description ? `<br><small>${d.description}</small>` : ''}`;
                item.onclick = () => {
                    codeInput.value = d.code;
                    nameInput.value = d.name;
                    resultsDiv.style.display = 'none';
                };
                list.appendChild(item);
            });

            resultsDiv.appendChild(list);
            resultsDiv.style.display = 'block';
        }
    } catch (err) {
        console.error('Diagnosis code search error:', err);
        alert('Error searching diagnosis codes. See console for details.');
    } finally {
        btn.textContent = '🔍';
        btn.disabled = false;
    }
}

// Search RCTC for diagnosis names
async function searchRCTCForDiagnosisByName(btn) {
    const row = btn.closest('.diagnosis-evidence-row');
    const codeInput = row.querySelector('.de-diagnosis-code');
    const nameInput = row.querySelector('.de-diagnosis-name');
    const resultsDiv = row.querySelector('.de-diagnosis-name-results');

    btn.textContent = '⏳';
    btn.disabled = true;
    if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

    try {
        if (!diagnosisLoaded) await loadDiagnosisFromRCTC();
        if (!Array.isArray(diagnosisData) || diagnosisData.length === 0) {
            alert('Diagnosis list is empty. The RCTC file may not have loaded.');
            return;
        }

        const q = String(nameInput.value || '').trim().toLowerCase();
        if (!q) { alert('Enter a diagnosis name to search'); return; }

        const exact = diagnosisData.filter(d => String(d.name || '').toLowerCase() === q);
        const starts = diagnosisData.filter(d => String(d.name || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === d.code));
        const contains = diagnosisData.filter(d => String(d.name || '').toLowerCase().includes(q)
            && !exact.some(e => e.code === d.code)
            && !starts.some(s => s.code === d.code));

        const matches = [...exact, ...starts, ...contains];

        if (!matches.length) {
            if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="no-results">No matching diagnosis names found</div>';
            }
            return;
        }

        if (resultsDiv) {
            const list = document.createElement('div');
            list.className = 'search-results-list';

            matches.slice(0, 10).forEach(d => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<strong>${d.name}</strong> – ${d.code}${d.description ? `<br><small>${d.description}</small>` : ''}`;
                item.onclick = () => {
                    codeInput.value = d.code;
                    nameInput.value = d.name;
                    resultsDiv.style.display = 'none';
                };
                list.appendChild(item);
            });

            resultsDiv.appendChild(list);
            resultsDiv.style.display = 'block';
        }
    } catch (err) {
        console.error('Diagnosis name search error:', err);
        alert('Error searching diagnosis names. See console for details.');
    } finally {
        btn.textContent = '🔍';
        btn.disabled = false;
    }
}

// Collect diagnosis evidence data
function collectDiagnosisEvidence() {
    const rows = Array.from(document.querySelectorAll('.diagnosis-evidence-row'));
    console.log('Found diagnosis rows:', rows.length);

    const result = rows.map(r => {
        const data = {
            diagnosisCode: r.querySelector('.de-diagnosis-code')?.value.trim() || '',
            diagnosisName: r.querySelector('.de-diagnosis-name')?.value.trim() || '',
            diagnosisDate: r.querySelector('.de-diagnosis-date')?.value.trim() || '',
            onsetDate: r.querySelector('.de-onset-date')?.value.trim() || '',
            status: r.querySelector('.de-status')?.value || 'completed',
            isRCTC: isRCTCTriggerCode(r.querySelector('.de-diagnosis-code')?.value)
        };
        console.log('Collected diagnosis:', data);
        return data;
    }).filter(x => x.diagnosisCode || x.diagnosisName);

    console.log('Final diagnosis evidence:', result);
    return result;
}

// Add problem evidence row
function addProblemEvidence(prefill = {}) {
    const template = document.getElementById('problemEvidenceTemplate');
    const clone = template.content.cloneNode(true);
    const row = clone.querySelector('.problem-evidence-row');

    // Populate with prefill data if provided
    if (prefill.problemCode) row.querySelector('.pe-problem-code').value = prefill.problemCode;
    if (prefill.problemName) row.querySelector('.pe-problem-name').value = prefill.problemName;
    if (prefill.onsetDate) row.querySelector('.pe-onset-date').value = prefill.onsetDate;
    if (prefill.status) row.querySelector('.pe-status').value = prefill.status;
    if (prefill.concernStatus) row.querySelector('.pe-concern-status').value = prefill.concernStatus;

    document.getElementById('problemEvidenceList').appendChild(clone);
}

// Remove problem evidence row
function removeProblemEvidence(btn) {
    btn.closest('.problem-evidence-row')?.remove();
}

// Search SNOMED for problem codes
async function searchSNOMEDForProblem(btn) {
    const row = btn.closest('.problem-evidence-row');
    const codeInput = row.querySelector('.pe-problem-code');
    const nameInput = row.querySelector('.pe-problem-name');
    const resultsDiv = row.querySelector('.pe-problem-code-results');

    btn.textContent = '⏳';
    btn.disabled = true;
    if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

    try {
        // Use existing diagnosis search as fallback for now
        if (!diagnosisLoaded) await loadDiagnosisFromRCTC();
        if (!Array.isArray(diagnosisData) || diagnosisData.length === 0) {
            alert('Problem list is empty. Using diagnosis data as fallback.');
            return;
        }

        const q = String(codeInput.value || '').trim().toLowerCase();
        if (!q) { alert('Enter a problem code to search'); return; }

        const exact = diagnosisData.filter(d => String(d.code || '').toLowerCase() === q);
        const starts = diagnosisData.filter(d => String(d.code || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === d.code));
        const contains = diagnosisData.filter(d => String(d.code || '').toLowerCase().includes(q)
            && !exact.some(e => e.code === d.code)
            && !starts.some(s => s.code === d.code));

        const matches = [...exact, ...starts, ...contains];

        if (!matches.length) {
            if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="no-results">No matching problem codes found</div>';
            }
            return;
        }

        if (resultsDiv) {
            const list = document.createElement('div');
            list.className = 'search-results-list';

            matches.slice(0, 10).forEach(d => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<strong>${d.code}</strong> — ${d.name}${d.description ? `<br><small>${d.description}</small>` : ''}`;
                item.onclick = () => {
                    codeInput.value = d.code;
                    nameInput.value = d.name;
                    resultsDiv.style.display = 'none';
                };
                list.appendChild(item);
            });

            resultsDiv.appendChild(list);
            resultsDiv.style.display = 'block';
        }
    } catch (err) {
        console.error('Problem code search error:', err);
        alert('Error searching problem codes. See console for details.');
    } finally {
        btn.textContent = '🔍';
        btn.disabled = false;
    }
}

// Search SNOMED for problem names
async function searchSNOMEDForProblemByName(btn) {
    const row = btn.closest('.problem-evidence-row');
    const codeInput = row.querySelector('.pe-problem-code');
    const nameInput = row.querySelector('.pe-problem-name');
    const resultsDiv = row.querySelector('.pe-problem-name-results');

    btn.textContent = '⏳';
    btn.disabled = true;
    if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

    try {
        // Use existing diagnosis search as fallback for now
        if (!diagnosisLoaded) await loadDiagnosisFromRCTC();
        if (!Array.isArray(diagnosisData) || diagnosisData.length === 0) {
            alert('Problem list is empty. Using diagnosis data as fallback.');
            return;
        }

        const q = String(nameInput.value || '').trim().toLowerCase();
        if (!q) { alert('Enter a problem name to search'); return; }

        const exact = diagnosisData.filter(d => String(d.name || '').toLowerCase() === q);
        const starts = diagnosisData.filter(d => String(d.name || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === d.code));
        const contains = diagnosisData.filter(d => String(d.name || '').toLowerCase().includes(q)
            && !exact.some(e => e.code === d.code)
            && !starts.some(s => s.code === d.code));

        const matches = [...exact, ...starts, ...contains];

        if (!matches.length) {
            if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="no-results">No matching problem names found</div>';
            }
            return;
        }

        if (resultsDiv) {
            const list = document.createElement('div');
            list.className = 'search-results-list';

            matches.slice(0, 10).forEach(d => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<strong>${d.name}</strong> — ${d.code}${d.description ? `<br><small>${d.description}</small>` : ''}`;
                item.onclick = () => {
                    codeInput.value = d.code;
                    nameInput.value = d.name;
                    resultsDiv.style.display = 'none';
                };
                list.appendChild(item);
            });

            resultsDiv.appendChild(list);
            resultsDiv.style.display = 'block';
        }
    } catch (err) {
        console.error('Problem name search error:', err);
        alert('Error searching problem names. See console for details.');
    } finally {
        btn.textContent = '🔍';
        btn.disabled = false;
    }
}

// Collect problem evidence data
function collectProblemEvidence() {
    return Array.from(document.querySelectorAll('.problem-evidence-row')).map(r => {
        return {
            problemCode: r.querySelector('.pe-problem-code')?.value.trim() || '',
            problemName: r.querySelector('.pe-problem-name')?.value.trim() || '',
            onsetDate: r.querySelector('.pe-onset-date')?.value.trim() || '',
            status: r.querySelector('.pe-status')?.value || 'active',
            concernStatus: r.querySelector('.pe-concern-status')?.value || 'active'
        };
    }).filter(x => x.problemCode || x.problemName);
}



       
        // Lab Evidence Repeater Functions
        function addLabEvidence(prefill = {}) {
            const template = document.getElementById('labEvidenceTemplate');
            const clone = template.content.cloneNode(true);
            const row = clone.querySelector('.lab-evidence-row');

            // Populate with prefill data if provided
            if (prefill.orderCode) row.querySelector('.le-order-code').value = prefill.orderCode;
            if (prefill.orderName) row.querySelector('.le-order-name').value = prefill.orderName;
            if (prefill.orderId) row.querySelector('.le-order-id').value = prefill.orderId;
            if (prefill.orderTime) row.querySelector('.le-order-time').value = prefill.orderTime;
            if (prefill.testCode) row.querySelector('.le-test-code').value = prefill.testCode;
            if (prefill.testName) row.querySelector('.le-test-name').value = prefill.testName;
            if (prefill.valueKind) {
                row.querySelector('.le-value-kind').value = prefill.valueKind;
                toggleValueEditors(row.querySelector('.le-value-kind'));
            }
            if (prefill.valueCode) row.querySelector('.le-value-code').value = prefill.valueCode;
            if (prefill.valueName) row.querySelector('.le-value-name').value = prefill.valueName;
            if (prefill.qtyValue) row.querySelector('.le-qty-value').value = prefill.qtyValue;
            if (prefill.qtyUnit) row.querySelector('.le-qty-unit').value = prefill.qtyUnit;
            if (prefill.textValue) row.querySelector('.le-text-value').value = prefill.textValue;
            if (prefill.time) row.querySelector('.le-time').value = prefill.time;
            if (prefill.status) row.querySelector('.le-status').value = prefill.status;
            if (prefill.interpretation) row.querySelector('.le-interpretation').value = prefill.interpretation;
            if (prefill.referenceRange) row.querySelector('.le-reference-range').value = prefill.referenceRange;

            document.getElementById('labEvidenceList').appendChild(clone);
        }

        function removeLabEvidence(btn) {
            btn.closest('.lab-evidence-row')?.remove();
        }

        function toggleValueEditors(sel) {
            const row = sel.closest('.lab-evidence-row');
            row.querySelectorAll('.le-coded,.le-qty,.le-text').forEach(el => el.classList.add('hidden'));
            const kind = sel.value;
            if (kind === 'coded') row.querySelectorAll('.le-coded').forEach(el => el.classList.remove('hidden'));
            if (kind === 'quantity') row.querySelectorAll('.le-qty').forEach(el => el.classList.remove('hidden'));
            if (kind === 'text') row.querySelectorAll('.le-text').forEach(el => el.classList.remove('hidden'));
        }

        // Search functions for lab orders and organisms
        async function searchRCTCForTest(btn) {
          const row = btn.closest('.lab-evidence-row');
          const codeInput  = row.querySelector('.le-test-code');
          const nameInput  = row.querySelector('.le-test-name');
          const resultsDiv = row.querySelector('.le-test-code-results');

          // UI: loading state
          btn.textContent = '⏳';
          btn.disabled = true;
          if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

          try {
            if (!testLoaded) await loadTestsFromRCTC();
            if (!Array.isArray(testData) || testData.length === 0) {
              alert('Test list is empty. The RCTC file may not have loaded.');
              return;
            }

            const q = String(codeInput.value || '').trim().toLowerCase();
            if (!q) { alert('Enter a LOINC code to search'); return; }

            const exact = testData.filter(t => String(t.code || '').toLowerCase() === q);
            const starts = testData.filter(t => String(t.code || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === t.code));
            const contains = testData.filter(t => String(t.code || '').toLowerCase().includes(q)
              && !exact.some(e => e.code === t.code)
              && !starts.some(s => s.code === t.code));

            const matches = [...exact, ...starts, ...contains];

            if (!matches.length) {
              if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="no-results">No matching test codes found</div>';
              }
              return;
            }

            if (resultsDiv) {
              const list = document.createElement('div');
              list.className = 'search-results-list';

              matches.slice(0, 10).forEach(t => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<strong>${t.code}</strong> — ${t.name}${t.description ? `<br><small>${t.description}</small>` : ''}`;
                item.onclick = () => {
                  codeInput.value = t.code;
                  nameInput.value = t.name;
                  resultsDiv.style.display = 'none';
                };
                list.appendChild(item);
              });

              resultsDiv.appendChild(list);
              resultsDiv.style.display = 'block';
            } else {
              codeInput.value = matches[0].code;
              nameInput.value = matches[0].name;
            }
          } catch (err) {
            console.error('Test code search error:', err);
            alert('Error searching tests (code). See console for details.');
          } finally {
            btn.textContent = '🔍';
            btn.disabled = false;
          }
        }

        async function searchRCTCForOrganism(btn) {
          const row = btn.closest('.lab-evidence-row');
          const codeInput   = row.querySelector('.le-value-code');
          const nameInput   = row.querySelector('.le-value-name');
          const resultsDiv  = row.querySelector('.le-value-code-results');

          // UI: loading state
          btn.textContent = '⏳';
          btn.disabled = true;
          if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

          try {
            if (!organismLoaded) await loadOrganismFromRCTC();
            if (!Array.isArray(organismData) || organismData.length === 0) {
              alert('Organism list is empty. The RCTC file may not have loaded.');
              return;
            }

            const q = String(codeInput.value || '').trim().toLowerCase();
            if (!q) { alert('Enter a code to search'); return; }

            const exact = organismData.filter(o => String(o.code || '').toLowerCase() === q);
            const starts = organismData.filter(o => String(o.code || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === o.code));
            const contains = organismData.filter(o => String(o.code || '').toLowerCase().includes(q)
              && !exact.some(e => e.code === o.code)
              && !starts.some(s => s.code === o.code));

            const matches = [...exact, ...starts, ...contains];

            if (!matches.length) {
              if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="no-results">No matching organisms found</div>';
              }
              return;
            }

            if (resultsDiv) {
              const list = document.createElement('div');
              list.className = 'search-results-list';

              matches.slice(0, 10).forEach(o => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<strong>${o.code}</strong> — ${o.name}${o.description ? `<br><small>${o.description}</small>` : ''}`;
                item.onclick = () => {
                  codeInput.value = o.code;
                  nameInput.value = o.name;
                  resultsDiv.style.display = 'none';
                };
                list.appendChild(item);
              });

              resultsDiv.appendChild(list);
              resultsDiv.style.display = 'block';
            } else {
              // Fallback
              codeInput.value = matches[0].code;
              nameInput.value = matches[0].name;
            }
          } catch (err) {
            console.error('Organism code search error:', err);
            alert('Error searching organisms. See console for details.');
          } finally {
            btn.textContent = '🔍';
            btn.disabled = false;
          }
        }

        // Search by test name
        async function searchRCTCForTestByName(btn) {
          const row = btn.closest('.lab-evidence-row');
          const codeInput  = row.querySelector('.le-test-code');
          const nameInput  = row.querySelector('.le-test-name');
          const resultsDiv = row.querySelector('.le-test-name-results');

          btn.textContent = '⏳';
          btn.disabled = true;
          if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

          try {
            if (!testLoaded) await loadTestsFromRCTC();
            if (!Array.isArray(testData) || testData.length === 0) {
              alert('Test list is empty. The RCTC file may not have loaded.');
              return;
            }

            const q = String(nameInput.value || '').trim().toLowerCase();
            if (!q) { alert('Enter a test name to search'); return; }

            const exact = testData.filter(t => String(t.name || '').toLowerCase() === q);
            const starts = testData.filter(t => String(t.name || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === t.code));
            const contains = testData.filter(t => String(t.name || '').toLowerCase().includes(q)
              && !exact.some(e => e.code === t.code)
              && !starts.some(s => s.code === t.code));

            const matches = [...exact, ...starts, ...contains];

            if (!matches.length) {
              if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="no-results">No matching test names found</div>';
              } else {
                alert(`No tests found for "${q}".`);
              }
              return;
            }

            if (resultsDiv) {
              const list = document.createElement('div');
              list.className = 'search-results-list';

              matches.slice(0, 10).forEach(t => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<strong>${t.name}</strong> — ${t.code}${t.description ? `<br><small>${t.description}</small>` : ''}`;
                item.onclick = () => {
                  codeInput.value = t.code;
                  nameInput.value = t.name;
                  resultsDiv.style.display = 'none';
                };
                list.appendChild(item);
              });

              resultsDiv.appendChild(list);
              resultsDiv.style.display = 'block';
            } else {
              codeInput.value = matches[0].code;
              nameInput.value = matches[0].name;
            }
          } catch (err) {
            console.error('Test name search error:', err);
            alert('Error searching tests (name). See console for details.');
          } finally {
            btn.textContent = '🔍';
            btn.disabled = false;
          }
        }

        // Search by organism name
        async function searchRCTCForOrganismByName(btn) {
          const row = btn.closest('.lab-evidence-row');
          const codeInput   = row.querySelector('.le-value-code');
          const nameInput   = row.querySelector('.le-value-name');
          const resultsDiv  = row.querySelector('.le-value-name-results');

          btn.textContent = '⏳';
          btn.disabled = true;
          if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

          try {
            if (!organismLoaded) await loadOrganismFromRCTC();
            if (!Array.isArray(organismData) || organismData.length === 0) {
              alert('Organism list is empty. The RCTC file may not have loaded.');
              return;
            }

            const q = String(nameInput.value || '').trim().toLowerCase();
            if (!q) { alert('Enter a name to search'); return; }

            const exact = organismData.filter(o => String(o.name || '').toLowerCase() === q);
            const starts = organismData.filter(o => String(o.name || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === o.code));
            const contains = organismData.filter(o => String(o.name || '').toLowerCase().includes(q)
              && !exact.some(e => e.code === o.code)
              && !starts.some(s => s.code === o.code));

            const matches = [...exact, ...starts, ...contains];

            if (!matches.length) {
              if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="no-results">No matching organisms found</div>';
              } else {
                alert(`No organisms found for "${q}".`);
              }
              return;
            }

            if (resultsDiv) {
              const list = document.createElement('div');
              list.className = 'search-results-list';

              matches.slice(0, 10).forEach(o => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `<strong>${o.name}</strong> — ${o.code}${o.description ? `<br><small>${o.description}</small>` : ''}`;
                item.onclick = () => {
                  codeInput.value = o.code;
                  nameInput.value = o.name;
                  resultsDiv.style.display = 'none';
                };
                list.appendChild(item);
              });

              resultsDiv.appendChild(list);
              resultsDiv.style.display = 'block';
            } else {
              codeInput.value = matches[0].code;
              nameInput.value = matches[0].name;
            }
          } catch (err) {
            console.error('Organism name search error:', err);
            alert('Error searching organisms. See console for details.');
          } finally {
            btn.textContent = '🔍';
            btn.disabled = false;
          }
        }

        // Lab Order Search Functions
        async function searchRCTCForLabOrder(btn) {
            const row = btn.closest('.lab-evidence-row');
            const codeInput = row.querySelector('.le-order-code');
            const nameInput = row.querySelector('.le-order-name');
            const resultsDiv = row.querySelector('.le-order-code-results');

            btn.textContent = '⏳';
            btn.disabled = true;
            if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

            try {
                if (!labOrderLoaded) await loadLabOrderFromRCTC();
                if (!Array.isArray(labOrderData) || labOrderData.length === 0) {
                    alert('Lab order list is empty. The RCTC file may not have loaded.');
                    return;
                }

                const q = String(codeInput.value || '').trim().toLowerCase();
                if (!q) { alert('Enter a LOINC code to search'); return; }

                const exact = labOrderData.filter(o => String(o.code || '').toLowerCase() === q);
                const starts = labOrderData.filter(o => String(o.code || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === o.code));
                const contains = labOrderData.filter(o => String(o.code || '').toLowerCase().includes(q)
                    && !exact.some(e => e.code === o.code)
                    && !starts.some(s => s.code === o.code));

                const matches = [...exact, ...starts, ...contains];

                if (!matches.length) {
                    if (resultsDiv) {
                        resultsDiv.style.display = 'block';
                        resultsDiv.innerHTML = '<div class="no-results">No matching lab order codes found</div>';
                    }
                    return;
                }

                if (resultsDiv) {
                    const list = document.createElement('div');
                    list.className = 'search-results-list';

                    matches.slice(0, 10).forEach(o => {
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.innerHTML = `<strong>${o.code}</strong> — ${o.name}${o.description ? `<br><small>${o.description}</small>` : ''}`;
                        item.onclick = () => {
                            codeInput.value = o.code;
                            nameInput.value = o.name;
                            resultsDiv.style.display = 'none';
                        };
                        list.appendChild(item);
                    });

                    resultsDiv.appendChild(list);
                    resultsDiv.style.display = 'block';
                }
            } catch (err) {
                console.error('Lab order code search error:', err);
                alert('Error searching lab orders. See console for details.');
            } finally {
                btn.textContent = '🔍';
                btn.disabled = false;
            }
        }

        async function searchRCTCForLabOrderByName(btn) {
            const row = btn.closest('.lab-evidence-row');
            const codeInput = row.querySelector('.le-order-code');
            const nameInput = row.querySelector('.le-order-name');
            const resultsDiv = row.querySelector('.le-order-name-results');

            btn.textContent = '⏳';
            btn.disabled = true;
            if (resultsDiv) { resultsDiv.innerHTML = ''; resultsDiv.style.display = 'none'; }

            try {
                if (!labOrderLoaded) await loadLabOrderFromRCTC();
                if (!Array.isArray(labOrderData) || labOrderData.length === 0) {
                    alert('Lab order list is empty. The RCTC file may not have loaded.');
                    return;
                }

                const q = String(nameInput.value || '').trim().toLowerCase();
                if (!q) { alert('Enter a lab order name to search'); return; }

                const exact = labOrderData.filter(o => String(o.name || '').toLowerCase() === q);
                const starts = labOrderData.filter(o => String(o.name || '').toLowerCase().startsWith(q) && !exact.some(e => e.code === o.code));
                const contains = labOrderData.filter(o => String(o.name || '').toLowerCase().includes(q)
                    && !exact.some(e => e.code === o.code)
                    && !starts.some(s => s.code === o.code));

                const matches = [...exact, ...starts, ...contains];

                if (!matches.length) {
                    if (resultsDiv) {
                        resultsDiv.style.display = 'block';
                        resultsDiv.innerHTML = '<div class="no-results">No matching lab order names found</div>';
                    }
                    return;
                }

                if (resultsDiv) {
                    const list = document.createElement('div');
                    list.className = 'search-results-list';

                    matches.slice(0, 10).forEach(o => {
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.innerHTML = `<strong>${o.name}</strong> — ${o.code}${o.description ? `<br><small>${o.description}</small>` : ''}`;
                        item.onclick = () => {
                            codeInput.value = o.code;
                            nameInput.value = o.name;
                            resultsDiv.style.display = 'none';
                        };
                        list.appendChild(item);
                    });

                    resultsDiv.appendChild(list);
                    resultsDiv.style.display = 'block';
                }
            } catch (err) {
                console.error('Lab order name search error:', err);
                alert('Error searching lab order names. See console for details.');
            } finally {
                btn.textContent = '🔍';
                btn.disabled = false;
            }
        }

        function collectLabEvidence() {
            return Array.from(document.querySelectorAll('.lab-evidence-row')).map(r => {
                const kind = r.querySelector('.le-value-kind').value;
                return {
                    // Order Information
                    orderCode: r.querySelector('.le-order-code')?.value.trim() || '',
                    orderName: r.querySelector('.le-order-name')?.value.trim() || '',
                    orderId: r.querySelector('.le-order-id')?.value.trim() || '',
                    orderTime: r.querySelector('.le-order-time')?.value.trim() || '',

                    // Test/Result Information
                    testCode: r.querySelector('.le-test-code')?.value.trim() || '',
                    testName: r.querySelector('.le-test-name')?.value.trim() || '',
                    valueKind: kind,
                    valueCode: r.querySelector('.le-value-code')?.value.trim() || '',
                    valueName: r.querySelector('.le-value-name')?.value.trim() || '',
                    qtyValue: r.querySelector('.le-qty-value')?.value.trim() || '',
                    qtyUnit: r.querySelector('.le-qty-unit')?.value.trim() || '',
                    textValue: r.querySelector('.le-text-value')?.value.trim() || '',
                    time: r.querySelector('.le-time')?.value.trim() || '',
                    status: r.querySelector('.le-status')?.value || '',
                    interpretation: r.querySelector('.le-interpretation')?.value || '',
                    referenceRange: r.querySelector('.le-reference-range')?.value.trim() || '',
                    isRCTC: isRCTCTriggerCode(r.querySelector('.le-test-code')?.value) ||
                            isRCTCTriggerCode(r.querySelector('.le-value-code')?.value) ||
                            isRCTCTriggerCode(r.querySelector('.le-order-code')?.value)
                };
            }).filter(x => x.testCode || x.testName || x.orderCode || x.orderName);
        }

        // Interpretation mapping
        function mapInterp(v) {
            switch ((v||'').toLowerCase()) {
                case 'positive': return 'POS';
                case 'negative': return 'NEG';
                case 'detected': return 'DET';
                case 'not detected': return 'NDET';
                case 'a': return 'A';
                case 'n': return 'N';
                case 'h': return 'H';
                case 'l': return 'L';
                default: return '';
            }
        }

        function getGlobalResultsProviders() {
            const v = id => (document.getElementById(id)?.value || '').trim();
            return {
                // Performing lab (organization)
                labCLIA:  v('resultLabCLIA'),
                labName:  v('resultLabName'),

                // Resulting performer (person)
                perfNPI:   v('resultPerformerNPI'),
                perfGiven: v('resultPerformerGiven'),
                perfFamily:v('resultPerformerFamily'),

                // Ordering provider (author)
                ordNPI:    v('resultOrderingNPI'),
                ordGiven:  v('resultOrderingGiven'),
                ordFamily: v('resultOrderingFamily'),
                ordTime:   v('resultAuthorTime')
            };
        }

function normalizeTS(raw) {
  const digits = String(raw || '').replace(/\D/g, '');
  if (digits.length >= 14) return digits.slice(0, 14); // YYYYMMDDHHMMSS
  if (digits.length >= 8)  return digits.slice(0, 8);  // YYYYMMDD
  // fall back to a safe date if empty/invalid; adjust if you prefer another default
  return '20240615';
}

function emitResultAuthorXML(ts) {
  const t = normalizeTS(ts);
  return `
    <author>
      <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
      <time value="${t}"/>
      <assignedAuthor>
        <id nullFlavor="UNK"/>
        <assignedPerson>
          <name><given>Unknown</given><family>Author</family></name>
        </assignedPerson>
      </assignedAuthor>
    </author>`;
}

// Build diagnosis table rows for the narrative text
function buildDiagnosisTableRows(data) {
    const diagnoses = data.diagnosisEvidence || [];
    console.log('buildDiagnosisTableRows called with:', diagnoses); // DEBUG LINE

    if (diagnoses.length === 0) {
        console.log('No diagnoses found, returning empty'); // DEBUG LINE
        return ''; // Return empty string, not a table row
    }

    const result = diagnoses.map(diagnosis =>
        `<tr><td>Diagnosis</td><td>${xmlEscape(diagnosis.diagnosisName || '')}</td><td>${xmlEscape(diagnosis.diagnosisCode || '')}</td><td>${xmlEscape(diagnosis.diagnosisDate || data.encounterDate)}</td><td>${diagnosis.isRCTC ? 'RCTC Trigger' : 'Active'}</td></tr>`
    ).join('');

    console.log('buildDiagnosisTableRows result:', result); // DEBUG LINE
    return result;
}

function generateDiagnosisEntries(data) {
    const diagnoses = data.diagnosisEvidence || [];
    console.log('generateDiagnosisEntries called with:', diagnoses);

    if (diagnoses.length === 0) {
        console.log('No diagnoses, returning empty comment');
        return '<!-- No diagnoses to report -->';
    }

    const result = diagnoses.map(diagnosis => {
        console.log('Processing diagnosis:', diagnosis);

        // Determine if this is an RCTC trigger code
        const isRCTCCode = isRCTCTriggerCode(diagnosis.diagnosisCode);

        // Get appropriate valueSet info for RCTC codes
        const valueSetInfo = isRCTCCode ? {
            oid: '2.16.840.1.113762.1.4.1146.2260',
            version: '2.0.1'
        } : null;

        return `
              <entryRelationship typeCode="SUBJ">
                <observation classCode="OBS" moodCode="EVN" negationInd="false">
                  <templateId root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.4" />
                  <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.3" />
                  <id root="${generateGUID()}" />
                  <code code="282291009" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT"
                    displayName="Diagnosis">
                    <translation code="29308-4" codeSystem="2.16.840.1.113883.6.1"
                      codeSystemName="LOINC" displayName="Diagnosis" />
                  </code>
                  <statusCode code="${diagnosis.status || 'completed'}" />
                  <effectiveTime><low value="${diagnosis.diagnosisDate || data.encounterDate}" /></effectiveTime>
                  ${diagnosis.diagnosisCode
                    ? `<value xsi:type="CD"
                            code="${xmlEscape(diagnosis.diagnosisCode)}"
                            codeSystem="2.16.840.1.113883.6.96"
                            codeSystemName="SNOMED CT"
                            displayName="${xmlEscape(diagnosis.diagnosisName)}"${valueSetInfo ? ` sdtc:valueSet="${valueSetInfo.oid}" sdtc:valueSetVersion="${valueSetInfo.version}"` : ''} />`
                    : `<value xsi:type="CD"
                            nullFlavor="UNK"
                            displayName="${xmlEscape(diagnosis.diagnosisName)}" />`
                  }
                </observation>
              </entryRelationship>`;
    }).join('');

    console.log('generateDiagnosisEntries result length:', result.length);
    return result;
}

// Build problems table rows for the narrative text
function buildProblemsTableRows(data) {
    const problems = data.problemEvidence || [];
    return problems.map(problem =>
        `<tr><td>Problem</td><td>${xmlEscape(problem.problemName || '')}</td><td>${xmlEscape(problem.problemCode || '')}</td><td>${xmlEscape(problem.onsetDate || '')}</td><td>${xmlEscape(problem.status || 'active')}</td></tr>`
    ).join('');
}

function generateProblemEntries(data) {
    const problems = data.problemEvidence || [];

    if (problems.length === 0) return '';

    return problems.map(problem => `
        <entryRelationship typeCode="SUBJ">
            <observation classCode="OBS" moodCode="EVN">
                <templateId root="2.16.840.1.113883.10.20.22.4.4" />
                <templateId root="2.16.840.1.113883.10.20.22.4.4" extension="2015-08-01"/>
                <id root="${generateGUID()}"/>
                <code code="55607006" displayName="Problem"
                      codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT">
                    <translation code="75326-9" codeSystem="2.16.840.1.113883.6.1"
                               codeSystemName="LOINC" displayName="Problem"/>
                </code>
                <text>
                    <reference value="#Problem${problem.problemCode}"/>
                </text>
                <statusCode code="completed"/>
                <effectiveTime>
                    <low value="${problem.onsetDate || data.encounterDate}"/>
                </effectiveTime>
                ${problem.problemCode
                    ? `<value xsi:type="CD" code="${xmlEscape(problem.problemCode)}"
                            codeSystem="2.16.840.1.113883.6.96"
                            codeSystemName="SNOMED CT"
                            displayName="${xmlEscape(problem.problemName)}"/>`
                    : `<value xsi:type="CD" nullFlavor="UNK"
                            displayName="${xmlEscape(problem.problemName)}"/>`
                }
            </observation>
        </entryRelationship>`).join('');
}

function buildResultsSectionXML(labEvidence, rctcVersion = '2016-12-01') {
  if (!labEvidence || labEvidence.length === 0) return '';

  const esc = s => xmlEscape(s || '');
  const data = getFormData(); // Get current form data for provider info

  const obsXml = labEvidence.map(le => {
    const id = generateGUID();
    const vsOID = '2.16.840.1.114222.4.11.7508';

    // Use test code as primary, fall back to order code
    const primaryCode = le.testCode || le.orderCode || '';
    const primaryName = le.testName || le.orderName || '';

    const codeAttrs = [
  primaryCode ? `code="${esc(primaryCode)}"` : 'nullFlavor="UNK"',
  `codeSystem="2.16.840.1.113883.6.1"`,
  `codeSystemName="LOINC"`,
  primaryName ? `displayName="${esc(primaryName)}"` : null,
  `sdtc:valueSet="${vsOID}" sdtc:valueSetVersion="${esc(rctcVersion)}"`
].filter(Boolean).join(' ');

    // Build <value> based on valueKind
    let valueXml = `<value xsi:type="CD" nullFlavor="UNK"/>`;
    if (le.valueKind === 'coded' && le.valueCode) {
      const vsPair = le.isRCTC ? ` sdtc:valueSet="${esc(vsOID)}" sdtc:valueSetVersion="${esc(rctcVersion)}"` : '';
      valueXml = `<value xsi:type="CD"
             code="${esc(le.valueCode)}"
             ${le.valueName ? `displayName="${esc(le.valueName)}"` : ''}
             codeSystem="2.16.840.1.113883.6.96"
             codeSystemName="SNOMED CT"${vsPair}/>`;
    } else if (le.valueKind === 'quantity' && le.qtyValue) {
      valueXml = `<value xsi:type="PQ" value="${esc(le.qtyValue)}"${le.qtyUnit ? ` unit="${esc(le.qtyUnit)}"` : ''}/>`;
    } else if (le.valueKind === 'text' && le.textValue) {
      valueXml = `<value xsi:type="ST">${esc(le.textValue)}</value>`;
    }

    // Interpretation
    const interpCode = mapInterp(le.interpretation);
    const interp = interpCode
      ? `<interpretationCode code="${interpCode}" codeSystem="2.16.840.1.113883.5.83"/>`
      : '';

    // Reference Range
   // Reference Range
const refRange = le.referenceRange
  ? `<referenceRange>
      <observationRange>
        <text>${esc(le.referenceRange)}</text>
        <value xsi:type="ST">${esc(le.referenceRange)}</value>
      </observationRange>
    </referenceRange>`
  : '';

    // Build Author (Ordering Provider)
    const orderingAuthor = (data.resultOrderingNPI || data.resultOrderingGiven || data.resultOrderingFamily) ? `
      <author>
        <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
        <time value="${esc(normalizeTS(le.orderTime || le.time || data.encounterDate))}"/>
        <assignedAuthor>
          ${data.resultOrderingNPI ? `<id extension="${esc(data.resultOrderingNPI)}" root="2.16.840.1.113883.4.6"/>` : `<id nullFlavor="UNK"/>`}
          <assignedPerson>
            <name>
              ${data.resultOrderingGiven ? `<given>${esc(data.resultOrderingGiven)}</given>` : ''}
              ${data.resultOrderingFamily ? `<family>${esc(data.resultOrderingFamily)}</family>` : ''}
            </name>
          </assignedPerson>
        </assignedAuthor>
      </author>` : `
      <author>
        <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
        <time value="${esc(normalizeTS(le.time || data.encounterDate))}"/>
        <assignedAuthor>
          <id extension="${esc(data.providerId || '1234567890')}" root="2.16.840.1.113883.4.6"/>
          <assignedPerson>
            <name>
              <given>${esc((data.providerName || 'Unknown').split(' ')[0])}</given>
              <family>${esc((data.providerName || 'Unknown').split(' ').slice(1).join(' ') || 'Provider')}</family>
            </name>
          </assignedPerson>
        </assignedAuthor>
      </author>`;

    // Build Performer (Lab/Resulting Performer)
    const performer = (data.resultPerformerNPI || data.resultPerformerGiven || data.resultPerformerFamily || data.resultLabName) ? `
      <performer typeCode="PRF">
        <assignedEntity>
          ${data.resultPerformerNPI ? `<id extension="${esc(data.resultPerformerNPI)}" root="2.16.840.1.113883.4.6"/>` : `<id nullFlavor="UNK"/>`}
          ${(data.resultPerformerGiven || data.resultPerformerFamily) ? `
          <assignedPerson>
            <name>
              ${data.resultPerformerGiven ? `<given>${esc(data.resultPerformerGiven)}</given>` : ''}
              ${data.resultPerformerFamily ? `<family>${esc(data.resultPerformerFamily)}</family>` : ''}
            </name>
          </assignedPerson>` : ''}
          ${(data.resultLabName || data.resultLabCLIA) ? `
          <representedOrganization>
            ${data.resultLabCLIA ? `<id extension="${esc(data.resultLabCLIA)}" root="2.16.840.1.113883.4.7"/>` : ''}
            ${data.resultLabName ? `<name>${esc(data.resultLabName)}</name>` : ''}
          </representedOrganization>` : ''}
        </assignedEntity>
      </performer>` : '';

    // Effective Time
    const effectiveTimeXml = le.time
      ? `<effectiveTime value="${esc(normalizeTS(le.time))}"/>`
      : `<effectiveTime nullFlavor="UNK"/>`;

    return `
      <entry>
        <organizer classCode="CLUSTER" moodCode="EVN">
          <!-- Result Organizer (V3) -->
          <templateId root="2.16.840.1.113883.10.20.22.4.1" extension="2015-08-01"/>
          <id root="${id}"/>
          <code ${codeAttrs}/>
          <statusCode code="completed"/>
          ${le.orderTime ? `<effectiveTime><low value="${esc(normalizeTS(le.orderTime))}"/><high value="${esc(normalizeTS(le.orderTime))}"/></effectiveTime>` : ''}

          ${(le.orderCode && le.orderName && le.orderCode !== le.testCode) ? `
          <!-- Lab Order Information -->
          <component>
            <procedure classCode="PROC" moodCode="RQO">
              <!-- Lab Order Procedure -->
              <templateId root="2.16.840.1.113883.10.20.22.4.41"/>
              <id root="${generateGUID()}"${le.orderId ? ` extension="${esc(le.orderId)}"` : ''}/>
              <code code="${esc(le.orderCode)}" codeSystem="2.16.840.1.113883.6.1"
                    displayName="${esc(le.orderName)}"/>
              <statusCode code="completed"/>
              ${le.orderTime ? `<effectiveTime><low value="${esc(normalizeTS(le.orderTime))}"/></effectiveTime>` : ''}
              ${orderingAuthor}
            </procedure>
          </component>` : ''}

          <!-- Result Observation -->
          <component>
            <observation classCode="OBS" moodCode="EVN">
              <!-- Result Observation (V3) -->
              <templateId root="2.16.840.1.113883.10.20.22.4.2"/>
              <templateId root="2.16.840.1.113883.10.20.22.4.2" extension="2015-08-01"/>
              <!-- Initial Case Report Trigger Code Result Observation (eICR) -->
              <templateId root="2.16.840.1.113883.10.20.15.2.3.2" extension="2016-12-01"/>
              <id root="${id}"/>
              <code ${codeAttrs}/>
              <statusCode code="${esc(le.status || 'completed')}"/>
              ${effectiveTimeXml}
              ${valueXml}
              ${interp}
              ${refRange}
              ${performer}
              ${orderingAuthor}
            </observation>
          </component>
        </organizer>
      </entry>`;
  }).join('\n');

  // Build narrative table that matches the actual data
  const narrative = labEvidence.map(le => {
    let displayValue = '';
    if (le.valueKind === 'coded') {
      displayValue = le.valueName || le.valueCode || '';
    } else if (le.valueKind === 'quantity') {
      displayValue = `${le.qtyValue || ''} ${le.qtyUnit || ''}`.trim();
    } else if (le.valueKind === 'text') {
      displayValue = le.textValue || '';
    }

    return `
    <tr>
      <td>${esc(le.orderName || le.orderCode || 'N/A')}</td>
      <td>${esc(le.testName || le.testCode || 'N/A')}</td>
      <td>${esc(displayValue)}</td>
      <td>${esc(le.referenceRange || 'N/A')}</td>
      <td>${esc(le.status || 'completed')}</td>
      <td>${esc(le.time || 'N/A')}</td>
    </tr>`;
  }).join('');

  return `
    <component>
      <section>
        <!-- Results Section (entries required) -->
        <templateId root="2.16.840.1.113883.10.20.22.2.3.1" extension="2015-08-01"/>
        <code code="30954-2" codeSystem="2.16.840.1.113883.6.1" displayName="Relevant diagnostic tests and/or laboratory data"/>
        <title>Lab Orders and Results</title>
        <text>
          <table border="1">
            <thead>
              <tr>
                <th>Order</th>
                <th>Test</th>
                <th>Value</th>
                <th>Reference Range</th>
                <th>Status</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody>${narrative}</tbody>
          </table>
        </text>
        ${obsXml}
      </section>
    </component>`;
}


        function buildEICRXml() {
            // Run comprehensive DQ Schematron validation first
            if (!validateFormData()) {
                throw new Error('Form data does not pass DQ Schematron validation. Please correct the errors and try again.');
            }
            
            const data = getFormData();
            
            // Additional CDA-specific validation
            if (!data.patientId || !data.patientName || !data.providerId) {
                throw new Error('Missing required patient or provider information for CDA generation');
            }
            
            if (!data.providerPhone) {
                throw new Error('Provider phone is required for author telecom compliance (CONF:1198-5428)');
            }
            
            if (!data.facilityAddress || !data.patientCity || !data.patientState || !data.patientZip) {
                throw new Error('Complete facility address is required for US Realm compliance (CONF:1198-5452)');
            }
            
            const cdaTemplate = `<?xml version="1.0" encoding="UTF-8"?>
<!-- 
  HL7 CDA-compliant eICR Document
  Generated by eICR Form Generator v1.0

-->
<ClinicalDocument xmlns="urn:hl7-org:v3" xmlns:cda="urn:hl7-org:v3" xmlns:sdtc="urn:hl7-org:sdtc"
  xmlns:voc="http://www.lantanagroup.com/voc"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="urn:hl7-org:v3 ../../schema/infrastructure/cda/CDA_SDTC.xsd">
  <realmCode code="US" />
  <typeId extension="POCD_HD000040" root="2.16.840.1.113883.1.3" />
  <templateId root="2.16.840.1.113883.10.20.22.1.1" />
  <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.1.1" />
  <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2" />
  <templateId extension="2022-05-01" root="2.16.840.1.113883.10.20.15.2" />
  <id root="${data.documentId}" />
  <code code="55751-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
    displayName="Public Health Case Report" />
  <title>Initial Public Health Case Report</title>
  <effectiveTime value="${data.effectiveTime}" />
  <confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25" displayName="Normal" />
  <languageCode code="en-US" />
  <setId extension="${getEffectiveSetId(data)}" root="1.2.840.114350.1.13.380.3.7.1.1" />
  <versionNumber value="${data.versionNumber}" />
  ${generateRelatedDocumentXml(data)}
  
  <!-- Patient Information -->
 <recordTarget>
    <patientRole>
      <id extension="${data.patientId}" root="2.16.840.1.113883.19.5" />
      <addr use="H">
        <streetAddressLine>${data.patientAddress}</streetAddressLine>
        <city>${data.patientCity}</city>
        <state>${data.patientState}</state>
        <postalCode>${data.patientZip}</postalCode>
        <county>${data.patientCounty}</county>
        <country>${data.patientCountry || 'US'}</country>
      </addr>
      <telecom use="MC" value="tel:${data.patientPhone}" />
      <telecom use="WP" value="mailto:${data.patientEmail}" />
    <patient>
      <!-- CDA Schema Compliant Patient Element Order -->
      <name use="L">
        <given>${data.patientName.split(' ')[0]}</given>
        <family>${data.patientName.split(' ').slice(1).join(' ')}</family>
      </name>
      <administrativeGenderCode code="${data.patientGender}" codeSystem="2.16.840.1.113883.5.1"
        displayName="${data.patientGender === 'F' ? 'Female' : 'Male'}" />
      <birthTime value="${data.patientBirthDate}" />
<sdtc:deceasedInd value="${data.patientDeathIndicator || 'false'}" />
      ${data.patientDeathDate ? `<sdtc:deceasedTime value="${data.patientDeathDate}" />` : ''}

      <raceCode code="${data.patientRace}" codeSystem="2.16.840.1.113883.6.238"
        codeSystemName="Race and Ethnicity - CDC" displayName="${getRaceDisplayName(data.patientRace)}" />
      ${data.patientDetailedRace ? `<sdtc:raceCode code="${data.patientDetailedRace}" codeSystem="2.16.840.1.113883.6.238" />` : ''}
      <ethnicGroupCode code="${data.patientEthnicity}" codeSystem="2.16.840.1.113883.6.238"
        codeSystemName="Race and Ethnicity - CDC" displayName="${getEthnicityDisplayName(data.patientEthnicity)}" />
      ${data.patientDetailedEthnicity ? `<sdtc:ethnicGroupCode code="${data.patientDetailedEthnicity}" codeSystem="2.16.840.1.113883.6.238" />` : ''}
      <maritalStatusCode code="S" codeSystem="2.16.840.1.113883.5.2" 
                     codeSystemName="MaritalStatus" displayName="Never Married"/>
      ${data.guardianName ? `
      <guardian>
        <code code="${data.guardianCode || 'GUARD'}" codeSystem="2.16.840.1.113883.11.20.12.1" />
        <addr use="H">
          <streetAddressLine>${data.guardianAddress || ''}</streetAddressLine>
          <city>${data.guardianCity || ''}</city>
          <state>${data.guardianState || ''}</state>
          <postalCode>${data.guardianZip || ''}</postalCode>
          <country>US</country>
        </addr>
        ${data.guardianPhone ? `<telecom use="HP" value="tel:${data.guardianPhone}" />` : ''}
        ${data.guardianEmail ? `<telecom use="WP" value="mailto:${data.guardianEmail}" />` : ''}
        <guardianPerson>
          <name use="L">
            <given>${data.guardianName.split(' ')[0] || ''}</given>
            <family>${data.guardianName.split(' ').slice(1).join(' ') || ''}</family>
          </name>
        </guardianPerson>
      </guardian>` : ''}
      <birthplace>
  <place>
    <addr>
      <streetAddressLine>${data.patientBirthPlaceFacility || ''}</streetAddressLine>
      <city>${data.patientBirthPlaceCity || data.patientCity}</city>
      <state>${data.patientBirthPlaceState || data.patientState}</state>
      <country>${data.patientBirthPlaceCountry || data.patientCountry || 'US'}</country>
    </addr>
    ${data.patientBirthPlaceFacility ? `<name>${data.patientBirthPlaceFacility}</name>` : ''}
  </place>
</birthplace>
      <languageCommunication>
  <languageCode code="${data.patientLanguage || 'en'}" />
  <preferenceInd value="true" />
  <proficiencyLevelCode code="G" 
                       codeSystem="2.16.840.1.113883.5.61" 
                       displayName="Good"/>
</languageCommunication>
      
    </patient>
    </patientRole>
  </recordTarget>

  <!-- Provider Information -->
  <author>
    <time value="${data.effectiveTime}" />
    <assignedAuthor>
      <id extension="${data.providerId}" root="2.16.840.1.113883.4.6" />
      <addr use="WP">
        <streetAddressLine>${data.facilityAddress}</streetAddressLine>
        <city>${data.patientCity}</city>
        <state>${data.patientState}</state>
        <postalCode>${data.patientZip}</postalCode>
        <country>US</country>
      </addr>
      <telecom use="WP" value="tel:${data.providerPhone}" />
      ${data.providerEmail ? `<telecom use="WP" value="mailto:${data.providerEmail}" />` : ''}
      <assignedAuthoringDevice>
        <manufacturerModelName>eICR Generator - Version 1.0</manufacturerModelName>
        <softwareName>eICR Generator - Version 1.0</softwareName>
      </assignedAuthoringDevice>
      <representedOrganization>
        <id extension="${data.organizationId || data.facilityId || data.providerId}" root="2.16.840.1.113883.4.6" />
        <name>${data.organizationName || data.facilityName}</name>
        <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}" />
        <addr use="WP">
          <streetAddressLine>${data.organizationAddress || data.facilityAddress}</streetAddressLine>
          <city>${data.patientCity}</city>
          <state>${data.patientState}</state>
          <postalCode>${data.patientZip}</postalCode>
          <country>US</country>
        </addr>
      </representedOrganization>
    </assignedAuthor>
  </author>

  <custodian>
    <assignedCustodian>
      <representedCustodianOrganization>
        <id extension="${data.organizationId || data.facilityId}" root="2.16.840.1.113883.4.6" />
        <name>${data.organizationName || data.facilityName}</name>
        <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}" />
        <addr use="WP">
          <streetAddressLine>${data.organizationAddress || data.facilityAddress}</streetAddressLine>
          <city>${data.patientCity}</city>
          <state>${data.patientState}</state>
          <postalCode>${data.patientZip}</postalCode>
          <country>US</country>
        </addr>
      </representedCustodianOrganization>
    </assignedCustodian>
  </custodian>

  // Find this section in your buildEICRXml() function and replace it:

<!-- Encounter Information -->
<componentOf>
  <encompassingEncounter>
    <id extension="${data.encounterId}" root="2.16.840.1.113883.19" />
    <code code="${data.encounterType}" codeSystem="2.16.840.1.113883.5.4"
      codeSystemName="HL7 ActEncounterCode" displayName="Ambulatory" />
    <effectiveTime>
      <low value="${data.encounterDate}" />
      <high value="${data.encounterEndDate || data.encounterDate}" />
    </effectiveTime>
    ${data.encounterDisposition ? `<dischargeDispositionCode code="${data.encounterDisposition}" codeSystem="2.16.840.1.113883.12.112" />` : ''}
    <responsibleParty>
      <assignedEntity>
        <id extension="${data.providerId}" root="2.16.840.1.113883.4.6" />
        <addr use="WP">
          <streetAddressLine>${data.facilityAddress}</streetAddressLine>
          <city>${data.patientCity}</city>
          <state>${data.patientState}</state>
          <postalCode>${data.patientZip}</postalCode>
          <country>US</country>
        </addr>
        <telecom use="WP" value="tel:${data.providerPhone}" />
        ${data.providerEmail ? `<telecom use="WP" value="mailto:${data.providerEmail}" />` : `<telecom use="WP" value="mailto:provider@example.com" />`}
        ${data.providerFax ? `<telecom use="WP" value="fax:${data.providerFax}" />` : `<telecom use="WP" value="fax:+1-555-777-0124" />`}
        <assignedPerson>
          <name>
            <given>${data.providerName.split(' ')[1] || 'Unknown'}</given>
            <family>${data.providerName.split(' ')[2] || 'Provider'}</family>
          </name>
        </assignedPerson>
        <representedOrganization>
          <name>${data.facilityName}</name>
          <addr use="WP">
            <streetAddressLine>${data.facilityAddress}</streetAddressLine>
            <city>${data.patientCity}</city>
            <state>${data.patientState}</state>
            <postalCode>${data.patientZip}</postalCode>
            <country>US</country>
          </addr>
          <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}" />
          ${data.organizationEmail ? `<telecom use="WP" value="mailto:${data.organizationEmail}" />` : ''}
        </representedOrganization>
      </assignedEntity>
    </responsibleParty>
    <location>
      <healthCareFacility>
        <id extension="${data.facilityId || data.providerId}" root="2.16.840.1.113883.4.6" />
        <code code="${data.facilityTypeCode || 'OF'}" codeSystem="2.16.840.1.113883.5.111"
          codeSystemName="HL7RoleCode" displayName="Healthcare Facility" />
        <location>
          <name>${data.facilityName}</name>
          <addr use="WP">
            <streetAddressLine>${data.facilityAddress}</streetAddressLine>
            <city>${data.patientCity}</city>
            <state>${data.patientState}</state>
            <postalCode>${data.patientZip}</postalCode>
            <country>US</country>
          </addr>
        </location>
        <serviceProviderOrganization>
          <id extension="${data.organizationId || data.facilityId}" root="2.16.840.1.113883.4.6" />
          <name>${data.organizationName || data.facilityName}</name>
          <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}" />
          ${data.organizationEmail ? `<telecom use="WP" value="mailto:${data.organizationEmail}" />` : ''}
          ${data.organizationFax ? `<telecom use="WP" value="fax:${data.organizationFax}" />` : ''}
          <addr use="WP">
            <streetAddressLine>${data.organizationAddress || data.facilityAddress}</streetAddressLine>
            <city>${data.patientCity}</city>
            <state>${data.patientState}</state>
            <postalCode>${data.patientZip}</postalCode>
            <country>US</country>
          </addr>
        </serviceProviderOrganization>
      </healthCareFacility>
    </location>
  </encompassingEncounter>
</componentOf>

  <component>
    <structuredBody>
      <!-- Encounters Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.22" />
          <templateId root="2.16.840.1.113883.10.20.22.2.22" extension="2015-08-01" />
          <templateId root="2.16.840.1.113883.10.20.22.2.22.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.22.1" extension="2015-08-01" />
          <code code="46240-8" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
            displayName="History of encounters" />
          <title>Encounters</title>
          <text>
            <table>
              <thead>
                <tr><th>Encounter</th><th>Date</th><th>Location</th></tr>
              </thead>
              <tbody><tr><td>Office outpatient visit</td><td>${data.encounterDate}</td><td>${data.facilityName}</td></tr></tbody>
            </table>
          </text>
          <entry typeCode="DRIV">
            <encounter classCode="ENC" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.49" />
              <templateId root="2.16.840.1.113883.10.20.22.4.49" extension="2015-08-01" />
              <id root="2.16.840.1.113883.19.${data.encounterId}" />
              <code code="99213" codeSystem="2.16.840.1.113883.6.12" codeSystemName="CPT-4"
      displayName="Office outpatient visit">
    <originalText>Office outpatient visit</originalText>
</code>
              <effectiveTime>
                <low value="${data.encounterDate}" />
                <high value="${data.encounterDate}" />
              </effectiveTime>
              <participant typeCode="LOC">
    <participantRole classCode="SDLOC">
      <templateId root="2.16.840.1.113883.10.20.22.4.32"/>
      <id root="2.16.840.1.113883.4.6" extension="${data.facilityId || data.organizationId}"/>
      <code code="${data.facilityTypeCode || 'OF'}" 
            codeSystem="2.16.840.1.113883.5.111" 
            displayName="Outpatient facility"/>
      <addr use="WP">
        <streetAddressLine>${data.facilityAddress}</streetAddressLine>
        <city>${data.patientCity}</city>
        <state>${data.patientState}</state>
        <postalCode>${data.patientZip}</postalCode>
        <country>US</country>
      </addr>
      <telecom use="WP" value="tel:${data.organizationPhone || data.providerPhone}"/>
      <playingEntity classCode="PLC">
        <name>${data.facilityName}</name>
      </playingEntity>
    </participantRole>
  </participant>
            </encounter>
          </entry>
        </section>
      </component>

         ${buildSpecimenSection(data)}  

      <!-- Reason for Visit Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.12" />
          <code code="29299-5" codeSystem="2.16.840.1.113883.6.1" displayName="Reason for visit" />
          <title>Reason for visit</title>
          <text>${data.chiefComplaint}</text>
        </section>
      </component>

      <!-- History of Present Illness -->
      <component>
        <section>
          <templateId root="1.3.6.1.4.1.19376.1.5.3.1.3.4" />
          <code code="10164-2" codeSystem="2.16.840.1.113883.6.1" displayName="History of Present Illness" />
          <title>History of Present Illness</title>
          <text>${data.presentIllness}</text>
        </section>
      </component>

      <!-- Medications Administered Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.38" />
          <templateId extension="2014-06-09" root="2.16.840.1.113883.10.20.22.2.38" />
          <code code="29549-3" codeSystem="2.16.840.1.113883.6.1"
            codeSystemName="LOINC" displayName="Medications Administered" />
          <title>Medications Administered</title>
          <text>
      <table border="1" width="100%">
        <thead>
          <tr>
            <th>Medication</th>
            <th>Dose</th>
            <th>Route</th>
            <th>Administration Time</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <content ID="MedAdministered_1">${data.adminMed1Name}</content>
            </td>
            <td>${data.adminMed1DoseValue} ${data.adminMed1DoseUnit}${data.adminMed1VolValue ? ` (${data.adminMed1VolValue} ${data.adminMed1VolUnit})` : ''}</td>
            <td>${data.adminMed1Route}</td>
            <td>${data.adminMed1Time}</td>
            <td>${data.adminMed1Negated ? 'Not Given' : data.adminMed1Status}</td>
          </tr>
          <tr>
            <td>
              <content ID="MedAdministered_2">${data.adminMed2Name}</content>
            </td>
            <td>${data.adminMed2DoseValue} ${data.adminMed2DoseUnit}${data.adminMed2VolValue ? ` (${data.adminMed2VolValue} ${data.adminMed2VolUnit})` : ''}</td>
            <td>${data.adminMed2Route}</td>
            <td>${data.adminMed2Time}</td>
            <td>${data.adminMed2Negated ? 'Not Given' : data.adminMed2Status}</td>
          </tr>
        </tbody>
      </table>
    </text>
    
    <!-- First Medication Entry -->
    <entry typeCode="DRIV">
      <substanceAdministration classCode="SBADM" moodCode="EVN" ${data.adminMed1Negated ? 'negationInd="true"' : ''}>
        <templateId root="2.16.840.1.113883.10.20.22.4.16" extension="2014-06-09" />
        <id extension="${data.adminMed1Id}" root="2.16.840.1.113883.19.5.99999.1" />
        <statusCode code="${data.adminMed1Status}" />
        <effectiveTime value="${data.adminMed1Time}" />
        <routeCode code="${data.adminMed1Route}" codeSystem="2.16.840.1.113883.3.26.1.1">
  <translation code="${getRouteTranslation(data.adminMed1Route).code}" 
               codeSystem="2.16.840.1.113883.6.96" 
               displayName="${getRouteTranslation(data.adminMed1Route).display}"/>
</routeCode>
        <doseQuantity value="${data.adminMed1DoseValue}" unit="${fixDoseUnit(data.adminMed1DoseUnit)}" />
        ${data.adminMed1VolValue ? `<maxDoseQuantity><numerator value="${data.adminMed1VolValue}" unit="${data.adminMed1VolUnit}" /></maxDoseQuantity>` : ''}
        <author>
      <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
      <time value="20240615120000"/>
      <assignedAuthor>
        <id extension="${data.providerId}" root="2.16.840.1.113883.4.6"/>
        <code code="${getProviderTaxonomyCode('physician').code}" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="${getProviderTaxonomyCode('physician').display}"/>
        <assignedPerson>
          <name>
            <given>${data.providerName.split(' ')[1] || 'Unknown'}</given>
            <family>${data.providerName.split(' ')[2] || 'Provider'}</family>
          </name>
        </assignedPerson>
      </assignedAuthor>
    </author>
        <consumable>
          <manufacturedProduct classCode="MANU">
            <templateId root="2.16.840.1.113883.10.20.22.4.23" extension="2014-06-09"/>
            <manufacturedMaterial>
              <code code="${data.adminMed1Code}" codeSystem="2.16.840.1.113883.6.88">
                <originalText>
                  <reference value="#MedAdministered_1" />
                </originalText>
              </code>
              <name>${data.adminMed1Name}</name>
            </manufacturedMaterial>
          </manufacturedProduct>
        </consumable>
         ${ (data.administeringProviderNPI || data.administeringProviderGiven || data.administeringProviderFamily) ? `
    <performer typeCode="PRF">
      <assignedEntity>
        ${data.administeringProviderNPI ? `<id root="2.16.840.1.113883.4.6" extension="${data.administeringProviderNPI}"/>` : ''}
        ${data.administeringProviderPhone ? `<telecom use="WP" value="tel:${data.administeringProviderPhone}"/>` : ''}
        <assignedPerson>
          <name>
            ${data.administeringProviderGiven ? `<given>${data.administeringProviderGiven}</given>` : ''}
            ${data.administeringProviderMiddle ? `<given>${data.administeringProviderMiddle}</given>` : ''}
            ${data.administeringProviderFamily ? `<family>${data.administeringProviderFamily}</family>` : ''}
          </name>
        </assignedPerson>
        ${data.administeringProviderOrgName ? `
        <representedOrganization>
          ${data.administeringProviderOrgId ? `<id root="${data.administeringProviderOrgIdRoot || '2.16.840.1.113883.19'}" extension="${data.administeringProviderOrgId}"/>` : ''}
          <name>${data.administeringProviderOrgName}</name>
        </representedOrganization>` : ''}
      </assignedEntity>
    </performer>` : '' }
      </substanceAdministration>
    </entry>
    
    <!-- Second Medication Entry -->
    <entry typeCode="DRIV">
      <substanceAdministration classCode="SBADM" moodCode="EVN" ${data.adminMed2Negated ? 'negationInd="true"' : ''}>
        <templateId root="2.16.840.1.113883.10.20.22.4.16" extension="2014-06-09" />
        <id extension="${data.adminMed2Id}" root="2.16.840.1.113883.19.5.99999.1" />
        <statusCode code="${data.adminMed2Status}" />
        <effectiveTime value="${data.adminMed2Time}" />      
  <routeCode code="${data.adminMed2Route}" codeSystem="2.16.840.1.113883.3.26.1.1">
  <translation code="${getRouteTranslation(data.adminMed2Route).code}" 
               codeSystem="2.16.840.1.113883.6.96" 
               displayName="${getRouteTranslation(data.adminMed2Route).display}"/>
</routeCode>
        <doseQuantity value="${data.adminMed2DoseValue}" unit="${data.adminMed2DoseUnit === '1' || data.adminMed2DoseUnit === 'each' ? 'mg' : data.adminMed2DoseUnit}" />
        ${data.adminMed2VolValue ? `<maxDoseQuantity><numerator value="${data.adminMed2VolValue}" unit="${data.adminMed2VolUnit}" /></maxDoseQuantity>` : ''}
        <author>
      <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
      <time value="20240615120000"/>
      <assignedAuthor>
        <id extension="${data.providerId}" root="2.16.840.1.113883.4.6"/>
        <code code="${getProviderTaxonomyCode('physician').code}" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="${getProviderTaxonomyCode('physician').display}"/>
        <assignedPerson>
          <name>
            <given>${data.providerName.split(' ')[1] || 'Unknown'}</given>
            <family>${data.providerName.split(' ')[2] || 'Provider'}</family>
          </name>
        </assignedPerson>
      </assignedAuthor>
    </author>
        <consumable>
          <manufacturedProduct classCode="MANU">
            <templateId root="2.16.840.1.113883.10.20.22.4.23" extension="2014-06-09"/>
            <manufacturedMaterial>
              <code code="${data.adminMed2Code}" codeSystem="2.16.840.1.113883.6.88">
                <originalText>
                  <reference value="#MedAdministered_2" />
                </originalText>
              </code>
              <name>${data.adminMed2Name}</name>
            </manufacturedMaterial>
          </manufacturedProduct>
        </consumable>
         ${ (data.administeringProviderNPI || data.administeringProviderGiven || data.administeringProviderFamily) ? `
    <performer typeCode="PRF">
      <assignedEntity>
        ${data.administeringProviderNPI ? `<id root="2.16.840.1.113883.4.6" extension="${data.administeringProviderNPI}"/>` : ''}
        ${data.administeringProviderPhone ? `<telecom use="WP" value="tel:${data.administeringProviderPhone}"/>` : ''}
        <assignedPerson>
          <name>
            ${data.administeringProviderGiven ? `<given>${data.administeringProviderGiven}</given>` : ''}
            ${data.administeringProviderMiddle ? `<given>${data.administeringProviderMiddle}</given>` : ''}
            ${data.administeringProviderFamily ? `<family>${data.administeringProviderFamily}</family>` : ''}
          </name>
        </assignedPerson>
        ${data.administeringProviderOrgName ? `
        <representedOrganization>
          ${data.administeringProviderOrgId ? `<id root="${data.administeringProviderOrgIdRoot || '2.16.840.1.113883.19'}" extension="${data.administeringProviderOrgId}"/>` : ''}
          <name>${data.administeringProviderOrgName}</name>
        </representedOrganization>` : ''}
      </assignedEntity>
    </performer>` : '' }
      </substanceAdministration>
    </entry>
        </section>
      </component>

      <!-- Problem List Section (includes both Problems and Diagnoses) -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.5" />
          <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.5" />
          <templateId root="2.16.840.1.113883.10.20.22.2.5.1" />
          <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.5.1" />
          <code code="11450-4" codeSystem="2.16.840.1.113883.6.1" displayName="Problem List" />
          <title>Problem List</title>
          <text>
            <table>
              <thead>
                <tr><th>Type</th><th>Name</th><th>Code</th><th>Date</th><th>Status</th></tr>
              </thead>
              <tbody>
                ${buildDiagnosisTableRows(data)}
                ${buildProblemsTableRows(data)}
              </tbody>
            </table>
          </text>
          <entry typeCode="DRIV">
            <act classCode="ACT" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.3" />
              <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.3" />
              <id root="a1c0c380-eacc-4b40-9207-85164185558d" />
              <code code="CONC" codeSystem="2.16.840.1.113883.5.6" displayName="Concern" />
              <statusCode code="active" />
              <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
              <author>
                <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
                <time value="20240615"/>
                <assignedAuthor>
                  <id extension="1234567890" root="2.16.840.1.113883.4.6"/>
                  <code code="207Q00000X"
                        codeSystem="2.16.840.1.113883.6.101"
                        displayName="Family Medicine Physician"/>
                  <assignedPerson>
                    <name>
                      <given>Royce</given>
                      <family>Hemlock</family>
                    </name>
                  </assignedPerson>
                </assignedAuthor>
              </author>
              ${generateDiagnosisEntries(data)}
              ${generateProblemEntries(data)}
            </act>
          </entry>
        </section>
      </component>

      <!-- Replace existing Results Section with Lab Evidence -->
     ${(data.labEvidence && data.labEvidence.length)
  ? buildResultsSectionXML(data.labEvidence, '2016-12-01')
  : `<!-- Fallback Results Section for Legacy Support -->
     <component>
       <section>
         <templateId root="2.16.840.1.113883.10.20.22.2.3" />
         <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.3" />
         <templateId root="2.16.840.1.113883.10.20.22.2.3.1" />
         <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.3.1" />
         <code code="30954-2" codeSystem="2.16.840.1.113883.6.1" displayName="Relevant diagnostic tests and/or laboratory data" />
         <title>Results</title>
         <text>
           <table>
             <thead>
               <tr><th>Test</th><th>Result</th><th>Date</th><th>RCTC Trigger</th></tr>
             </thead>
             <tbody>
               <tr><td>${data.labTest1Name || ''}</td><td>${data.labTest1Result || ''}</td><td>${data.encounterDate || ''}</td><td>Yes</td></tr>
               <tr><td>${data.labTest2Name || ''}</td><td>${data.labTest2Result || ''}</td><td>${data.encounterDate || ''}</td><td>Yes</td></tr>
             </tbody>  
           </table>
         </text>
         
         <!-- COVID-19 Test Result with RCTC Trigger Code Template -->
         <entry typeCode="DRIV">
           <organizer classCode="BATTERY" moodCode="EVN">
             <templateId root="2.16.840.1.113883.10.20.22.4.1" />
             <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.1" />
             <id root="2047cca3-559f-45da-8775-406538fa4815" />
             <code code="${data.labTest1Code || ''}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
               displayName="${data.labTest1Name || ''}" />
             <statusCode code="completed" />
             <effectiveTime>
               <low value="${data.encounterDate || ''}" />
               <high value="${data.encounterDate || ''}" />
             </effectiveTime>
               <author>
            <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
            <time value="20240615"/>
            <assignedAuthor>
              <id extension="1234567890" root="2.16.840.1.113883.4.6"/>
              <code code="207Q00000X" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="Family Medicine Physician"/>
              <assignedPerson>
                <name>
                  <given>Royce</given>
                  <family>Hemlock</family>
                </name>
              </assignedPerson>
            </assignedAuthor>
          </author>
             <component>
               <observation classCode="OBS" moodCode="EVN">
                 <templateId root="2.16.840.1.113883.10.20.22.4.2" />
                 <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.2" />
                 <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.2" />
                 <id root="9890e2c3-019a-4168-8403-a0a069994440" />
                 <code code="${data.labTest1Code || ''}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                   displayName="${data.labTest1Name || ''}"
                   sdtc:valueSet="${getConditionSpecificValueSet(data.labTest1Code, '2.16.840.1.113883.6.1').oid}"
                   sdtc:valueSetVersion="${getConditionSpecificValueSet(data.labTest1Code, '2.16.840.1.113883.6.1').version}" />
                 <statusCode code="completed" />
                 <effectiveTime value="${data.encounterDate || ''}" />
                   <author>
            <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
            <time value="20240615"/>
            <assignedAuthor>
              <id extension="1234567890" root="2.16.840.1.113883.4.6"/>
              <code code="207Q00000X" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="Family Medicine Physician"/>
              <assignedPerson>
                <name>
                  <given>Royce</given>
                  <family>Hemlock</family>
                </name>
              </assignedPerson>
            </assignedAuthor>
          </author>
                 <value code="260373001" codeSystem="2.16.840.1.113883.6.96"
                   codeSystemName="SNOMED-CT" displayName="${data.labTest1Result || ''}" xsi:type="CD" />
                   <interpretationCode code="${getInterpretationCode(data.labTest1Result, data.labTest1Interpretation)}" 
                       codeSystem="2.16.840.1.113883.5.83" 
                       codeSystemName="ObservationInterpretation"/>
                        <referenceRange>
      <observationRange>
        <text>Not Detected</text>
        <value xsi:type="CD" code="260415000" 
               codeSystem="2.16.840.1.113883.6.96" 
               displayName="Not detected"/>
      </observationRange>
    </referenceRange>
               </observation>
             </component>
           </organizer>
         </entry>

         <!-- Influenza Test Result with RCTC Trigger Code Template -->
         <entry typeCode="DRIV">
           <organizer classCode="BATTERY" moodCode="EVN">
             <templateId root="2.16.840.1.113883.10.20.22.4.1" />
             <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.1" />
             <id root="3f4b84f1-d3f6-4731-8e61-7c63d8f39a70" />
             <code code="${data.labTest2Code || ''}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
               displayName="${data.labTest2Name || ''}" />
             <statusCode code="completed" />
             <effectiveTime>
               <low value="${data.encounterDate || ''}" />
               <high value="${data.encounterDate || ''}" />
             </effectiveTime>
               <author>
            <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
            <time value="20240615"/>
            <assignedAuthor>
              <id extension="1234567890" root="2.16.840.1.113883.4.6"/>
              <code code="207Q00000X" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="Family Medicine Physician"/>
              <assignedPerson>
                <name>
                  <given>Royce</given>
                  <family>Hemlock</family>
                </name>
              </assignedPerson>
            </assignedAuthor>
          </author>
             <component>
               <observation classCode="OBS" moodCode="EVN">
                 <templateId root="2.16.840.1.113883.10.20.22.4.2" />
                 <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.4.2" />
                 <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.2" />
                 <id root="6c53c5ff-42a9-4f3c-a2c0-d412f019c0de" />
                 <code code="${data.labTest2Code || ''}" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC"
                   displayName="${data.labTest2Name || ''}"
                   sdtc:valueSet="${getConditionSpecificValueSet(data.labTest2Code, '2.16.840.1.113883.6.1').oid}"
                   sdtc:valueSetVersion="${getConditionSpecificValueSet(data.labTest2Code, '2.16.840.1.113883.6.1').version}" />
                 <statusCode code="completed" />
                 <effectiveTime value="${data.encounterDate || ''}" />
                   <author>
            <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
            <time value="20240615"/>
            <assignedAuthor>
              <id extension="1234567890" root="2.16.840.1.113883.4.6"/>
              <code code="207Q00000X" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="Family Medicine Physician"/>
              <assignedPerson>
                <name>
                  <given>Royce</given>
                  <family>Hemlock</family>
                </name>
              </assignedPerson>
            </assignedAuthor>
          </author>
                 <value code="260373001" codeSystem="2.16.840.1.113883.6.96"
                   codeSystemName="SNOMED-CT" displayName="${data.labTest2Result || ''}" xsi:type="CD" />
                   <interpretationCode code="${getInterpretationCode(data.labTest2Result, data.labTest2Interpretation)}" 
                   codeSystem="2.16.840.1.113883.5.83" codeSystemName="ObservationInterpretation"/>

<referenceRange>
  <observationRange>
    <text>${data.labTest1ReferenceRange || 'Not Detected'}</text>
    <value xsi:type="CD" code="260415000" 
           codeSystem="2.16.840.1.113883.6.96" 
           displayName="Not detected"/>
  </observationRange>
</referenceRange>
               </observation>
             </component>
           </organizer>
         </entry>
       </section>
     </component>`
}

      <!-- Social History Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.17" />
          <templateId extension="2015-08-01" root="2.16.840.1.113883.10.20.22.2.17" />
          <code code="29762-2" codeSystem="2.16.840.1.113883.6.1" displayName="Social History" />
          <title>Social History</title>
          <text>
            <table>
              <thead>
                <tr><th>Travel History</th><th>Dates</th><th>Location</th></tr>
              </thead>
              <tbody><tr><td>Recent travel</td><td>${data.travelStartDate} - ${data.travelEndDate}</td><td>${data.travelLocation}</td></tr></tbody>
            </table>
          </text>
          <entry typeCode="DRIV">
            <act classCode="ACT" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.15.2.3.1" />
              <templateId extension="2016-12-01" root="2.16.840.1.113883.10.20.15.2.3.1" />
              <id root="79565142-eae0-4213-a3b3-b73cdf474682" />
              <code code="420008001" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT"
      displayName="Travel">
    <originalText>Travel</originalText>
</code>
              <text>Recent travel to ${data.travelLocation}</text>
              <statusCode code="completed" />
              <effectiveTime>
                <low value="${data.travelStartDate}" />
                <high value="${data.travelEndDate}" />
              </effectiveTime>
              <participant typeCode="LOC">
    <participantRole classCode="TERR">
      <id nullFlavor="UNK"/>
      <code code="US" 
      codeSystem="1.0.3166.1" 
      displayName="United States"/>
      <addr>
        <streetAddressLine>${data.travelAddress}</streetAddressLine>
        <city>${data.travelLocation.split(',')[0] || data.travelLocation}</city>
        <state>${data.travelLocationCode || 'IL'}</state>
        <country>US</country>
      </addr>
      <playingEntity classCode="PLC">
        <name>${data.travelLocation}</name>
      </playingEntity>
    </participantRole>
  </participant>
            </act>
          </entry>
          
  <!-- ADDED to satisfy CONF:1198-14824 — exactly one Smoking Status - MU (V2) -->
    <entry>
      <observation classCode="OBS" moodCode="EVN">
        <!-- Smoking Status - Meaningful Use (V2) -->
        <templateId root="2.16.840.1.113883.10.20.22.4.78"/>
        <templateId root="2.16.840.1.113883.10.20.22.4.78" extension="2014-06-09"/>
        <id root="b3d8d3b1-9b8b-49a8-8ad0-6a0e0c0a1234"/>
        <code code="72166-2" codeSystem="2.16.840.1.113883.6.1" displayName="Tobacco smoking status NHIS"/>
        <statusCode code="completed"/>
        <!-- use the encounter/assessment date if known -->
        <effectiveTime value="20240520"/>
           <author>
            <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
            <time value="20240615"/>
            <assignedAuthor>
              <id extension="1234567890" root="2.16.840.1.113883.4.6"/>
              <code code="207Q00000X" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="Family Medicine Physician"/>
              <assignedPerson>
                <name>
                  <given>Royce</given>
                  <family>Hemlock</family>
                </name>
              </assignedPerson>
            </assignedAuthor>
          </author>
        <!-- SNOMED CT concept from the Smoking Status value set -->
        <value xsi:type="CD"
               code="266919005"
               codeSystem="2.16.840.1.113883.6.96"
               displayName="Never smoker"/>
      </observation>
    </entry>



         <!-- Pregnancy Observation -->
          ${generatePregnancyObservation(data)}


          <!-- Birth Sex Observation -->
          <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.200" extension="2016-06-01" />
              <id root="${generateGUID()}" />
              <code code="76689-9" codeSystem="2.16.840.1.113883.6.1" displayName="Sex Assigned At Birth" />
              <statusCode code="completed" />
              <effectiveTime value="${data.patientBirthDate}" />
              <value xsi:type="CD" code="${data.patientBirthSex || data.patientGender}" codeSystem="2.16.840.1.113883.5.1" />
            </observation>
          </entry>
          
          <!-- Gender Identity Observation -->
          <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.38" extension="2015-08-01" />
              <id root="${generateGUID()}" />
              <code code="76691-5" codeSystem="2.16.840.1.113883.6.1" displayName="Gender identity" />
              <statusCode code="completed" />
              <effectiveTime value="${data.patientBirthDate}" />
                <author>
            <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
            <time value="20240615"/>
            <assignedAuthor>
              <id extension="1234567890" root="2.16.840.1.113883.4.6"/>
              <code code="207Q00000X" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="Family Medicine Physician"/>
              <assignedPerson>
                <name>
                  <given>Royce</given>
                  <family>Hemlock</family>
                </name>
              </assignedPerson>
            </assignedAuthor>
          </author>
              <value xsi:type="CD" code="${data.patientGenderIdentity || data.patientGender}" codeSystem="2.16.840.1.113883.6.96" />
            </observation>
          </entry>

          
          
          <!-- Occupation Information -->
          ${data.currentOccupation ? `
          <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.38" extension="2015-08-01" />
              <id root="${generateGUID()}" />
              <code code="87729-0" codeSystem="2.16.840.1.113883.6.1" displayName="Current occupation" />
              <statusCode code="completed" />
              <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
                <author>
            <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
            <time value="20240615"/>
            <assignedAuthor>
              <id extension="1234567890" root="2.16.840.1.113883.4.6"/>
              <code code="207Q00000X" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="Family Medicine Physician"/>
              <assignedPerson>
                <name>
                  <given>Royce</given>
                  <family>Hemlock</family>
                </name>
              </assignedPerson>
            </assignedAuthor>
          </author>
              <value xsi:type="ST">${data.currentOccupation}</value>
              <participant typeCode="IND">
                <participantRole classCode="ASSIGNED">
                   
                  ${data.currentEmployerAddress ? `<addr><streetAddressLine>${data.currentEmployerAddress}</streetAddressLine></addr>` : ''}
                   ${data.currentEmployerPhone ? `<telecom value="tel:${data.currentEmployerPhone}" />` : ''}
                  <playingEntity classCode="ORG">
                    <name>${data.currentEmployerName || 'Unknown'}</name>
                  </playingEntity>
                </participantRole>
              </participant>
            </observation>
          </entry>
          
          <entry typeCode="DRIV">
            <observation classCode="OBS" moodCode="EVN">
              <templateId root="2.16.840.1.113883.10.20.22.4.216" extension="2022-06-01" />
              <id root="${generateGUID()}" />
              <code code="21843-8" codeSystem="2.16.840.1.113883.6.1" displayName="History of Occupation industry" />
              <statusCode code="active" />
              <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
              <value xsi:type="ST">${data.currentIndustry || 'Unknown'}</value>
            </observation>
          </entry>` : ''}
        </section>
      </component>

<!-- Occupational Data for Health Template Requirements Section -->
<component>
  <section>
    <templateId root="2.16.840.1.113883.10.20.22.2.17" extension="2020-09-01"/>
    <code code="29762-2" codeSystem="2.16.840.1.113883.6.1" 
      displayName="Social History"/>
    <title>Occupational Data for Health</title>
    <text>
      <table border="1">
        <thead>
          <tr><th>Category</th><th>Value</th><th>Details</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Current Occupation</td>
            <td>${data.currentOccupation}</td>
            <td>Job Title: ${data.currentJobTitle}</td>
          </tr>
          <tr>
            <td>Current Industry</td>
            <td>${data.currentIndustry}</td>
            <td>Employer: ${data.currentEmployerName}</td>
          </tr>
          <tr>
            <td>Employment Status</td>
            <td>${getEmploymentStatusDisplay(data.employmentStatus)}</td>
            <td>Occupational Exposure Risk: ${data.occupationalExposure === 'Y' ? 'Yes' : data.occupationalExposure === 'N' ? 'No' : 'Unknown'}</td>
          </tr>
        </tbody>
      </table>
    </text>
    
    <!-- Current Occupation Observation -->
    <entry typeCode="DRIV">
      <observation classCode="OBS" moodCode="EVN">
        <templateId root="2.16.840.1.113883.10.20.22.4.38" extension="2015-08-01" />
        <id root="${generateGUID()}" />
        <code code="87729-0" codeSystem="2.16.840.1.113883.6.1" displayName="Current occupation" />
        <statusCode code="completed" />
        <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
        <author>
          <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
          <time value="${data.encounterDate}"/>
          <assignedAuthor>
            <id extension="${data.providerId}" root="2.16.840.1.113883.4.6"/>
            <code code="${getProviderTaxonomyCode('physician').code}" 
                  codeSystem="2.16.840.1.113883.6.101" 
                  displayName="${getProviderTaxonomyCode('physician').display}"/>
            <assignedPerson>
              <name>
                <given>${(data.providerName || 'Unknown').split(' ')[0]}</given>
                <family>${(data.providerName || 'Unknown').split(' ').slice(1).join(' ') || 'Provider'}</family>
              </name>
            </assignedPerson>
          </assignedAuthor>
        </author>
        <value xsi:type="ST">${data.currentOccupation}</value>
        <participant typeCode="IND">
          <participantRole classCode="ASSIGNED">
            ${data.currentEmployerAddress ? `<addr><streetAddressLine>${data.currentEmployerAddress}</streetAddressLine></addr>` : ''}
            ${data.currentEmployerPhone ? `<telecom value="tel:${data.currentEmployerPhone}" />` : ''}
            <playingEntity classCode="ORG">
              <name>${data.currentEmployerName || 'Unknown'}</name>
            </playingEntity>
          </participantRole>
        </participant>
      </observation>
    </entry>
    
    <!-- Current Industry Observation -->
    <entry typeCode="DRIV">
      <observation classCode="OBS" moodCode="EVN">
        <templateId root="2.16.840.1.113883.10.20.22.4.216" extension="2022-06-01" />
        <id root="${generateGUID()}" />
        <code code="21843-8" codeSystem="2.16.840.1.113883.6.1" displayName="History of Occupation industry" />
        <statusCode code="active" />
        <effectiveTime><low value="${data.encounterDate}" /></effectiveTime>
        <author>
          <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
          <time value="${data.encounterDate}"/>
          <assignedAuthor>
            <id extension="${data.providerId}" root="2.16.840.1.113883.4.6"/>
            <code code="${getProviderTaxonomyCode('physician').code}" 
                  codeSystem="2.16.840.1.113883.6.101" 
                  displayName="${getProviderTaxonomyCode('physician').display}"/>
            <assignedPerson>
              <name>
                <given>${(data.providerName || 'Unknown').split(' ')[0]}</given>
                <family>${(data.providerName || 'Unknown').split(' ').slice(1).join(' ') || 'Provider'}</family>
              </name>
            </assignedPerson>
          </assignedAuthor>
        </author>
        <value xsi:type="ST">${data.currentIndustry}</value>
      </observation>
    </entry>
  </section>
</component>






      <!-- Vital Signs Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.4" />
          <templateId root="2.16.840.1.113883.10.20.22.2.4" extension="2015-08-01" />
          <templateId root="2.16.840.1.113883.10.20.22.2.4.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.4.1" extension="2015-08-01" />
          <code code="8716-3" codeSystem="2.16.840.1.113883.6.1" displayName="Vital signs" />
          <title>Vital Signs</title>
          <text>
            <table>
              <thead>
                <tr><th>Vital Sign</th><th>Value</th><th>Unit</th><th>Date</th></tr>
              </thead>
              <tbody>${data.temperature ? `<tr><td>Temperature</td><td>${data.temperature}</td><td>°F</td><td>${data.encounterDate}</td></tr>` : ''}${data.bloodPressure ? `<tr><td>Blood Pressure</td><td>${data.bloodPressure}</td><td>mmHg</td><td>${data.encounterDate}</td></tr>` : ''}${data.heartRate ? `<tr><td>Heart Rate</td><td>${data.heartRate}</td><td>bpm</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.respiratoryRate  ? `<tr><td>Respiratory Rate</td><td>${data.respiratoryRate}</td><td>/min</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.oxygenSaturation ? `<tr><td>Oxygen Saturation</td><td>${data.oxygenSaturation}</td><td>%</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.weight           ? `<tr><td>Weight</td><td>${data.weight}</td><td>kg</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.height           ? `<tr><td>Height</td><td>${data.height}</td><td>cm</td><td>${data.encounterDate}</td></tr>` : ''}
  ${data.bmi              ? `<tr><td>BMI</td><td>${data.bmi}</td><td>kg/m²</td><td>${data.encounterDate}</td></tr>` : ''}
</tbody>

            </table>
          </text>
          ${generateVitalSignsEntries(data)}
        </section>
      </component>

      <!-- Medications Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.1" extension="2014-06-09" />
          <templateId root="2.16.840.1.113883.10.20.22.2.1.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.1.1" extension="2014-06-09" />
          <code code="10160-0" codeSystem="2.16.840.1.113883.6.1" displayName="Medications" />
          <title>Medications</title>
          <text>
            <table>
              <thead>
                <tr><th>Medication</th><th>Dose</th><th>Route</th><th>Date</th><th>Status</th></tr>
              </thead>
              <tbody>${data.adminMed1Name ? `<tr><td>${data.adminMed1Name}</td><td>${data.adminMed1DoseValue} ${data.adminMed1DoseUnit}${data.adminMed1VolValue ? ' (' + data.adminMed1VolValue + ' ' + data.adminMed1VolUnit + ')' : ''}</td><td>${data.adminMed1Route}</td><td>${data.adminMed1Time}</td><td>${data.adminMed1Status}</td></tr>` : ''}${data.adminMed2Name ? `<tr><td>${data.adminMed2Name}</td><td>${data.adminMed2DoseValue} ${data.adminMed2DoseUnit}${data.adminMed2VolValue ? ' (' + data.adminMed2VolValue + ' ' + data.adminMed2VolUnit + ')' : ''}</td><td>${data.adminMed2Route}</td><td>${data.adminMed2Time}</td><td>${data.adminMed2Status}</td></tr>` : ''}</tbody>
            </table>
          </text>
          ${generateMedicationEntries(data)}
        </section>
      </component>

      <!-- Immunizations Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.2" />
          <templateId root="2.16.840.1.113883.10.20.22.2.2" extension="2015-08-01" />
          <templateId root="2.16.840.1.113883.10.20.22.2.2.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.2.1" extension="2015-08-01" />
          <code code="11369-6" codeSystem="2.16.840.1.113883.6.1" displayName="Immunizations" />
          <title>Immunizations</title>
          <text>
            <table>
              <thead>
                <tr><th>Vaccine</th><th>Date</th><th>Status</th><th>Manufacturer</th></tr>
              </thead>
              <tbody>${data.vaccine1Name ? `<tr><td>${data.vaccine1Name}</td><td>${data.immunization1Date}</td><td>${data.immunization1Status}</td><td>${data.vaccine1Manufacturer}</td></tr>` : ''}${data.vaccine2Name ? `<tr><td>${data.vaccine2Name}</td><td>${data.immunization2Date}</td><td>${data.immunization2Status}</td><td>${data.vaccine2Manufacturer}</td></tr>` : ''}</tbody>
            </table>
          </text>
          ${generateImmunizationEntries(data)}
        </section>
      </component>

      <!-- Procedures Section -->
      <component>
        <section>
          <templateId root="2.16.840.1.113883.10.20.22.2.7" />
          <templateId root="2.16.840.1.113883.10.20.22.2.7" extension="2014-06-09" />
          <templateId root="2.16.840.1.113883.10.20.22.2.7.1" />
          <templateId root="2.16.840.1.113883.10.20.22.2.7.1" extension="2014-06-09" />
          <code code="47519-4" codeSystem="2.16.840.1.113883.6.1" displayName="Procedures" />
          <title>Procedures</title>
          <text>
            <table>
              <thead>
                <tr><th>Procedure</th><th>Date</th><th>Type</th></tr>
              </thead>
              <tbody>${
  data.currentProc1Name
    ? `<tr><td>${xmlEscape(data.currentProc1Name)}</td><td>${xmlEscape(data.currentProc1Date)}</td><td>${xmlEscape(data.currentProc1Type)}</td></tr>`
    : ''
}${
  data.currentProc2Name
    ? `<tr><td>${xmlEscape(data.currentProc2Name)}</td><td>${xmlEscape(data.currentProc2Date)}</td><td>${xmlEscape(data.currentProc2Type)}</td></tr>`
    : ''
}${
  data.triggerProc1Name
    ? `<tr><td>${xmlEscape(data.triggerProc1Name)}</td><td>${xmlEscape(data.triggerProc1Date)}</td><td>${xmlEscape(data.triggerProc1Type)}</td></tr>`
    : ''
}</tbody>

            </table>
          </text>
          ${generateProcedureEntries(data)}
        </section>
      </component>

      <!-- Allergies Section -->
      <component>
        <section nullFlavor="NI">
          <templateId root="2.16.840.1.113883.10.20.22.2.6.1" extension="2015-08-01"/>
          <code code="48765-2" codeSystem="2.16.840.1.113883.6.1" displayName="Allergies and adverse reactions Document"/>
          <title>Allergies</title>
          <text>No Known Allergies</text>
        </section>
      </component>

      // Find this section in your buildEICRXml() function around line 1600+ and replace it:

// Find this section in your buildEICRXml() function around line 1600+ and replace it:

<!-- Admission Medications Section -->
<component>
  <section>
    <templateId root="2.16.840.1.113883.10.20.22.2.44" extension="2015-08-01"/>
    <code code="42346-7" codeSystem="2.16.840.1.113883.6.1" displayName="Medications on admission (narrative) Document"/>
    <title>Admission Medications</title>
    <text>
      <table>
        <thead>
          <tr><th>Medication</th><th>Dose</th><th>Route</th></tr>
        </thead>
        <tbody>
          <tr><td>${data.adminMed1Name}</td><td>${data.adminMed1DoseValue} ${data.adminMed1DoseUnit}</td><td>${data.adminMed1Route}</td></tr>
        </tbody>
      </table>
    </text>
    <entry typeCode="DRIV">
      <act classCode="ACT" moodCode="EVN">
        <templateId root="2.16.840.1.113883.10.20.22.4.36" extension="2014-06-09"/>
        <id root="${generateGUID()}"/>
        <code code="42346-7" codeSystem="2.16.840.1.113883.6.1" displayName="Medications on admission"/>
        <statusCode code="active"/>
        <effectiveTime value="${data.encounterDate}"/>
  <author>
            <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
            <time value="20240615"/>
            <assignedAuthor>
              <id extension="1234567890" root="2.16.840.1.113883.4.6"/>
              <code code="207Q00000X" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="Family Medicine Physician"/>
              <assignedPerson>
                <name>
                  <given>Royce</given>
                  <family>Hemlock</family>
                </name>
              </assignedPerson>
            </assignedAuthor>
          </author>
        <entryRelationship typeCode="SUBJ">
          <substanceAdministration classCode="SBADM" moodCode="INT">
            <templateId root="2.16.840.1.113883.10.20.22.4.16" extension="2014-06-09"/>
            <id root="${generateGUID()}"/>
            <statusCode code="active"/>
            <effectiveTime value="${data.encounterDate}"/>
               <author>
            <templateId root="2.16.840.1.113883.10.20.22.4.119"/>
            <time value="20240615"/>
            <assignedAuthor>
              <id extension="1234567890" root="2.16.840.1.113883.4.6"/>
              <code code="207Q00000X" 
      codeSystem="2.16.840.1.113883.6.101" 
      displayName="Family Medicine Physician"/>
              <assignedPerson>
                <name>
                  <given>Royce</given>
                  <family>Hemlock</family>
                </name>
              </assignedPerson>
            </assignedAuthor>
          </author>
            <routeCode code="${data.adminMed1Route}" codeSystem="2.16.840.1.113883.3.26.1.1">
              <translation code="${getRouteTranslation(data.adminMed1Route).code}" 
                           codeSystem="2.16.840.1.113883.6.96" 
                           displayName="${getRouteTranslation(data.adminMed1Route).display}"/>
            </routeCode>
            <doseQuantity value="${data.adminMed1DoseValue}" unit="${data.adminMed1DoseUnit}"/>
            <consumable>
              <manufacturedProduct classCode="MANU">
                <templateId root="2.16.840.1.113883.10.20.22.4.23" extension="2014-06-09"/>
                <manufacturedMaterial>
                  <code code="${data.adminMed1Code}" codeSystem="2.16.840.1.113883.6.88" displayName="${data.adminMed1Name}"/>
                </manufacturedMaterial>
              </manufacturedProduct>
            </consumable>
          </substanceAdministration>
        </entryRelationship>
      </act>
    </entry>
  </section>
</component>

      <!-- Hospital Admission Diagnosis FIXED VERSION -->
<component>
  <section nullFlavor="NI">
    <templateId root="2.16.840.1.113883.10.20.22.2.43" extension="2015-08-01"/>
    <code code="46241-6" codeSystem="2.16.840.1.113883.6.1" displayName="Hospital admission diagnosis Narrative - Reported">
      <translation code="42347-5" codeSystem="2.16.840.1.113883.6.1" displayName="Admission Diagnosis"/>
    </code>
    <title>Hospital Admission Diagnosis</title>
    <text>See Encounters Section and Problems Section</text>
  </section>
</component>

      <!-- Hospital Discharge Diagnosis -->
      <component>
        <section nullFlavor="NI">
          <templateId root="2.16.840.1.113883.10.20.22.2.24" extension="2015-08-01"/>
          <code code="11535-2" codeSystem="2.16.840.1.113883.6.1" displayName="Hospital discharge diagnosis Narrative">
      <translation code="78375-3" codeSystem="2.16.840.1.113883.6.1" displayName="Discharge Diagnosis"/>
    </code>
          <title>Hospital Discharge Diagnosis</title>
          <text>See Encounters Section and Problems Section</text>
        </section>
      </component>

      <!-- Past Medical History -->
      <component>
        <section nullFlavor="NI">
          <templateId root="2.16.840.1.113883.10.20.22.2.20" extension="2015-08-01"/>
          <code code="11348-0" codeSystem="2.16.840.1.113883.6.1" displayName="History of Past illness Narrative"/>
          <title>Past Medical History</title>
          <text>${data.pastMedicalHistory}</text>
        </section>
      </component>

      <!-- Review of Systems -->
      <component>
        <section nullFlavor="NI">
          <templateId root="1.3.6.1.4.1.19376.1.5.3.1.3.18"/>
          <code code="10187-3" codeSystem="2.16.840.1.113883.6.1" displayName="Review of systems Narrative - Reported"/>
          <title>Review of Systems</title>
          <text>${data.reviewOfSystems}</text>
        </section>
      </component>

      <!-- Chief Complaint -->
      <component>
        <section nullFlavor="NI">
          <templateId root="1.3.6.1.4.1.19376.1.5.3.1.1.13.2.1"/>
          <code code="10154-3" codeSystem="2.16.840.1.113883.6.1" displayName="Chief complaint Narrative - Reported"/>
          <title>Chief Complaint</title>
          <text>${data.chiefComplaint}</text>
        </section>
      </component>
<!-- Emergency Outbreak Information Section -->
<component>
  <section>
    <templateId root="2.16.840.1.113883.10.20.15.2.2.4" extension="2021-01-01"/>
    <code code="83910-0" codeSystem="2.16.840.1.113883.6.1" 
          codeSystemName="LOINC" displayName="Emergency outbreak information"/>
    <title>Emergency Outbreak Information</title>
    <text>
      <table border="1">
        <thead>
          <tr>
            <th>Category</th>
            <th>Information</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Emergency/Outbreak Status</td>
            <td>${getEmergencyOutbreakDisplay(data.emergencyOutbreakInfo)}</td>
            <td>${data.outbreakDetails}</td>
          </tr>
          <tr>
            <td>Exposure/Contact</td>
            <td>${getExposureContactDisplay(data.exposureContactInfo)}</td>
            <td>Type: ${getExposureTypeDisplay(data.exposureType)}, Location: ${data.exposureLocation}, Date: ${data.exposureDate}</td>
          </tr>
          <tr>
            <td>Contact Person</td>
            <td>${data.contactPersonName}</td>
            <td>Phone: ${data.contactPersonPhone}</td>
          </tr>
          <tr>
            <td>Quarantine/Isolation</td>
            <td>Quarantine: ${getQuarantineStatusDisplay(data.quarantineStatus)}, Isolation: ${getIsolationStatusDisplay(data.isolationStatus)}</td>
            <td>Current status as of encounter date</td>
          </tr>
        </tbody>
      </table>
    </text>
    
    <!-- REQUIRED Emergency Outbreak Information Observation -->
<entry typeCode="DRIV">
  <observation classCode="OBS" moodCode="EVN">
    <templateId root="2.16.840.1.113883.10.20.15.2.3.40" extension="2021-01-01"/>
    <id root="${generateGUID()}"/>
    <code code="83910-0" codeSystem="2.16.840.1.113883.6.1" 
          displayName="Emergency outbreak information"/>
    <statusCode code="completed"/>
    <effectiveTime value="${data.encounterDate}"/>
    <value xsi:type="CD" 
           code="${data.emergencyOutbreakInfo || 'N/A'}" 
           codeSystem="2.16.840.1.113883.6.96" 
           displayName="${getEmergencyOutbreakDisplay(data.emergencyOutbreakInfo || 'N/A')}"/>
  </observation>
</entry>
    
    <!-- Exposure Information Entry -->
    ${data.exposureContactInfo && data.exposureContactInfo !== '373068000' 
      ? `<entry typeCode="DRIV">
           <observation classCode="OBS" moodCode="EVN">
             <templateId root="2.16.840.1.113883.10.20.22.4.38"/>
             <id root="${generateGUID()}"/>
             <code code="418715001" codeSystem="2.16.840.1.113883.6.96" 
                   displayName="Exposure to potentially harmful entity"/>
             <statusCode code="completed"/>
             <effectiveTime value="${data.exposureDate !== 'Not applicable' ? data.exposureDate : data.encounterDate}"/>
             <value xsi:type="CD" code="${data.exposureContactInfo}" 
                    codeSystem="2.16.840.1.113883.6.96" 
                    displayName="${getExposureContactDisplay(data.exposureContactInfo)}"/>
           </observation>
         </entry>`
      : ''
    }
  </section>
</component>
    </structuredBody>
  </component>
</ClinicalDocument>`;
            return cdaTemplate;
        }

        function generateCDA() {
            return buildEICRXml();
        }

        async function generateAndDownloadCDA() {
            if (!validateFormData()) {
                return;
            }

            try {
                const cdaContent = generateCDA();
                const data = getFormData();

                // Additional CDA-specific validation
                if (!cdaContent.includes('<ClinicalDocument')) {
                    throw new Error('Invalid CDA document structure generated');
                }

                const blob = new Blob([cdaContent], { type: 'application/xml' });
                const filename = generateDynamicFilename('eICR', 'xml');

                // Try to use File System Access API (Chrome/Edge) to prompt for save location
                if ('showSaveFilePicker' in window) {
                    try {
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: filename,
                            types: [
                                {
                                    description: 'XML files',
                                    accept: { 'application/xml': ['.xml'] }
                                }
                            ]
                        });
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        console.log('CDA file saved with user-selected location');
                        return;
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.warn('File System Access API failed for CDA, falling back to download:', err);
                        } else {
                            console.log('User cancelled CDA save dialog');
                            return;
                        }
                    }
                }

                // Fallback to traditional download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                
            } catch (error) {
                console.error('CDA Generation Error:', error);
                alert(`Error generating CDA document: ${error.message}\n\nPlease check that all required fields are completed correctly.`);
            }
        }


        function saveFormData() {
            const data = getFormData();
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RCTC_eICR_form_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function loadFormData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            setFormData(data);
            
            // Handle lab evidence if present
            if (data.labEvidence && Array.isArray(data.labEvidence)) {
                const labList = document.getElementById('labEvidenceList');
                if (labList) {
                    labList.innerHTML = ''; // Clear existing entries
                    data.labEvidence.forEach(labEntry => {
                        addLabEvidence(labEntry);
                    });
                }
            }

            // Handle diagnosis evidence if present
            if (data.diagnosisEvidence && Array.isArray(data.diagnosisEvidence)) {
                const diagnosisList = document.getElementById('diagnosisEvidenceList');
                if (diagnosisList) {
                    diagnosisList.innerHTML = ''; // Clear existing entries
                    data.diagnosisEvidence.forEach(diagnosisEntry => {
                        addDiagnosisEvidence(diagnosisEntry);
                    });
                }
            }

            // Handle problem evidence if present
            if (data.problemEvidence && Array.isArray(data.problemEvidence)) {
                const problemList = document.getElementById('problemEvidenceList');
                if (problemList) {
                    problemList.innerHTML = ''; // Clear existing entries
                    data.problemEvidence.forEach(problemEntry => {
                        addProblemEvidence(problemEntry);
                    });
                }
            }

            alert('Form data loaded successfully!');
        } catch (error) {
            alert('Error loading file: ' + error.message);
            console.error('Load error:', error);
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            const searchResults = document.querySelectorAll('.search-results');
            searchResults.forEach(result => {
                if (!result.parentElement.contains(e.target)) {
                    result.style.display = 'none';
                }
            });
        });

        function togglePregnancyFields() {
            const genderSelect = document.getElementById('patientGender');
            const pregnancySections = document.querySelectorAll('.section');
            
            let pregnancyDiv = null;
            pregnancySections.forEach(section => {
                const title = section.querySelector('.section-title');
                if (title && title.textContent.includes('Pregnancy Information')) {
                    pregnancyDiv = section;
                }
            });
            
            if (genderSelect && pregnancyDiv) {
                if (genderSelect.value === 'F') {
                    pregnancyDiv.style.display = 'block';
                } else {
                    pregnancyDiv.style.display = 'none';
                }
            }
        }

        function toggleGuardianFields() {
            const birthDate = document.getElementById('patientBirthDate');
            const guardianSections = document.querySelectorAll('.section');
            
            let guardianDiv = null;
            guardianSections.forEach(section => {
                const title = section.querySelector('.section-title');
                if (title && title.textContent.includes('Guardian/Parent Information')) {
                    guardianDiv = section;
                }
            });
            
            if (birthDate && guardianDiv && birthDate.value.length === 8) {
                const today = new Date();
                const birth = new Date(
                    birthDate.value.substring(0, 4),
                    birthDate.value.substring(4, 6) - 1,
                    birthDate.value.substring(6, 8)
                );
                
                const age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                
                if (age < 18 || (age === 18 && monthDiff < 0)) {
                    guardianDiv.style.display = 'block';
                } else {
                    guardianDiv.style.display = 'none';
                }
            }
        }

        function setupConditionalDisplays() {
            // Gender-based pregnancy field display
            const genderSelect = document.getElementById('patientGender');
            if (genderSelect) {
                genderSelect.addEventListener('change', togglePregnancyFields);
                togglePregnancyFields(); // Initial check
            }

            // Age-based guardian field display
            const birthDateInput = document.getElementById('patientBirthDate');
            if (birthDateInput) {
                birthDateInput.addEventListener('change', toggleGuardianFields);
                birthDateInput.addEventListener('blur', toggleGuardianFields);
            }
        }

        // Global variable to store conditions data
        let conditionsData = [];
        let conditionsLoaded = false;

        // Load conditions from Excel file
        async function loadConditionsFromExcel() {
            try {
                const response = await fetch('./assets/xslt/conditions.xlsx');
                if (!response.ok) {
                    throw new Error(`Failed to load Excel file: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                const allConditions = [];
                
                // Process all sheets
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Skip empty sheets or sheets with no data rows
                    if (jsonData.length <= 1) return;
                    
                    const headers = jsonData[0];
                    const conditionIndex = headers.findIndex(h => h && h.toLowerCase().includes('condition'));
                    const codeTypeIndex = headers.findIndex(h => h && h.toLowerCase().includes('code_type'));
                    const codeIndex = headers.findIndex(h => h && (h.toLowerCase().includes('code') && !h.toLowerCase().includes('code_type')));
                    const descriptionIndex = headers.findIndex(h => h && h.toLowerCase().includes('description'));
                    
                    // Process data rows
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row && row[codeIndex]) {
                            allConditions.push({
                                condition: row[conditionIndex] || '',
                                codeType: row[codeTypeIndex] || '',
                                code: row[codeIndex] || '',
                                description: row[descriptionIndex] || ''
                            });
                        }
                    }
                });
                
                conditionsData = allConditions;
                conditionsLoaded = true;
                
                // Populate dropdowns after loading
                populateConditionDropdowns(conditionsData);
                
                console.log(`Loaded ${conditionsData.length} conditions from Excel file`);
                return conditionsData;
                
            } catch (error) {
                console.warn('Failed to load conditions from Excel file:', error);
                // Fallback to hardcoded values if Excel file can't be loaded
                conditionsData = getHardcodedConditions();
                conditionsLoaded = true;
                populateConditionDropdowns(conditionsData);
                return conditionsData;
            }
        }

        // Fallback hardcoded conditions
        function getHardcodedConditions() {
            return [
                { condition: "Down Syndrome", code: "67531005", codeType: "SNOMEDCT", description: "Down syndrome (disorder)" },
                { condition: "Pertussis", code: "414819007", codeType: "SNOMEDCT", description: "Disease caused by Bordetella pertussis (disorder)" },
                { condition: "Gonorrhea", code: "86299006", codeType: "SNOMEDCT", description: "Gonorrhea (disorder)" }
            ];
        }

        // Populate condition dropdowns
        function populateConditionDropdowns(conditions) {
            const diagnosisFields = ['diagnosis1Code', 'diagnosis2Code', 'diagnosis3Code'];
            const defaultValues = ['67531005', '414819007', '86299006']; // Original hardcoded values
            
            diagnosisFields.forEach((fieldId, index) => {
                const select = document.getElementById(fieldId);
                if (select && select.tagName === 'SELECT') {
                    // Clear existing options except the first placeholder
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    // Add conditions as options
                    conditions.forEach(condition => {
                        const option = document.createElement('option');
                        option.value = condition.code;
                        option.textContent = `${condition.code} - ${condition.description} (${condition.condition})`;
                        
                        // Mark RCTC trigger codes
                        if (isRCTCTriggerCode(condition.code)) {
                            option.textContent += ' [RCTC]';
                            option.style.fontWeight = 'bold';
                        }
                        
                        select.appendChild(option);
                    });
                    
                    // Set default value and trigger auto-population
                    if (defaultValues[index]) {
                        select.value = defaultValues[index];
                        handleDiagnosisSelection(fieldId, defaultValues[index], conditions);
                    }
                }
            });
        }

        // Handle diagnosis code selection
        function handleDiagnosisSelection(fieldId, selectedCode, conditions) {
            const nameFieldId = fieldId.replace('Code', 'Name');
            const nameField = document.getElementById(nameFieldId);
            
            if (nameField && selectedCode) {
                const selectedCondition = conditions.find(c => c.code === selectedCode);
                if (selectedCondition) {
                    nameField.value = selectedCondition.condition;
                }
            }
            
            // Validate trigger code
            validateTriggerCode(fieldId);
        }

        // Initialize the form
        function migrateLegacyLabsToNewSystem() {
            const data = getFormData();

            // Add default lab evidence entries from legacy data if they exist
            if (data.labTest1Code || data.labOrder1Code) {
                addLabEvidence({
                    orderCode: data.labOrder1Code || data.labTest1Code,
                    orderName: data.labTest1Name,
                    orderId: data.labOrder1Id,
                    orderTime: data.labOrder1Time,
                    testCode: data.labTest1Code,
                    testName: data.labTest1Name,
                    valueKind: 'text',
                    textValue: data.labTest1Result,
                    time: data.labTest1Time,
                    status: data.labTest1Status || 'completed',
                    interpretation: data.labTest1Interpretation,
                    referenceRange: data.labTest1ReferenceRange
                });
            }

            if (data.labTest2Code) {
                addLabEvidence({
                    testCode: data.labTest2Code,
                    testName: data.labTest2Name,
                    valueKind: 'text',
                    textValue: data.labTest2Result,
                    time: data.labTest2Time,
                    status: data.labTest2Status || 'completed',
                    interpretation: data.labTest2Interpretation,
                    referenceRange: data.labTest2ReferenceRange
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('eICR Generator loaded');
            console.log('RCTC Metadata:', rctcData.metadata);
            
            // Load conditions from Excel file
            loadConditionsFromExcel().then(() => {
                console.log('Conditions loaded successfully');
            });
            
            setupConditionalDisplays();
            
            // Initialize document relationship fields
            handleRelationshipTypeChange();
            
            // NEW: Initialize lab evidence
            if (!document.querySelector('.lab-evidence-row')) {
                addLabEvidence();
            }

            // Initialize diagnosis evidence with default entries
            if (!document.querySelector('.diagnosis-evidence-row')) {
                // Add default diagnoses
                addDiagnosisEvidence({
                    diagnosisCode: '67531005',
                    diagnosisName: 'Down syndrome (disorder)',
                    diagnosisDate: '20240601',
                    onsetDate: '20240601',
                    status: 'completed'
                });
                addDiagnosisEvidence({
                    diagnosisCode: '67531005',
                    diagnosisName: 'Spina bifida (disorder)',
                    diagnosisDate: '20240601',
                    onsetDate: '20240601',
                    status: 'completed'
                });
                addDiagnosisEvidence({
                    diagnosisCode: '414819007',
                    diagnosisName: 'Neonatal abstinence syndrome (disorder)',
                    diagnosisDate: '20240610',
                    onsetDate: '20240610',
                    status: 'completed'
                });
            }

            // Initialize problems evidence with default entry
            if (!document.querySelector('.problem-evidence-row')) {
                addProblemEvidence({
                    problemCode: '385093006',
                    problemName: 'Community acquired pneumonia',
                    onsetDate: '20240227',
                    status: 'active',
                    concernStatus: 'active'
                });
            }

            // Set default birth date to datetime-local format
            const birthDateInput = document.getElementById('patientBirthDate');
            if (birthDateInput && birthDateInput.type === 'datetime-local') {
                // Set default to June 15, 2024 at midnight
                birthDateInput.value = '2024-06-15T00:00';
            }

            // Generate random Document ID
            function generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            document.getElementById('documentId').value = generateUUID();

        });
    </script>


  <!-- Clean UI v8.1 overlay -->
  <script type="module" src="js/ui.clean.v8_1.refresh.js" defer></script>

</body>
</html>